---
title: A few useful JavaScript aggregation and formatting functions for {reactable}
subtitle: Series on runtime-free content delivery
author: R package build
date: '2022-07-31'
slug: reactable-javascript
categories: []
tags: ['rstats', 'javascript']
summary: ''
authors: []
lastmod: '2022-07-31T09:20:22-05:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>
<script src="{{< blogdown/postref >}}index_files/core-js/shim.min.js"></script>
<script src="{{< blogdown/postref >}}index_files/react/react.min.js"></script>
<script src="{{< blogdown/postref >}}index_files/react/react-dom.min.js"></script>
<script src="{{< blogdown/postref >}}index_files/reactwidget/react-tools.js"></script>
<script src="{{< blogdown/postref >}}index_files/htmlwidgets/htmlwidgets.js"></script>
<script src="{{< blogdown/postref >}}index_files/reactable-binding/reactable.js"></script>


<p><strong><strong>In Progress</strong></strong></p>
<p>In my <a href="https://www.zajichekstats.com/post/filterable-maps/">last post</a> we demonstrated how to build a filterable map widget into an HTML output that was free of <code>R</code> runtime dependency. In continuation of that theme, this article focuses on the <a href="https://glin.github.io/reactable/"><code>reactable</code></a> package, which enables you to embed interactive data tables into your document. Specifically, we’ll look at how we can use its built-in JavaScript interface to define custom functions for commonly-desired aggregation and formatting.</p>
<div id="table-of-contents" class="section level1">
<h1>Table of Contents</h1>
<ol style="list-style-type: decimal">
<li><a href="#thebasics">The Basics</a></li>
</ol>
<ul>
<li><a href="#summarydata">Make a summary dataset</a></li>
<li><a href="#defaulttable">The default table</a></li>
<li><a href="#builtinaggregation">Built-in aggregation</a></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><a href="#jsinterface">Using the JavaScript Interface</a></li>
</ol>
<ul>
<li><a href="#function1">Function 1: Weighted mean</a></li>
</ul>
</div>
<div id="the-basics" class="section level1">
<h1>The Basics</h1>
<p>Let’s start with loading some packages.</p>
<pre class="r"><code>require(reactable)</code></pre>
<pre><code>## Loading required package: reactable</code></pre>
<pre class="r"><code>require(tidyverse)</code></pre>
<pre><code>## Loading required package: tidyverse</code></pre>
<pre><code>## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──</code></pre>
<pre><code>## ✓ ggplot2 3.3.5     ✓ purrr   0.3.4
## ✓ tibble  3.1.6     ✓ dplyr   1.0.8
## ✓ tidyr   1.2.0     ✓ stringr 1.4.0
## ✓ readr   2.1.2     ✓ forcats 0.5.1</code></pre>
<pre><code>## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<div id="summarydata" class="section level2">
<h2>Make a summary dataset</h2>
<p>First we’ll need to create a data frame with group-level summary statistics that we want to display. For this example, we’ll look at the 30-day hospital readmission rate for heart failure patients at the top five (5) most voluminous hospitals in a handful of Midwest states.</p>
<pre class="r"><code># Import dataset
readmission_rates &lt;-
  read_csv(
    file = &quot;https://data.cms.gov/provider-data/sites/default/files/resources/37e3c1486ad47b7a0eb471ecf3f7e428_1657310806/Unplanned_Hospital_Visits-Hospital.csv&quot;,
    na = c(&quot;&quot;, &quot; &quot;, &quot;NA&quot;, &quot;N/A&quot;, &quot;Not Available&quot;)
  ) %&gt;%
  
  # Filter to states with non-null values
  filter(
    State %in% c(&quot;WI&quot;, &quot;MN&quot;, &quot;MI&quot;, &quot;IL&quot;),
    `Measure ID` == &quot;READM_30_HF&quot;,
    !is.na(Denominator),
    !is.na(Score)
  ) %&gt;%
  
  # Convert to proportion
  mutate(
    Score = Score / 100
  ) %&gt;%
  
  # Keep a few columns
  select(
    State,
    Hospital = `Facility Name`,
    Cases = Denominator,
    `30-Day Readmission Rate` = Score
  ) %&gt;%
  
  # For each state, keep the top 5 most voluminous hospitals
  group_by(State) %&gt;%
  slice_max(
    n = 5,
    order_by = Cases,
    with_ties = FALSE
  ) %&gt;%
  ungroup()</code></pre>
<pre><code>## Warning: One or more parsing issues, see `problems()` for details</code></pre>
<pre><code>## Rows: 67802 Columns: 20
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;,&quot;
## chr (15): Facility ID, Facility Name, Address, City, State, ZIP Code, County...
## dbl  (5): Denominator, Score, Lower Estimate, Higher Estimate, Footnote
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<pre class="r"><code>readmission_rates</code></pre>
<pre><code>## # A tibble: 20 × 4
##    State Hospital                                         Cases `30-Day Readmi…`
##    &lt;chr&gt; &lt;chr&gt;                                            &lt;dbl&gt;            &lt;dbl&gt;
##  1 IL    NORTHSHORE UNIVERSITY HEALTHSYSTEM - EVANSTON H…  2205            0.212
##  2 IL    PALOS COMMUNITY HOSPITAL                          1292            0.219
##  3 IL    ADVOCATE CHRIST HOSPITAL &amp; MEDICAL CENTER         1225            0.221
##  4 IL    NORTHWESTERN MEMORIAL HOSPITAL                    1211            0.212
##  5 IL    NORTHWESTERN MEDICINE MCHENRY                     1046            0.189
##  6 MI    BEAUMONT HOSPITAL ROYAL OAK                       1736            0.216
##  7 MI    BEAUMONT HOSPITAL, TROY                           1580            0.213
##  8 MI    ASCENSION PROVIDENCE HOSPITAL, SOUTHFIELD AND N…  1249            0.221
##  9 MI    ST JOSEPH MERCY HOSPITAL                          1095            0.18 
## 10 MI    SPECTRUM HEALTH                                   1039            0.188
## 11 MN    MAYO CLINIC HOSPITAL ROCHESTER                    1218            0.185
## 12 MN    ABBOTT NORTHWESTERN HOSPITAL                       639            0.186
## 13 MN    MINNEAPOLIS VA MEDICAL CENTER                      585            0.213
## 14 MN    MERCY HOSPITAL                                     567            0.183
## 15 MN    PARK NICOLLET METHODIST HOSPITAL                   554            0.219
## 16 WI    AURORA ST LUKES MEDICAL CENTER                    1236            0.203
## 17 WI    UNIVERSITY OF WI  HOSPITALS &amp; CLINICS AUTHORITY    597            0.231
## 18 WI    FROEDTERT MEMORIAL LUTHERAN HOSPITAL               592            0.216
## 19 WI    MERITER HOSPITAL                                   559            0.213
## 20 WI    MILWAUKEE VA MEDICAL CENTER                        544            0.244</code></pre>
</div>
<div id="defaulttable" class="section level2">
<h2>The default table</h2>
<p>As a starting point, let’s see what we get when we call the <code>reactable</code> function without any additional arguments.</p>
<pre class="r"><code>readmission_rates %&gt;% reactable()</code></pre>
<div id="htmlwidget-1" class="reactable html-widget" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"State":["IL","IL","IL","IL","IL","MI","MI","MI","MI","MI","MN","MN","MN","MN","MN","WI","WI","WI","WI","WI"],"Hospital":["NORTHSHORE UNIVERSITY HEALTHSYSTEM - EVANSTON HOSPITAL","PALOS COMMUNITY HOSPITAL","ADVOCATE CHRIST HOSPITAL & MEDICAL CENTER","NORTHWESTERN MEMORIAL HOSPITAL","NORTHWESTERN MEDICINE MCHENRY","BEAUMONT HOSPITAL ROYAL OAK","BEAUMONT HOSPITAL, TROY","ASCENSION PROVIDENCE HOSPITAL, SOUTHFIELD AND NOVI","ST JOSEPH MERCY HOSPITAL","SPECTRUM HEALTH","MAYO CLINIC HOSPITAL ROCHESTER","ABBOTT NORTHWESTERN HOSPITAL","MINNEAPOLIS VA MEDICAL CENTER","MERCY HOSPITAL","PARK NICOLLET METHODIST HOSPITAL","AURORA ST LUKES MEDICAL CENTER","UNIVERSITY OF WI  HOSPITALS & CLINICS AUTHORITY","FROEDTERT MEMORIAL LUTHERAN HOSPITAL","MERITER HOSPITAL","MILWAUKEE VA MEDICAL CENTER"],"Cases":[2205,1292,1225,1211,1046,1736,1580,1249,1095,1039,1218,639,585,567,554,1236,597,592,559,544],"30-Day Readmission Rate":[0.212,0.219,0.221,0.212,0.189,0.216,0.213,0.221,0.18,0.188,0.185,0.186,0.213,0.183,0.219,0.203,0.231,0.216,0.213,0.244]},"columns":[{"accessor":"State","name":"State","type":"character"},{"accessor":"Hospital","name":"Hospital","type":"character"},{"accessor":"Cases","name":"Cases","type":"numeric"},{"accessor":"30-Day Readmission Rate","name":"30-Day Readmission Rate","type":"numeric"}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"dataKey":"2f550a9ae4f75138ed95661384b09599","key":"2f550a9ae4f75138ed95661384b09599"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
<p>We get about what we’d expect: a basic, paginated table where each row from our dataset is represented verbatim. There are many things we could clean up here such as rounding, number representations, formatting, and, of course, aggregating the statistics to get state-specific readmission rates.</p>
</div>
<div id="builtinaggregation" class="section level2">
<h2>Built-in aggregation</h2>
<p>There are a number of <a href="#https://glin.github.io/reactable/articles/examples.html#grouping-and-aggregation">built-in aggregation functions</a> available to us by default. We just need to specify:</p>
<ol style="list-style-type: decimal">
<li>The groups we want the aggregation applied within using the <code>groupBy</code> argument</li>
<li>The columns we want to aggregate, and how, using <code>colDef</code> within the <code>columns</code> argument</li>
</ol>
<p>Let’s add functionality to the table above to aggregate the <em>total</em> case count and the <em>average</em> 30-day readmission rate within each state.</p>
<pre class="r"><code>readmission_rates %&gt;%
  reactable(
    groupBy = &quot;State&quot;,
    columns = 
      list(
        Cases = colDef(aggregate = &quot;sum&quot;),
        `30-Day Readmission Rate` = colDef(aggregate = &quot;mean&quot;)
      )
  )</code></pre>
<div id="htmlwidget-2" class="reactable html-widget" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"State":["IL","IL","IL","IL","IL","MI","MI","MI","MI","MI","MN","MN","MN","MN","MN","WI","WI","WI","WI","WI"],"Hospital":["NORTHSHORE UNIVERSITY HEALTHSYSTEM - EVANSTON HOSPITAL","PALOS COMMUNITY HOSPITAL","ADVOCATE CHRIST HOSPITAL & MEDICAL CENTER","NORTHWESTERN MEMORIAL HOSPITAL","NORTHWESTERN MEDICINE MCHENRY","BEAUMONT HOSPITAL ROYAL OAK","BEAUMONT HOSPITAL, TROY","ASCENSION PROVIDENCE HOSPITAL, SOUTHFIELD AND NOVI","ST JOSEPH MERCY HOSPITAL","SPECTRUM HEALTH","MAYO CLINIC HOSPITAL ROCHESTER","ABBOTT NORTHWESTERN HOSPITAL","MINNEAPOLIS VA MEDICAL CENTER","MERCY HOSPITAL","PARK NICOLLET METHODIST HOSPITAL","AURORA ST LUKES MEDICAL CENTER","UNIVERSITY OF WI  HOSPITALS & CLINICS AUTHORITY","FROEDTERT MEMORIAL LUTHERAN HOSPITAL","MERITER HOSPITAL","MILWAUKEE VA MEDICAL CENTER"],"Cases":[2205,1292,1225,1211,1046,1736,1580,1249,1095,1039,1218,639,585,567,554,1236,597,592,559,544],"30-Day Readmission Rate":[0.212,0.219,0.221,0.212,0.189,0.216,0.213,0.221,0.18,0.188,0.185,0.186,0.213,0.183,0.219,0.203,0.231,0.216,0.213,0.244]},"columns":[{"accessor":"State","name":"State","type":"character"},{"accessor":"Hospital","name":"Hospital","type":"character"},{"accessor":"Cases","name":"Cases","type":"numeric","aggregate":"sum"},{"accessor":"30-Day Readmission Rate","name":"30-Day Readmission Rate","type":"numeric","aggregate":"mean"}],"pivotBy":["State"],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"dataKey":"9630209e4a0e018135df53b7de3f29e5","key":"9630209e4a0e018135df53b7de3f29e5"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
<p>The problem with this table is that the displayed state-level readmission rates represent the <em>averaged</em> rates across the individual hospitals. What we really want in the aggregation is for the hospital-specific rates to be weighted by their respective case volumes so that the state-level readmission rates are correct. This is where JavaScript comes in.</p>
</div>
</div>
<div id="jsinterface" class="section level1">
<h1>Using the JavaScript Interface</h1>
<p>During the call to <code>reactable</code>, our table is accessible through a JavaScript interface which makes it easy for us to customize the aggregation and formatting behavior when the default options won’t suffice. We can use the <code>JS</code> function from the <a href="https://www.htmlwidgets.org/"><code>htmlwidgets</code></a> package to:</p>
<ol style="list-style-type: decimal">
<li>Define a JavaScript function as a text string</li>
<li>Supply that function as an argument in the <code>colDef</code> applicable to the function’s context</li>
</ol>
<div id="function1" class="section level2">
<h2>Function 1: Weighted mean</h2>
<p>Referring back to our <a href="#builtinaggregation">example</a>, we want to average the 30-day readmission rates over the hospitals within each state, but we need to weight them by their respective case volume. To do this, we can supply a custom JavaScript function to the <code>aggregate</code> argument. This function takes the entire vector of values within the group as its argument, as well as the group’s rows, and returns a scalar value. We can specify the column containing the case weights directly by name within the row.</p>
<pre class="r"><code>weighted_mean &lt;-
  function(weight) {
    JS(
      paste0(
        &quot;function(values, rows) {
          var numerator = 0
          var denominator = 0
    
          rows.forEach(function(row, index) {
            numerator += row[&#39;&quot;, weight, &quot;&#39;] * values[index]
            denominator += row[&#39;&quot;, weight, &quot;&#39;]
          })
    
          return numerator / denominator
  
        }&quot;
      )
    )
  }</code></pre>
<p>In our implementation, we encoded the <code>JS</code> function into an <code>R</code> function that calls for the weight column name, which generalizes its usage to any <code>reactable</code> in which we want this functionality applied.</p>
<pre class="r"><code>readmission_rates %&gt;%
  reactable(
    groupBy = &quot;State&quot;,
    columns = 
      list(
        Cases = colDef(aggregate = &quot;sum&quot;),
        `30-Day Readmission Rate` = colDef(aggregate = weighted_mean(&quot;Cases&quot;))
      )
  )</code></pre>
<div id="htmlwidget-3" class="reactable html-widget" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-3">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"State":["IL","IL","IL","IL","IL","MI","MI","MI","MI","MI","MN","MN","MN","MN","MN","WI","WI","WI","WI","WI"],"Hospital":["NORTHSHORE UNIVERSITY HEALTHSYSTEM - EVANSTON HOSPITAL","PALOS COMMUNITY HOSPITAL","ADVOCATE CHRIST HOSPITAL & MEDICAL CENTER","NORTHWESTERN MEMORIAL HOSPITAL","NORTHWESTERN MEDICINE MCHENRY","BEAUMONT HOSPITAL ROYAL OAK","BEAUMONT HOSPITAL, TROY","ASCENSION PROVIDENCE HOSPITAL, SOUTHFIELD AND NOVI","ST JOSEPH MERCY HOSPITAL","SPECTRUM HEALTH","MAYO CLINIC HOSPITAL ROCHESTER","ABBOTT NORTHWESTERN HOSPITAL","MINNEAPOLIS VA MEDICAL CENTER","MERCY HOSPITAL","PARK NICOLLET METHODIST HOSPITAL","AURORA ST LUKES MEDICAL CENTER","UNIVERSITY OF WI  HOSPITALS & CLINICS AUTHORITY","FROEDTERT MEMORIAL LUTHERAN HOSPITAL","MERITER HOSPITAL","MILWAUKEE VA MEDICAL CENTER"],"Cases":[2205,1292,1225,1211,1046,1736,1580,1249,1095,1039,1218,639,585,567,554,1236,597,592,559,544],"30-Day Readmission Rate":[0.212,0.219,0.221,0.212,0.189,0.216,0.213,0.221,0.18,0.188,0.185,0.186,0.213,0.183,0.219,0.203,0.231,0.216,0.213,0.244]},"columns":[{"accessor":"State","name":"State","type":"character"},{"accessor":"Hospital","name":"Hospital","type":"character"},{"accessor":"Cases","name":"Cases","type":"numeric","aggregate":"sum"},{"accessor":"30-Day Readmission Rate","name":"30-Day Readmission Rate","type":"numeric","aggregate":"function(values, rows) {\n          var numerator = 0\n          var denominator = 0\n    \n          rows.forEach(function(row, index) {\n            numerator += row['Cases'] * values[index]\n            denominator += row['Cases']\n          })\n    \n          return numerator / denominator\n  \n        }"}],"pivotBy":["State"],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"dataKey":"7a9069fa82082c2cd20667e37e672471","key":"7a9069fa82082c2cd20667e37e672471"},"children":[]},"class":"reactR_markup"},"evals":["tag.attribs.columns.3.aggregate"],"jsHooks":[]}</script>
</div>
</div>
