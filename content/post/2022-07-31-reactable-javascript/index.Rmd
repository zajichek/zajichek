---
title: A few useful JavaScript aggregation functions for {reactable}
subtitle: Series on runtime-free content delivery
author: R package build
date: '2022-07-31'
slug: reactable-javascript
categories: []
tags: ['rstats', 'javascript']
summary: ''
authors: []
lastmod: '2022-07-31T09:20:22-05:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---

**__In Progress__**

In my [last post](https://www.zajichekstats.com/post/filterable-maps/) we demonstrated how to build a filterable map widget that was free of `R` runtime dependency. In continuation of the latter theme, this article focuses on the [`reactable`](https://glin.github.io/reactable/) package, which enables you to embed interactive data tables into your HTML document. In this article, we will focus on how we can define custom JavaScript functions to do commonly-desired aggregation. 

```{r}
require(reactable)
require(tidyverse)
```

# The Basics

## Make a summary dataset

The first step to building a summary table is to create some group-level statistics that we want to display. For this example, we'll use the [`heart_disease`](https://zajichek.github.io/cheese/reference/heart_disease.html) dataset from the [`cheese`](https://zajichek.github.io/cheese/index.html) package, which provides various clinical characteristics for a set of patients.

```{r}
heart_disease <- cheese::heart_disease
heart_disease
```

Let's look at the average age, average cholesterol level, and rate of heart disease within sex and chest pain categories.

```{r}
heart_disease_summary <-
  heart_disease %>%
  
  # For each group
  group_by(Sex, ChestPain) %>%
  
  # Compute some statistics
  summarise(
    Patients = n(),
    Age = mean(Age),
    Cholesterol = mean(Cholesterol),
    HeartDisease = mean(HeartDisease == "Yes"),
    .groups = "drop"
  ) %>%
  
  # Rename columns
  rename(
    `Chest Pain` = ChestPain,
    `Heart Disease` = HeartDisease
  )
heart_disease_summary
```

## The default table

If we call the `reactable` function without any additional arguments to our data frame, we'll get a basic table.

```{r}
heart_disease_summary %>% reactable()
```

There are a number of things to clean up here such as rounding, number representations, and, of course, aggregating the statistics to get "rolled-up" summaries.

## Built in aggregation

There are a number of [built-in aggregation functions](#https://glin.github.io/reactable/articles/examples.html#grouping-and-aggregation) in the package. We just need to specify:

1. The groups we want with the `groupBy` argument
2. The columns to aggregate by specifying column definitions using `colDef` within the `columns` argument

Let's add functionality to the table above to aggregate the _total_ patient count and the _average_ of the remaining variables over the chest pain categories within each sex group:

```{r}
heart_disease_summary %>%
  reactable(
    groupBy = "Sex",
    columns = 
      list(
        Patients = colDef(aggregate = "sum"),
        Age = colDef(aggregate = "mean"),
        Cholesterol = colDef(aggregate = "mean"),
        `Heart Disease` = colDef(aggregate = "mean")
      )
  )
```

The problem with this table is that the displayed sex-specific average values for age, cholesterol, and heart disease represent the _averaged_ average value across the chest pain categories. What we really want in the aggregation is for the chest pain group average values to be weighted by the respective patient volume so that the sex-specific group averages are correct. This is where JavaScript comes in.

# Custom JavaScript Functions

Each row of our table is accessible through a JavaScript interface which makes it easy for us to customize the aggregation behavior when the default options won't suffice. We can use the `JS` function from the `htmlwidgets` package to:

1. Define a JavaScript function as a text string
2. Supply that function as the `aggregate` argument within `colDef` in our column definition list.

## Defining the function

```{r}
weighted_mean <-
  function(weight) {
    JS(
      paste0(
        "function(values, rows) {
          var numerator = 0
          var denominator = 0
    
          rows.forEach(function(row, index) {
            numerator += row['", weight, "'] * values[index]
            denominator += row['", weight, "']
          })
    
          return numerator / denominator
  
        }"
      )
    )
  }

heart_disease_summary %>%
  reactable(
    groupBy = "Sex",
    columns = 
      list(
        Patients = colDef(aggregate = "sum"),
        Age = colDef(aggregate = weighted_mean("Patients")),
        Cholesterol = colDef(aggregate = weighted_mean("Patients")),
        `Heart Disease` = colDef(aggregate = weighted_mean("Patients"))
      )
  )
```

