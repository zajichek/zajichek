---
title: Exploring COM Poisson Regression
subtitle: A method for underdispersed count data
author: Alex Zajichek
date: '2021-12-28'
slug: com-poisson-regression
categories: []
tags: []
summary: ''
authors: []
lastmod: '2021-12-28T06:53:32-06:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---

$$\Large \it \text {In Progress}$$
A few years ago I encountered an interesting count distribution at work during a modeling project. The goal was to model the number of [suture anchors](https://www.shoulderdoc.co.uk/article/538) used in rotator-cuff tendon tears, and how that was influenced by tear characteristics and surgeon preference. My instinct would typically be to fit a [Poisson](https://en.wikipedia.org/wiki/Poisson_distribution) model, but the target took on relatively small values and was also non-zero, so I had to do some digging for an alternative approach. I came across a method called Conway-Maxwell (COM) Poisson regression, which not only allowed for _overdispersion_ (i.e., the population variance is greater than its mean), but also _underdispersion_. It hit me that I had never come across methodology for the latter and it seemed to align with my problem, so I was intrigued (FD: I heard of COM-Poisson prior to that, albeit knew nothing about it, when one of my super smart graduate school buddies was doing research on it, so that's also why it stuck). 

Long story short, we didn't end up using the COM-Poisson model for the [anchor project](https://www.jshoulderelbow.org/article/S1058-2746(18)30555-X/fulltext) `r emo::ji("grin")`, and instead went in favor of [Zero-Truncated Poisson regression](https://stats.oarc.ucla.edu/r/dae/zero-truncated-poisson/). Nevertheless I thought it was an awesome method that warranted further exploration and later did a [talk](NonTraditionalCountRegression.pdf) on it. That was a few years ago--so this article is intended to be a reworking of that talk to relearn it for myself, but also to get the word out about this awesome method!

# A review of Poisson regression

I really like making up examples, so lets start with that:

Suppose hospital administrators are interested in emergency department (ED) utilization and have asked two specific questions:

1. How many patients can we expect to see in a single day?
2. What is the likelihood that we see more than 40 patients in a single day?

To expedite the process, we're given a pre-built dataset called `ed_volumes` containing the number of patients entering the ED each day over the past year.

```{r, echo = FALSE, message = FALSE}

# Load packages
require(tidyverse)

# Set a seed
set.seed(123)

### 1. Create simulated dataset

# Generating a random Poisson parameter
ed_true_mean <-
  runif(
    n = 1,
    min = 25,
    max = 50
  )

# Build the dataset
ed_volumes <-
  tibble(
    Date = Sys.Date() - seq(1, 365, 1),
    Volume = 
      rpois(
        n = length(Date), 
        lambda = ifelse(weekdays(Date) %in% c("Saturday", "Sunday"), ed_true_mean - 10, ed_true_mean)
      )
  )

```

```{r}
# Load some packages
require(tidyverse)

# Check the dataset
print(ed_volumes, n = 5)

```

First, let's take a look at the distribution of patient volume over the time period:

```{r}
ed_volumes %>%
  
  # Make a plot
  ggplot() +
  geom_histogram(
    aes(
      x = Volume
    ),
    fill = "gray",
    color = "black",
    bins = 30
  ) +
  geom_vline(
    aes(
      xintercept = mean(Volume)
    ),
    color = "#b84f48"
  ) +
  geom_text(
    aes(
      x = mean(Volume) + 1,
      y = 41,
      label = str_c("Avg: ", round(mean(Volume), 1), " patients")
    ),
    color = "#b84f48",
    hjust = -.15
  ) +
  xlab("Daily Patient Volume") +
  ylab("Frequency") +
  theme(
    legend.position = "none",
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 12),
    panel.background = element_blank(),
    panel.grid.major.y = element_line(color = "gray")
  )
```

There were `r round(mean(ed_volumes$Volume), 1)` patients per day on average, ranging from `r min(range(ed_volumes$Volume))` to `r max(range(ed_volumes$Volume))`. Knowing that this is a count distribution, we think to use a Poisson model to provide our estimates. Let's remind ourselves the specifics of a Poisson random variable:

If the probability mass function (PMF) for a non-negative, integer-valued $Y$ is:

$$P(Y = y|\lambda) = \frac{e^{-\lambda}\lambda^y}{y!}$$
then $Y$ is distributed as a Poisson random variable, and has the following property:

$$E[Y] = \lambda$$
It turns out that the maximum likelihood estimator (MLE) for $\lambda$ is the [sample average](https://www.statlect.com/fundamentals-of-statistics/Poisson-distribution-maximum-likelihood). Remembering this, _we provide the estimate for the first question to be `r round(mean(ed_volumes$Volume))` patients._

```{r}
lambda_hat <- mean(ed_volumes$Volume)
lambda_hat
```

We also know that once we have an estimate for $\lambda$ that we can compute probabilities by plugging it into the PMF:

$$P(Y>40) = 1 - P(Y\leq40) = 1 - \sum_{y=0}^{40} \frac{e^{-\lambda}\lambda^y}{y!}$$
```{r}
y <- 0:40
p <- exp(-lambda_hat) * lambda_hat^y / factorial(y)
question2 <- 1 - sum(p)
question2

# Alternative approach
1- ppois(40, lambda_hat)
```

_We estimate that there is a `r round(question2*100,1)`% chance that we will see more than 40 patients in the ED in a single day_--we're done! 

`r emo::ji("scared")`

Unfortunately, after we handed off the results, we realized that we missed a crucial assumption about the Poisson distribution that we didn't account for:

$$E[Y] = Var[Y]$$
The estimates we provided assumed that the mean and variance of our underlying distribution were equal, but we failed to check this assumption. The sample variance was `r round(var(ed_volumes$Volume), 1)` which is considerably larger than the mean of `r round(mean(ed_volumes$Volume), 1)`. Here is what an actual Poisson distribution looks like in comparison with our observed sample:

```{r}
tibble(
  Group = "Original Sample",
  Volume = ed_volumes$Volume
) %>%
  bind_rows(
    tibble(
      Group = "Actual Poisson",
      Volume = rpois(100000, mean(ed_volumes$Volume))
    ) 
  ) %>%
  ggplot() +
  geom_density(
    aes(
      x = Volume,
      fill = Group
    ),
    alpha = .5,
    color = "black"
  ) +
  geom_vline(
    aes(
      xintercept = mean(Volume)
    ),
    color = "#b84f48"
  ) +
  xlab("Daily Patient Volume") +
  ylab("Density") +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 12),
    panel.background = element_blank(),
    panel.grid.major.y = element_line(color = "gray")
  ) +
  scale_fill_manual(
    values = 
      c(
        "blue",
        "gray"
      ),
    guide = guide_legend(reverse = T)
  ) 
```


Fortunately, we remembered something the hospital administrators passively hypothesized during the consultation: they think the ED is less busy on the weekends than during the week.

Namely, the population average number of events is equal to its variance which is a crucial assumption. Here is a look at the distribution of a number of simulated Poisson random variables for increasing $\lambda$:

```{r}

# Load the tidyverse!
require(tidyverse)

# Set a seed 
set.seed(123)

# Number of samples
n <- 10000

# Grid of lambdas
lambda_grid <- c(0.5, 1, 2, 4, 8, 15, 25, 50, 100)

lambda_grid %>%
  
  # For each lambda
  map_df(
    ~
      tibble(
        lambda = .x,
        y = rpois(n = n, lambda = .x)
      )
  ) %>%
  
  # Make facet labels; maintain ordering
  mutate(
    lambda = 
      lambda %>%
      factor() %>%
      fct_relabel(
        ~paste0("lambda==", .x),
      )
  ) %>%
  
  # Make a plot
  ggplot() +
  geom_histogram(
    aes(
      x = y,
      fill = lambda
    )
  ) +
  facet_wrap(
    ~lambda,
    label = "label_parsed",
    scales = "free_x"
  ) +
  xlab("Y = y") +
  ylab("Count") +
  theme(
    legend.position = "none",
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 12),
    panel.background = element_blank(),
    panel.grid.major.y = element_line(color = "gray")
  )

```

For small $\lambda$, __Y__ takes on a relatively small number of (small) values and appears right-skewed. As $\lambda$ increases, the distribution becomes much more symmetric and "organized", partially because the standard deviation is decreasing relative to the mean.

## How does the regression model work?

Just like other [generalized linear models](https://en.wikipedia.org/wiki/Generalized_linear_model) (GLM), in a Poisson regression model, we want to estimate the population average (the same average as described above), but conditioned on a given set of covariates. 

Suppose we have a collection of covariates $x_1, x_2, .., x_p$, then we can assume the following functional form:

$$log(\lambda_i) = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2}+...+\beta_px_{ip}$$
This _log-linear_ model then allows us to estimate the average number of events (i.e., the Poisson parameter) for a given arrangement of covariate values. We also get informative interpretation of the individual effects of each covariate. For example, if we look at the resulting $\lambda$ estimation for increasing $x_1$ by 1 unit, assuming all other covariates are the same, we get:

$$$$

$$$$

To estimate the parameters, we can plug this equation into the Poisson PMF:

$$P(Y_i = y_i|\lambda_) $$


If $\lambda$ is large, it can be reasonable to get away with a ordinary least-squares model.




* COM Poisson distribution, generalizes Poisson
* Modeling different dispersions by groups
* Zero inflated COM Poisson
* Number of re-admissions in 30 day period

```{r}
# Load required packages
require(COMPoissonReg)
```

# Code Appendix
```{r, eval = FALSE}

# Load packages
require(tidyverse)

# Set a seed
set.seed(123)

### 1. Create simulated dataset

# Generating a random Poisson parameter
ed_true_mean <-
  runif(
    n = 1,
    min = 25,
    max = 50
  )

# Build the dataset
ed_volumes <-
  tibble(
    Date = Sys.Date() - seq(1, 365, 1),
    Volume = 
      rpois(
        n = length(Date), 
        lambda = ifelse(weekdays(Date) %in% c("Saturday", "Sunday"), ed_true_mean - 10, ed_true_mean)
      )
  )

```


