---
title: Exploring COM Poisson Regression
subtitle: A method for underdispersed count data
author: Alex Zajichek
date: '2021-12-28'
slug: com-poisson-regression
categories: []
tags: []
summary: ''
authors: []
lastmod: '2021-12-28T06:53:32-06:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<p><span class="math display">\[\Large \it \text {In Progress}\]</span>
A few years ago I encountered an interesting count distribution at work during a modeling project. The goal was to model the number of <a href="https://www.shoulderdoc.co.uk/article/538">suture anchors</a> used in rotator-cuff tendon tears, and how that was influenced by tear characteristics and surgeon preference. My instinct would typically be to fit a <a href="https://en.wikipedia.org/wiki/Poisson_distribution">Poisson</a> model, but the target took on relatively small values and was also non-zero, so I had to do some digging for an alternative approach. I came across a method called Conway-Maxwell (COM) Poisson regression, which not only allowed for <em>overdispersion</em> (i.e., the population variance is greater than its mean), but also <em>underdispersion</em>. It hit me that I had never come across methodology for the latter and it seemed to align with my problem, so I was intrigued (FD: I heard of COM-Poisson prior to that, albeit knew nothing about it, when one of my super smart graduate school buddies was doing research on it, so that‚Äôs also why it stuck).</p>
<p>Long story short, we didn‚Äôt end up using the COM-Poisson model for the <a href="https://www.jshoulderelbow.org/article/S1058-2746(18)30555-X/fulltext">anchor project</a> üòÅ, and instead went in favor of <a href="https://stats.oarc.ucla.edu/r/dae/zero-truncated-poisson/">Zero-Truncated Poisson regression</a>. Nevertheless I thought it was an awesome method that warranted further exploration and later did a <a href="NonTraditionalCountRegression.pdf">talk</a> on it. That was a few years ago‚Äìso this article is intended to be a reworking of that talk to relearn it for myself, but also to get the word out about this awesome method!</p>
<div id="a-review-of-poisson-regression" class="section level1">
<h1>A review of Poisson regression</h1>
<p>I really like making up examples, so lets start with that:</p>
<p>Suppose hospital administrators are interested in emergency department (ED) utilization and have asked a few questions:</p>
<ol style="list-style-type: decimal">
<li>How many patients can we expect to see in a given day?</li>
<li>What is the likelihood that we see more than 40 patients in a single day?</li>
<li>Do we see more variation during the week versus weekend, or in the AM versus PM hours?</li>
</ol>
<p>To expedite the process, we‚Äôre given a pre-built dataset called <code>ed_volumes</code> containing the number of patients entering the ED each day over the past year.</p>
<pre class="r"><code># Load some packages
require(tidyverse)

# Check the dataset
print(ed_volumes, n = 5)</code></pre>
<pre><code>## # A tibble: 730 x 3
##   Date       TimeOfDay Volume
##   &lt;date&gt;     &lt;chr&gt;      &lt;int&gt;
## 1 2022-01-18 AM            19
## 2 2022-01-18 PM            12
## 3 2022-01-17 AM            20
## 4 2022-01-17 PM            16
## 5 2022-01-16 AM             5
## # ‚Ä¶ with 725 more rows</code></pre>
<p>First, let‚Äôs take a look at the distribution of total daily patient volume over the time period:</p>
<pre class="r"><code>ed_volumes %&gt;%
  
  # For each date
  group_by(Date) %&gt;%
  
  # Compute the total 
  summarise(
    Volume = sum(Volume),
    .groups = &quot;drop&quot;
  ) %&gt;%
  
  # Make a plot
  ggplot() +
  geom_histogram(
    aes(
      x = Volume
    ),
    fill = &quot;gray&quot;,
    color = &quot;black&quot;,
    bins = 30
  ) +
  geom_vline(
    aes(
      xintercept = mean(Volume)
    ),
    color = &quot;#b84f48&quot;
  ) +
  geom_text(
    aes(
      x = mean(Volume) + 1,
      y = 41,
      label = str_c(&quot;Avg: &quot;, round(mean(Volume), 1), &quot; patients&quot;)
    ),
    color = &quot;#b84f48&quot;,
    hjust = -.15
  ) +
  xlab(&quot;Daily Patient Volume&quot;) +
  ylab(&quot;Frequency&quot;) +
  theme(
    legend.position = &quot;none&quot;,
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 12),
    panel.background = element_blank(),
    panel.grid.major.y = element_line(color = &quot;gray&quot;)
  )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>There were 29.4 patients per day on average, ranging from 11 to 50. Knowing that this is a count distribution, we think to use a Poisson model to provide our estimates for the first two questions. Let‚Äôs remind ourselves the specifics of a Poisson random variable:</p>
<p>If the probability mass function (PMF) for a non-negative, integer-valued <span class="math inline">\(Y\)</span> is:</p>
<p><span class="math display">\[P(Y = y|\lambda) = \frac{e^{-\lambda}\lambda^y}{y!}\]</span>
then <span class="math inline">\(Y\)</span> is distributed as a Poisson random variable, and has the following property:</p>
<p><span class="math display">\[E[Y] = \lambda\]</span>
It turns out that the maximum likelihood estimator (MLE) for <span class="math inline">\(\lambda\)</span> is the <a href="https://www.statlect.com/fundamentals-of-statistics/Poisson-distribution-maximum-likelihood">sample average</a>. Remembering this, <em>we provide the estimate for the first question to be 30 patients. (rounding up)</em></p>
<pre class="r"><code>lambda_hat &lt;- mean(with(ed_volumes, tapply(Volume, Date, sum)))
lambda_hat</code></pre>
<pre><code>## [1] 29.44932</code></pre>
<p>We also know that once we have an estimate for <span class="math inline">\(\lambda\)</span> that we can compute probabilities by plugging it into the PMF:</p>
<p><span class="math display">\[P(Y&gt;40) = 1 - P(Y\leq40) = 1 - \sum_{y=0}^{40} \frac{e^{-\lambda}\lambda^y}{y!}\]</span></p>
<pre class="r"><code>y &lt;- 0:40
p &lt;- exp(-lambda_hat) * lambda_hat^y / factorial(y)
question2 &lt;- 1 - sum(p)
question2</code></pre>
<pre><code>## [1] 0.02530979</code></pre>
<pre class="r"><code># Alternative approach
1- ppois(40, lambda_hat)</code></pre>
<pre><code>## [1] 0.02530979</code></pre>
<p><em>We estimate that there is a 2.5% chance that we will see more than 40 patients in the ED in a single day</em>‚Äìdone with the first two questions!</p>
<p>üò±</p>
<p>Unfortunately, we missed a crucial assumption about the Poisson distribution that we didn‚Äôt account for:</p>
<p><span class="math display">\[E[Y] = Var[Y]\]</span>
The estimates we provided assumed that the mean and variance of our underlying distribution were equal. The sample variance was 54.2 which is considerably larger than the mean of 29.4. Here is what an actual Poisson distribution looks like (blue curve) with <span class="math inline">\(\lambda\)</span> = 29.4 (our sample average) in comparison with the observed data (bars):</p>
<pre class="r"><code>ed_volumes %&gt;%
  
  # Compute the total for each date
  group_by(Date) %&gt;%
  summarise(
    Volume = sum(Volume),
    .groups = &quot;drop&quot;
  ) %&gt;%
  
  # Count the occurrences of each daily volume
  group_by(Volume) %&gt;%
  summarise(
    N = n(),
    .groups = &quot;drop&quot;
  ) %&gt;%
  
  # Compute the observed and theoretical relative frequencies
  mutate(
    Observed = N / sum(N),
    Theoretical = dpois(Volume, lambda = lambda_hat)
  ) %&gt;%
  
  # Remove raw count
  select(-N) %&gt;% 
  
  # Make a plot
  ggplot(
    aes(
      x = Volume
    )
  ) +
  geom_col(
    aes(
      y = Observed
    ),
    fill = &quot;gray&quot;,
    color = &quot;black&quot;
  ) +
  geom_area(
    aes(
      y = Theoretical
    ),
    alpha = .25,
    color = &quot;black&quot;,
    fill = &quot;blue&quot;
  ) +
  geom_vline(
    aes(
      xintercept = lambda_hat
    ),
    color = &quot;#b84f48&quot;
  ) +
  xlab(&quot;Daily Patient Volume&quot;) +
  ylab(&quot;Relative Frequency (%)&quot;) +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 12),
    panel.background = element_blank(),
    panel.grid.major.y = element_line(color = &quot;gray&quot;)
  ) +
  scale_y_continuous(labels = scales::percent)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>The tails of the observed sample are heavier than a Poisson would be with the same mean. Therefore, the estimates we provided for questions one and two are probably not very accurate. Let‚Äôs take a different approach: <em>answer question three first, and then work our way back to the other two.</em></p>
<p>As a reminder, we want to assess whether there is more variation in patient volume during the week versus weekend, or in the AM versus PM hours. To get this comparison, we need a way to simultaneously estimate the effect of each of these factors on the patient volume: enter Poisson regression.</p>
<div id="model-formulation" class="section level2">
<h2>Model formulation</h2>
<p>Just like other <a href="https://en.wikipedia.org/wiki/Generalized_linear_model">generalized linear models</a> (GLM), a Poisson regression model estimates the population average (the same average as described above!), <em>but conditioned on a set of covariates</em>.</p>
<p>More formally, for a given set of covariates <span class="math inline">\(x_1, x_2, .., x_p\)</span>, we assume the following functional form:</p>
<p><span class="math display">\[log(\lambda_i) = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2}+...+\beta_px_{ip} = X_i\beta\]</span>
This <em>log-linear</em> model then allows us to estimate the average number of events (i.e., the Poisson parameter <span class="math inline">\(\lambda\)</span>) for a given arrangement of covariate values. We also get informative interpretation of the individual effects of each covariate. For our example, the model looks like this:</p>
<p><span class="math display">\[log(\lambda_i) = \beta_0 + \beta_{weekend}x_{i_{weekend}} + \beta_{PM}x_{i_{PM}}\]</span>
where <span class="math inline">\(\lambda_i\)</span> is the expected patient volume, <span class="math inline">\(x_{i_{weekend}} = 1\)</span> if it is Saturday or Sunday, and <span class="math inline">\(x_{i_{PM}} = 1\)</span> if it is PM hours (and they are 0 otherwise). We can take the following steps to estimate the parameters:</p>
<ol style="list-style-type: decimal">
<li>Plug the regression formula into the Poisson PMF</li>
</ol>
<p><span class="math display">\[
\begin{equation} 
\begin{split}
P(Y_i = y_i|\lambda_i) &amp; = \frac{e^{-\lambda_i}\lambda_i^{y_i}}{y_i!} \\
&amp; = \frac{e^{-e^{X_i\beta}}{(e^{X_i\beta})}^{y_i}}{y_i!} \\
\end{split}
\end{equation}
\]</span>
where <span class="math inline">\(Y_i\)</span> is the patient volume.</p>
<ol start="2" style="list-style-type: decimal">
<li>Compute the likelihood function</li>
</ol>
<p><span class="math display">\[L(\lambda_i) = \prod_{i=1}^N \frac{e^{-e^{X_i\beta}}{(e^{X_i\beta})}^{y_i}}{y_i!} \\\]</span>
where <span class="math inline">\(N\)</span> is the total sample size.</p>
<ol start="3" style="list-style-type: decimal">
<li>Derive the MLE‚Äôs</li>
</ol>
<p><span class="math display">\[\hat{\beta} = max_{\beta} L(\lambda_i)\\\]</span>
where <span class="math inline">\(\hat{\beta}\)</span> is the set of estimated parameters computed from maximizing the likelihood function. Once we have these, we can plug them into the regression formula, and away we go! Luckily, our software will compute these for us‚Äìall we need to do is supply the data.</p>
<pre class="r"><code># Fit a generalized linear model
model &lt;-
  glm(
    formula = Volume ~ Weekend + PM, # Specify the model form
    data = # Supply the data
      ed_volumes %&gt;% 
      mutate(
        Weekend = weekdays(Date) %in% c(&quot;Saturday&quot;, &quot;Sunday&quot;),
        PM = TimeOfDay == &quot;PM&quot;
      ),
    family = &quot;poisson&quot; # Indicate the likelihood
  )

# Show the model summary
summary(model)</code></pre>
<pre><code>## 
## Call:
## glm(formula = Volume ~ Weekend + PM, family = &quot;poisson&quot;, data = ed_volumes %&gt;% 
##     mutate(Weekend = weekdays(Date) %in% c(&quot;Saturday&quot;, &quot;Sunday&quot;), 
##         PM = TimeOfDay == &quot;PM&quot;))
## 
## Deviance Residuals: 
##      Min        1Q    Median        3Q       Max  
## -2.88945  -0.61987  -0.02368   0.61366   2.88787  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)  2.77850    0.01459 190.465   &lt;2e-16 ***
## WeekendTRUE -0.40608    0.02369 -17.142   &lt;2e-16 ***
## PMTRUE       0.02177    0.01929   1.128    0.259    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 1039.96  on 729  degrees of freedom
## Residual deviance:  721.94  on 727  degrees of freedom
## AIC: 4004.3
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<ul>
<li>COM Poisson distribution, generalizes Poisson</li>
<li>Modeling different dispersions by groups</li>
<li>Zero inflated COM Poisson</li>
<li>Number of re-admissions in 30 day period</li>
</ul>
<pre class="r"><code># Load required packages
require(COMPoissonReg)</code></pre>
<pre><code>## Loading required package: COMPoissonReg</code></pre>
<pre><code>## Loading required package: Rcpp</code></pre>
</div>
</div>
<div id="code-appendix" class="section level1">
<h1>Code Appendix</h1>
<pre class="r"><code># Load packages
require(tidyverse)

# Set a seed
set.seed(123)

### 1. Create simulated dataset

# Generating a random Poisson parameter
ed_true_mean &lt;-
  runif(
    n = 1,
    min = 12.5,
    max = 25
  )

# Build the dataset
ed_volumes &lt;-
  tibble(
    Date = rep(Sys.Date() - seq(1, 365, 1), 2),
    TimeOfDay = c(rep(&quot;AM&quot;, length(Date) / 2), rep(&quot;PM&quot;, length(Date) / 2)),
    Volume = 
      rpois(
        n = length(Date), 
        lambda = ifelse(weekdays(Date) %in% c(&quot;Saturday&quot;, &quot;Sunday&quot;), ed_true_mean - 5, ed_true_mean)
      )
  ) %&gt;%
  arrange(
    desc(Date),
    TimeOfDay
  )</code></pre>
</div>
