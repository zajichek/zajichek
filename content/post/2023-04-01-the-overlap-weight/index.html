---
title: The overlap weight
author: Alex Zajichek
date: '2023-04-01'
slug: the-overlap-weight
categories: []
tags: ['statistics', 'datascience', 'causation', 'rstats']
subtitle: 'A smoother, more inclusive approach to balancing'
summary: "It starts the same as propsensity score matching. It's what is done with the scores that differentiate the methods."
authors: []
lastmod: '2023-04-01T11:39:12-05:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---

<script src="{{< blogdown/postref >}}index_files/htmlwidgets/htmlwidgets.js"></script>
<script src="{{< blogdown/postref >}}index_files/plotly-binding/plotly.js"></script>
<script src="{{< blogdown/postref >}}index_files/typedarray/typedarray.min.js"></script>
<script src="{{< blogdown/postref >}}index_files/jquery/jquery.min.js"></script>
<link href="{{< blogdown/postref >}}index_files/crosstalk/css/crosstalk.min.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/crosstalk/js/crosstalk.min.js"></script>
<link href="{{< blogdown/postref >}}index_files/plotly-htmlwidgets-css/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/plotly-main/plotly-latest.min.js"></script>


<p><strong><em>In progress</em></strong></p>
<p>I was recently introduced to a method called <a href="https://jamanetwork.com/journals/jama/article-abstract/2765748"><em>overlap weighting</em></a> for balancing covariates when estimating treatment effects in observational data. Although I’ve just started getting into the details, I find it superior to the often-used <a href="https://en.wikipedia.org/wiki/Propensity_score_matching">propensity score (PS) matching</a> for many reasons:</p>
<ol style="list-style-type: decimal">
<li>All observations are used instead of arbitrary cutoffs (e.g., 1:5 matching)</li>
<li>It proportionately down-weights the impacts of observations most likely belonging to a certain treatment group</li>
<li>Achieves perfect balance in covariates across treatment groups instead of being arbitrarily close</li>
<li>Treatment groups equally contribute to the (weighted) estimation in the outcome model</li>
<li>The weights themselves can be used to gain insight about the imbalance in the sample and intuition about their impacts on the estimation</li>
<li>Avoids extreme case weights by being bounded between 0 and 1</li>
<li>It has even <a href="https://academic.oup.com/aje/article/188/1/250/5090958">been shown</a> to produce more unbiased and efficient estimates than other inclusive weighting approaches like <a href="https://en.wikipedia.org/wiki/Inverse_probability_weighting">inverse probability weighting (IPW)</a></li>
</ol>
<p>It actually starts the same as the matching approach by deriving a propensity score. It’s what is done with the scores that differentiate the methods.</p>
<div id="table-of-contents" class="section level1">
<h1>Table of Contents</h1>
<ul>
<li><a href="#definition">Defining the overlap weight</a></li>
<li><a href="#usage">Using the overlap weight</a></li>
<li><a href="#example">Heart disease example</a>
<ul>
<li><a href="#artificial">Making an artificial treatment</a></li>
<li><a href="#modelfit">Fitting the propensity score model</a></li>
</ul></li>
<li><a href="#resources">Resources</a></li>
</ul>
</div>
<div id="definition" class="section level1">
<h1>How is it defined?</h1>
<p>It’s actually quite simple. Suppose you have treatments <em>A</em> &amp; <em>B</em>. Then,</p>
<p><span class="math display">\[P(T_i = A|X_i) = p_i\]</span>
is the <em>true</em> propensity score of treatment <em>A</em> for observation <em>i</em> given the set of covariates, <span class="math inline">\(X_i\)</span>, that contribute to the treatment imbalance.</p>
<p>So you build a model to estimate <span class="math inline">\(p_i\)</span> using the set of treatments that were actually observed. If you use <a href="https://en.wikipedia.org/wiki/Logistic_regression">logistic regression</a>, which is the common approach, then the estimated propensity score <span class="math inline">\(\hat{p_i}\)</span> is</p>
<p><span class="math display">\[p_i \approx \hat{p_i} = \frac{1}{1 + e^{-X_i\hat{\beta}}}\]</span>
where <span class="math inline">\(\hat{\beta}\)</span> are the estimated regression coefficients. Then the overlap weight, <span class="math inline">\(OW_i\)</span>, is calculated by:</p>
<p><span class="math display">\[
\begin{equation}
OW_i=
    \begin{cases}
        1-\hat{p_i} &amp; \text{if } T_i = A\\
        \hat{p_i} &amp; \text{if } T_i = B\\
    \end{cases}
\end{equation}
\]</span>
That’s it.</p>
<p>Now we do end up normalizing these weights so that they sum to one (1) within each treatment group. But the intuition about what is happening is that it shifts the focus of the downstream estimation to observations that are most likely in <em>either</em> treatment group (i.e., <span class="math inline">\(p_i\)</span> near 0.5).</p>
<p>I think this makes a lot of sense. When we’re trying to evaluate the effectiveness of a treatment, we want to focus most heavily on those who could be candidates for either one, and less so on those who were bound for one of the treatment options. The beautiful thing here is that we do this without throwing away any information; smoothly and proportionately weighting each observation just the amount that we should.</p>
</div>
<div id="usage" class="section level1">
<h1>How do I use it?</h1>
<p>In it’s most basic usage (and possibly an oversimplification), you just compute the difference in mean values across treatment groups after weighting them by the overlap weights, and this provides an estimate of the <em>average treatment effect in the overlap population</em> (ATO).</p>
</div>
<div id="example" class="section level1">
<h1>Example</h1>
<p>Sure. Let’s first load some packages to get started.</p>
<pre class="r"><code>library(tidyverse)
library(plotly)</code></pre>
<p>We’re going to be creating an artificial example using the <code>cheese::heart_disease</code> data set to estimate the effect of some treatment on the likelihood of heart disease.</p>
<pre class="r"><code>dat &lt;- cheese::heart_disease
print(dat, n = 5)</code></pre>
<pre><code>## # A tibble: 303 × 9
##     Age Sex    ChestPain           BP Choleste…¹ Blood…² Maxim…³ Exerc…⁴ Heart…⁵
##   &lt;dbl&gt; &lt;fct&gt;  &lt;fct&gt;            &lt;dbl&gt;      &lt;dbl&gt; &lt;lgl&gt;     &lt;dbl&gt; &lt;fct&gt;   &lt;fct&gt;  
## 1    63 Male   Typical angina     145        233 TRUE        150 No      No     
## 2    67 Male   Asymptomatic       160        286 FALSE       108 Yes     Yes    
## 3    67 Male   Asymptomatic       120        229 FALSE       129 Yes     Yes    
## 4    37 Male   Non-anginal pain   130        250 FALSE       187 No      No     
## 5    41 Female Atypical angina    130        204 FALSE       172 No      No     
## # … with 298 more rows, and abbreviated variable names ¹​Cholesterol,
## #   ²​BloodSugar, ³​MaximumHR, ⁴​ExerciseInducedAngina, ⁵​HeartDisease</code></pre>
<div id="artificial" class="section level2">
<h2>Making an artificial treatment</h2>
<p>There is not actually a treatment column in this data set, so we’ll make one. Let’s assume the following:</p>
<p><span class="math display">\[logit(P(T_i|X_i)) = 0.75Age_{std} + 0.5Male\]</span>
That is, the probability of being <em>treated</em> (<span class="math inline">\(T_i\)</span>) is linearly related to the (standardized) age and sex of the patient. Further, older patients and male patients are more likely to be treated.</p>
<pre class="r"><code>dat &lt;- 
  dat %&gt;%
  
  # Add the true propensity score
  mutate(
    PS = 1 / (1 + exp(-(.75 * ((Age - mean(Age))/sd(Age)) + .5 * (Sex == &quot;Male&quot;))))
  ) </code></pre>
<p>Let’s look at the <em>true</em> propensity score distribution (note these are never known).</p>
<pre class="r"><code>dat %&gt;%
  plot_ly(
    x = ~PS,
    type = &quot;histogram&quot;
  ) %&gt;%
  layout(
    xaxis = list(title = &quot;True Propensity Score (PS)&quot;, tickformat = &quot;2%&quot;),
    yaxis = list(title = &quot;Patients&quot;)
  )</code></pre>
<div id="htmlwidget-1" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"visdat":{"447046dee7d8":["function () ","plotlyVisDat"]},"cur_data":"447046dee7d8","attrs":{"447046dee7d8":{"x":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"histogram"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"True Propensity Score (PS)","tickformat":"2%"},"yaxis":{"domain":[0,1],"automargin":true,"title":"Patients"},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[0.770364359631493,0.823795524051423,0.823795524051423,0.279482678662,0.246917293432171,0.652383238080084,0.651898061282358,0.552928075143194,0.770364359631493,0.594018030932883,0.670955196826942,0.532337688917272,0.652383238080084,0.409461733601653,0.573861593007813,0.670955196826942,0.49142997224931,0.613862587117283,0.369518392328375,0.512170947887757,0.784713096571341,0.573338496999314,0.689007920302571,0.689007920302571,0.723409840321588,0.408944683966175,0.573338496999314,0.722981702440214,0.389558632128273,0.332233949444466,0.769985793610694,0.723409840321588,0.784713096571341,0.70650344997063,0.409461733601653,0.370016799924178,0.389558632128273,0.670955196826942,0.633335882718861,0.739701169150525,0.706059775851641,0.332233949444466,0.798055421386148,0.70650344997063,0.632839083015439,0.689007920302571,0.553456705183428,0.532870096838967,0.706059775851641,0.594018030932883,0.246917293432171,0.798399885078115,0.409461733601653,0.409461733601653,0.723409840321588,0.613862587117283,0.532870096838967,0.350891773876053,0.613862587117283,0.553456705183428,0.429141949592691,0.331759633741377,0.689007920302571,0.490895457861402,0.613862587117283,0.723409840321588,0.723409840321588,0.613862587117283,0.70650344997063,0.450107285869159,0.706059775851641,0.823795524051423,0.755357435666517,0.798399885078115,0.409461733601653,0.706059775851641,0.723409840321588,0.429141949592691,0.49142997224931,0.689007920302571,0.42966597202442,0.470185643027067,0.314088163398748,0.835518462005383,0.573861593007813,0.409461733601653,0.470718457162363,0.470185643027067,0.470185643027067,0.429141949592691,0.811425642404402,0.651898061282358,0.755357435666517,0.296047496506071,0.670482848552301,0.573861593007813,0.70650344997063,0.613355510273774,0.573861593007813,0.49142997224931,0.42966597202442,0.232194729716581,0.552928075143194,0.798055421386148,0.512170947887757,0.613862587117283,0.70650344997063,0.670955196826942,0.739701169150525,0.314088163398748,0.632839083015439,0.652383238080084,0.573861593007813,0.279052202106184,0.651898061282358,0.350891773876053,0.689007920302571,0.166174889491516,0.770364359631493,0.798399885078115,0.49142997224931,0.670482848552301,0.553456705183428,0.633335882718861,0.798399885078115,0.31362758647169,0.532337688917272,0.613862587117283,0.409461733601653,0.651898061282358,0.613862587117283,0.553456705183428,0.166471444665653,0.553456705183428,0.279052202106184,0.511636569526832,0.857075301063222,0.755357435666517,0.247315202903325,0.553456705183428,0.70650344997063,0.70650344997063,0.573861593007813,0.784713096571341,0.689007920302571,0.470718457162363,0.670955196826942,0.350891773876053,0.42966597202442,0.613355510273774,0.573861593007813,0.262668512394506,0.739289160646041,0.633335882718861,0.784713096571341,0.857075301063222,0.553456705183428,0.689007920302571,0.723409840321588,0.835518462005383,0.450107285869159,0.914670684573403,0.490895457861402,0.573338496999314,0.49142997224931,0.670955196826942,0.573861593007813,0.490895457861402,0.247315202903325,0.31362758647169,0.857075301063222,0.594018030932883,0.593502150961137,0.651898061282358,0.784713096571341,0.670955196826942,0.573861593007813,0.652383238080084,0.389558632128273,0.594018030932883,0.49142997224931,0.532337688917272,0.370016799924178,0.70650344997063,0.613355510273774,0.670482848552301,0.370016799924178,0.811425642404402,0.613862587117283,0.846606694824675,0.532870096838967,0.553456705183428,0.389558632128273,0.651898061282358,0.754961999181645,0.823795524051423,0.846606694824675,0.31362758647169,0.408944683966175,0.70650344997063,0.408944683966175,0.688549457511965,0.670955196826942,0.688549457511965,0.389558632128273,0.42966597202442,0.689007920302571,0.532870096838967,0.633335882718861,0.651898061282358,0.190459205727706,0.296493408535217,0.350891773876053,0.722981702440214,0.573861593007813,0.652383238080084,0.331759633741377,0.331759633741377,0.688549457511965,0.70650344997063,0.246917293432171,0.490895457861402,0.217367225755322,0.594018030932883,0.670482848552301,0.154993678674541,0.470718457162363,0.739289160646041,0.613862587117283,0.811425642404402,0.449577984976474,0.511636569526832,0.512170947887757,0.835224331600778,0.490895457861402,0.613862587117283,0.652383238080084,0.450107285869159,0.389050157629421,0.370016799924178,0.350891773876053,0.246917293432171,0.389050157629421,0.739701169150525,0.613355510273774,0.823795524051423,0.689007920302571,0.470718457162363,0.573861593007813,0.755357435666517,0.670955196826942,0.689007920302571,0.784713096571341,0.429141949592691,0.389558632128273,0.262668512394506,0.739289160646041,0.856813112939884,0.857075301063222,0.670955196826942,0.296047496506071,0.573338496999314,0.613355510273774,0.409461733601653,0.739701169150525,0.370016799924178,0.573861593007813,0.70650344997063,0.332233949444466,0.370016799924178,0.739701169150525,0.811425642404402,0.450107285869159,0.798055421386148,0.70650344997063,0.784713096571341,0.722981702440214,0.217367225755322,0.670955196826942,0.573338496999314,0.670955196826942,0.470718457162363,0.511636569526832,0.247315202903325,0.739701169150525,0.689007920302571,0.573338496999314,0.689007920302571,0.652383238080084,0.652383238080084,0.823795524051423,0.511636569526832,0.409461733601653,0.770364359631493,0.670482848552301,0.350891773876053,0.70650344997063,0.552928075143194,0.42966597202442,0.835518462005383,0.670955196826942,0.552928075143194,0.296493408535217],"type":"histogram","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
<p>Now, we’ll generate the treatment indicator for each patient by taking a random draw from a Bernoulli distribution:</p>
<pre class="r"><code>set.seed(123)
dat &lt;- 
  dat %&gt;%
  
  # Assign treatment
  mutate(
    Treated = rbinom(n = nrow(dat), size = 1, prob = PS)
  )</code></pre>
<p>Of the 303 patients, 175 (57.8%) were treated. Let’s look at the observed rate of treatment by age and sex.</p>
<pre class="r"><code>ggplotly(
  dat %&gt;%
    
    # Make age groups
    mutate(
      Age = Hmisc::cut2(Age, g = 5)
    ) %&gt;%
    
    # For each group
    group_by(Age, Sex) %&gt;%
    
    # Compute the rate
    summarise(
      Patients = n(),
      Treated = sum(Treated),
      .groups = &quot;drop&quot;
    ) %&gt;%
    
    # Make the proportion
    mutate(
      Rate = Treated / Patients
    ) %&gt;%
    
    # Make a plot
    ggplot(
      aes(
        x = Age,
        y = Rate,
        color = Sex,
        group = Sex,
        text = 
          paste0(
            &quot;Patients: &quot;, Patients,
            &quot;&lt;br&gt;Treated: &quot;, Treated,
            &quot;&lt;br&gt;Percent Treated: &quot;, round(Rate * 100, 1), &quot;%&quot;
          )
      )
    ) +
    geom_point() +
    geom_line() +
    scale_y_continuous(labels = scales::percent) +
    ylab(&quot;Percent Treated (%)&quot;),
  tooltip = &quot;text&quot;
)</code></pre>
<div id="htmlwidget-2" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"data":[{"x":[1,2,3,4,5],"y":[0.333333333333333,0.411764705882353,0.636363636363636,0.466666666666667,0.68],"text":["Patients: 18<br>Treated: 6<br>Percent Treated: 33.3%","Patients: 17<br>Treated: 7<br>Percent Treated: 41.2%","Patients: 22<br>Treated: 14<br>Percent Treated: 63.6%","Patients: 15<br>Treated: 7<br>Percent Treated: 46.7%","Patients: 25<br>Treated: 17<br>Percent Treated: 68%"],"type":"scatter","mode":"markers+lines","marker":{"autocolorscale":false,"color":"rgba(248,118,109,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(248,118,109,1)"}},"hoveron":"points","name":"Female","legendgroup":"Female","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","line":{"width":1.88976377952756,"color":"rgba(248,118,109,1)","dash":"solid"},"frame":null},{"x":[1,2,3,4,5],"y":[0.311111111111111,0.595744680851064,0.653061224489796,0.633333333333333,0.885714285714286],"text":["Patients: 45<br>Treated: 14<br>Percent Treated: 31.1%","Patients: 47<br>Treated: 28<br>Percent Treated: 59.6%","Patients: 49<br>Treated: 32<br>Percent Treated: 65.3%","Patients: 30<br>Treated: 19<br>Percent Treated: 63.3%","Patients: 35<br>Treated: 31<br>Percent Treated: 88.6%"],"type":"scatter","mode":"markers+lines","marker":{"autocolorscale":false,"color":"rgba(0,191,196,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(0,191,196,1)"}},"hoveron":"points","name":"Male","legendgroup":"Male","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","line":{"width":1.88976377952756,"color":"rgba(0,191,196,1)","dash":"solid"},"frame":null}],"layout":{"margin":{"t":26.2283105022831,"r":7.30593607305936,"b":40.1826484018265,"l":43.1050228310502},"plot_bgcolor":"rgba(235,235,235,1)","paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[0.4,5.6],"tickmode":"array","ticktext":["[29,46)","[46,54)","[54,59)","[59,63)","[63,77]"],"tickvals":[1,2,3,4,5],"categoryorder":"array","categoryarray":["[29,46)","[46,54)","[54,59)","[59,63)","[63,77]"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"y","title":{"text":"Age","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[0.282380952380952,0.914444444444444],"tickmode":"array","ticktext":["30%","40%","50%","60%","70%","80%","90%"],"tickvals":[0.3,0.4,0.5,0.6,0.7,0.8,0.9],"categoryorder":"array","categoryarray":["30%","40%","50%","60%","70%","80%","90%"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","title":{"text":"Percent Treated (%)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":true,"legend":{"bgcolor":"rgba(255,255,255,1)","bordercolor":"transparent","borderwidth":1.88976377952756,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.689497716895},"title":{"text":"Sex","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"44704e279f0c":{"x":{},"y":{},"colour":{},"text":{},"type":"scatter"},"4470b3af4ea":{"x":{},"y":{},"colour":{},"text":{}}},"cur_data":"44704e279f0c","visdat":{"44704e279f0c":["function (y) ","x"],"4470b3af4ea":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
<p>As expected, we see an increasing treatment rate with age, as well as for male patients (this is only expected because we defined it this way; in practice, this graph might give us the evidence to use age and sex in a propensity score model).</p>
<p><strong>Important</strong>: <em>Note that we did not relate the treatment to likelihood of heart disease (our outcome), so there is actually no effect. Any effect we do see is completely explained by confounding due to age and sex.</em></p>
</div>
<div id="modelfit" class="section level2">
<h2>Fitting the propensity score model</h2>
<p>As described <a href="#definition">above</a>, we just need to fit a logistic regression model, regressing the treatment variable on age and sex.</p>
<pre class="r"><code>ps_mod &lt;- glm(Treated ~ scale(Age) + Sex, data = dat, family = &quot;binomial&quot;)
summary(ps_mod)</code></pre>
<pre><code>## 
## Call:
## glm(formula = Treated ~ scale(Age) + Sex, family = &quot;binomial&quot;, 
##     data = dat)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.9569  -1.0562   0.6597   0.9673   1.9153  
## 
## Coefficients:
##              Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept) -0.001903   0.218624  -0.009   0.9931    
## scale(Age)   0.771038   0.135698   5.682 1.33e-08 ***
## SexMale      0.515147   0.268698   1.917   0.0552 .  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 412.73  on 302  degrees of freedom
## Residual deviance: 373.79  on 300  degrees of freedom
## AIC: 379.79
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<p>Note that we centered and scaled <code>Age</code> which resulted in basically the same model we <a href="#artificial">specified</a> (which we would hope it does).</p>
</div>
<div id="extractingweights" class="section level2">
<h2>Extracting the overlap weights</h2>
<p>To get the weights, we have to extract the fitted probabilities of treatment for each observation, and then apply the <a href="#definition">formula</a>. We’ll also take one extra step and normalize the weights within each treatment group so they sum to 1.</p>
<pre class="r"><code>dat &lt;-
  dat %&gt;%
  
  # Compute the weights
  mutate(
    p_hat = predict(ps_mod, type = &quot;response&quot;),
    OW = 
      case_when(
        Treated == 1 ~ 1 - p_hat,
        TRUE ~ p_hat
      )
  ) %&gt;%
  
  # Normalize in each group
  group_by(Treated) %&gt;%
  mutate(
    OW_norm = OW / sum(OW)
  ) %&gt;%
  ungroup()

dat %&gt;%
  plot_ly(
    x = ~OW_norm,
    y = ~factor(Treated),
    color = ~factor(Treated),
    type = &quot;box&quot;
  )</code></pre>
<pre><code>## Warning in RColorBrewer::brewer.pal(N, &quot;Set2&quot;): minimal value for n is 3, returning requested palette with 3 different levels

## Warning in RColorBrewer::brewer.pal(N, &quot;Set2&quot;): minimal value for n is 3, returning requested palette with 3 different levels</code></pre>
<div id="htmlwidget-3" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-3">{"x":{"visdat":{"44707d49277d":["function () ","plotlyVisDat"]},"cur_data":"44707d49277d","attrs":{"44707d49277d":{"x":{},"y":{},"color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"box"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"OW_norm"},"yaxis":{"domain":[0,1],"automargin":true,"title":"factor(Treated)","type":"category","categoryorder":"array","categoryarray":["0","1"]},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"fillcolor":"rgba(102,194,165,0.5)","x":[0.00854139717012359,0.0104110270424465,0.0101183569783923,0.0062725665588455,0.0104110270424465,0.00757093811406164,0.00563728654471382,0.00789972494263915,0.0121915030428131,0.00886472811864584,0.0106950838805586,0.00595784707268974,0.00505349286434982,0.0119594817159768,0.0112350163146475,0.0109699161539755,0.0062725665588455,0.00564916603859024,0.00505349286434982,0.00919628330606766,0.00371302304494393,0.0062725665588455,0.00951012829866379,0.00504221955562502,0.00755814357010722,0.00951012829866379,0.0112350163146475,0.00951012829866379,0.0109699161539755,0.00691606481110786,0.0109593982252437,0.0062725665588455,0.00757093811406164,0.00659232780277975,0.00476805540887716,0.0062725665588455,0.00657980062441351,0.0101068010278037,0.0044811924467635,0.0109699161539755,0.00348684807422069,0.0123957695031988,0.00951012829866379,0.0109699161539755,0.00476805540887716,0.0098059393650034,0.0101068010278037,0.00534743935796059,0.0062725665588455,0.0101068010278037,0.00951012829866379,0.0085540450774025,0.00247007419610218,0.0085540450774025,0.00421493662744833,0.00788693310752358,0.0117345048048341,0.0106950838805586,0.00724265576167283,0.00534743935796059,0.00659232780277975,0.00949802242790228,0.00887723687688843,0.00395877527130201,0.0085540450774025,0.00691606481110786,0.00757093811406164,0.00887723687688843,0.00755814357010722,0.0037223905477432,0.00475712663979625,0.00918395606588795,0.0101068010278037,0.00564916603859024,0.00951012829866379,0.0131471949268253,0.0117251855123495,0.00475712663979625,0.00626021608595525,0.00626021608595525,0.0106841967474842,0.00595784707268974,0.00283710527602738,0.00449175434763085,0.00534743935796059,0.0101183569783923,0.00504221955562502,0.00504221955562502,0.0106841967474842,0.0109699161539755,0.00371302304494393,0.00325352232716256,0.00919628330606766,0.00229171987438495,0.00724265576167283,0.00951012829866379,0.0126054193660335,0.00789972494263915,0.00755814357010722,0.00594571347575244,0.00534743935796059,0.00371302304494393,0.00594571347575244,0.00887723687688843,0.00657980062441351,0.00595784707268974,0.0104110270424465,0.00886472811864584,0.00949802242790228,0.00564916603859024,0.00505349286434982,0.00564916603859024,0.0114899802256138,0.00691606481110786,0.0109699161539755,0.011224885401803,0.00325352232716256,0.00886472811864584,0.0104110270424465,0.00724265576167283,0.0037223905477432,0.0101183569783923,0.0062725665588455,0.0119683839513531,0.0103997925627788,0.0109699161539755,0.00659232780277975,0.0104110270424465],"y":["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],"type":"box","orientation":"h","name":"0","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"fillcolor":"rgba(141,160,203,0.5)","x":[0.00345122333189841,0.00262322603689299,0.00262322603689299,0.0111944939044541,0.0117065842383069,0.00530125030485912,0.00531280625544769,0.00345122333189841,0.00622332397718364,0.00720452799055184,0.00654237040636284,0.00590947898458754,0.0047245234026928,0.00418459096860396,0.00915939119729579,0.00655487916460543,0.00419472188144853,0.00322810424043845,0.00946176021056128,0.00500858024080487,0.00560182027347321,0.00392962705763772,0.00446020905800773,0.00302383778005277,0.004449691129276,0.00561366791824795,0.0047245234026928,0.00686556220584874,0.00719178527110348,0.00446020905800773,0.0030157749765602,0.00914704072440555,0.00418459096860396,0.00590947898458754,0.00719178527110348,0.0100721679252904,0.00686556220584874,0.00883980665883756,0.0047245234026928,0.00418459096860396,0.00262322603689299,0.00368510247841742,0.0030157749765602,0.00446020905800773,0.00418459096860396,0.00883980665883756,0.0047245234026928,0.00818970232824815,0.0024427111765997,0.00654237040636284,0.0081769515215783,0.00818970232824815,0.00818970232824815,0.00281418791721808,0.00368510247841742,0.00501981472047264,0.00654237040636284,0.00592158485534905,0.00654237040636284,0.00784866916918952,0.00882727948047132,0.00687821011312765,0.00751988234061204,0.00500858024080487,0.00392962705763772,0.00530125030485912,0.00654237040636284,0.0112046706558025,0.0047245234026928,0.0129564127391964,0.00345122333189841,0.0030157749765602,0.00784866916918952,0.00501981472047264,0.00686556220584874,0.00560182027347321,0.0030157749765602,0.0106624806434547,0.00720452799055184,0.00590947898458754,0.00211205393379166,0.0116972167355076,0.00686556220584874,0.004449691129276,0.004449691129276,0.00654237040636284,0.00322810424043845,0.00500858024080487,0.00393935713596962,0.00560182027347321,0.00322810424043845,0.00211205393379166,0.0047245234026928,0.00418459096860396,0.0024427111765997,0.00123873647682416,0.00786146371314394,0.00655487916460543,0.00500858024080487,0.00211205393379166,0.00622332397718364,0.00322810424043845,0.00500858024080487,0.00654237040636284,0.00530125030485912,0.00946176021056128,0.00622332397718364,0.00784866916918952,0.00720452799055184,0.00977044124466075,0.004449691129276,0.00592158485534905,0.00501981472047264,0.00281418791721808,0.00719178527110348,0.00686556220584874,0.00946176021056128,0.00531280625544769,0.00262322603689299,0.0022724123564264,0.004449691129276,0.00500858024080487,0.00473541053576722,0.00882727948047132,0.0047245234026928,0.00719178527110348,0.00560182027347321,0.00531280625544769,0.00419472188144853,0.00654237040636284,0.00786146371314394,0.00501981472047264,0.00393935713596962,0.00851620372834762,0.0075326741757276,0.00244954443509495,0.00590947898458754,0.00530125030485912,0.00850354247214324,0.00977044124466075,0.00392962705763772,0.00592158485534905,0.00262322603689299,0.0047245234026928,0.0081769515215783,0.00368510247841742,0.00500858024080487,0.0047245234026928,0.00322810424043845,0.0114608320119488,0.00393935713596962,0.00211811318670278,0.00211205393379166,0.0109384148364874,0.00914704072440555,0.00392962705763772,0.00654237040636284,0.004449691129276,0.00281418791721808,0.00302383778005277,0.00322810424043845,0.00500858024080487,0.0075326741757276,0.00392962705763772,0.0047245234026928,0.00655487916460543,0.0047245234026928,0.00530125030485912,0.00262322603689299,0.0075326741757276,0.0100721679252904,0.00687821011312765,0.0024427111765997,0.00687821011312765,0.01092785293562],"y":["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"],"type":"box","orientation":"h","name":"1","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
<p>We can use the <code>PSweight</code> package to verify that we computed the weights correctly.</p>
</div>
<div id="estimate-treatment-effect" class="section level2">
<h2>Estimate treatment effect</h2>
<ul>
<li>Verify standardized differences are zero (compared to unweighted)</li>
<li>Plot the treatment effect before and after weighting.</li>
</ul>
</div>
</div>
<div id="explaining-the-weights" class="section level1">
<h1>Explaining the weights</h1>
<p>The <a href="#example">example</a> above just gave the steps to run the procedure and get an estimated treatment effect. However, in practice, it is much more complex than this (mostly because we already knew the answer!). There are many ways we can think to summarize the weights as an exploratory step to better understand the impact of the weighting procedure.</p>
<ul>
<li>Intuition about who it focuses on, proportional down weights</li>
<li>Show differences in outcome weighted and unweighted</li>
<li>Show standarized differences of covariates (some not included in PS model as well) (use plotly)</li>
<li>Show ways to assess cumulative contribution of cases and impact on other covariates</li>
<li>Assess redundancy</li>
</ul>
</div>
<div id="resources" class="section level1">
<h1>Resources</h1>
<p>The overlap weight is part of a general class of causal methodology/theory for balancing covariates to estimate treatment effects using propensity scores. More broadly, these fall into the <a href="https://en.wikipedia.org/wiki/Rubin_causal_model"><em>potential outcomes</em></a> framework of causal inference, which I happened to be introduced to by accident while learning about overlap weighting from these resources:</p>
<ul>
<li>Original paper for overlap weighting (<a href="https://pubmed.ncbi.nlm.nih.gov/30189042/">link</a>)</li>
<li>Paper extending overlap weighting to survival analysis (<a href="https://arxiv.org/abs/2108.04394">link</a>)</li>
<li>Example simulation of overlap weighting in the survival setting in SAS (<a href="http://www2.stat.duke.edu/~fl35/OW/OW_survival_Demo.sas">link</a>)</li>
<li>R package for implementing overlap weight methods (<a href="https://github.com/thuizhou/PSweight">link</a>)</li>
<li>R functions for overlap weighting in the survival setting (<a href="https://github.com/chaochengstat/OW_Survival">link</a>)</li>
<li>Author’s web page dedicated to overlap weighting (<a href="https://www2.stat.duke.edu/~fl35/OW.html">link</a>)</li>
</ul>
<p>All of these were super helpful. Understanding the idea of potential outcomes made the math and methodological concepts a lot easier to grasp conceptually and gain intuition. The way I like to think about it is (roughly) in the following order:</p>
<ol style="list-style-type: decimal">
<li>Each observation has a <em>true</em> propensity score (probability of treatment). The treatment we observe is just a realization of a random draw from that <a href="https://en.wikipedia.org/wiki/Bernoulli_distribution">Bernoulli</a> distribution (or <a href="https://en.wikipedia.org/wiki/Multinomial_distribution">Multinomial</a> distribution if there are more treatments). We must estimate this from the treatment we observe.</li>
<li>Since there is a true propensity score, there is also a <em>true</em> overlap weight (for each treatment option) that balances the observations back with the population. We must also estimate this from the data.</li>
<li>The outcome we observe is conditional on the observed treatment. So there exists some true function (e.g., linear predictor) relating the observation to the outcome under the treatment we observed.</li>
<li>However, this also all exists for the treatment(s) we did <em>NOT</em> observe. So there are analogous functions relating the observation to the outcome under the alternate treatment scenarios.</li>
<li>If we could observe the outcome for all treatments, we could just compute the mean differences in the outcome across the treatment groups and that would be the causal treatment effect. I imagine a stacked data set where there is a row for each observation under each treatment, it’s just that the the outcome value (and other data) for the treatments that weren’t observed are missing, and our goal is to estimate what the mean differences in the outcomes would have been had that data not been missing. Thus we must use what we have to approximate that.</li>
</ol>
</div>
