---
title: The overlap weight
author: Alex Zajichek
date: '2023-04-01'
slug: the-overlap-weight
categories: []
tags: ['statistics', 'datascience', 'causation', 'rstats']
subtitle: 'A smoother, more inclusive approach to matching'
summary: ''
authors: []
lastmod: '2023-04-01T11:39:12-05:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---

<script src="{{< blogdown/postref >}}index_files/htmlwidgets/htmlwidgets.js"></script>
<script src="{{< blogdown/postref >}}index_files/plotly-binding/plotly.js"></script>
<script src="{{< blogdown/postref >}}index_files/typedarray/typedarray.min.js"></script>
<script src="{{< blogdown/postref >}}index_files/jquery/jquery.min.js"></script>
<link href="{{< blogdown/postref >}}index_files/crosstalk/css/crosstalk.min.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/crosstalk/js/crosstalk.min.js"></script>
<link href="{{< blogdown/postref >}}index_files/plotly-htmlwidgets-css/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/plotly-main/plotly-latest.min.js"></script>


<p>I was recently introduced to a method in the field of <a href="https://en.wikipedia.org/wiki/Matching_(statistics)">matching</a> (or <em>balancing</em>) for observational studies called <a href="https://jamanetwork.com/journals/jama/article-abstract/2765748"><em>overlap weighting</em></a>. Although I’ve just started getting into the details, I already see it as superior to <a href="https://en.wikipedia.org/wiki/Propensity_score_matching">propensity score (PS) matching</a>, a well-known matching method and what I’ve typically done in the past, for a few reasons (that I’ve observed at least):</p>
<ol style="list-style-type: decimal">
<li>It uses all available information (all observations) instead of arbitrary cutoffs like, for example, 1:5 matching.</li>
<li>Its properties <em>force</em> the standardized differences of all factors included in the propensity score model to be zero across the treatment groups instead of arbitrarily close.</li>
<li>Each treatment group contributes equally to the outcome model when the overlap weights are used regardless of the balance of the treatment groups in the original sample.</li>
<li>Because of (1), it makes it much more intuitive to explore the impacts of the weighting process on other covariates and the outcome.</li>
<li>It also has <a href="https://academic.oup.com/aje/article/188/1/250/5090958">been shown</a> to produce more unbiased and efficient estimates than other inclusive weighting approaches like <em>inverse probability weighting (IPW)</em> (regardless if trimming was used). It also has practical benefits over IPW in that weights are bounded between 0 and 1, foregoing the need for (arbitrary) trimming.</li>
</ol>
<p>The <em>overlap weighting</em> process actually starts the same as <em>PS matching</em>–by modeling the treatment group as a function of various factors that may be confounding the observed (unadjusted) treatment effect. It’s what is done with the scores (probabilities) that differentiate the methods.</p>
<div id="how-is-it-defined" class="section level1">
<h1>How is it defined?</h1>
<p>It’s actually quite simple. Suppose you have treatments A &amp; B (note this does extend to more treatments as well), and you build a propensity score model (using logistic regression) to estimate the probability that each observation belongs to a particular treatment group given a collection of covariate values (<em>Note: We should strive for selecting covariates that we believe are associated with both the treatment group membership and the outcome of interest</em>):</p>
<p><span class="math display">\[P(T_i = A|X_i) \approx \frac{1}{1 + e^{-X_i\hat{\beta}}} = \hat{p_i}\]</span>
where <span class="math inline">\(\hat{\beta}\)</span> are the estimated regression coefficients and <span class="math inline">\(X_i\)</span>, <span class="math inline">\(T_i\)</span> are the covariate values and treatment group for the <span class="math inline">\(i^{th}\)</span> observation, respectively. Then <span class="math inline">\(OW_i\)</span>, the <em>overlap weight</em> for the <span class="math inline">\(i^{th}\)</span> observation, is calculated by:</p>
<p><span class="math display">\[
\begin{equation}
OW_i=
    \begin{cases}
        1-\hat{p_i} &amp; \text{if } T_i = A\\
        \hat{p_i} &amp; \text{if } T_i = B\\
    \end{cases}
\end{equation}
\]</span>
Now we do end up normalizing these weights so that they sum to one (1) <em>within</em> each treatment group. But here’s some intuition about what’s happening: it shifts the focus of the subsequent outcome model to observations that are most likely in <em>either</em> treatment group (i.e., <span class="math inline">\(P(T_i = A|X_i)\)</span> near 0.5) (technically it focuses <em>most</em> on observations that are “misclassified”, but since these probabilities are derived on the data set in which the model was built, we probably won’t see many of those).</p>
<p>I think this makes a lot of sense. When we’re trying to evaluate the effectiveness of a treatment, we want to focus most heavily on those who could be candidates for either one, and less so on those who were bound for one of the treatment options (because of their specific characteristics). The beautiful thing here is that we do this without throwing away any information; smoothly and proportionately weighting each observation just the amount that we should.</p>
</div>
<div id="can-i-have-an-example" class="section level1">
<h1>Can I have an example?</h1>
<p>Sure. Let’s first create a synthetic treatment as example. Using the <code>cheese::heart_disease</code> data set, we’re going to assume the following:</p>
<p><span class="math display">\[logit(P(T_i|X_i)) = 0.75Age_{std} + 0.5Male\]</span></p>
<p>That is, the probability of being <em>treated</em> (<span class="math inline">\(T_i\)</span>) is linearly related to the (standardized) age and sex of the patient. Further, older patients and male patients are more likely to be treated.</p>
<pre class="r"><code># Load some packages
library(tidyverse)</code></pre>
<pre><code>## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──
## ✔ ggplot2 3.4.0     ✔ purrr   1.0.0
## ✔ tibble  3.1.8     ✔ dplyr   1.1.0
## ✔ tidyr   1.2.1     ✔ stringr 1.4.1
## ✔ readr   2.1.3     ✔ forcats 0.5.2
## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code>library(plotly)</code></pre>
<pre><code>## 
## Attaching package: &#39;plotly&#39;
## 
## The following object is masked from &#39;package:ggplot2&#39;:
## 
##     last_plot
## 
## The following object is masked from &#39;package:stats&#39;:
## 
##     filter
## 
## The following object is masked from &#39;package:graphics&#39;:
## 
##     layout</code></pre>
<pre class="r"><code>dat &lt;- 
  cheese::heart_disease %&gt;%
  
  # Add the true propensity score
  mutate(
    PS = 1 / (1 + exp(-(.75 * ((Age - mean(Age))/sd(Age)) + .5 * (Sex == &quot;Male&quot;))))
  ) </code></pre>
<p>First lets look at the overall <em>true</em> propensity score distribution.</p>
<pre class="r"><code>dat %&gt;%
  plot_ly(
    x = ~PS,
    type = &quot;histogram&quot;
  ) %&gt;%
  layout(
    xaxis = list(title = &quot;True Propensity Score (PS)&quot;, tickformat = &quot;2%&quot;),
    yaxis = list(title = &quot;Patients&quot;)
  )</code></pre>
<div id="htmlwidget-1" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"visdat":{"87c110e80a5a":["function () ","plotlyVisDat"]},"cur_data":"87c110e80a5a","attrs":{"87c110e80a5a":{"x":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"histogram"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"True Propensity Score (PS)","tickformat":"2%"},"yaxis":{"domain":[0,1],"automargin":true,"title":"Patients"},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[0.770364359631493,0.823795524051423,0.823795524051423,0.279482678662,0.246917293432171,0.652383238080084,0.651898061282358,0.552928075143194,0.770364359631493,0.594018030932883,0.670955196826942,0.532337688917272,0.652383238080084,0.409461733601653,0.573861593007813,0.670955196826942,0.49142997224931,0.613862587117283,0.369518392328375,0.512170947887757,0.784713096571341,0.573338496999314,0.689007920302571,0.689007920302571,0.723409840321588,0.408944683966175,0.573338496999314,0.722981702440214,0.389558632128273,0.332233949444466,0.769985793610694,0.723409840321588,0.784713096571341,0.70650344997063,0.409461733601653,0.370016799924178,0.389558632128273,0.670955196826942,0.633335882718861,0.739701169150525,0.706059775851641,0.332233949444466,0.798055421386148,0.70650344997063,0.632839083015439,0.689007920302571,0.553456705183428,0.532870096838967,0.706059775851641,0.594018030932883,0.246917293432171,0.798399885078115,0.409461733601653,0.409461733601653,0.723409840321588,0.613862587117283,0.532870096838967,0.350891773876053,0.613862587117283,0.553456705183428,0.429141949592691,0.331759633741377,0.689007920302571,0.490895457861402,0.613862587117283,0.723409840321588,0.723409840321588,0.613862587117283,0.70650344997063,0.450107285869159,0.706059775851641,0.823795524051423,0.755357435666517,0.798399885078115,0.409461733601653,0.706059775851641,0.723409840321588,0.429141949592691,0.49142997224931,0.689007920302571,0.42966597202442,0.470185643027067,0.314088163398748,0.835518462005383,0.573861593007813,0.409461733601653,0.470718457162363,0.470185643027067,0.470185643027067,0.429141949592691,0.811425642404402,0.651898061282358,0.755357435666517,0.296047496506071,0.670482848552301,0.573861593007813,0.70650344997063,0.613355510273774,0.573861593007813,0.49142997224931,0.42966597202442,0.232194729716581,0.552928075143194,0.798055421386148,0.512170947887757,0.613862587117283,0.70650344997063,0.670955196826942,0.739701169150525,0.314088163398748,0.632839083015439,0.652383238080084,0.573861593007813,0.279052202106184,0.651898061282358,0.350891773876053,0.689007920302571,0.166174889491516,0.770364359631493,0.798399885078115,0.49142997224931,0.670482848552301,0.553456705183428,0.633335882718861,0.798399885078115,0.31362758647169,0.532337688917272,0.613862587117283,0.409461733601653,0.651898061282358,0.613862587117283,0.553456705183428,0.166471444665653,0.553456705183428,0.279052202106184,0.511636569526832,0.857075301063222,0.755357435666517,0.247315202903325,0.553456705183428,0.70650344997063,0.70650344997063,0.573861593007813,0.784713096571341,0.689007920302571,0.470718457162363,0.670955196826942,0.350891773876053,0.42966597202442,0.613355510273774,0.573861593007813,0.262668512394506,0.739289160646041,0.633335882718861,0.784713096571341,0.857075301063222,0.553456705183428,0.689007920302571,0.723409840321588,0.835518462005383,0.450107285869159,0.914670684573403,0.490895457861402,0.573338496999314,0.49142997224931,0.670955196826942,0.573861593007813,0.490895457861402,0.247315202903325,0.31362758647169,0.857075301063222,0.594018030932883,0.593502150961137,0.651898061282358,0.784713096571341,0.670955196826942,0.573861593007813,0.652383238080084,0.389558632128273,0.594018030932883,0.49142997224931,0.532337688917272,0.370016799924178,0.70650344997063,0.613355510273774,0.670482848552301,0.370016799924178,0.811425642404402,0.613862587117283,0.846606694824675,0.532870096838967,0.553456705183428,0.389558632128273,0.651898061282358,0.754961999181645,0.823795524051423,0.846606694824675,0.31362758647169,0.408944683966175,0.70650344997063,0.408944683966175,0.688549457511965,0.670955196826942,0.688549457511965,0.389558632128273,0.42966597202442,0.689007920302571,0.532870096838967,0.633335882718861,0.651898061282358,0.190459205727706,0.296493408535217,0.350891773876053,0.722981702440214,0.573861593007813,0.652383238080084,0.331759633741377,0.331759633741377,0.688549457511965,0.70650344997063,0.246917293432171,0.490895457861402,0.217367225755322,0.594018030932883,0.670482848552301,0.154993678674541,0.470718457162363,0.739289160646041,0.613862587117283,0.811425642404402,0.449577984976474,0.511636569526832,0.512170947887757,0.835224331600778,0.490895457861402,0.613862587117283,0.652383238080084,0.450107285869159,0.389050157629421,0.370016799924178,0.350891773876053,0.246917293432171,0.389050157629421,0.739701169150525,0.613355510273774,0.823795524051423,0.689007920302571,0.470718457162363,0.573861593007813,0.755357435666517,0.670955196826942,0.689007920302571,0.784713096571341,0.429141949592691,0.389558632128273,0.262668512394506,0.739289160646041,0.856813112939884,0.857075301063222,0.670955196826942,0.296047496506071,0.573338496999314,0.613355510273774,0.409461733601653,0.739701169150525,0.370016799924178,0.573861593007813,0.70650344997063,0.332233949444466,0.370016799924178,0.739701169150525,0.811425642404402,0.450107285869159,0.798055421386148,0.70650344997063,0.784713096571341,0.722981702440214,0.217367225755322,0.670955196826942,0.573338496999314,0.670955196826942,0.470718457162363,0.511636569526832,0.247315202903325,0.739701169150525,0.689007920302571,0.573338496999314,0.689007920302571,0.652383238080084,0.652383238080084,0.823795524051423,0.511636569526832,0.409461733601653,0.770364359631493,0.670482848552301,0.350891773876053,0.70650344997063,0.552928075143194,0.42966597202442,0.835518462005383,0.670955196826942,0.552928075143194,0.296493408535217],"type":"histogram","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
<p>Now, let’s generate the treatment indicator for each patient by taking a random draw from a Bernoulli distribution:</p>
<pre class="r"><code>set.seed(123)
dat &lt;- 
  dat %&gt;%
  
  # Assign treatment
  mutate(
    Treated = rbinom(n = nrow(dat), size = 1, prob = PS)
  )</code></pre>
<p>Of the 303 patients, 175 (57.8%) were treated. Let’s look at the rate of treatment by age and sex.</p>
<pre class="r"><code>ggplotly(
  dat %&gt;%
    
    # Make age groups
    mutate(
      Age = Hmisc::cut2(Age, g = 5)
    ) %&gt;%
    
    # For each group
    group_by(Age, Sex) %&gt;%
    
    # Compute the rate
    summarise(
      Patients = n(),
      Treated = sum(Treated),
      .groups = &quot;drop&quot;
    ) %&gt;%
    
    # Make the proportion
    mutate(
      Rate = Treated / Patients
    ) %&gt;%
    
    # Make a plot
    ggplot(
      aes(
        x = Age,
        y = Rate,
        color = Sex,
        group = Sex,
        text = 
          paste0(
            &quot;Patients: &quot;, Patients,
            &quot;&lt;br&gt;Treated: &quot;, Treated,
            &quot;&lt;br&gt;Percent Treated: &quot;, round(Rate * 100, 1), &quot;%&quot;
          )
      )
    ) +
    geom_point() +
    geom_line() +
    scale_y_continuous(labels = scales::percent) +
    ylab(&quot;Percent Treated (%)&quot;),
  tooltip = &quot;text&quot;
)</code></pre>
<div id="htmlwidget-2" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"data":[{"x":[1,2,3,4,5],"y":[0.333333333333333,0.411764705882353,0.636363636363636,0.466666666666667,0.68],"text":["Patients: 18<br>Treated: 6<br>Percent Treated: 33.3%","Patients: 17<br>Treated: 7<br>Percent Treated: 41.2%","Patients: 22<br>Treated: 14<br>Percent Treated: 63.6%","Patients: 15<br>Treated: 7<br>Percent Treated: 46.7%","Patients: 25<br>Treated: 17<br>Percent Treated: 68%"],"type":"scatter","mode":"markers+lines","marker":{"autocolorscale":false,"color":"rgba(248,118,109,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(248,118,109,1)"}},"hoveron":"points","name":"Female","legendgroup":"Female","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","line":{"width":1.88976377952756,"color":"rgba(248,118,109,1)","dash":"solid"},"frame":null},{"x":[1,2,3,4,5],"y":[0.311111111111111,0.595744680851064,0.653061224489796,0.633333333333333,0.885714285714286],"text":["Patients: 45<br>Treated: 14<br>Percent Treated: 31.1%","Patients: 47<br>Treated: 28<br>Percent Treated: 59.6%","Patients: 49<br>Treated: 32<br>Percent Treated: 65.3%","Patients: 30<br>Treated: 19<br>Percent Treated: 63.3%","Patients: 35<br>Treated: 31<br>Percent Treated: 88.6%"],"type":"scatter","mode":"markers+lines","marker":{"autocolorscale":false,"color":"rgba(0,191,196,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(0,191,196,1)"}},"hoveron":"points","name":"Male","legendgroup":"Male","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","line":{"width":1.88976377952756,"color":"rgba(0,191,196,1)","dash":"solid"},"frame":null}],"layout":{"margin":{"t":26.2283105022831,"r":7.30593607305936,"b":40.1826484018265,"l":43.1050228310502},"plot_bgcolor":"rgba(235,235,235,1)","paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[0.4,5.6],"tickmode":"array","ticktext":["[29,46)","[46,54)","[54,59)","[59,63)","[63,77]"],"tickvals":[1,2,3,4,5],"categoryorder":"array","categoryarray":["[29,46)","[46,54)","[54,59)","[59,63)","[63,77]"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"y","title":{"text":"Age","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[0.282380952380952,0.914444444444444],"tickmode":"array","ticktext":["30%","40%","50%","60%","70%","80%","90%"],"tickvals":[0.3,0.4,0.5,0.6,0.7,0.8,0.9],"categoryorder":"array","categoryarray":["30%","40%","50%","60%","70%","80%","90%"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","title":{"text":"Percent Treated (%)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":true,"legend":{"bgcolor":"rgba(255,255,255,1)","bordercolor":"transparent","borderwidth":1.88976377952756,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.689497716895},"title":{"text":"Sex","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"87c167e86459":{"x":{},"y":{},"colour":{},"text":{},"type":"scatter"},"87c14a14445a":{"x":{},"y":{},"colour":{},"text":{}}},"cur_data":"87c167e86459","visdat":{"87c167e86459":["function (y) ","x"],"87c14a14445a":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
<div id="build-the-propensity-score-model" class="section level2">
<h2>1. Build the propensity score model</h2>
</div>
<div id="calculate-the-overlap-weights" class="section level2">
<h2>2. Calculate the overlap weights</h2>
<ul>
<li>How to calculate them</li>
<li>Intuition about who it focuses on, proportional down weights</li>
<li>Show differences in outcome weighted and unweighted</li>
<li>Show standarized differences of covariates (some not included in PS model as well) (use plotly)</li>
<li>Show ways to assess cumulative contribution of cases and impact on other covariates</li>
<li>Assess redundancy</li>
</ul>
</div>
</div>
