<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alex Zajichek">
<meta name="dcterms.date" content="2021-12-28">
<meta name="description" content="A method for underdispersed count data">

<title>Exploring COM Poisson regression ‚Äì Zajichek Stats</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../logo.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-9MW3W3RQD9"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-9MW3W3RQD9', { 'anonymize_ip': true});
</script>
<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="Exploring COM Poisson regression ‚Äì Zajichek Stats">
<meta property="og:description" content="A method for underdispersed count data">
<meta property="og:image" content="https://www.zajichekstats.com/post/com-poisson-regression/feature.png">
<meta property="og:site_name" content="Zajichek Stats">
<meta property="og:image:height" content="1018">
<meta property="og:image:width" content="1020">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Zajichek Stats</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/alexzajichek"> <i class="bi bi-linkedin" role="img" aria-label="LinkedIn">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.youtube.com/@centralstatz"> <i class="bi bi-youtube" role="img" aria-label="YouTube">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/zajichek"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Exploring COM Poisson regression</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">Regression</div>
  </div>
  </div>

<div>
  <div class="description">
    A method for underdispersed count data
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Alex Zajichek </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 28, 2021</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>A few years ago I encountered an interesting count distribution during a modeling project. The goal was to model the number of <a href="https://www.shoulderdoc.co.uk/article/538">suture anchors</a> used in rotator-cuff tendon tears, and how that was influenced by tear characteristics and surgeon preference. My instinct was to fit a <a href="https://en.wikipedia.org/wiki/Poisson_distribution">Poisson</a> model, but the target took on relatively small values and was also non-zero, so I had to do some digging for an alternative approach. I came across a method called Conway-Maxwell (COM) Poisson regression, which not only allowed for <em>overdispersion</em> (i.e., the population variance is greater than its mean), but also <em>underdispersion</em>. It hit me that I had never come across methodology for the latter and it seemed to align with my problem, so I was intrigued (Full Disclosure: I heard of COM-Poisson prior to that, albeit knew nothing about it, when one of my super smart graduate school buddies was doing research on it, so that‚Äôs also why it stuck).</p>
<p>Long story short, we didn‚Äôt end up using the COM-Poisson model for the <a href="https://www.jshoulderelbow.org/article/S1058-2746(18)30555-X/fulltext">anchor project</a> üòÅ, and instead went in favor of <a href="https://stats.oarc.ucla.edu/r/dae/zero-truncated-poisson/">Zero-Truncated Poisson regression</a>. Nevertheless I thought it was an awesome method that warranted further exploration and later did a <a href="NonTraditionalCountRegression.pdf">talk</a> on it. That was a few years ago‚Äìso this article is intended to be a reworking of that talk to relearn it for myself, but also to get the word out about this awesome method! All code is written in R.</p>
<section id="table-of-contents" class="level1">
<h1>Table Of Contents</h1>
<ul>
<li><a href="#reviewofpoisson">A Review of Poisson Regression</a>
<ul>
<li><a href="#poissondistribution">The Poisson Distribution</a></li>
<li><a href="#modelformulation">Model Formulation</a></li>
</ul></li>
<li><a href="#compoisson">Conway-Maxwell (COM) Poisson Regression</a>
<ul>
<li><a href="#compoissondistribution">The COM-Poisson Distribution</a></li>
<li><a href="#compoissonregressionmodel">The Regression Model</a></li>
<li><a href="#compoissonlrt">Testing for Violations of Equidispersion</a></li>
<li><a href="#stratifieddispersion">Stratified Dispersion</a></li>
<li><a href="#comfittedvalues">Generating Fitted Values</a></li>
<li><a href="#compowersim">Simulation: Power of Equidispersion Test</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#codeappendix">Code Appendix</a></li>
</ul>
</section>
<section id="reviewofpoisson" class="level1">
<h1>A Review of Poisson Regression</h1>
<p>I really like making up examples, so lets start with that:</p>
<p>Suppose hospital administrators are interested in emergency department (ED) utilization and have asked a few questions:</p>
<ol type="1">
<li>How many patients can we expect to see in a given day?</li>
<li>What is the likelihood that we see more than 40 patients in a single day?</li>
<li>Do we see more variation during the week versus weekend, or in the AM versus PM hours?</li>
</ol>
<p>To expedite the process, we‚Äôre given a pre-built dataset called <code>ed_volumes</code> containing the number of patients entering the ED each (half) day over the past calendar year.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: tidyverse</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>‚îÄ‚îÄ Attaching core tidyverse packages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ tidyverse 2.0.0 ‚îÄ‚îÄ
‚úî dplyr     1.1.4     ‚úî readr     2.1.5
‚úî forcats   1.0.0     ‚úî stringr   1.5.1
‚úî ggplot2   3.5.1     ‚úî tibble    3.2.1
‚úî lubridate 1.9.3     ‚úî tidyr     1.3.1
‚úî purrr     1.0.2     
‚îÄ‚îÄ Conflicts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ tidyverse_conflicts() ‚îÄ‚îÄ
‚úñ dplyr::filter() masks stats::filter()
‚úñ dplyr::lag()    masks stats::lag()
‚Ñπ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set a seed</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="do">### 1. Create simulated dataset</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Generating a random Poisson parameter</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>ed_true_mean <span class="ot">&lt;-</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">runif</span>(</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="dv">1</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">min =</span> <span class="fl">12.5</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">max =</span> <span class="dv">25</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the dataset</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>ed_volumes <span class="ot">&lt;-</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Date =</span> <span class="fu">rep</span>(<span class="fu">as.Date</span>(<span class="st">"2021-12-31"</span>) <span class="sc">-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">364</span>, <span class="dv">1</span>), <span class="dv">2</span>),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">TimeOfDay =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"AM"</span>, <span class="fu">length</span>(Date) <span class="sc">/</span> <span class="dv">2</span>), <span class="fu">rep</span>(<span class="st">"PM"</span>, <span class="fu">length</span>(Date) <span class="sc">/</span> <span class="dv">2</span>)),</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">Volume =</span> </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rpois</span>(</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">n =</span> <span class="fu">length</span>(Date), </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda =</span> <span class="fu">ifelse</span>(<span class="fu">weekdays</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>), ed_true_mean <span class="sc">-</span> <span class="dv">5</span>, ed_true_mean)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">desc</span>(Date),</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    TimeOfDay</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load some packages</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the dataset</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ed_volumes, <span class="at">n =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 730 √ó 3
  Date       TimeOfDay Volume
  &lt;date&gt;     &lt;chr&gt;      &lt;int&gt;
1 2021-12-31 AM            19
2 2021-12-31 PM            12
3 2021-12-30 AM            20
4 2021-12-30 PM            20
5 2021-12-29 AM             9
# ‚Ñπ 725 more rows</code></pre>
</div>
</div>
<p>First, let‚Äôs take a look at the distribution of total daily patient volume over the time period:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ed_volumes <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each date</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the total </span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Volume =</span> <span class="fu">sum</span>(Volume),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Volume</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"gray"</span>,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">30</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">xintercept =</span> <span class="fu">mean</span>(Volume)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"#b84f48"</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">mean</span>(Volume) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="dv">41</span>,</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="fu">str_c</span>(<span class="st">"Avg: "</span>, <span class="fu">round</span>(<span class="fu">mean</span>(Volume), <span class="dv">1</span>), <span class="st">" patients"</span>)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"#b84f48"</span>,</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="sc">-</span>.<span class="dv">15</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Daily Patient Volume"</span>) <span class="sc">+</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Frequency"</span>) <span class="sc">+</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>)</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in geom_text(aes(x = mean(Volume) + 1, y = 41, label = str_c("Avg: ", : All aesthetics have length 1, but the data has 365 rows.
‚Ñπ Please consider using `annotate()` or provide this layer with data containing
  a single row.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There were 29.5 patients per day on average, ranging from 11 to 47. Knowing that this is a count distribution, we think to use a Poisson model to provide our estimates for the first two questions. Let‚Äôs remind ourselves of the specifics:</p>
<section id="poissondistribution" class="level2">
<h2 class="anchored" data-anchor-id="poissondistribution">The Poisson Distribution</h2>
<p>If the probability mass function (PMF) for a non-negative, integer-valued <span class="math inline">\(Y\)</span> is:</p>
<p><span class="math display">\[P(Y = y|\lambda) = \frac{e^{-\lambda}\lambda^y}{y!}\]</span> then <span class="math inline">\(Y\)</span> is distributed as a Poisson random variable, and has the following property:</p>
<p><span class="math display">\[E[Y] = \lambda\]</span> It turns out that the maximum likelihood estimator (MLE) for <span class="math inline">\(\lambda\)</span> is the <a href="https://www.statlect.com/fundamentals-of-statistics/Poisson-distribution-maximum-likelihood">sample average</a>. Remembering this, <em>we provide the estimate for the first question to be 30 patients. (rounding up)</em></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>lambda_hat <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">with</span>(ed_volumes, <span class="fu">tapply</span>(Volume, Date, sum)))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>lambda_hat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 29.53699</code></pre>
</div>
</div>
<p>We also know that once we have an estimate for <span class="math inline">\(\lambda\)</span> that we can compute probabilities by plugging it into the PMF:</p>
<p><span class="math display">\[P(Y&gt;40) = 1 - P(Y\leq40) = 1 - \sum_{y=0}^{40} \frac{e^{-\lambda}\lambda^y}{y!}\]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">40</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>lambda_hat) <span class="sc">*</span> lambda_hat<span class="sc">^</span>y <span class="sc">/</span> <span class="fu">factorial</span>(y)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>question2 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(p)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>question2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.02633629</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative approach</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">-</span> <span class="fu">ppois</span>(<span class="dv">40</span>, lambda_hat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.02633629</code></pre>
</div>
</div>
<p><em>We estimate that there is a 2.6% chance that we will see more than 40 patients in the ED in a single day</em>‚Äìdone with the first two questions!</p>
<p>üò®</p>
<p>Unfortunately, we missed a crucial assumption about the Poisson distribution that we didn‚Äôt account for:</p>
<p><span class="math display">\[E[Y] = Var[Y]\]</span> The estimates we provided assumed that the mean and variance of our underlying distribution were equal. The sample variance was 53.4 which is considerably larger than the mean of 29.5. Here is what an actual Poisson distribution looks like with <span class="math inline">\(\lambda\)</span> = 29.5 (our sample average) in comparison with the observed data:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>ed_volumes <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the total for each date</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Volume =</span> <span class="fu">sum</span>(Volume),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count the occurrences of each daily volume</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Volume) <span class="sc">%&gt;%</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the observed and theoretical relative frequencies</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">Observed =</span> N <span class="sc">/</span> <span class="fu">sum</span>(N),</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">Theoretical =</span> <span class="fu">dpois</span>(Volume, <span class="at">lambda =</span> lambda_hat)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove raw count</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>N) <span class="sc">%&gt;%</span> </span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Volume</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Observed,</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">"Observed Data"</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Theoretical,</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">"Actual Poisson"</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">25</span>,</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">xintercept =</span> lambda_hat</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"#b84f48"</span></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Daily Patient Volume"</span>) <span class="sc">+</span></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Relative Frequency (%)"</span>) <span class="sc">+</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>)</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"gray"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The tails of the observed sample are heavier than a Poisson would be with the same mean. Therefore, the estimates we provided for questions 1 and 2 are probably not very accurate. Let‚Äôs take a different approach: <em>answer question 3 first, and then work our way back to the other two.</em></p>
<p>As a reminder, we want to assess whether there is more variation in patient volume during the week versus weekend, or in the AM versus PM hours. To get this comparison, we need a way to simultaneously estimate the effect of each of these factors on the patient volume: enter Poisson regression.</p>
</section>
<section id="modelformulation" class="level2">
<h2 class="anchored" data-anchor-id="modelformulation">Model Formulation</h2>
<p>Just like other <a href="https://en.wikipedia.org/wiki/Generalized_linear_model">generalized linear models</a> (GLM), a Poisson regression model estimates the population average (the same average as described above!), <em>but conditioned on a set of covariates</em>.</p>
<p>More formally, for a given set of covariates <span class="math inline">\(x_1, x_2, .., x_p\)</span>, we assume the following functional form:</p>
<p><span class="math display">\[log(\lambda_i) = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2}+...+\beta_px_{ip} = X_i\beta\]</span> This <em>log-linear</em> model allows us to estimate the mean number of events (i.e., the Poisson parameter <span class="math inline">\(\lambda\)</span>) for a given arrangement of covariate values. We also get informative interpretation of the individual effects of each covariate. For our example, the model looks like this:</p>
<p><span class="math display">\[log(\lambda_i) = \beta_0 + \beta_{weekend}x_{i_{weekend}} + \beta_{PM}x_{i_{PM}}\]</span> where <span class="math inline">\(\lambda_i\)</span> is the expected (half-day) patient volume, <span class="math inline">\(x_{i_{weekend}} = 1\)</span> if it is Saturday or Sunday, and <span class="math inline">\(x_{i_{PM}} = 1\)</span> if it is PM hours (and they are 0 otherwise). We can take the following steps to estimate the <span class="math inline">\(\beta\)</span> parameters:</p>
<ol type="1">
<li>Plug the regression formula into the Poisson PMF</li>
</ol>
<p><span class="math display">\[
\begin{equation}
\begin{split}
P(Y_i = y_i|\lambda_i) &amp; = \frac{e^{-\lambda_i}\lambda_i^{y_i}}{y_i!} \\
&amp; = \frac{e^{-e^{X_i\beta}}{(e^{X_i\beta})}^{y_i}}{y_i!} \\
\end{split}
\end{equation}
\]</span></p>
<ol start="2" type="1">
<li>Derive the likelihood function</li>
</ol>
<p><span class="math display">\[L(\lambda_i) = \prod_{i=1}^N \frac{e^{-e^{X_i\beta}}{(e^{X_i\beta})}^{y_i}}{y_i!} \\\]</span> where <span class="math inline">\(N\)</span> is the total number of (half) days.</p>
<ol start="3" type="1">
<li>Compute the MLE‚Äôs</li>
</ol>
<p><span class="math display">\[\hat{\beta} = max_{\beta} L(\lambda_i)\\\]</span> <span class="math inline">\(\hat{\beta}\)</span> is the set of estimated parameter values computed from maximizing the likelihood function. Once we have these, we can plug them into the regression formula, and away we go! Luckily, our software will compute these for us‚Äìall we need to do is supply the data.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a generalized linear model</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> Volume <span class="sc">~</span> Weekend <span class="sc">+</span> PM, <span class="co"># Specify the model form</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="co"># Supply the data</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>      ed_volumes <span class="sc">%&gt;%</span> </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">Weekend =</span> <span class="fu">weekdays</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>),</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">PM =</span> TimeOfDay <span class="sc">==</span> <span class="st">"PM"</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"poisson"</span> <span class="co"># Indicate the likelihood</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the model summary</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = Volume ~ Weekend + PM, family = "poisson", data = ed_volumes %&gt;% 
    mutate(Weekend = weekdays(Date) %in% c("Saturday", "Sunday"), 
        PM = TimeOfDay == "PM"))

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  2.78530    0.01455 191.483   &lt;2e-16 ***
WeekendTRUE -0.41433    0.02371 -17.474   &lt;2e-16 ***
PMTRUE       0.01762    0.01926   0.915     0.36    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 1054.15  on 729  degrees of freedom
Residual deviance:  723.55  on 727  degrees of freedom
AIC: 4007.4

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>The estimated model turns out to be:</p>
<p><span class="math display">\[log(\hat{\lambda_i}) = 2.7853 - 0.4143x_{i_{weekend}} + 0.0176x_{i_{PM}}\]</span> where <span class="math inline">\(\hat{\lambda_i}\)</span> is the <em>estimated</em> average number of patients showing up to the ED on a given day of the week and time of day. Let‚Äôs take a look at the four possible estimated means:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make grid of possible values for each input</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Weekend =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">PM =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find cross-product</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cross_df</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add some columns</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add predictions</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">EstimatedVolume =</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">predict</span>(</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        model, <span class="co"># Supply the model</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">newdata =</span> <span class="fu">data.frame</span>(Weekend, PM),</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"response"</span> <span class="co"># Applies the inverse link to the linear predictor</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">EstimatedVolume =</span> <span class="fu">round</span>(EstimatedVolume, <span class="dv">2</span>),</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up names</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">Weekend =</span> </span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        Weekend <span class="sc">~</span> <span class="st">"Sat, Sun"</span>,</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Mon - Fri"</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relevel</span>(<span class="st">"Mon - Fri"</span>),</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">PM =</span> </span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>        PM <span class="sc">~</span> <span class="st">"PM"</span>,</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"AM"</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relevel</span>(</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"AM"</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rearrange</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    Weekend,</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    PM</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send over the columns</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> PM,</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> EstimatedVolume</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rename column</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Day of week</span><span class="st">`</span> <span class="ot">=</span> Weekend</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a kable</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"html"</span>,</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Expected ED patient volume"</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"responsive"</span>)</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">""</span>, <span class="st">"Time of day"</span> <span class="ot">=</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `cross_df()` was deprecated in purrr 1.0.0.
‚Ñπ Please use `tidyr::expand_grid()` instead.
‚Ñπ See &lt;https://github.com/tidyverse/purrr/issues/768&gt;.</code></pre>
</div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<caption>Expected ED patient volume</caption>
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; empty-cells: hide; border-bottom: hidden;"></th>
<th colspan="2" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Time of day
</div></th>
</tr>
<tr class="odd">
<th style="text-align: left;" data-quarto-table-cell-role="th">Day of week</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">AM</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">PM</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Mon - Fri</td>
<td style="text-align: right;">16.20</td>
<td style="text-align: right;">16.49</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sat, Sun</td>
<td style="text-align: right;">10.71</td>
<td style="text-align: right;">10.90</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>Our model suggests that we see <span class="math inline">\(1 - e^{\beta_{weekend}} \approx\)</span> 33.9% <em>less</em> patient volume on the weekends compared to during the week, regardless if it is AM or PM hours‚Äìthis is reflected in our table estimates. We can also see that there is little difference in patient volume by the time of day, regardless of the day of the week.</p>
<p><strong><em>Answer to Question 3</em></strong></p>
<p>The evidence tells us that not only is the day of the week the <em>more important</em> factor, but the time of day does not appear to matter at all. This is clear when we stratify our observed sample distribution:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ed_volumes <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make the indicators</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Weekend =</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">weekdays</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>) <span class="sc">~</span> <span class="st">"Sat, Sun"</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Mon - Fri"</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relevel</span>(<span class="st">"Mon - Fri"</span>),</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">TimeOfDay =</span> </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>      TimeOfDay <span class="sc">%&gt;%</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relevel</span>(</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"AM"</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Volume,</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> Weekend</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">20</span>,</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"identity"</span>,</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">5</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>TimeOfDay,</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="dv">2</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Half-Day Patient Volume"</span>) <span class="sc">+</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Frequency"</span>) <span class="sc">+</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>)</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong><em>Answers to Questions 1 &amp; 2</em></strong></p>
<p>So back to the first two questions. How can we use what we found for question 3 to inform us of these answers? Remember, we need to provide estimates regarding the <em>total</em> daily patient volume even though our model target was half-day patient volume. We have a couple options:</p>
<ol type="1">
<li>Since we have established that the time of day does not impact patient volume, we could fit a new model by first aggregating the target to reflect the total daily patient volume and then only add the weekday versus weekend factor as a covariate.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a generalized linear model</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> Volume <span class="sc">~</span> Weekend, <span class="co"># Specify the model form</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>      ed_volumes <span class="sc">%&gt;%</span> </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For each date</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compute the total daily patient volume</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">Volume =</span> <span class="fu">sum</span>(Volume),</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Make the indicator</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">Weekend =</span> <span class="fu">weekdays</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"poisson"</span> <span class="co"># Indicate the likelihood</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the model summary</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = Volume ~ Weekend, family = "poisson", data = ed_volumes %&gt;% 
    group_by(Date) %&gt;% summarise(Volume = sum(Volume), .groups = "drop") %&gt;% 
    mutate(Weekend = weekdays(Date) %in% c("Saturday", "Sunday")))

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  3.48729    0.01082  322.15   &lt;2e-16 ***
WeekendTRUE -0.41433    0.02371  -17.47   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 681.97  on 364  degrees of freedom
Residual deviance: 352.21  on 363  degrees of freedom
AIC: 2252.7

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>Notice the relative effect of the day of week factor remained consistent from the original model‚Äìthe intercept just changed to reflect the shifted distribution for the total patient volume. This approach works, but lets use the model we originally developed‚Ä¶</p>
<ol start="2" type="1">
<li>This option requires us to know a <a href="https://math.stackexchange.com/questions/221078/poisson-distribution-of-sum-of-two-random-independent-variables-x-y">property</a> of Poisson random variables. Specifically, if <em>X</em> and <em>Y</em> are two independent Poisson random variables and <span class="math inline">\(Z = X + Y\)</span>, then</li>
</ol>
<p><span class="math display">\[Z \sim Poisson(\lambda_X + \lambda_Y)\]</span> where <span class="math inline">\(\lambda_X\)</span> and <span class="math inline">\(\lambda_Y\)</span> are the expected values (means) for <em>X</em> and <em>Y</em>, respectively. This is relevant to us because we need to aggregate our model estimates over the time of day in order to get estimates for the total daily volume. Specifically, if <span class="math inline">\(V\)</span> is the patient volume, then <span class="math inline">\(V_{Daily} = V_{AM} + V_{PM}\)</span> for a particular day of the week. We assume from our model specification above that <span class="math inline">\(V_{AM}\)</span> and <span class="math inline">\(V_{PM}\)</span> follow independent Poisson distributions. Thus, we get the following:</p>
<p><span class="math display">\[
\begin{equation}
\begin{split}
\lambda_{Daily} &amp; = E[V_{Daily}] \\
&amp; = E[V_{AM} + V_{PM}] \\
&amp; = E[V_{AM}] + E[V_{PM}] \\
&amp; = \lambda_{AM} + \lambda_{PM} \\
&amp; = e^{\beta_0 + \beta_{weekend}x_{i_{weekend}}} + e^{\beta_0 + \beta_{weekend}x_{i_{weekend}} + \beta_{PM}} \\
&amp; = e^{\beta_0 + \beta_{weekend}x_{i_{weekend}}} (1 + e^{\beta_{PM}})\\
&amp; =
\begin{cases}
e^{\beta_0} (1 + e^{\beta_{PM}}) &amp; \text{if M-F} \\
e^{\beta_0 + \beta_{weekend}} (1 + e^{\beta_{PM}}) &amp; \text{if Sat, Sun} \\
\end{cases} \\
&amp; \approx
\begin{cases}
32.70 &amp; \text{if M-F} \\
21.61         &amp; \text{if Sat, Sun} \\
\end{cases}
\end{split}
\end{equation}
\]</span> Simply put, to get estimates around the total daily volume, we summed the regression equation over the time of day variable. Note that this is exactly what we would have gotten by just taking the sample mean of total daily volume stratified by each day of week grouping:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>stratified_means <span class="ot">&lt;-</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  ed_volumes <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each date</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the total daily patient volume</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Volume =</span> <span class="fu">sum</span>(Volume),</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make the indicator</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">Weekend =</span> </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">weekdays</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>) <span class="sc">~</span> <span class="st">"Sat, Sun"</span>,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Mon - Fri"</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relevel</span>(<span class="st">"Mon - Fri"</span>)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each group</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Weekend) <span class="sc">%&gt;%</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the mean</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean =</span> <span class="fu">mean</span>(Volume),</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variance =</span> <span class="fu">var</span>(Volume),</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>stratified_means <span class="sc">%&gt;%</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a kable</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"html"</span>,</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Stratified Daily Sample Means and Variances"</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"responsive"</span>)</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>  ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="table-responsive">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<caption>Stratified Daily Sample Means and Variances</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Weekend</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Variance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Mon - Fri</td>
<td style="text-align: right;">32.69732</td>
<td style="text-align: right;">31.93495</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sat, Sun</td>
<td style="text-align: right;">21.60577</td>
<td style="text-align: right;">19.40618</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>Notice also that the stratified sample <em>variances</em> align much more with our assumptions in using a Poisson distribution‚Äìthis was one of our <a href="#poissondistribution">problems earlier</a>, but it appears to be resolved! Now that we have weekday and weekend-specific Poisson distributions, we can confidently compute our final estimates for questions 1 and 2 the same way we did <a href="#poissondistribution">above</a>.</p>
<p>Table 2 already shows the answer to question 1: <em>we can expect to see 33 patients per day Monday-Friday, and 22 patients on Saturdays or Sundays.</em> To get the updated estimates for question 2, we just need to plug in the new means to the PDF and compute the cumulative probability:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>question2_updated <span class="ot">&lt;-</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  stratified_means <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each set, compute the cumulative probability</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  cheese<span class="sc">::</span><span class="fu">stratiply</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> Weekend,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">f =</span> <span class="sc">~</span><span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(<span class="fu">exp</span>(<span class="sc">-</span>.x<span class="sc">$</span>Mean) <span class="sc">*</span> .x<span class="sc">$</span>Mean<span class="sc">^</span><span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">40</span>) <span class="sc">/</span> <span class="fu">factorial</span>(<span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">40</span>)))</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>question2_updated</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$`Mon - Fri`
[1] 0.08959949

$`Sat, Sun`
[1] 0.0001298706</code></pre>
</div>
</div>
<p><em>We estimate that there is a 8.96% chance that we will see more than 40 patients on any given Monday-Friday, and a 0.01% chance that we will see that many patients on the weekend.</em></p>
<p>Okay we got a little carried away with that but hopefully you have an idea of how Poisson regression works.</p>
</section>
</section>
<section id="compoisson" class="level1">
<h1>Conway-Maxwell (COM) Poisson Regression</h1>
<p>Now that we have a foundation for standard Poisson regression, we can dig into COM-Poisson! We will use the <a href="https://github.com/lotze/COMPoissonReg"><code>COMPoissonReg</code></a> package in R, which can be installed from CRAN with <code>install.packages("COMPoissonReg")</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the package</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(COMPoissonReg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: COMPoissonReg</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Rcpp</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: numDeriv</code></pre>
</div>
</div>
<section id="compoissondistribution" class="level2">
<h2 class="anchored" data-anchor-id="compoissondistribution">The COM-Poisson Distribution</h2>
<p>If the PMF for a non-negative, integer-valued <span class="math inline">\(Y\)</span> is:</p>
<p><span class="math display">\[P(Y = y|\lambda, \nu) = \frac{\lambda^y}{y!^{\nu}Z(\lambda, \nu)}\]</span> where <span class="math inline">\(\lambda, \nu &gt; 0\)</span>, and</p>
<p><span class="math display">\[Z(\lambda, \nu) = \sum_{k=0}^{\infty}\frac{\lambda^k}{k!^{\nu}}\]</span> then <span class="math inline">\(Y\)</span> is distributed as a COM-Poisson random variable.</p>
<p>That‚Äôs kind of a mouthful, but we can see some similarities in its form to the <a href="#poissondistribution">Poisson PDF</a>. In fact, if you‚Äôre really math-savvy (which I‚Äôm not, I had to look this up), you‚Äôll notice that the function <span class="math inline">\(Z\)</span> is a <em><a href="https://en.wikipedia.org/wiki/Power_series">power series</a></em>. When we set <span class="math inline">\(\nu = 1\)</span>, then</p>
<p><span class="math display">\[Z(\lambda, \nu = 1) = \sum_{k=0}^{\infty}\frac{\lambda^k}{k!} = e^\lambda\]</span> Plugging that result back into the full PMF, it turns out to be <em>exactly</em> the same as a Poisson distribution. This tells us that <strong><em>the Poisson distribution is a special case of the COM-Poisson</em></strong>. In the other words, the COM-Poisson is a generalization of the Poisson distribution, so we‚Äôll expect it do everything that the latter can‚Äìplus more.</p>
<section id="dispersion-parameter" class="level3">
<h3 class="anchored" data-anchor-id="dispersion-parameter">Dispersion Parameter</h3>
<p>An important feature of the COM-Poisson PDF is the parameter <span class="math inline">\(\nu\)</span>, which determines its <em>dispersion</em> (i.e., how variable it is relative to its mean). In the standard Poisson distribution, the mean and variance are always the same, by definition. The <span class="math inline">\(\nu\)</span> parameter allows us to relax that restriction in cases where it does not apply (or we don‚Äôt want to force it to). The following table describes the properties when it is above, below, and equal to 1:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Parameter</th>
<th>Implies</th>
<th>Described As</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(\nu=1\)</span></td>
<td><span class="math inline">\(E[Y] = Var[Y]\)</span></td>
<td>Equidispersed</td>
</tr>
<tr class="even">
<td><span class="math inline">\(\nu&lt;1\)</span></td>
<td><span class="math inline">\(E[Y] &lt; Var[Y]\)</span></td>
<td>Overdispersed</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\nu&gt;1\)</span></td>
<td><span class="math inline">\(E[Y] &gt; Var[Y]\)</span></td>
<td>Underdispersed</td>
</tr>
</tbody>
</table>
</section>
<section id="compoissonmeanapprox" class="level3">
<h3 class="anchored" data-anchor-id="compoissonmeanapprox">Mean and Variance</h3>
<p>Unfortunately, there is <a href="https://faculty.georgetown.edu/kfs7/MY%20PUBLICATIONS/COMPoissonModelForCountDataWithDiscussion.pdf">no closed form solution</a> for the mean and variance of a COM-Poisson random variable. However, there are a couple related properties that are worth relaying:</p>
<ul>
<li>The <span class="math inline">\(\lambda\)</span> parameter is the mean of the power-transformed counts</li>
</ul>
<p><span class="math display">\[E[Y^\nu] = \lambda\]</span></p>
<ul>
<li>The mean and variance can be approximated as:</li>
</ul>
<p><span class="math display">\[E[Y] \approx \lambda^{1/\nu} - \frac{\nu-1}{2\nu}\]</span> <span class="math display">\[Var[Y] \approx \frac{\lambda^{1/\nu}}{\nu}\]</span> when <span class="math inline">\(\nu \leq 1\)</span> (overdispersed) or <span class="math inline">\(\lambda &gt; 10^\nu\)</span> (larger counts).</p>
</section>
<section id="centralitysimulation" class="level3">
<h3 class="anchored" data-anchor-id="centralitysimulation">Centrality Simulation</h3>
<p>The properties described above give us some useful information, but it is hard to make sense of how these parameters directly govern the data we might observe from a COM-Poisson distribution. To give us a bit more insight, lets randomly generate a bunch of data for different parameter combinations and see what we find. To do this, we‚Äôll use the <code>rcmp</code> function.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a parameter grid</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">50</span>),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">nu =</span> <span class="fu">c</span>(.<span class="dv">5</span>, <span class="dv">1</span>, <span class="fl">1.25</span>, <span class="fl">1.5</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cross_df</span>()</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of samples</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of simulations</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Set a seed</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>compoisson_sim1 <span class="ot">&lt;-</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  params <span class="sc">%&gt;%</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Split into a list</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.)) <span class="sc">%&gt;%</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each element</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_df</span>(</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(.x) {</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span><span class="sc">:</span>s <span class="sc">%&gt;%</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each iteration</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">map_df</span>(</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>          <span class="cf">function</span>(.sim) {</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Time the sampling</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>            temp_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>(temp_value <span class="ot">&lt;-</span> <span class="fu">rcmp</span>(<span class="at">n =</span> n, <span class="at">lambda =</span> .x<span class="sc">$</span>lambda, <span class="at">nu =</span> .x<span class="sc">$</span>nu))</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>            <span class="fu">tibble</span>(</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>              <span class="at">s =</span> .sim,</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>              <span class="at">lambda =</span> .x<span class="sc">$</span>lambda,</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>              <span class="at">nu =</span> .x<span class="sc">$</span>nu,</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>              <span class="at">value =</span> temp_value,</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>              <span class="at">time =</span> temp_time[<span class="st">"elapsed"</span>][[<span class="dv">1</span>]]</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We took 100 random samples of size 500 from 24 parameter combinations. This process took about 94.1 seconds to run. Lets first take a quick look at the distributions from the first simulation for each parameter set.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>compoisson_sim1 <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter to the first simulated value</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    s <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to factors</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        lambda,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        nu</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>      factor</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> </span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>      lambda <span class="sc">%&gt;%</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relabel</span>(</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x) <span class="fu">paste0</span>(<span class="st">"lambda == "</span>, x)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> value,</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> nu</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"identity"</span>,</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>lambda,</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">"free"</span>,</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"label_parsed"</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Observed Value"</span>) <span class="sc">+</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Frequency"</span>) <span class="sc">+</span></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>)</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="fu">expression</span>(nu)</span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It looks like the magnitude of counts increases with <span class="math inline">\(\lambda\)</span>, and decreases with <span class="math inline">\(\nu\)</span>. To get a more concrete view of this, lets compute the sample mean and variance for each iteration, and then average those over the simulations for each parameter combination. By doing this, we‚Äôll also get a sense of the sampling variability of these statistics when <span class="math inline">\(n=\)</span> 500.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>compoisson_sim1 <span class="sc">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each group</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lambda, nu, s) <span class="sc">%&gt;%</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the statistics</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean =</span> <span class="fu">mean</span>(value),</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variance =</span> <span class="fu">var</span>(value),</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send the statistics down the rows</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(Mean, Variance)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each group</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lambda, nu, name) <span class="sc">%&gt;%</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the mean/standard error</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean =</span> <span class="fu">mean</span>(value),</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">SE =</span> <span class="fu">sd</span>(value),</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join to get the average time for each iteration</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> </span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>      compoisson_sim1 <span class="sc">%&gt;%</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Remove the value, get unique rows</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>value) <span class="sc">%&gt;%</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For each group</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(lambda, nu) <span class="sc">%&gt;%</span></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compute the average time per iteration</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">time =</span> <span class="fu">mean</span>(time),</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> </span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"lambda"</span>,</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nu"</span></span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to factors</span></span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">nu =</span> </span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>      nu <span class="sc">%&gt;%</span></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relabel</span>(</span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x) <span class="fu">paste0</span>(<span class="st">"nu == "</span>, x)</span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> lambda,</span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Mean</span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> name</span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">1.25</span></span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> name</span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(</span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymin =</span> Mean <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>SE,</span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymax =</span> Mean <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>SE,</span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> name</span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">25</span></span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>nu,</span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">"free_y"</span>,</span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"label_parsed"</span></span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Value"</span>) <span class="sc">+</span></span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>)</span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">unique</span>(params<span class="sc">$</span>lambda)</span>
<span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(lambda)</span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
‚Ñπ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When <span class="math inline">\(\nu=0.5\)</span> (overdispersed), the counts become large quickly with an increasing <span class="math inline">\(\lambda\)</span>. As the data becomes more underdispersed (<span class="math inline">\(\nu &gt; 1\)</span>), the variance increases at a slower rate as <span class="math inline">\(\lambda\)</span> increases, relative to the mean.</p>
<p>So how does this translate to a regression model?</p>
</section>
</section>
<section id="compoissonregressionmodel" class="level2">
<h2 class="anchored" data-anchor-id="compoissonregressionmodel">The Regression Model</h2>
<p>It turns out that the model structure for COM-Poisson regression is very similar to the <a href="#modelformulation">standard Poisson model</a>. In fact, we can just copy and paste it from above:</p>
<p><span class="math display">\[log(\lambda_i) = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2}+...+\beta_px_{ip} = X_i\beta\]</span> The basic structure models the <span class="math inline">\(\lambda\)</span> parameter (on the log scale) as a linear combination of covariates. In turn, the steps for estimating the parameters are also the same:</p>
<ol type="1">
<li>Plug the regression formula into the COM-Poisson PDF</li>
<li>Derive the likelihood function</li>
<li>Compute the maximum likelihood estimates (MLEs)</li>
</ol>
<p>The only difference is that the <span class="math inline">\(\lambda\)</span> parameter in this model no longer <a href="#poissondistribution">represents the mean</a>. So when we generate fitted values or interpret parameter estimates, there has to be a little more care taken as to what those represent.</p>
<p>Let‚Äôs take a quick look at how to fit a model with the <code>glm.cmp</code> function and orient ourselves with its output. We‚Äôll use the <code>ed_volumes</code> dataset from the <a href="#reviewofpoisson">previous section</a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>compoisson_model1 <span class="ot">&lt;-</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Function to fit a COM-Poisson model</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm.cmp</span>(</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula.lambda =</span> Volume <span class="sc">~</span> Weekend <span class="sc">+</span> PM, <span class="co"># lamda parameter linear predictor</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>      ed_volumes <span class="sc">%&gt;%</span> </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">Weekend =</span> <span class="fu">weekdays</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>),</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">PM =</span> TimeOfDay <span class="sc">==</span> <span class="st">"PM"</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>compoisson_model1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CMP coefficients
              Estimate     SE  z-value   p-value
X:(Intercept)   2.8470 0.1531  18.5957 3.481e-77
X:WeekendTRUE  -0.4230 0.0323 -13.1174 2.619e-39
X:PMTRUE        0.0180 0.0195   0.9251    0.3549
S:(Intercept)   0.0217 0.0529   0.4096    0.6821
--
Transformed intercept-only parameters
   Estimate     SE
nu   1.0219 0.0541
--
Chi-squared test for equidispersion
X^2 = 0.1614, df = 1, p-value = 6.8788e-01
--
Elapsed: 0.39 sec   Sample size: 730   formula interface
LogLik: -2000.6310   AIC: 4009.2620   BIC: 4027.6341   
Optimization Method: L-BFGS-B   Converged status: 0
Message: CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH</code></pre>
</div>
</div>
<p>We see some familiar results. Namely, the parameter estimates and p-values are pretty similar to the standard Poisson model <a href="#modelformulation">above</a>. However, there is additional output‚Äìthis is where the dispersion comes in. When we fit the model, the function also estimated the value of the <span class="math inline">\(\nu\)</span> parameter, which in this case was 1.022 (it was expected to be near 1, given that our data was generated from a standard Poisson distribution). The <code>X</code> components make up the regression equation for <span class="math inline">\(\lambda\)</span>, and the <code>S</code> components make up the regression equation for <span class="math inline">\(\nu\)</span>. We just need to evaluate those equations on an observation‚Äôs covariate values, and we‚Äôll have its estimated conditional COM-Poisson distribution.</p>
</section>
<section id="compoissonlrt" class="level2">
<h2 class="anchored" data-anchor-id="compoissonlrt">Testing for Violations of Equidispersion</h2>
<p>We could just look at the estimated <span class="math inline">\(\nu\)</span> parameter and its standard error in the model output to draw a conclusion about the dispersion. Nevertheless, the package also provides a function called <code>equitest</code> to more formally carry out a <em>likelihood ratio test (LRT)</em> for the following hypotheses:</p>
<p><span class="math display">\[H_0: \nu = 1 \hskip.25in H_A: \nu \neq 1\]</span></p>
<p>It tests for evidence that the data is <em>not</em> equidispersed, but does not specify its direction. Therefore, if <span class="math inline">\(H_0\)</span> is rejected, it is up to us to garner from the model output whether there is over or under dispersion. Here is the output when performing this test on our model:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">equitest</span>(compoisson_model1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$teststat
[1] 0.1613952

$pvalue
[1] 0.6878752

$df
[1] 1</code></pre>
</div>
</div>
<p>As expected, the p-value of 0.6879 does not indicate that over or under dispersion was detected.</p>
</section>
<section id="stratifieddispersion" class="level2">
<h2 class="anchored" data-anchor-id="stratifieddispersion">Stratified Dispersion</h2>
<p>One of the coolest features of this modeling framework (in my opinion) is that not only can you fit a model for over or under dispersed data, but you can allow the dispersion parameter to vary by covariate values. You probably noticed the <code>formula.lambda</code> argument in the <code>glm.cmp</code> function call where we specified the model form for the <span class="math inline">\(\lambda\)</span> parameter. There is an additional argument called <code>formula.nu</code> where we can analogously specify a linear predictor for the <span class="math inline">\(\nu\)</span> parameter, which, like <span class="math inline">\(\lambda\)</span>, is on the <em>log</em> scale. This means that, for example, if we suspect that one group has <em>overdispersed</em> data, and another has <em>underdispersed</em> data, we can account for that within a single model. Very cool! Just for kicks, let‚Äôs see what this looks like when we allow the <span class="math inline">\(\nu\)</span> parameter to vary between AM and PM hours from our <code>ed_volumes</code> dataset:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>compoisson_model2 <span class="ot">&lt;-</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm.cmp</span>(</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula.lambda =</span> Volume <span class="sc">~</span> Weekend, <span class="co"># Linear predictor for log-lambda</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula.nu =</span> Volume <span class="sc">~</span> PM, <span class="co"># Linear predictor for log-nu</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>      ed_volumes <span class="sc">%&gt;%</span> </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">Weekend =</span> <span class="fu">weekdays</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>),</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">PM =</span> TimeOfDay <span class="sc">==</span> <span class="st">"PM"</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>compoisson_model2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CMP coefficients
              Estimate     SE  z-value   p-value
X:(Intercept)   2.8562 0.1532  18.6442 1.407e-77
X:WeekendTRUE  -0.4231 0.0322 -13.1194 2.549e-39
S:(Intercept)   0.0250 0.0530   0.4708    0.6378
S:PMTRUE       -0.0064 0.0069  -0.9317    0.3515
--
Chi-squared test for equidispersion
X^2 = 1.0119, df = 2, p-value = 6.0295e-01
--
Elapsed: 0.48 sec   Sample size: 730   formula interface
LogLik: -2000.6243   AIC: 4009.2487   BIC: 4027.6208   
Optimization Method: L-BFGS-B   Converged status: 0
Message: CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH</code></pre>
</div>
</div>
<p>We can see that there are now two parameters associated with the <code>S</code> component of the model. We can simply evaluate and exponentiate those terms to get the <span class="math inline">\(\nu\)</span> estimates for each group:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a simple design matrix</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>nu_design <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Multiply by the S component of the model</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>nu_log_estimates <span class="ot">&lt;-</span> nu_design <span class="sc">%*%</span> <span class="fu">as.matrix</span>(compoisson_model2<span class="sc">$</span>gamma)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Exponentiate</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>nu_estimates <span class="ot">&lt;-</span> <span class="fu">exp</span>(nu_log_estimates)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the names</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(nu_estimates) <span class="ot">&lt;-</span> <span class="fu">names</span>(compoisson_model2<span class="sc">$</span>gamma)</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>nu_estimates</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                  [,1]
S:(Intercept) 1.025285
S:PMTRUE      1.018696</code></pre>
</div>
</div>
<p>Again, both groups‚Äô data were knowingly generated from a standard Poisson distribution here, so we expected the conditional estimates to be near 1 as well. Nevertheless, it illustrates the power and flexibility of this framework.</p>
</section>
<section id="comfittedvalues" class="level2">
<h2 class="anchored" data-anchor-id="comfittedvalues">Generating Fitted Values</h2>
<p>As <a href="#compoissonmeanapprox">previously mentioned</a>, there is no closed form solution for the mean of a COM-Poisson random variable. So when we generate fitted values from the model‚Äôs linear predictor, it is hard to conceptualize what they represent (it is <em>NOT</em> the mean). Since our model <em>does</em> produce estimates for both <span class="math inline">\(\lambda\)</span> and <span class="math inline">\(\nu\)</span>, the <a href="https://projecteuclid.org/journals/annals-of-applied-statistics/volume-4/issue-2/A-flexible-regression-model-for-count-data/10.1214/09-AOAS306.full">recommendation</a> is to plug these into the inverse cumulative density function (CDF) to obtain quantile-based fitted values. Specifically, we can use the <em>median</em>. The figure below displays the median and <span class="math inline">\(25^{th}\)</span>/<span class="math inline">\(75^{th}\)</span> percentiles from the parameter grid used in the <a href="#centralitysimulation">simulation above</a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>params <span class="sc">%&gt;%</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the quantiles</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">Quantile =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.50</span>, <span class="fl">0.75</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">character</span>()</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the value</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">Value =</span> <span class="fu">qcmp</span>(Quantile, lambda, nu),</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">Linegroup =</span> <span class="fu">factor</span>(Quantile <span class="sc">==</span> <span class="fl">0.50</span>) <span class="sc">%&gt;%</span> <span class="fu">fct_rev</span>(),</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">nu =</span> </span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>      nu <span class="sc">%&gt;%</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relabel</span>(</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x) <span class="fu">paste0</span>(<span class="st">"nu == "</span>, x)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> lambda,</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Value,</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> Quantile</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">linetype =</span> Linegroup,</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> Linegroup</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">1.25</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">2</span></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>nu,</span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">"free_y"</span>,</span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"label_parsed"</span></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Median &amp; 25th/75th Percentiles"</span>) <span class="sc">+</span></span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>)</span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">unique</span>(params<span class="sc">$</span>lambda)</span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(lambda)</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>)</span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `by = character()` to perform a cross join was deprecated in dplyr 1.1.0.
‚Ñπ Please use `cross_join()` instead.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The median values seem to have a relatively similar behavior to the simulated means.</p>
<p>So, to obtain <em>predicted</em> values with our model object (we‚Äôll use the <a href="#compoissonregressionmodel">first model we made</a>), we have to:</p>
<ol type="1">
<li>Produce observation-level estimates of <span class="math inline">\(\lambda\)</span> and <span class="math inline">\(\nu\)</span> with the regression equation</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Multiply the design matrices by the parameter estimates for each linear predictor, then exponentiate</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>lambda_hat <span class="ot">&lt;-</span> <span class="fu">exp</span>(compoisson_model1<span class="sc">$</span>X <span class="sc">%*%</span> <span class="fu">as.matrix</span>(compoisson_model1<span class="sc">$</span>beta))</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>nu_hat <span class="ot">&lt;-</span> <span class="fu">exp</span>(compoisson_model1<span class="sc">$</span>S <span class="sc">%*%</span> <span class="fu">as.matrix</span>(compoisson_model1<span class="sc">$</span>gamma))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(lambda_hat, nu_hat))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  lambda_hat   nu_hat
1   17.23626 1.021921
2   17.54978 1.021921
3   17.23626 1.021921
4   17.54978 1.021921
5   17.23626 1.021921
6   17.54978 1.021921</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Plug the estimates into the inverse CDF at the 50th percentile</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>y_hat <span class="ot">&lt;-</span> <span class="fu">qcmp</span>(<span class="fu">rep</span>(<span class="fl">0.5</span>, <span class="fu">length</span>(lambda_hat)), <span class="at">lambda =</span> lambda_hat, <span class="at">nu =</span> nu_hat)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(y_hat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>y_hat
 11  16 
208 522 </code></pre>
</div>
</div>
<p>There does exist a <code>predict.cmp</code> function that uses the <a href="#compoissonmeanapprox">mean approximation</a> by default, so this could be used for fitted values as well if those conditions are satisfied.</p>
</section>
<section id="compowersim" class="level2">
<h2 class="anchored" data-anchor-id="compowersim">Simulation: Power of Equidispersion Test</h2>
<p>So how well does the likelihood ratio test <a href="#compoissonlrt">described above</a> detect over or under dispersion in the data-generating process? We can use simulation! To keep it simple, we will base it off of intercept-only regression models (i.e., no covariates), in effect assessing power at varying values of <span class="math inline">\(\lambda\)</span>. Presumably, power may depend on the complexity of the model, so coverage might vary as terms are added. Here are the parameter values we will consider:</p>
<p><span class="math display">\[
\begin{equation}
\begin{split}
\lambda &amp; = (1, 3, 5, 10, 25) \\
\nu &amp; = (0.5, 0.75, 1, 1.25, 1.5, 2) \\
N &amp; = (25, 50, 100, 500) \\
\end{split}
\end{equation}
\]</span></p>
<p>With those, we will take the following steps to carry out the simulation <em>for each combination of <span class="math inline">\(\lambda\)</span>, <span class="math inline">\(\nu\)</span>, and <span class="math inline">\(N\)</span></em>:</p>
<ol type="1">
<li>Generate <span class="math inline">\(N\)</span> random COM-Poisson realizations</li>
<li>Fit an intercept-only COM-Poisson regression model</li>
<li>Conduct the likelihood ratio test for equidispersion</li>
<li>Calculate the p-value from (3)</li>
<li>Repeat steps 1-4 for 100 iterations</li>
<li>Compute the proportion of iterations in (5) where the p-value was less than 0.05</li>
</ol>
<p>The following code chunk carries out these steps:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: THIS CHUNK TAKES A WHILE TO RUN</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of iterations</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>power_results <span class="ot">&lt;-</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parameter set</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">25</span>),</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">nu =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="dv">1</span>, <span class="fl">1.25</span>, <span class="fl">1.5</span>, <span class="dv">2</span>),</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">N  =</span> <span class="fu">c</span>(<span class="dv">25</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">500</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the cross product</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cross_df</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Split into a list</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.)) <span class="sc">%&gt;%</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each parameter combination</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_df</span>(</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) {</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Generate all CMP realizations</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">S =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>sims, x<span class="sc">$</span>N),</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">Y =</span> <span class="fu">rcmp</span>(<span class="at">n =</span> x<span class="sc">$</span>N <span class="sc">*</span> sims, <span class="at">lambda =</span> x<span class="sc">$</span>lambda, <span class="at">nu =</span> x<span class="sc">$</span>nu)</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each iteration</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(S) <span class="sc">%&gt;%</span></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute the p-value</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>          <span class="at">PValue =</span> </span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>            <span class="fu">tryCatch</span>(</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>              <span class="fu">equitest</span>(<span class="fu">glm.cmp</span>(Y <span class="sc">~</span> <span class="dv">1</span>))<span class="sc">$</span>pvalue,</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>              <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NA_real_</span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>          <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add the parameter values</span></span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>          <span class="at">lambda =</span> x<span class="sc">$</span>lambda,</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>          <span class="at">nu =</span> x<span class="sc">$</span>nu,</span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>          <span class="at">N =</span> x<span class="sc">$</span>N</span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This code took quite a while to run (~4 hours). I‚Äôve noticed the fitting procedure takes a bit longer than we‚Äôd be used to with a simple <code>glm</code> call (which is probably expected given the complexity of the estimation), and varies depending on the combination of parameter values. It‚Äôs also worth noting that it failed to converge on 0.9% of simulations, which tended to only occur when there was overdispersion (<span class="math inline">\(\nu=0.5\)</span>) with large counts (<span class="math inline">\(\lambda &gt; 5\)</span>). Nevertheless, the figure below gives us the results of the simulation showing the estimated power for each parameter combination:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>power_results <span class="sc">%&gt;%</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each group</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lambda, nu, N) <span class="sc">%&gt;%</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the power, and a measure of simulation error</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Power =</span> <span class="fu">mean</span>(PValue <span class="sc">&lt;=</span> <span class="fl">0.05</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">SE =</span> <span class="fu">sd</span>(PValue <span class="sc">&lt;=</span> <span class="fl">0.05</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">n</span>()),</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a factor</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">factor</span>(N),</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">nu =</span> </span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>      nu <span class="sc">%&gt;%</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relabel</span>(</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x) <span class="fu">paste0</span>(<span class="st">"nu == "</span>, x)</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> lambda,</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Power</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> N</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> N</span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(</span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymin =</span> Power <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>SE,</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymax =</span> Power <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>SE,</span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> N</span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">35</span></span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>nu,</span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"label_parsed"</span></span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Power"</span>) <span class="sc">+</span></span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>)</span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">unique</span>(power_results<span class="sc">$</span>lambda)</span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(lambda)</span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Findings</strong>:</p>
<ul>
<li>The power increases with sample size and deviation from <span class="math inline">\(\nu=1\)</span></li>
<li>The test has a much harder time detecting over/under dispersion when the counts are really small (i.e., <span class="math inline">\(\lambda = 1\)</span>)</li>
<li>When there is overdispersion (<span class="math inline">\(\nu&lt;1\)</span>), the power looks higher at lower values of <span class="math inline">\(\lambda\)</span>, but the opposite occurs as the data becomes more underdispersed</li>
</ul>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>The COM-Poisson regression framework is another tool in the toolbox to consider when modeling count data. Given that it is a generalization of the standard Poisson model that handles both over and under dispersed data, a good strategy may be to use it as a starting point to explore the variability in a dataset, and then shape the model from there. The likelihood ratio test allows us to test for violations of equidispersion, at which point we can use estimation to identify the direction that the dispersion exists. Since there are popular methods to handle overdispersed data (e.g., negative binomial models), the real void this method fills is its handling of underdispersed data‚Äìthe challenge there may simply be finding the use case.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.zajichekstats\.com\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb51" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Exploring COM Poisson regression"</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "A method for underdispersed count data"</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Alex Zajichek"</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "12/28/2021"</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> "feature.png"</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - Regression</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>A few years ago I encountered an interesting count distribution during a modeling project. The goal was to model the number of <span class="co">[</span><span class="ot">suture anchors</span><span class="co">](https://www.shoulderdoc.co.uk/article/538)</span> used in rotator-cuff tendon tears, and how that was influenced by tear characteristics and surgeon preference. My instinct was to fit a <span class="co">[</span><span class="ot">Poisson</span><span class="co">](https://en.wikipedia.org/wiki/Poisson_distribution)</span> model, but the target took on relatively small values and was also non-zero, so I had to do some digging for an alternative approach. I came across a method called Conway-Maxwell (COM) Poisson regression, which not only allowed for _overdispersion_ (i.e., the population variance is greater than its mean), but also _underdispersion_. It hit me that I had never come across methodology for the latter and it seemed to align with my problem, so I was intrigued (Full Disclosure: I heard of COM-Poisson prior to that, albeit knew nothing about it, when one of my super smart graduate school buddies was doing research on it, so that's also why it stuck). </span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>Long story short, we didn't end up using the COM-Poisson model for the <span class="co">[</span><span class="ot">anchor project</span><span class="co">]</span>(https://www.jshoulderelbow.org/article/S1058-2746(18)30555-X/fulltext) <span class="in">`r emo::ji("grin")`</span>, and instead went in favor of <span class="co">[</span><span class="ot">Zero-Truncated Poisson regression</span><span class="co">](https://stats.oarc.ucla.edu/r/dae/zero-truncated-poisson/)</span>. Nevertheless I thought it was an awesome method that warranted further exploration and later did a <span class="co">[</span><span class="ot">talk</span><span class="co">](NonTraditionalCountRegression.pdf)</span> on it. That was a few years ago--so this article is intended to be a reworking of that talk to relearn it for myself, but also to get the word out about this awesome method! All code is written in R.</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="fu"># Table Of Contents</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">A Review of Poisson Regression</span><span class="co">](#reviewofpoisson)</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">The Poisson Distribution</span><span class="co">](#poissondistribution)</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">Model Formulation</span><span class="co">](#modelformulation)</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Conway-Maxwell (COM) Poisson Regression</span><span class="co">](#compoisson)</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">The COM-Poisson Distribution</span><span class="co">](#compoissondistribution)</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">The Regression Model</span><span class="co">](#compoissonregressionmodel)</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">Testing for Violations of Equidispersion</span><span class="co">](#compoissonlrt)</span></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">Stratified Dispersion</span><span class="co">](#stratifieddispersion)</span></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">Generating Fitted Values</span><span class="co">](#comfittedvalues)</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">Simulation: Power of Equidispersion Test</span><span class="co">](#compowersim)</span></span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Conclusion</span><span class="co">](#conclusion)</span></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Code Appendix</span><span class="co">](#codeappendix)</span></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a><span class="fu"># A Review of Poisson Regression {#reviewofpoisson}</span></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>I really like making up examples, so lets start with that:</span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>Suppose hospital administrators are interested in emergency department (ED) utilization and have asked a few questions:</span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>How many patients can we expect to see in a given day?</span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>What is the likelihood that we see more than 40 patients in a single day?</span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Do we see more variation during the week versus weekend, or in the AM versus PM hours?</span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>To expedite the process, we're given a pre-built dataset called <span class="in">`ed_volumes`</span> containing the number of patients entering the ED each (half) day over the past calendar year.</span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages</span></span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Set a seed</span></span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a><span class="do">### 1. Create simulated dataset</span></span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Generating a random Poisson parameter</span></span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a>ed_true_mean <span class="ot">&lt;-</span></span>
<span id="cb51-59"><a href="#cb51-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">runif</span>(</span>
<span id="cb51-60"><a href="#cb51-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="dv">1</span>,</span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">min =</span> <span class="fl">12.5</span>,</span>
<span id="cb51-62"><a href="#cb51-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">max =</span> <span class="dv">25</span></span>
<span id="cb51-63"><a href="#cb51-63" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the dataset</span></span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a>ed_volumes <span class="ot">&lt;-</span></span>
<span id="cb51-67"><a href="#cb51-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb51-68"><a href="#cb51-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">Date =</span> <span class="fu">rep</span>(<span class="fu">as.Date</span>(<span class="st">"2021-12-31"</span>) <span class="sc">-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">364</span>, <span class="dv">1</span>), <span class="dv">2</span>),</span>
<span id="cb51-69"><a href="#cb51-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">TimeOfDay =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"AM"</span>, <span class="fu">length</span>(Date) <span class="sc">/</span> <span class="dv">2</span>), <span class="fu">rep</span>(<span class="st">"PM"</span>, <span class="fu">length</span>(Date) <span class="sc">/</span> <span class="dv">2</span>)),</span>
<span id="cb51-70"><a href="#cb51-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">Volume =</span> </span>
<span id="cb51-71"><a href="#cb51-71" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rpois</span>(</span>
<span id="cb51-72"><a href="#cb51-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">n =</span> <span class="fu">length</span>(Date), </span>
<span id="cb51-73"><a href="#cb51-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda =</span> <span class="fu">ifelse</span>(<span class="fu">weekdays</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>), ed_true_mean <span class="sc">-</span> <span class="dv">5</span>, ed_true_mean)</span>
<span id="cb51-74"><a href="#cb51-74" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb51-75"><a href="#cb51-75" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-76"><a href="#cb51-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(</span>
<span id="cb51-77"><a href="#cb51-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">desc</span>(Date),</span>
<span id="cb51-78"><a href="#cb51-78" aria-hidden="true" tabindex="-1"></a>    TimeOfDay</span>
<span id="cb51-79"><a href="#cb51-79" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-80"><a href="#cb51-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-81"><a href="#cb51-81" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-82"><a href="#cb51-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-85"><a href="#cb51-85" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-86"><a href="#cb51-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Load some packages</span></span>
<span id="cb51-87"><a href="#cb51-87" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span>
<span id="cb51-88"><a href="#cb51-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-89"><a href="#cb51-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the dataset</span></span>
<span id="cb51-90"><a href="#cb51-90" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ed_volumes, <span class="at">n =</span> <span class="dv">5</span>)</span>
<span id="cb51-91"><a href="#cb51-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-92"><a href="#cb51-92" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-93"><a href="#cb51-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-94"><a href="#cb51-94" aria-hidden="true" tabindex="-1"></a>First, let's take a look at the distribution of total daily patient volume over the time period:</span>
<span id="cb51-95"><a href="#cb51-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-98"><a href="#cb51-98" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-99"><a href="#cb51-99" aria-hidden="true" tabindex="-1"></a>ed_volumes <span class="sc">%&gt;%</span></span>
<span id="cb51-100"><a href="#cb51-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-101"><a href="#cb51-101" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each date</span></span>
<span id="cb51-102"><a href="#cb51-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb51-103"><a href="#cb51-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-104"><a href="#cb51-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the total </span></span>
<span id="cb51-105"><a href="#cb51-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb51-106"><a href="#cb51-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">Volume =</span> <span class="fu">sum</span>(Volume),</span>
<span id="cb51-107"><a href="#cb51-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb51-108"><a href="#cb51-108" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-109"><a href="#cb51-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-110"><a href="#cb51-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb51-111"><a href="#cb51-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb51-112"><a href="#cb51-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb51-113"><a href="#cb51-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-114"><a href="#cb51-114" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Volume</span>
<span id="cb51-115"><a href="#cb51-115" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-116"><a href="#cb51-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"gray"</span>,</span>
<span id="cb51-117"><a href="#cb51-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb51-118"><a href="#cb51-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">30</span></span>
<span id="cb51-119"><a href="#cb51-119" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-120"><a href="#cb51-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb51-121"><a href="#cb51-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-122"><a href="#cb51-122" aria-hidden="true" tabindex="-1"></a>      <span class="at">xintercept =</span> <span class="fu">mean</span>(Volume)</span>
<span id="cb51-123"><a href="#cb51-123" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-124"><a href="#cb51-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"#b84f48"</span></span>
<span id="cb51-125"><a href="#cb51-125" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-126"><a href="#cb51-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb51-127"><a href="#cb51-127" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-128"><a href="#cb51-128" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">mean</span>(Volume) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb51-129"><a href="#cb51-129" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="dv">41</span>,</span>
<span id="cb51-130"><a href="#cb51-130" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="fu">str_c</span>(<span class="st">"Avg: "</span>, <span class="fu">round</span>(<span class="fu">mean</span>(Volume), <span class="dv">1</span>), <span class="st">" patients"</span>)</span>
<span id="cb51-131"><a href="#cb51-131" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-132"><a href="#cb51-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"#b84f48"</span>,</span>
<span id="cb51-133"><a href="#cb51-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="sc">-</span>.<span class="dv">15</span></span>
<span id="cb51-134"><a href="#cb51-134" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-135"><a href="#cb51-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Daily Patient Volume"</span>) <span class="sc">+</span></span>
<span id="cb51-136"><a href="#cb51-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Frequency"</span>) <span class="sc">+</span></span>
<span id="cb51-137"><a href="#cb51-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb51-138"><a href="#cb51-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb51-139"><a href="#cb51-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb51-140"><a href="#cb51-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-141"><a href="#cb51-141" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-142"><a href="#cb51-142" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb51-143"><a href="#cb51-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>)</span>
<span id="cb51-144"><a href="#cb51-144" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-145"><a href="#cb51-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-146"><a href="#cb51-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-147"><a href="#cb51-147" aria-hidden="true" tabindex="-1"></a>There were <span class="in">`r round(mean(with(ed_volumes, tapply(Volume, Date, sum))), 1)`</span> patients per day on average, ranging from <span class="in">`r min(range(with(ed_volumes, tapply(Volume, Date, sum))))`</span> to <span class="in">`r max(range(with(ed_volumes, tapply(Volume, Date, sum))))`</span>. Knowing that this is a count distribution, we think to use a Poisson model to provide our estimates for the first two questions. Let's remind ourselves of the specifics:</span>
<span id="cb51-148"><a href="#cb51-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-149"><a href="#cb51-149" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Poisson Distribution {#poissondistribution}</span></span>
<span id="cb51-150"><a href="#cb51-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-151"><a href="#cb51-151" aria-hidden="true" tabindex="-1"></a>If the probability mass function (PMF) for a non-negative, integer-valued $Y$ is:</span>
<span id="cb51-152"><a href="#cb51-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-153"><a href="#cb51-153" aria-hidden="true" tabindex="-1"></a>$$P(Y = y|\lambda) = \frac{e^{-\lambda}\lambda^y}{y!}$$</span>
<span id="cb51-154"><a href="#cb51-154" aria-hidden="true" tabindex="-1"></a>then $Y$ is distributed as a Poisson random variable, and has the following property:</span>
<span id="cb51-155"><a href="#cb51-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-156"><a href="#cb51-156" aria-hidden="true" tabindex="-1"></a>$$E<span class="co">[</span><span class="ot">Y</span><span class="co">]</span> = \lambda$$</span>
<span id="cb51-157"><a href="#cb51-157" aria-hidden="true" tabindex="-1"></a>It turns out that the maximum likelihood estimator (MLE) for $\lambda$ is the <span class="co">[</span><span class="ot">sample average</span><span class="co">](https://www.statlect.com/fundamentals-of-statistics/Poisson-distribution-maximum-likelihood)</span>. Remembering this, _we provide the estimate for the first question to be `r ceiling(mean(with(ed_volumes, tapply(Volume, Date, sum))))` patients. (rounding up)_</span>
<span id="cb51-158"><a href="#cb51-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-161"><a href="#cb51-161" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-162"><a href="#cb51-162" aria-hidden="true" tabindex="-1"></a>lambda_hat <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">with</span>(ed_volumes, <span class="fu">tapply</span>(Volume, Date, sum)))</span>
<span id="cb51-163"><a href="#cb51-163" aria-hidden="true" tabindex="-1"></a>lambda_hat</span>
<span id="cb51-164"><a href="#cb51-164" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-165"><a href="#cb51-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-166"><a href="#cb51-166" aria-hidden="true" tabindex="-1"></a>We also know that once we have an estimate for $\lambda$ that we can compute probabilities by plugging it into the PMF:</span>
<span id="cb51-167"><a href="#cb51-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-168"><a href="#cb51-168" aria-hidden="true" tabindex="-1"></a>$$P(Y&gt;40) = 1 - P(Y\leq40) = 1 - \sum_{y=0}^{40} \frac{e^{-\lambda}\lambda^y}{y!}$$</span>
<span id="cb51-171"><a href="#cb51-171" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-172"><a href="#cb51-172" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">40</span></span>
<span id="cb51-173"><a href="#cb51-173" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>lambda_hat) <span class="sc">*</span> lambda_hat<span class="sc">^</span>y <span class="sc">/</span> <span class="fu">factorial</span>(y)</span>
<span id="cb51-174"><a href="#cb51-174" aria-hidden="true" tabindex="-1"></a>question2 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(p)</span>
<span id="cb51-175"><a href="#cb51-175" aria-hidden="true" tabindex="-1"></a>question2</span>
<span id="cb51-176"><a href="#cb51-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-177"><a href="#cb51-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative approach</span></span>
<span id="cb51-178"><a href="#cb51-178" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">-</span> <span class="fu">ppois</span>(<span class="dv">40</span>, lambda_hat)</span>
<span id="cb51-179"><a href="#cb51-179" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-180"><a href="#cb51-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-181"><a href="#cb51-181" aria-hidden="true" tabindex="-1"></a>_We estimate that there is a `r round(question2*100,1)`% chance that we will see more than 40 patients in the ED in a single day_--done with the first two questions! </span>
<span id="cb51-182"><a href="#cb51-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-183"><a href="#cb51-183" aria-hidden="true" tabindex="-1"></a><span class="in">`r emo::ji("scared")`</span></span>
<span id="cb51-184"><a href="#cb51-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-185"><a href="#cb51-185" aria-hidden="true" tabindex="-1"></a>Unfortunately, we missed a crucial assumption about the Poisson distribution that we didn't account for:</span>
<span id="cb51-186"><a href="#cb51-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-187"><a href="#cb51-187" aria-hidden="true" tabindex="-1"></a>$$E<span class="co">[</span><span class="ot">Y</span><span class="co">]</span> = Var<span class="co">[</span><span class="ot">Y</span><span class="co">]</span>$$</span>
<span id="cb51-188"><a href="#cb51-188" aria-hidden="true" tabindex="-1"></a>The estimates we provided assumed that the mean and variance of our underlying distribution were equal. The sample variance was <span class="in">`r round(var(with(ed_volumes, tapply(Volume, Date, sum))), 1)`</span> which is considerably larger than the mean of <span class="in">`r round(mean(with(ed_volumes, tapply(Volume, Date, sum))), 1)`</span>. Here is what an actual Poisson distribution looks like with $\lambda$ = <span class="in">`r round(mean(with(ed_volumes, tapply(Volume, Date, sum))), 1)`</span> (our sample average) in comparison with the observed data:</span>
<span id="cb51-189"><a href="#cb51-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-192"><a href="#cb51-192" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-193"><a href="#cb51-193" aria-hidden="true" tabindex="-1"></a>ed_volumes <span class="sc">%&gt;%</span></span>
<span id="cb51-194"><a href="#cb51-194" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-195"><a href="#cb51-195" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the total for each date</span></span>
<span id="cb51-196"><a href="#cb51-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb51-197"><a href="#cb51-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb51-198"><a href="#cb51-198" aria-hidden="true" tabindex="-1"></a>    <span class="at">Volume =</span> <span class="fu">sum</span>(Volume),</span>
<span id="cb51-199"><a href="#cb51-199" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb51-200"><a href="#cb51-200" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-201"><a href="#cb51-201" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-202"><a href="#cb51-202" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count the occurrences of each daily volume</span></span>
<span id="cb51-203"><a href="#cb51-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Volume) <span class="sc">%&gt;%</span></span>
<span id="cb51-204"><a href="#cb51-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb51-205"><a href="#cb51-205" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb51-206"><a href="#cb51-206" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb51-207"><a href="#cb51-207" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-208"><a href="#cb51-208" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-209"><a href="#cb51-209" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the observed and theoretical relative frequencies</span></span>
<span id="cb51-210"><a href="#cb51-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb51-211"><a href="#cb51-211" aria-hidden="true" tabindex="-1"></a>    <span class="at">Observed =</span> N <span class="sc">/</span> <span class="fu">sum</span>(N),</span>
<span id="cb51-212"><a href="#cb51-212" aria-hidden="true" tabindex="-1"></a>    <span class="at">Theoretical =</span> <span class="fu">dpois</span>(Volume, <span class="at">lambda =</span> lambda_hat)</span>
<span id="cb51-213"><a href="#cb51-213" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-214"><a href="#cb51-214" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-215"><a href="#cb51-215" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove raw count</span></span>
<span id="cb51-216"><a href="#cb51-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>N) <span class="sc">%&gt;%</span> </span>
<span id="cb51-217"><a href="#cb51-217" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-218"><a href="#cb51-218" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb51-219"><a href="#cb51-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb51-220"><a href="#cb51-220" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-221"><a href="#cb51-221" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Volume</span>
<span id="cb51-222"><a href="#cb51-222" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-223"><a href="#cb51-223" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-224"><a href="#cb51-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(</span>
<span id="cb51-225"><a href="#cb51-225" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-226"><a href="#cb51-226" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Observed,</span>
<span id="cb51-227"><a href="#cb51-227" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">"Observed Data"</span></span>
<span id="cb51-228"><a href="#cb51-228" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-229"><a href="#cb51-229" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span></span>
<span id="cb51-230"><a href="#cb51-230" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-231"><a href="#cb51-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(</span>
<span id="cb51-232"><a href="#cb51-232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-233"><a href="#cb51-233" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Theoretical,</span>
<span id="cb51-234"><a href="#cb51-234" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">"Actual Poisson"</span></span>
<span id="cb51-235"><a href="#cb51-235" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-236"><a href="#cb51-236" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">25</span>,</span>
<span id="cb51-237"><a href="#cb51-237" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span></span>
<span id="cb51-238"><a href="#cb51-238" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-239"><a href="#cb51-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb51-240"><a href="#cb51-240" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-241"><a href="#cb51-241" aria-hidden="true" tabindex="-1"></a>      <span class="at">xintercept =</span> lambda_hat</span>
<span id="cb51-242"><a href="#cb51-242" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-243"><a href="#cb51-243" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"#b84f48"</span></span>
<span id="cb51-244"><a href="#cb51-244" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-245"><a href="#cb51-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Daily Patient Volume"</span>) <span class="sc">+</span></span>
<span id="cb51-246"><a href="#cb51-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Relative Frequency (%)"</span>) <span class="sc">+</span></span>
<span id="cb51-247"><a href="#cb51-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb51-248"><a href="#cb51-248" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb51-249"><a href="#cb51-249" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-250"><a href="#cb51-250" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb51-251"><a href="#cb51-251" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb51-252"><a href="#cb51-252" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-253"><a href="#cb51-253" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-254"><a href="#cb51-254" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb51-255"><a href="#cb51-255" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>)</span>
<span id="cb51-256"><a href="#cb51-256" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-257"><a href="#cb51-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb51-258"><a href="#cb51-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"gray"</span>))</span>
<span id="cb51-259"><a href="#cb51-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-260"><a href="#cb51-260" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-261"><a href="#cb51-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-262"><a href="#cb51-262" aria-hidden="true" tabindex="-1"></a>The tails of the observed sample are heavier than a Poisson would be with the same mean. Therefore, the estimates we provided for questions 1 and 2 are probably not very accurate. Let's take a different approach: _answer question 3 first, and then work our way back to the other two._ </span>
<span id="cb51-263"><a href="#cb51-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-264"><a href="#cb51-264" aria-hidden="true" tabindex="-1"></a>As a reminder, we want to assess whether there is more variation in patient volume during the week versus weekend, or in the AM versus PM hours. To get this comparison, we need a way to simultaneously estimate the effect of each of these factors on the patient volume: enter Poisson regression. </span>
<span id="cb51-265"><a href="#cb51-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-266"><a href="#cb51-266" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Formulation {#modelformulation}</span></span>
<span id="cb51-267"><a href="#cb51-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-268"><a href="#cb51-268" aria-hidden="true" tabindex="-1"></a>Just like other <span class="co">[</span><span class="ot">generalized linear models</span><span class="co">](https://en.wikipedia.org/wiki/Generalized_linear_model)</span> (GLM), a Poisson regression model estimates the population average (the same average as described above!), _but conditioned on a set of covariates_. </span>
<span id="cb51-269"><a href="#cb51-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-270"><a href="#cb51-270" aria-hidden="true" tabindex="-1"></a>More formally, for a given set of covariates $x_1, x_2, .., x_p$, we assume the following functional form:</span>
<span id="cb51-271"><a href="#cb51-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-272"><a href="#cb51-272" aria-hidden="true" tabindex="-1"></a>$$log(\lambda_i) = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2}+...+\beta_px_{ip} = X_i\beta$$</span>
<span id="cb51-273"><a href="#cb51-273" aria-hidden="true" tabindex="-1"></a>This _log-linear_ model allows us to estimate the mean number of events (i.e., the Poisson parameter $\lambda$) for a given arrangement of covariate values. We also get informative interpretation of the individual effects of each covariate. For our example, the model looks like this:</span>
<span id="cb51-274"><a href="#cb51-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-275"><a href="#cb51-275" aria-hidden="true" tabindex="-1"></a>$$log(\lambda_i) = \beta_0 + \beta_{weekend}x_{i_{weekend}} + \beta_{PM}x_{i_{PM}}$$</span>
<span id="cb51-276"><a href="#cb51-276" aria-hidden="true" tabindex="-1"></a>where $\lambda_i$ is the expected (half-day) patient volume, $x_{i_{weekend}} = 1$ if it is Saturday or Sunday, and $x_{i_{PM}} = 1$ if it is PM hours (and they are 0 otherwise). We can take the following steps to estimate the $\beta$ parameters:</span>
<span id="cb51-277"><a href="#cb51-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-278"><a href="#cb51-278" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Plug the regression formula into the Poisson PMF</span>
<span id="cb51-279"><a href="#cb51-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-280"><a href="#cb51-280" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb51-281"><a href="#cb51-281" aria-hidden="true" tabindex="-1"></a>\begin{equation} </span>
<span id="cb51-282"><a href="#cb51-282" aria-hidden="true" tabindex="-1"></a>\begin{split}</span>
<span id="cb51-283"><a href="#cb51-283" aria-hidden="true" tabindex="-1"></a>P(Y_i = y_i|\lambda_i) &amp; = \frac{e^{-\lambda_i}\lambda_i^{y_i}}{y_i!} <span class="sc">\\</span></span>
<span id="cb51-284"><a href="#cb51-284" aria-hidden="true" tabindex="-1"></a>&amp; = \frac{e^{-e^{X_i\beta}}{(e^{X_i\beta})}^{y_i}}{y_i!} <span class="sc">\\</span></span>
<span id="cb51-285"><a href="#cb51-285" aria-hidden="true" tabindex="-1"></a>\end{split}</span>
<span id="cb51-286"><a href="#cb51-286" aria-hidden="true" tabindex="-1"></a>\end{equation}</span>
<span id="cb51-287"><a href="#cb51-287" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb51-288"><a href="#cb51-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-289"><a href="#cb51-289" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Derive the likelihood function</span>
<span id="cb51-290"><a href="#cb51-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-291"><a href="#cb51-291" aria-hidden="true" tabindex="-1"></a>$$L(\lambda_i) = \prod_{i=1}^N \frac{e^{-e^{X_i\beta}}{(e^{X_i\beta})}^{y_i}}{y_i!} <span class="sc">\\</span>$$</span>
<span id="cb51-292"><a href="#cb51-292" aria-hidden="true" tabindex="-1"></a>where $N$ is the total number of (half) days.</span>
<span id="cb51-293"><a href="#cb51-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-294"><a href="#cb51-294" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Compute the MLE's</span>
<span id="cb51-295"><a href="#cb51-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-296"><a href="#cb51-296" aria-hidden="true" tabindex="-1"></a>$$\hat{\beta} = max_{\beta} L(\lambda_i)<span class="sc">\\</span>$$</span>
<span id="cb51-297"><a href="#cb51-297" aria-hidden="true" tabindex="-1"></a>$\hat{\beta}$ is the set of estimated parameter values computed from maximizing the likelihood function. Once we have these, we can plug them into the regression formula, and away we go! Luckily, our software will compute these for us--all we need to do is supply the data.</span>
<span id="cb51-298"><a href="#cb51-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-301"><a href="#cb51-301" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-302"><a href="#cb51-302" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a generalized linear model</span></span>
<span id="cb51-303"><a href="#cb51-303" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span></span>
<span id="cb51-304"><a href="#cb51-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(</span>
<span id="cb51-305"><a href="#cb51-305" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> Volume <span class="sc">~</span> Weekend <span class="sc">+</span> PM, <span class="co"># Specify the model form</span></span>
<span id="cb51-306"><a href="#cb51-306" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="co"># Supply the data</span></span>
<span id="cb51-307"><a href="#cb51-307" aria-hidden="true" tabindex="-1"></a>      ed_volumes <span class="sc">%&gt;%</span> </span>
<span id="cb51-308"><a href="#cb51-308" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb51-309"><a href="#cb51-309" aria-hidden="true" tabindex="-1"></a>        <span class="at">Weekend =</span> <span class="fu">weekdays</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>),</span>
<span id="cb51-310"><a href="#cb51-310" aria-hidden="true" tabindex="-1"></a>        <span class="at">PM =</span> TimeOfDay <span class="sc">==</span> <span class="st">"PM"</span></span>
<span id="cb51-311"><a href="#cb51-311" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb51-312"><a href="#cb51-312" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"poisson"</span> <span class="co"># Indicate the likelihood</span></span>
<span id="cb51-313"><a href="#cb51-313" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-314"><a href="#cb51-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-315"><a href="#cb51-315" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the model summary</span></span>
<span id="cb51-316"><a href="#cb51-316" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span>
<span id="cb51-317"><a href="#cb51-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-318"><a href="#cb51-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-319"><a href="#cb51-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-320"><a href="#cb51-320" aria-hidden="true" tabindex="-1"></a>The estimated model turns out to be:</span>
<span id="cb51-321"><a href="#cb51-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-322"><a href="#cb51-322" aria-hidden="true" tabindex="-1"></a>$$log(\hat{\lambda_i}) = 2.7853 - 0.4143x_{i_{weekend}} + 0.0176x_{i_{PM}}$$</span>
<span id="cb51-323"><a href="#cb51-323" aria-hidden="true" tabindex="-1"></a>where $\hat{\lambda_i}$ is the _estimated_ average number of patients showing up to the ED on a given day of the week and time of day. Let's take a look at the four possible estimated means:</span>
<span id="cb51-324"><a href="#cb51-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-327"><a href="#cb51-327" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-328"><a href="#cb51-328" aria-hidden="true" tabindex="-1"></a><span class="co"># Make grid of possible values for each input</span></span>
<span id="cb51-329"><a href="#cb51-329" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb51-330"><a href="#cb51-330" aria-hidden="true" tabindex="-1"></a>  <span class="at">Weekend =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb51-331"><a href="#cb51-331" aria-hidden="true" tabindex="-1"></a>  <span class="at">PM =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>)</span>
<span id="cb51-332"><a href="#cb51-332" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb51-333"><a href="#cb51-333" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-334"><a href="#cb51-334" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find cross-product</span></span>
<span id="cb51-335"><a href="#cb51-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cross_df</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-336"><a href="#cb51-336" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-337"><a href="#cb51-337" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add some columns</span></span>
<span id="cb51-338"><a href="#cb51-338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb51-339"><a href="#cb51-339" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-340"><a href="#cb51-340" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add predictions</span></span>
<span id="cb51-341"><a href="#cb51-341" aria-hidden="true" tabindex="-1"></a>    <span class="at">EstimatedVolume =</span></span>
<span id="cb51-342"><a href="#cb51-342" aria-hidden="true" tabindex="-1"></a>      <span class="fu">predict</span>(</span>
<span id="cb51-343"><a href="#cb51-343" aria-hidden="true" tabindex="-1"></a>        model, <span class="co"># Supply the model</span></span>
<span id="cb51-344"><a href="#cb51-344" aria-hidden="true" tabindex="-1"></a>        <span class="at">newdata =</span> <span class="fu">data.frame</span>(Weekend, PM),</span>
<span id="cb51-345"><a href="#cb51-345" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"response"</span> <span class="co"># Applies the inverse link to the linear predictor</span></span>
<span id="cb51-346"><a href="#cb51-346" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb51-347"><a href="#cb51-347" aria-hidden="true" tabindex="-1"></a>    <span class="at">EstimatedVolume =</span> <span class="fu">round</span>(EstimatedVolume, <span class="dv">2</span>),</span>
<span id="cb51-348"><a href="#cb51-348" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-349"><a href="#cb51-349" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up names</span></span>
<span id="cb51-350"><a href="#cb51-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">Weekend =</span> </span>
<span id="cb51-351"><a href="#cb51-351" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb51-352"><a href="#cb51-352" aria-hidden="true" tabindex="-1"></a>        Weekend <span class="sc">~</span> <span class="st">"Sat, Sun"</span>,</span>
<span id="cb51-353"><a href="#cb51-353" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Mon - Fri"</span></span>
<span id="cb51-354"><a href="#cb51-354" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb51-355"><a href="#cb51-355" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-356"><a href="#cb51-356" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relevel</span>(<span class="st">"Mon - Fri"</span>),</span>
<span id="cb51-357"><a href="#cb51-357" aria-hidden="true" tabindex="-1"></a>    <span class="at">PM =</span> </span>
<span id="cb51-358"><a href="#cb51-358" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb51-359"><a href="#cb51-359" aria-hidden="true" tabindex="-1"></a>        PM <span class="sc">~</span> <span class="st">"PM"</span>,</span>
<span id="cb51-360"><a href="#cb51-360" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"AM"</span></span>
<span id="cb51-361"><a href="#cb51-361" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb51-362"><a href="#cb51-362" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-363"><a href="#cb51-363" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relevel</span>(</span>
<span id="cb51-364"><a href="#cb51-364" aria-hidden="true" tabindex="-1"></a>        <span class="st">"AM"</span></span>
<span id="cb51-365"><a href="#cb51-365" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb51-366"><a href="#cb51-366" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-367"><a href="#cb51-367" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-368"><a href="#cb51-368" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rearrange</span></span>
<span id="cb51-369"><a href="#cb51-369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(</span>
<span id="cb51-370"><a href="#cb51-370" aria-hidden="true" tabindex="-1"></a>    Weekend,</span>
<span id="cb51-371"><a href="#cb51-371" aria-hidden="true" tabindex="-1"></a>    PM</span>
<span id="cb51-372"><a href="#cb51-372" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-373"><a href="#cb51-373" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-374"><a href="#cb51-374" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send over the columns</span></span>
<span id="cb51-375"><a href="#cb51-375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb51-376"><a href="#cb51-376" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> PM,</span>
<span id="cb51-377"><a href="#cb51-377" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> EstimatedVolume</span>
<span id="cb51-378"><a href="#cb51-378" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-379"><a href="#cb51-379" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-380"><a href="#cb51-380" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rename column</span></span>
<span id="cb51-381"><a href="#cb51-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb51-382"><a href="#cb51-382" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Day of week</span><span class="st">`</span> <span class="ot">=</span> Weekend</span>
<span id="cb51-383"><a href="#cb51-383" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-384"><a href="#cb51-384" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-385"><a href="#cb51-385" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a kable</span></span>
<span id="cb51-386"><a href="#cb51-386" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb51-387"><a href="#cb51-387" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"html"</span>,</span>
<span id="cb51-388"><a href="#cb51-388" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Expected ED patient volume"</span></span>
<span id="cb51-389"><a href="#cb51-389" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-390"><a href="#cb51-390" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(</span>
<span id="cb51-391"><a href="#cb51-391" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb51-392"><a href="#cb51-392" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"responsive"</span>)</span>
<span id="cb51-393"><a href="#cb51-393" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-394"><a href="#cb51-394" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">""</span>, <span class="st">"Time of day"</span> <span class="ot">=</span> <span class="dv">2</span>))</span>
<span id="cb51-395"><a href="#cb51-395" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-396"><a href="#cb51-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-397"><a href="#cb51-397" aria-hidden="true" tabindex="-1"></a>Our model suggests that we see $1 - e^{\beta_{weekend}} \approx$ <span class="in">`r paste0(round((1 - exp(coefficients(model)[["WeekendTRUE"]])) * 100, 1), "%")`</span> _less_ patient volume on the weekends compared to during the week, regardless if it is AM or PM hours--this is reflected in our table estimates. We can also see that there is little difference in patient volume by the time of day, regardless of the day of the week. </span>
<span id="cb51-398"><a href="#cb51-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-399"><a href="#cb51-399" aria-hidden="true" tabindex="-1"></a>__*Answer to Question 3*__</span>
<span id="cb51-400"><a href="#cb51-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-401"><a href="#cb51-401" aria-hidden="true" tabindex="-1"></a>The evidence tells us that not only is the day of the week the _more important_ factor, but the time of day does not appear to matter at all. This is clear when we stratify our observed sample distribution:</span>
<span id="cb51-402"><a href="#cb51-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-405"><a href="#cb51-405" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-406"><a href="#cb51-406" aria-hidden="true" tabindex="-1"></a>ed_volumes <span class="sc">%&gt;%</span> </span>
<span id="cb51-407"><a href="#cb51-407" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-408"><a href="#cb51-408" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make the indicators</span></span>
<span id="cb51-409"><a href="#cb51-409" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb51-410"><a href="#cb51-410" aria-hidden="true" tabindex="-1"></a>    <span class="at">Weekend =</span> </span>
<span id="cb51-411"><a href="#cb51-411" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb51-412"><a href="#cb51-412" aria-hidden="true" tabindex="-1"></a>        <span class="fu">weekdays</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>) <span class="sc">~</span> <span class="st">"Sat, Sun"</span>,</span>
<span id="cb51-413"><a href="#cb51-413" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Mon - Fri"</span></span>
<span id="cb51-414"><a href="#cb51-414" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb51-415"><a href="#cb51-415" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-416"><a href="#cb51-416" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relevel</span>(<span class="st">"Mon - Fri"</span>),</span>
<span id="cb51-417"><a href="#cb51-417" aria-hidden="true" tabindex="-1"></a>    <span class="at">TimeOfDay =</span> </span>
<span id="cb51-418"><a href="#cb51-418" aria-hidden="true" tabindex="-1"></a>      TimeOfDay <span class="sc">%&gt;%</span></span>
<span id="cb51-419"><a href="#cb51-419" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-420"><a href="#cb51-420" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relevel</span>(</span>
<span id="cb51-421"><a href="#cb51-421" aria-hidden="true" tabindex="-1"></a>        <span class="st">"AM"</span></span>
<span id="cb51-422"><a href="#cb51-422" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb51-423"><a href="#cb51-423" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-424"><a href="#cb51-424" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-425"><a href="#cb51-425" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb51-426"><a href="#cb51-426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb51-427"><a href="#cb51-427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb51-428"><a href="#cb51-428" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-429"><a href="#cb51-429" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Volume,</span>
<span id="cb51-430"><a href="#cb51-430" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> Weekend</span>
<span id="cb51-431"><a href="#cb51-431" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-432"><a href="#cb51-432" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb51-433"><a href="#cb51-433" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">20</span>,</span>
<span id="cb51-434"><a href="#cb51-434" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"identity"</span>,</span>
<span id="cb51-435"><a href="#cb51-435" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">5</span></span>
<span id="cb51-436"><a href="#cb51-436" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb51-437"><a href="#cb51-437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb51-438"><a href="#cb51-438" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>TimeOfDay,</span>
<span id="cb51-439"><a href="#cb51-439" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="dv">2</span></span>
<span id="cb51-440"><a href="#cb51-440" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-441"><a href="#cb51-441" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Half-Day Patient Volume"</span>) <span class="sc">+</span></span>
<span id="cb51-442"><a href="#cb51-442" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Frequency"</span>) <span class="sc">+</span></span>
<span id="cb51-443"><a href="#cb51-443" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb51-444"><a href="#cb51-444" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb51-445"><a href="#cb51-445" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-446"><a href="#cb51-446" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-447"><a href="#cb51-447" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb51-448"><a href="#cb51-448" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-449"><a href="#cb51-449" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-450"><a href="#cb51-450" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb51-451"><a href="#cb51-451" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>)</span>
<span id="cb51-452"><a href="#cb51-452" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-453"><a href="#cb51-453" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-454"><a href="#cb51-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-455"><a href="#cb51-455" aria-hidden="true" tabindex="-1"></a>__*Answers to Questions 1 &amp; 2*__</span>
<span id="cb51-456"><a href="#cb51-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-457"><a href="#cb51-457" aria-hidden="true" tabindex="-1"></a>So back to the first two questions. How can we use what we found for question 3 to inform us of these answers? Remember, we need to provide estimates regarding the _total_ daily patient volume even though our model target was half-day patient volume. We have a couple options:</span>
<span id="cb51-458"><a href="#cb51-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-459"><a href="#cb51-459" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Since we have established that the time of day does not impact patient volume, we could fit a new model by first aggregating the target to reflect the total daily patient volume and then only add the weekday versus weekend factor as a covariate. </span>
<span id="cb51-460"><a href="#cb51-460" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-463"><a href="#cb51-463" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-464"><a href="#cb51-464" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a generalized linear model</span></span>
<span id="cb51-465"><a href="#cb51-465" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span></span>
<span id="cb51-466"><a href="#cb51-466" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(</span>
<span id="cb51-467"><a href="#cb51-467" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> Volume <span class="sc">~</span> Weekend, <span class="co"># Specify the model form</span></span>
<span id="cb51-468"><a href="#cb51-468" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb51-469"><a href="#cb51-469" aria-hidden="true" tabindex="-1"></a>      ed_volumes <span class="sc">%&gt;%</span> </span>
<span id="cb51-470"><a href="#cb51-470" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb51-471"><a href="#cb51-471" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For each date</span></span>
<span id="cb51-472"><a href="#cb51-472" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb51-473"><a href="#cb51-473" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb51-474"><a href="#cb51-474" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compute the total daily patient volume</span></span>
<span id="cb51-475"><a href="#cb51-475" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb51-476"><a href="#cb51-476" aria-hidden="true" tabindex="-1"></a>        <span class="at">Volume =</span> <span class="fu">sum</span>(Volume),</span>
<span id="cb51-477"><a href="#cb51-477" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb51-478"><a href="#cb51-478" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb51-479"><a href="#cb51-479" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb51-480"><a href="#cb51-480" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Make the indicator</span></span>
<span id="cb51-481"><a href="#cb51-481" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb51-482"><a href="#cb51-482" aria-hidden="true" tabindex="-1"></a>        <span class="at">Weekend =</span> <span class="fu">weekdays</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>)</span>
<span id="cb51-483"><a href="#cb51-483" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb51-484"><a href="#cb51-484" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"poisson"</span> <span class="co"># Indicate the likelihood</span></span>
<span id="cb51-485"><a href="#cb51-485" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-486"><a href="#cb51-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-487"><a href="#cb51-487" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the model summary</span></span>
<span id="cb51-488"><a href="#cb51-488" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model2)</span>
<span id="cb51-489"><a href="#cb51-489" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-490"><a href="#cb51-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-491"><a href="#cb51-491" aria-hidden="true" tabindex="-1"></a>Notice the relative effect of the day of week factor remained consistent from the original model--the intercept just changed to reflect the shifted distribution for the total patient volume. This approach works, but lets use the model we originally developed...</span>
<span id="cb51-492"><a href="#cb51-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-493"><a href="#cb51-493" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>This option requires us to know a <span class="co">[</span><span class="ot">property</span><span class="co">](https://math.stackexchange.com/questions/221078/poisson-distribution-of-sum-of-two-random-independent-variables-x-y)</span> of Poisson random variables. Specifically, if _X_ and _Y_ are two independent Poisson random variables and $Z = X + Y$, then</span>
<span id="cb51-494"><a href="#cb51-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-495"><a href="#cb51-495" aria-hidden="true" tabindex="-1"></a>$$Z \sim Poisson(\lambda_X + \lambda_Y)$$</span>
<span id="cb51-496"><a href="#cb51-496" aria-hidden="true" tabindex="-1"></a>where $\lambda_X$ and $\lambda_Y$ are the expected values (means) for _X_ and _Y_, respectively. This is relevant to us because we need to aggregate our model estimates over the time of day in order to get estimates for the total daily volume. Specifically, if $V$ is the patient volume, then $V_{Daily} = V_{AM} + V_{PM}$ for a particular day of the week. We assume from our model specification above that $V_{AM}$ and $V_{PM}$ follow independent Poisson distributions. Thus, we get the following:</span>
<span id="cb51-497"><a href="#cb51-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-498"><a href="#cb51-498" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb51-499"><a href="#cb51-499" aria-hidden="true" tabindex="-1"></a>\begin{equation}</span>
<span id="cb51-500"><a href="#cb51-500" aria-hidden="true" tabindex="-1"></a>\begin{split}</span>
<span id="cb51-501"><a href="#cb51-501" aria-hidden="true" tabindex="-1"></a>\lambda_{Daily} &amp; = E<span class="co">[</span><span class="ot">V_{Daily}</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb51-502"><a href="#cb51-502" aria-hidden="true" tabindex="-1"></a>&amp; = E<span class="co">[</span><span class="ot">V_{AM} + V_{PM}</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb51-503"><a href="#cb51-503" aria-hidden="true" tabindex="-1"></a>&amp; = E<span class="co">[</span><span class="ot">V_{AM}</span><span class="co">]</span> + E<span class="co">[</span><span class="ot">V_{PM}</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb51-504"><a href="#cb51-504" aria-hidden="true" tabindex="-1"></a>&amp; = \lambda_{AM} + \lambda_{PM} <span class="sc">\\</span></span>
<span id="cb51-505"><a href="#cb51-505" aria-hidden="true" tabindex="-1"></a>&amp; = e^{\beta_0 + \beta_{weekend}x_{i_{weekend}}} + e^{\beta_0 + \beta_{weekend}x_{i_{weekend}} + \beta_{PM}} <span class="sc">\\</span></span>
<span id="cb51-506"><a href="#cb51-506" aria-hidden="true" tabindex="-1"></a>&amp; = e^{\beta_0 + \beta_{weekend}x_{i_{weekend}}} (1 + e^{\beta_{PM}})<span class="sc">\\</span></span>
<span id="cb51-507"><a href="#cb51-507" aria-hidden="true" tabindex="-1"></a>&amp; =</span>
<span id="cb51-508"><a href="#cb51-508" aria-hidden="true" tabindex="-1"></a>\begin{cases} </span>
<span id="cb51-509"><a href="#cb51-509" aria-hidden="true" tabindex="-1"></a>e^{\beta_0} (1 + e^{\beta_{PM}}) &amp; \text{if M-F} <span class="sc">\\</span></span>
<span id="cb51-510"><a href="#cb51-510" aria-hidden="true" tabindex="-1"></a>e^{\beta_0 + \beta_{weekend}} (1 + e^{\beta_{PM}}) &amp; \text{if Sat, Sun} <span class="sc">\\</span></span>
<span id="cb51-511"><a href="#cb51-511" aria-hidden="true" tabindex="-1"></a>\end{cases} <span class="sc">\\</span></span>
<span id="cb51-512"><a href="#cb51-512" aria-hidden="true" tabindex="-1"></a>&amp; \approx</span>
<span id="cb51-513"><a href="#cb51-513" aria-hidden="true" tabindex="-1"></a>\begin{cases} </span>
<span id="cb51-514"><a href="#cb51-514" aria-hidden="true" tabindex="-1"></a>32.70 &amp; \text{if M-F} <span class="sc">\\</span></span>
<span id="cb51-515"><a href="#cb51-515" aria-hidden="true" tabindex="-1"></a>21.61         &amp; \text{if Sat, Sun} <span class="sc">\\</span></span>
<span id="cb51-516"><a href="#cb51-516" aria-hidden="true" tabindex="-1"></a>\end{cases}</span>
<span id="cb51-517"><a href="#cb51-517" aria-hidden="true" tabindex="-1"></a>\end{split}</span>
<span id="cb51-518"><a href="#cb51-518" aria-hidden="true" tabindex="-1"></a>\end{equation}</span>
<span id="cb51-519"><a href="#cb51-519" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb51-520"><a href="#cb51-520" aria-hidden="true" tabindex="-1"></a>Simply put, to get estimates around the total daily volume, we summed the regression equation over the time of day variable. Note that this is exactly what we would have gotten by just taking the sample mean of total daily volume stratified by each day of week grouping:</span>
<span id="cb51-521"><a href="#cb51-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-524"><a href="#cb51-524" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-525"><a href="#cb51-525" aria-hidden="true" tabindex="-1"></a>stratified_means <span class="ot">&lt;-</span></span>
<span id="cb51-526"><a href="#cb51-526" aria-hidden="true" tabindex="-1"></a>  ed_volumes <span class="sc">%&gt;%</span> </span>
<span id="cb51-527"><a href="#cb51-527" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-528"><a href="#cb51-528" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each date</span></span>
<span id="cb51-529"><a href="#cb51-529" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb51-530"><a href="#cb51-530" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-531"><a href="#cb51-531" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the total daily patient volume</span></span>
<span id="cb51-532"><a href="#cb51-532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb51-533"><a href="#cb51-533" aria-hidden="true" tabindex="-1"></a>    <span class="at">Volume =</span> <span class="fu">sum</span>(Volume),</span>
<span id="cb51-534"><a href="#cb51-534" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb51-535"><a href="#cb51-535" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-536"><a href="#cb51-536" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-537"><a href="#cb51-537" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make the indicator</span></span>
<span id="cb51-538"><a href="#cb51-538" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb51-539"><a href="#cb51-539" aria-hidden="true" tabindex="-1"></a>    <span class="at">Weekend =</span> </span>
<span id="cb51-540"><a href="#cb51-540" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb51-541"><a href="#cb51-541" aria-hidden="true" tabindex="-1"></a>        <span class="fu">weekdays</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>) <span class="sc">~</span> <span class="st">"Sat, Sun"</span>,</span>
<span id="cb51-542"><a href="#cb51-542" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Mon - Fri"</span></span>
<span id="cb51-543"><a href="#cb51-543" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb51-544"><a href="#cb51-544" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-545"><a href="#cb51-545" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relevel</span>(<span class="st">"Mon - Fri"</span>)</span>
<span id="cb51-546"><a href="#cb51-546" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-547"><a href="#cb51-547" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-548"><a href="#cb51-548" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each group</span></span>
<span id="cb51-549"><a href="#cb51-549" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Weekend) <span class="sc">%&gt;%</span></span>
<span id="cb51-550"><a href="#cb51-550" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-551"><a href="#cb51-551" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the mean</span></span>
<span id="cb51-552"><a href="#cb51-552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb51-553"><a href="#cb51-553" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean =</span> <span class="fu">mean</span>(Volume),</span>
<span id="cb51-554"><a href="#cb51-554" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variance =</span> <span class="fu">var</span>(Volume),</span>
<span id="cb51-555"><a href="#cb51-555" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb51-556"><a href="#cb51-556" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-557"><a href="#cb51-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-558"><a href="#cb51-558" aria-hidden="true" tabindex="-1"></a>stratified_means <span class="sc">%&gt;%</span></span>
<span id="cb51-559"><a href="#cb51-559" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-560"><a href="#cb51-560" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a kable</span></span>
<span id="cb51-561"><a href="#cb51-561" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb51-562"><a href="#cb51-562" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"html"</span>,</span>
<span id="cb51-563"><a href="#cb51-563" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Stratified Daily Sample Means and Variances"</span></span>
<span id="cb51-564"><a href="#cb51-564" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-565"><a href="#cb51-565" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(</span>
<span id="cb51-566"><a href="#cb51-566" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb51-567"><a href="#cb51-567" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"responsive"</span>)</span>
<span id="cb51-568"><a href="#cb51-568" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb51-569"><a href="#cb51-569" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-570"><a href="#cb51-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-571"><a href="#cb51-571" aria-hidden="true" tabindex="-1"></a>Notice also that the stratified sample _variances_ align much more with our assumptions in using a Poisson distribution--this was one of our <span class="co">[</span><span class="ot">problems earlier</span><span class="co">](#poissondistribution)</span>, but it appears to be resolved! Now that we have weekday and weekend-specific Poisson distributions, we can confidently compute our final estimates for questions 1 and 2 the same way we did <span class="co">[</span><span class="ot">above</span><span class="co">](#poissondistribution)</span>. </span>
<span id="cb51-572"><a href="#cb51-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-573"><a href="#cb51-573" aria-hidden="true" tabindex="-1"></a>Table 2 already shows the answer to question 1: _we can expect to see 33 patients per day Monday-Friday, and 22 patients on Saturdays or Sundays._ To get the updated estimates for question 2, we just need to plug in the new means to the PDF and compute the cumulative probability:</span>
<span id="cb51-574"><a href="#cb51-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-577"><a href="#cb51-577" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-578"><a href="#cb51-578" aria-hidden="true" tabindex="-1"></a>question2_updated <span class="ot">&lt;-</span></span>
<span id="cb51-579"><a href="#cb51-579" aria-hidden="true" tabindex="-1"></a>  stratified_means <span class="sc">%&gt;%</span></span>
<span id="cb51-580"><a href="#cb51-580" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-581"><a href="#cb51-581" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each set, compute the cumulative probability</span></span>
<span id="cb51-582"><a href="#cb51-582" aria-hidden="true" tabindex="-1"></a>  cheese<span class="sc">::</span><span class="fu">stratiply</span>(</span>
<span id="cb51-583"><a href="#cb51-583" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> Weekend,</span>
<span id="cb51-584"><a href="#cb51-584" aria-hidden="true" tabindex="-1"></a>    <span class="at">f =</span> <span class="sc">~</span><span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(<span class="fu">exp</span>(<span class="sc">-</span>.x<span class="sc">$</span>Mean) <span class="sc">*</span> .x<span class="sc">$</span>Mean<span class="sc">^</span><span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">40</span>) <span class="sc">/</span> <span class="fu">factorial</span>(<span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">40</span>)))</span>
<span id="cb51-585"><a href="#cb51-585" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-586"><a href="#cb51-586" aria-hidden="true" tabindex="-1"></a>question2_updated</span>
<span id="cb51-587"><a href="#cb51-587" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-588"><a href="#cb51-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-589"><a href="#cb51-589" aria-hidden="true" tabindex="-1"></a>_We estimate that there is a `r paste0(round(question2_updated[[1]] * 100, 2), "%")` chance that we will see more than 40 patients on any given Monday-Friday, and a `r paste0(round(question2_updated[[2]] * 100, 2), "%")` chance that we will see that many patients on the weekend._</span>
<span id="cb51-590"><a href="#cb51-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-591"><a href="#cb51-591" aria-hidden="true" tabindex="-1"></a>Okay we got a little carried away with that but hopefully you have an idea of how Poisson regression works.</span>
<span id="cb51-592"><a href="#cb51-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-593"><a href="#cb51-593" aria-hidden="true" tabindex="-1"></a><span class="fu"># Conway-Maxwell (COM) Poisson Regression {#compoisson}</span></span>
<span id="cb51-594"><a href="#cb51-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-595"><a href="#cb51-595" aria-hidden="true" tabindex="-1"></a>Now that we have a foundation for standard Poisson regression, we can dig into COM-Poisson! We will use the <span class="co">[</span><span class="ot">`COMPoissonReg`</span><span class="co">](https://github.com/lotze/COMPoissonReg)</span> package in R, which can be installed from CRAN with <span class="in">`install.packages("COMPoissonReg")`</span>.</span>
<span id="cb51-596"><a href="#cb51-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-599"><a href="#cb51-599" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-600"><a href="#cb51-600" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the package</span></span>
<span id="cb51-601"><a href="#cb51-601" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(COMPoissonReg)</span>
<span id="cb51-602"><a href="#cb51-602" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-603"><a href="#cb51-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-604"><a href="#cb51-604" aria-hidden="true" tabindex="-1"></a><span class="fu">## The COM-Poisson Distribution {#compoissondistribution}</span></span>
<span id="cb51-605"><a href="#cb51-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-606"><a href="#cb51-606" aria-hidden="true" tabindex="-1"></a>If the PMF for a non-negative, integer-valued $Y$ is:</span>
<span id="cb51-607"><a href="#cb51-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-608"><a href="#cb51-608" aria-hidden="true" tabindex="-1"></a>$$P(Y = y|\lambda, \nu) = \frac{\lambda^y}{y!^{\nu}Z(\lambda, \nu)}$$</span>
<span id="cb51-609"><a href="#cb51-609" aria-hidden="true" tabindex="-1"></a>where $\lambda, \nu &gt; 0$, and </span>
<span id="cb51-610"><a href="#cb51-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-611"><a href="#cb51-611" aria-hidden="true" tabindex="-1"></a>$$Z(\lambda, \nu) = \sum_{k=0}^{\infty}\frac{\lambda^k}{k!^{\nu}}$$</span>
<span id="cb51-612"><a href="#cb51-612" aria-hidden="true" tabindex="-1"></a>then $Y$ is distributed as a COM-Poisson random variable.</span>
<span id="cb51-613"><a href="#cb51-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-614"><a href="#cb51-614" aria-hidden="true" tabindex="-1"></a>That's kind of a mouthful, but we can see some similarities in its form to the <span class="co">[</span><span class="ot">Poisson PDF</span><span class="co">](#poissondistribution)</span>. In fact, if you're really math-savvy (which I'm not, I had to look this up), you'll notice that the function $Z$ is a _[power series](https://en.wikipedia.org/wiki/Power_series)_. When we set $\nu = 1$, then</span>
<span id="cb51-615"><a href="#cb51-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-616"><a href="#cb51-616" aria-hidden="true" tabindex="-1"></a>$$Z(\lambda, \nu = 1) = \sum_{k=0}^{\infty}\frac{\lambda^k}{k!} = e^\lambda$$</span>
<span id="cb51-617"><a href="#cb51-617" aria-hidden="true" tabindex="-1"></a>Plugging that result back into the full PMF, it turns out to be _exactly_ the same as a Poisson distribution. This tells us that **_the Poisson distribution is a special case of the COM-Poisson_**. In the other words, the COM-Poisson is a generalization of the Poisson distribution, so we'll expect it do everything that the latter can--plus more.</span>
<span id="cb51-618"><a href="#cb51-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-619"><a href="#cb51-619" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dispersion Parameter</span></span>
<span id="cb51-620"><a href="#cb51-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-621"><a href="#cb51-621" aria-hidden="true" tabindex="-1"></a>An important feature of the COM-Poisson PDF is the parameter $\nu$, which determines its _dispersion_ (i.e., how variable it is relative to its mean). In the standard Poisson distribution, the mean and variance are always the same, by definition. The $\nu$ parameter allows us to relax that restriction in cases where it does not apply (or we don't want to force it to). The following table describes the properties when it is above, below, and equal to 1:</span>
<span id="cb51-622"><a href="#cb51-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-623"><a href="#cb51-623" aria-hidden="true" tabindex="-1"></a>Parameter|Implies|Described As</span>
<span id="cb51-624"><a href="#cb51-624" aria-hidden="true" tabindex="-1"></a>------|-----------|----------</span>
<span id="cb51-625"><a href="#cb51-625" aria-hidden="true" tabindex="-1"></a>$\nu=1$|$E<span class="co">[</span><span class="ot">Y</span><span class="co">]</span> = Var<span class="co">[</span><span class="ot">Y</span><span class="co">]</span>$|Equidispersed</span>
<span id="cb51-626"><a href="#cb51-626" aria-hidden="true" tabindex="-1"></a>$\nu&lt;1$|$E<span class="co">[</span><span class="ot">Y</span><span class="co">]</span> &lt; Var<span class="co">[</span><span class="ot">Y</span><span class="co">]</span>$|Overdispersed</span>
<span id="cb51-627"><a href="#cb51-627" aria-hidden="true" tabindex="-1"></a>$\nu&gt;1$|$E<span class="co">[</span><span class="ot">Y</span><span class="co">]</span> &gt; Var<span class="co">[</span><span class="ot">Y</span><span class="co">]</span>$|Underdispersed</span>
<span id="cb51-628"><a href="#cb51-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-629"><a href="#cb51-629" aria-hidden="true" tabindex="-1"></a><span class="fu">### Mean and Variance {#compoissonmeanapprox}</span></span>
<span id="cb51-630"><a href="#cb51-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-631"><a href="#cb51-631" aria-hidden="true" tabindex="-1"></a>Unfortunately, there is <span class="co">[</span><span class="ot">no closed form solution</span><span class="co">](https://faculty.georgetown.edu/kfs7/MY%20PUBLICATIONS/COMPoissonModelForCountDataWithDiscussion.pdf)</span> for the mean and variance of a COM-Poisson random variable. However, there are a couple related properties that are worth relaying:</span>
<span id="cb51-632"><a href="#cb51-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-633"><a href="#cb51-633" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The $\lambda$ parameter is the mean of the power-transformed counts</span>
<span id="cb51-634"><a href="#cb51-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-635"><a href="#cb51-635" aria-hidden="true" tabindex="-1"></a>$$E<span class="co">[</span><span class="ot">Y^\nu</span><span class="co">]</span> = \lambda$$</span>
<span id="cb51-636"><a href="#cb51-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-637"><a href="#cb51-637" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The mean and variance can be approximated as:</span>
<span id="cb51-638"><a href="#cb51-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-639"><a href="#cb51-639" aria-hidden="true" tabindex="-1"></a>$$E<span class="co">[</span><span class="ot">Y</span><span class="co">]</span> \approx \lambda^{1/\nu} - \frac{\nu-1}{2\nu}$$</span>
<span id="cb51-640"><a href="#cb51-640" aria-hidden="true" tabindex="-1"></a>$$Var<span class="co">[</span><span class="ot">Y</span><span class="co">]</span> \approx \frac{\lambda^{1/\nu}}{\nu}$$</span>
<span id="cb51-641"><a href="#cb51-641" aria-hidden="true" tabindex="-1"></a>when $\nu \leq 1$ (overdispersed) or $\lambda &gt; 10^\nu$ (larger counts).</span>
<span id="cb51-642"><a href="#cb51-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-643"><a href="#cb51-643" aria-hidden="true" tabindex="-1"></a><span class="fu">### Centrality Simulation {#centralitysimulation}</span></span>
<span id="cb51-644"><a href="#cb51-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-645"><a href="#cb51-645" aria-hidden="true" tabindex="-1"></a>The properties described above give us some useful information, but it is hard to make sense of how these parameters directly govern the data we might observe from a COM-Poisson distribution. To give us a bit more insight, lets randomly generate a bunch of data for different parameter combinations and see what we find. To do this, we'll use the <span class="in">`rcmp`</span> function.</span>
<span id="cb51-646"><a href="#cb51-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-647"><a href="#cb51-647" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo = FALSE, message = FALSE}</span></span>
<span id="cb51-648"><a href="#cb51-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-649"><a href="#cb51-649" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a parameter grid</span></span>
<span id="cb51-650"><a href="#cb51-650" aria-hidden="true" tabindex="-1"></a><span class="in">params &lt;-</span></span>
<span id="cb51-651"><a href="#cb51-651" aria-hidden="true" tabindex="-1"></a><span class="in">  list(</span></span>
<span id="cb51-652"><a href="#cb51-652" aria-hidden="true" tabindex="-1"></a><span class="in">    lambda = c(1, 3, 5, 10, 25, 50),</span></span>
<span id="cb51-653"><a href="#cb51-653" aria-hidden="true" tabindex="-1"></a><span class="in">    nu = c(.5, 1, 1.25, 1.5)</span></span>
<span id="cb51-654"><a href="#cb51-654" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb51-655"><a href="#cb51-655" aria-hidden="true" tabindex="-1"></a><span class="in">  cross_df()</span></span>
<span id="cb51-656"><a href="#cb51-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-657"><a href="#cb51-657" aria-hidden="true" tabindex="-1"></a><span class="in"># Number of samples</span></span>
<span id="cb51-658"><a href="#cb51-658" aria-hidden="true" tabindex="-1"></a><span class="in">n &lt;- 500</span></span>
<span id="cb51-659"><a href="#cb51-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-660"><a href="#cb51-660" aria-hidden="true" tabindex="-1"></a><span class="in"># Number of simulations</span></span>
<span id="cb51-661"><a href="#cb51-661" aria-hidden="true" tabindex="-1"></a><span class="in">s &lt;- 100</span></span>
<span id="cb51-662"><a href="#cb51-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-663"><a href="#cb51-663" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-664"><a href="#cb51-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-665"><a href="#cb51-665" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb51-666"><a href="#cb51-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-667"><a href="#cb51-667" aria-hidden="true" tabindex="-1"></a><span class="in"># Make a parameter grid</span></span>
<span id="cb51-668"><a href="#cb51-668" aria-hidden="true" tabindex="-1"></a><span class="in">params &lt;-</span></span>
<span id="cb51-669"><a href="#cb51-669" aria-hidden="true" tabindex="-1"></a><span class="in">  list(</span></span>
<span id="cb51-670"><a href="#cb51-670" aria-hidden="true" tabindex="-1"></a><span class="in">    lambda = c(1, 3, 5, 10, 25, 50),</span></span>
<span id="cb51-671"><a href="#cb51-671" aria-hidden="true" tabindex="-1"></a><span class="in">    nu = c(.5, 1, 1.25, 1.5)</span></span>
<span id="cb51-672"><a href="#cb51-672" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb51-673"><a href="#cb51-673" aria-hidden="true" tabindex="-1"></a><span class="in">  cross_df()</span></span>
<span id="cb51-674"><a href="#cb51-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-675"><a href="#cb51-675" aria-hidden="true" tabindex="-1"></a><span class="in"># Number of samples</span></span>
<span id="cb51-676"><a href="#cb51-676" aria-hidden="true" tabindex="-1"></a><span class="in">n &lt;- 500</span></span>
<span id="cb51-677"><a href="#cb51-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-678"><a href="#cb51-678" aria-hidden="true" tabindex="-1"></a><span class="in"># Number of simulations</span></span>
<span id="cb51-679"><a href="#cb51-679" aria-hidden="true" tabindex="-1"></a><span class="in">s &lt;- 100</span></span>
<span id="cb51-680"><a href="#cb51-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-681"><a href="#cb51-681" aria-hidden="true" tabindex="-1"></a><span class="in"># Set a seed</span></span>
<span id="cb51-682"><a href="#cb51-682" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(123)</span></span>
<span id="cb51-683"><a href="#cb51-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-684"><a href="#cb51-684" aria-hidden="true" tabindex="-1"></a><span class="in">compoisson_sim1 &lt;-</span></span>
<span id="cb51-685"><a href="#cb51-685" aria-hidden="true" tabindex="-1"></a><span class="in">  params %&gt;%</span></span>
<span id="cb51-686"><a href="#cb51-686" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb51-687"><a href="#cb51-687" aria-hidden="true" tabindex="-1"></a><span class="in">  # Split into a list</span></span>
<span id="cb51-688"><a href="#cb51-688" aria-hidden="true" tabindex="-1"></a><span class="in">  split(1:nrow(.)) %&gt;%</span></span>
<span id="cb51-689"><a href="#cb51-689" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb51-690"><a href="#cb51-690" aria-hidden="true" tabindex="-1"></a><span class="in">  # For each element</span></span>
<span id="cb51-691"><a href="#cb51-691" aria-hidden="true" tabindex="-1"></a><span class="in">  map_df(</span></span>
<span id="cb51-692"><a href="#cb51-692" aria-hidden="true" tabindex="-1"></a><span class="in">    function(.x) {</span></span>
<span id="cb51-693"><a href="#cb51-693" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb51-694"><a href="#cb51-694" aria-hidden="true" tabindex="-1"></a><span class="in">      1:s %&gt;%</span></span>
<span id="cb51-695"><a href="#cb51-695" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb51-696"><a href="#cb51-696" aria-hidden="true" tabindex="-1"></a><span class="in">        # For each iteration</span></span>
<span id="cb51-697"><a href="#cb51-697" aria-hidden="true" tabindex="-1"></a><span class="in">        map_df(</span></span>
<span id="cb51-698"><a href="#cb51-698" aria-hidden="true" tabindex="-1"></a><span class="in">          function(.sim) {</span></span>
<span id="cb51-699"><a href="#cb51-699" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb51-700"><a href="#cb51-700" aria-hidden="true" tabindex="-1"></a><span class="in">            # Time the sampling</span></span>
<span id="cb51-701"><a href="#cb51-701" aria-hidden="true" tabindex="-1"></a><span class="in">            temp_time &lt;- system.time(temp_value &lt;- rcmp(n = n, lambda = .x$lambda, nu = .x$nu))</span></span>
<span id="cb51-702"><a href="#cb51-702" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb51-703"><a href="#cb51-703" aria-hidden="true" tabindex="-1"></a><span class="in">            tibble(</span></span>
<span id="cb51-704"><a href="#cb51-704" aria-hidden="true" tabindex="-1"></a><span class="in">              s = .sim,</span></span>
<span id="cb51-705"><a href="#cb51-705" aria-hidden="true" tabindex="-1"></a><span class="in">              lambda = .x$lambda,</span></span>
<span id="cb51-706"><a href="#cb51-706" aria-hidden="true" tabindex="-1"></a><span class="in">              nu = .x$nu,</span></span>
<span id="cb51-707"><a href="#cb51-707" aria-hidden="true" tabindex="-1"></a><span class="in">              value = temp_value,</span></span>
<span id="cb51-708"><a href="#cb51-708" aria-hidden="true" tabindex="-1"></a><span class="in">              time = temp_time["elapsed"][[1]]</span></span>
<span id="cb51-709"><a href="#cb51-709" aria-hidden="true" tabindex="-1"></a><span class="in">            )</span></span>
<span id="cb51-710"><a href="#cb51-710" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb51-711"><a href="#cb51-711" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb51-712"><a href="#cb51-712" aria-hidden="true" tabindex="-1"></a><span class="in">        )</span></span>
<span id="cb51-713"><a href="#cb51-713" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb51-714"><a href="#cb51-714" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb51-715"><a href="#cb51-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-716"><a href="#cb51-716" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-717"><a href="#cb51-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-718"><a href="#cb51-718" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo = FALSE, message = FALSE}</span></span>
<span id="cb51-719"><a href="#cb51-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-720"><a href="#cb51-720" aria-hidden="true" tabindex="-1"></a><span class="in"># Load the simulated data set</span></span>
<span id="cb51-721"><a href="#cb51-721" aria-hidden="true" tabindex="-1"></a><span class="in">load(file = "/Users/alexzajichek/Documents/GitHub/compoisson_sim1.RData")</span></span>
<span id="cb51-722"><a href="#cb51-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-723"><a href="#cb51-723" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-724"><a href="#cb51-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-725"><a href="#cb51-725" aria-hidden="true" tabindex="-1"></a>We took <span class="in">`r s`</span> random samples of size <span class="in">`r n`</span> from <span class="in">`r nrow(params)`</span> parameter combinations. This process took about <span class="in">`r round(with(distinct(select(compoisson_sim1, -value)), sum(time)), 1)`</span> seconds to run. Lets first take a quick look at the distributions from the first simulation for each parameter set.</span>
<span id="cb51-726"><a href="#cb51-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-729"><a href="#cb51-729" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-730"><a href="#cb51-730" aria-hidden="true" tabindex="-1"></a>compoisson_sim1 <span class="sc">%&gt;%</span></span>
<span id="cb51-731"><a href="#cb51-731" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-732"><a href="#cb51-732" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter to the first simulated value</span></span>
<span id="cb51-733"><a href="#cb51-733" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb51-734"><a href="#cb51-734" aria-hidden="true" tabindex="-1"></a>    s <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb51-735"><a href="#cb51-735" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-736"><a href="#cb51-736" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-737"><a href="#cb51-737" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to factors</span></span>
<span id="cb51-738"><a href="#cb51-738" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb51-739"><a href="#cb51-739" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb51-740"><a href="#cb51-740" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(</span>
<span id="cb51-741"><a href="#cb51-741" aria-hidden="true" tabindex="-1"></a>        lambda,</span>
<span id="cb51-742"><a href="#cb51-742" aria-hidden="true" tabindex="-1"></a>        nu</span>
<span id="cb51-743"><a href="#cb51-743" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb51-744"><a href="#cb51-744" aria-hidden="true" tabindex="-1"></a>      factor</span>
<span id="cb51-745"><a href="#cb51-745" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-746"><a href="#cb51-746" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> </span>
<span id="cb51-747"><a href="#cb51-747" aria-hidden="true" tabindex="-1"></a>      lambda <span class="sc">%&gt;%</span></span>
<span id="cb51-748"><a href="#cb51-748" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relabel</span>(</span>
<span id="cb51-749"><a href="#cb51-749" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x) <span class="fu">paste0</span>(<span class="st">"lambda == "</span>, x)</span>
<span id="cb51-750"><a href="#cb51-750" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb51-751"><a href="#cb51-751" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-752"><a href="#cb51-752" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-753"><a href="#cb51-753" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb51-754"><a href="#cb51-754" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb51-755"><a href="#cb51-755" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb51-756"><a href="#cb51-756" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-757"><a href="#cb51-757" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> value,</span>
<span id="cb51-758"><a href="#cb51-758" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> nu</span>
<span id="cb51-759"><a href="#cb51-759" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-760"><a href="#cb51-760" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"identity"</span>,</span>
<span id="cb51-761"><a href="#cb51-761" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb51-762"><a href="#cb51-762" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-763"><a href="#cb51-763" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb51-764"><a href="#cb51-764" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>lambda,</span>
<span id="cb51-765"><a href="#cb51-765" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">"free"</span>,</span>
<span id="cb51-766"><a href="#cb51-766" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"label_parsed"</span></span>
<span id="cb51-767"><a href="#cb51-767" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-768"><a href="#cb51-768" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Observed Value"</span>) <span class="sc">+</span></span>
<span id="cb51-769"><a href="#cb51-769" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Frequency"</span>) <span class="sc">+</span></span>
<span id="cb51-770"><a href="#cb51-770" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb51-771"><a href="#cb51-771" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb51-772"><a href="#cb51-772" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-773"><a href="#cb51-773" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-774"><a href="#cb51-774" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb51-775"><a href="#cb51-775" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-776"><a href="#cb51-776" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-777"><a href="#cb51-777" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb51-778"><a href="#cb51-778" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>)</span>
<span id="cb51-779"><a href="#cb51-779" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-780"><a href="#cb51-780" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb51-781"><a href="#cb51-781" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="fu">expression</span>(nu)</span>
<span id="cb51-782"><a href="#cb51-782" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-783"><a href="#cb51-783" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-784"><a href="#cb51-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-785"><a href="#cb51-785" aria-hidden="true" tabindex="-1"></a>It looks like the magnitude of counts increases with $\lambda$, and decreases with $\nu$. To get a more concrete view of this, lets compute the sample mean and variance for each iteration, and then average those over the simulations for each parameter combination. By doing this, we'll also get a sense of the sampling variability of these statistics when $n=$ <span class="in">`r n`</span>.</span>
<span id="cb51-786"><a href="#cb51-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-789"><a href="#cb51-789" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-790"><a href="#cb51-790" aria-hidden="true" tabindex="-1"></a>compoisson_sim1 <span class="sc">%&gt;%</span></span>
<span id="cb51-791"><a href="#cb51-791" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-792"><a href="#cb51-792" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each group</span></span>
<span id="cb51-793"><a href="#cb51-793" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lambda, nu, s) <span class="sc">%&gt;%</span></span>
<span id="cb51-794"><a href="#cb51-794" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-795"><a href="#cb51-795" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the statistics</span></span>
<span id="cb51-796"><a href="#cb51-796" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb51-797"><a href="#cb51-797" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean =</span> <span class="fu">mean</span>(value),</span>
<span id="cb51-798"><a href="#cb51-798" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variance =</span> <span class="fu">var</span>(value),</span>
<span id="cb51-799"><a href="#cb51-799" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb51-800"><a href="#cb51-800" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-801"><a href="#cb51-801" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-802"><a href="#cb51-802" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send the statistics down the rows</span></span>
<span id="cb51-803"><a href="#cb51-803" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb51-804"><a href="#cb51-804" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(Mean, Variance)</span>
<span id="cb51-805"><a href="#cb51-805" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-806"><a href="#cb51-806" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-807"><a href="#cb51-807" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each group</span></span>
<span id="cb51-808"><a href="#cb51-808" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lambda, nu, name) <span class="sc">%&gt;%</span></span>
<span id="cb51-809"><a href="#cb51-809" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-810"><a href="#cb51-810" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the mean/standard error</span></span>
<span id="cb51-811"><a href="#cb51-811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb51-812"><a href="#cb51-812" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean =</span> <span class="fu">mean</span>(value),</span>
<span id="cb51-813"><a href="#cb51-813" aria-hidden="true" tabindex="-1"></a>    <span class="at">SE =</span> <span class="fu">sd</span>(value),</span>
<span id="cb51-814"><a href="#cb51-814" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb51-815"><a href="#cb51-815" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-816"><a href="#cb51-816" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-817"><a href="#cb51-817" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join to get the average time for each iteration</span></span>
<span id="cb51-818"><a href="#cb51-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb51-819"><a href="#cb51-819" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> </span>
<span id="cb51-820"><a href="#cb51-820" aria-hidden="true" tabindex="-1"></a>      compoisson_sim1 <span class="sc">%&gt;%</span></span>
<span id="cb51-821"><a href="#cb51-821" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb51-822"><a href="#cb51-822" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Remove the value, get unique rows</span></span>
<span id="cb51-823"><a href="#cb51-823" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>value) <span class="sc">%&gt;%</span></span>
<span id="cb51-824"><a href="#cb51-824" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-825"><a href="#cb51-825" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb51-826"><a href="#cb51-826" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For each group</span></span>
<span id="cb51-827"><a href="#cb51-827" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(lambda, nu) <span class="sc">%&gt;%</span></span>
<span id="cb51-828"><a href="#cb51-828" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb51-829"><a href="#cb51-829" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compute the average time per iteration</span></span>
<span id="cb51-830"><a href="#cb51-830" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb51-831"><a href="#cb51-831" aria-hidden="true" tabindex="-1"></a>        <span class="at">time =</span> <span class="fu">mean</span>(time),</span>
<span id="cb51-832"><a href="#cb51-832" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb51-833"><a href="#cb51-833" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb51-834"><a href="#cb51-834" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> </span>
<span id="cb51-835"><a href="#cb51-835" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(</span>
<span id="cb51-836"><a href="#cb51-836" aria-hidden="true" tabindex="-1"></a>        <span class="st">"lambda"</span>,</span>
<span id="cb51-837"><a href="#cb51-837" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nu"</span></span>
<span id="cb51-838"><a href="#cb51-838" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb51-839"><a href="#cb51-839" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-840"><a href="#cb51-840" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-841"><a href="#cb51-841" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to factors</span></span>
<span id="cb51-842"><a href="#cb51-842" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb51-843"><a href="#cb51-843" aria-hidden="true" tabindex="-1"></a>    <span class="at">nu =</span> </span>
<span id="cb51-844"><a href="#cb51-844" aria-hidden="true" tabindex="-1"></a>      nu <span class="sc">%&gt;%</span></span>
<span id="cb51-845"><a href="#cb51-845" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-846"><a href="#cb51-846" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relabel</span>(</span>
<span id="cb51-847"><a href="#cb51-847" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x) <span class="fu">paste0</span>(<span class="st">"nu == "</span>, x)</span>
<span id="cb51-848"><a href="#cb51-848" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb51-849"><a href="#cb51-849" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-850"><a href="#cb51-850" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-851"><a href="#cb51-851" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb51-852"><a href="#cb51-852" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb51-853"><a href="#cb51-853" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-854"><a href="#cb51-854" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> lambda,</span>
<span id="cb51-855"><a href="#cb51-855" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Mean</span>
<span id="cb51-856"><a href="#cb51-856" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-857"><a href="#cb51-857" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-858"><a href="#cb51-858" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb51-859"><a href="#cb51-859" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-860"><a href="#cb51-860" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> name</span>
<span id="cb51-861"><a href="#cb51-861" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-862"><a href="#cb51-862" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">1.25</span></span>
<span id="cb51-863"><a href="#cb51-863" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-864"><a href="#cb51-864" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb51-865"><a href="#cb51-865" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-866"><a href="#cb51-866" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> name</span>
<span id="cb51-867"><a href="#cb51-867" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-868"><a href="#cb51-868" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb51-869"><a href="#cb51-869" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-870"><a href="#cb51-870" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(</span>
<span id="cb51-871"><a href="#cb51-871" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-872"><a href="#cb51-872" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymin =</span> Mean <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>SE,</span>
<span id="cb51-873"><a href="#cb51-873" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymax =</span> Mean <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>SE,</span>
<span id="cb51-874"><a href="#cb51-874" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> name</span>
<span id="cb51-875"><a href="#cb51-875" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-876"><a href="#cb51-876" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">25</span></span>
<span id="cb51-877"><a href="#cb51-877" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-878"><a href="#cb51-878" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb51-879"><a href="#cb51-879" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>nu,</span>
<span id="cb51-880"><a href="#cb51-880" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">"free_y"</span>,</span>
<span id="cb51-881"><a href="#cb51-881" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"label_parsed"</span></span>
<span id="cb51-882"><a href="#cb51-882" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-883"><a href="#cb51-883" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Value"</span>) <span class="sc">+</span></span>
<span id="cb51-884"><a href="#cb51-884" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb51-885"><a href="#cb51-885" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb51-886"><a href="#cb51-886" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb51-887"><a href="#cb51-887" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-888"><a href="#cb51-888" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb51-889"><a href="#cb51-889" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-890"><a href="#cb51-890" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-891"><a href="#cb51-891" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb51-892"><a href="#cb51-892" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>)</span>
<span id="cb51-893"><a href="#cb51-893" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-894"><a href="#cb51-894" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb51-895"><a href="#cb51-895" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">unique</span>(params<span class="sc">$</span>lambda)</span>
<span id="cb51-896"><a href="#cb51-896" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-897"><a href="#cb51-897" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb51-898"><a href="#cb51-898" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(lambda)</span>
<span id="cb51-899"><a href="#cb51-899" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-900"><a href="#cb51-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-901"><a href="#cb51-901" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-902"><a href="#cb51-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-903"><a href="#cb51-903" aria-hidden="true" tabindex="-1"></a>When $\nu=0.5$ (overdispersed), the counts become large quickly with an increasing $\lambda$. As the data becomes more underdispersed ($\nu &gt; 1$), the variance increases at a slower rate as $\lambda$ increases, relative to the mean.</span>
<span id="cb51-904"><a href="#cb51-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-905"><a href="#cb51-905" aria-hidden="true" tabindex="-1"></a>So how does this translate to a regression model?</span>
<span id="cb51-906"><a href="#cb51-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-907"><a href="#cb51-907" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Regression Model {#compoissonregressionmodel}</span></span>
<span id="cb51-908"><a href="#cb51-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-909"><a href="#cb51-909" aria-hidden="true" tabindex="-1"></a>It turns out that the model structure for COM-Poisson regression is very similar to the <span class="co">[</span><span class="ot">standard Poisson model</span><span class="co">](#modelformulation)</span>. In fact, we can just copy and paste it from above:</span>
<span id="cb51-910"><a href="#cb51-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-911"><a href="#cb51-911" aria-hidden="true" tabindex="-1"></a>$$log(\lambda_i) = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2}+...+\beta_px_{ip} = X_i\beta$$</span>
<span id="cb51-912"><a href="#cb51-912" aria-hidden="true" tabindex="-1"></a>The basic structure models the $\lambda$ parameter (on the log scale) as a linear combination of covariates. In turn, the steps for estimating the parameters are also the same:</span>
<span id="cb51-913"><a href="#cb51-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-914"><a href="#cb51-914" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Plug the regression formula into the COM-Poisson PDF</span>
<span id="cb51-915"><a href="#cb51-915" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Derive the likelihood function</span>
<span id="cb51-916"><a href="#cb51-916" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Compute the maximum likelihood estimates (MLEs)</span>
<span id="cb51-917"><a href="#cb51-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-918"><a href="#cb51-918" aria-hidden="true" tabindex="-1"></a>The only difference is that the $\lambda$ parameter in this model no longer <span class="co">[</span><span class="ot">represents the mean</span><span class="co">](#poissondistribution)</span>. So when we generate fitted values or interpret parameter estimates, there has to be a little more care taken as to what those represent. </span>
<span id="cb51-919"><a href="#cb51-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-920"><a href="#cb51-920" aria-hidden="true" tabindex="-1"></a>Let's take a quick look at how to fit a model with the <span class="in">`glm.cmp`</span> function and orient ourselves with its output. We'll use the <span class="in">`ed_volumes`</span> dataset from the <span class="co">[</span><span class="ot">previous section</span><span class="co">](#reviewofpoisson)</span>.</span>
<span id="cb51-921"><a href="#cb51-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-924"><a href="#cb51-924" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-925"><a href="#cb51-925" aria-hidden="true" tabindex="-1"></a>compoisson_model1 <span class="ot">&lt;-</span></span>
<span id="cb51-926"><a href="#cb51-926" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-927"><a href="#cb51-927" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Function to fit a COM-Poisson model</span></span>
<span id="cb51-928"><a href="#cb51-928" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm.cmp</span>(</span>
<span id="cb51-929"><a href="#cb51-929" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula.lambda =</span> Volume <span class="sc">~</span> Weekend <span class="sc">+</span> PM, <span class="co"># lamda parameter linear predictor</span></span>
<span id="cb51-930"><a href="#cb51-930" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb51-931"><a href="#cb51-931" aria-hidden="true" tabindex="-1"></a>      ed_volumes <span class="sc">%&gt;%</span> </span>
<span id="cb51-932"><a href="#cb51-932" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb51-933"><a href="#cb51-933" aria-hidden="true" tabindex="-1"></a>        <span class="at">Weekend =</span> <span class="fu">weekdays</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>),</span>
<span id="cb51-934"><a href="#cb51-934" aria-hidden="true" tabindex="-1"></a>        <span class="at">PM =</span> TimeOfDay <span class="sc">==</span> <span class="st">"PM"</span></span>
<span id="cb51-935"><a href="#cb51-935" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb51-936"><a href="#cb51-936" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-937"><a href="#cb51-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-938"><a href="#cb51-938" aria-hidden="true" tabindex="-1"></a>compoisson_model1</span>
<span id="cb51-939"><a href="#cb51-939" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-940"><a href="#cb51-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-941"><a href="#cb51-941" aria-hidden="true" tabindex="-1"></a>We see some familiar results. Namely, the parameter estimates and p-values are pretty similar to the standard Poisson model <span class="co">[</span><span class="ot">above</span><span class="co">](#modelformulation)</span>. However, there is additional output--this is where the dispersion comes in. When we fit the model, the function also estimated the value of the $\nu$ parameter, which in this case was <span class="in">`r round(exp(compoisson_model1$gamma)[[1]], 3)`</span> (it was expected to be near 1, given that our data was generated from a standard Poisson distribution). The <span class="in">`X`</span> components make up the regression equation for $\lambda$, and the <span class="in">`S`</span> components make up the regression equation for $\nu$. We just need to evaluate those equations on an observation's covariate values, and we'll have its estimated conditional COM-Poisson distribution.</span>
<span id="cb51-942"><a href="#cb51-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-943"><a href="#cb51-943" aria-hidden="true" tabindex="-1"></a><span class="fu">## Testing for Violations of Equidispersion {#compoissonlrt}</span></span>
<span id="cb51-944"><a href="#cb51-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-945"><a href="#cb51-945" aria-hidden="true" tabindex="-1"></a>We could just look at the estimated $\nu$ parameter and its standard error in the model output to draw a conclusion about the dispersion. Nevertheless, the package also provides a function called <span class="in">`equitest`</span> to more formally carry out a _likelihood ratio test (LRT)_ for the following hypotheses:</span>
<span id="cb51-946"><a href="#cb51-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-947"><a href="#cb51-947" aria-hidden="true" tabindex="-1"></a>$$H_0: \nu = 1 \hskip.25in H_A: \nu \neq 1$$</span>
<span id="cb51-948"><a href="#cb51-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-949"><a href="#cb51-949" aria-hidden="true" tabindex="-1"></a>It tests for evidence that the data is _not_ equidispersed, but does not specify its direction. Therefore, if $H_0$ is rejected, it is up to us to garner from the model output whether there is over or under dispersion. Here is the output when performing this test on our model:</span>
<span id="cb51-950"><a href="#cb51-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-953"><a href="#cb51-953" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-954"><a href="#cb51-954" aria-hidden="true" tabindex="-1"></a><span class="fu">equitest</span>(compoisson_model1)</span>
<span id="cb51-955"><a href="#cb51-955" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-956"><a href="#cb51-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-957"><a href="#cb51-957" aria-hidden="true" tabindex="-1"></a>As expected, the p-value of <span class="in">`r round(equitest(compoisson_model1)$pvalue, 4)`</span> does not indicate that over or under dispersion was detected.</span>
<span id="cb51-958"><a href="#cb51-958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-959"><a href="#cb51-959" aria-hidden="true" tabindex="-1"></a><span class="fu">## Stratified Dispersion {#stratifieddispersion}</span></span>
<span id="cb51-960"><a href="#cb51-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-961"><a href="#cb51-961" aria-hidden="true" tabindex="-1"></a>One of the coolest features of this modeling framework (in my opinion) is that not only can you fit a model for over or under dispersed data, but you can allow the dispersion parameter to vary by covariate values. You probably noticed the <span class="in">`formula.lambda`</span> argument in the <span class="in">`glm.cmp`</span> function call where we specified the model form for the $\lambda$ parameter. There is an additional argument called <span class="in">`formula.nu`</span> where we can analogously specify a linear predictor for the $\nu$ parameter, which, like $\lambda$, is on the _log_ scale. This means that, for example, if we suspect that one group has _overdispersed_ data, and another has _underdispersed_ data, we can account for that within a single model. Very cool! Just for kicks, let's see what this looks like when we allow the $\nu$ parameter to vary between AM and PM hours from our <span class="in">`ed_volumes`</span> dataset:</span>
<span id="cb51-962"><a href="#cb51-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-965"><a href="#cb51-965" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-966"><a href="#cb51-966" aria-hidden="true" tabindex="-1"></a>compoisson_model2 <span class="ot">&lt;-</span></span>
<span id="cb51-967"><a href="#cb51-967" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm.cmp</span>(</span>
<span id="cb51-968"><a href="#cb51-968" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula.lambda =</span> Volume <span class="sc">~</span> Weekend, <span class="co"># Linear predictor for log-lambda</span></span>
<span id="cb51-969"><a href="#cb51-969" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula.nu =</span> Volume <span class="sc">~</span> PM, <span class="co"># Linear predictor for log-nu</span></span>
<span id="cb51-970"><a href="#cb51-970" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb51-971"><a href="#cb51-971" aria-hidden="true" tabindex="-1"></a>      ed_volumes <span class="sc">%&gt;%</span> </span>
<span id="cb51-972"><a href="#cb51-972" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb51-973"><a href="#cb51-973" aria-hidden="true" tabindex="-1"></a>        <span class="at">Weekend =</span> <span class="fu">weekdays</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>),</span>
<span id="cb51-974"><a href="#cb51-974" aria-hidden="true" tabindex="-1"></a>        <span class="at">PM =</span> TimeOfDay <span class="sc">==</span> <span class="st">"PM"</span></span>
<span id="cb51-975"><a href="#cb51-975" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb51-976"><a href="#cb51-976" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-977"><a href="#cb51-977" aria-hidden="true" tabindex="-1"></a>compoisson_model2</span>
<span id="cb51-978"><a href="#cb51-978" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-979"><a href="#cb51-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-980"><a href="#cb51-980" aria-hidden="true" tabindex="-1"></a>We can see that there are now two parameters associated with the <span class="in">`S`</span> component of the model. We can simply evaluate and exponentiate those terms to get the $\nu$ estimates for each group:</span>
<span id="cb51-981"><a href="#cb51-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-984"><a href="#cb51-984" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-985"><a href="#cb51-985" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a simple design matrix</span></span>
<span id="cb51-986"><a href="#cb51-986" aria-hidden="true" tabindex="-1"></a>nu_design <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb51-987"><a href="#cb51-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-988"><a href="#cb51-988" aria-hidden="true" tabindex="-1"></a><span class="co"># Multiply by the S component of the model</span></span>
<span id="cb51-989"><a href="#cb51-989" aria-hidden="true" tabindex="-1"></a>nu_log_estimates <span class="ot">&lt;-</span> nu_design <span class="sc">%*%</span> <span class="fu">as.matrix</span>(compoisson_model2<span class="sc">$</span>gamma)</span>
<span id="cb51-990"><a href="#cb51-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-991"><a href="#cb51-991" aria-hidden="true" tabindex="-1"></a><span class="co"># Exponentiate</span></span>
<span id="cb51-992"><a href="#cb51-992" aria-hidden="true" tabindex="-1"></a>nu_estimates <span class="ot">&lt;-</span> <span class="fu">exp</span>(nu_log_estimates)</span>
<span id="cb51-993"><a href="#cb51-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-994"><a href="#cb51-994" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the names</span></span>
<span id="cb51-995"><a href="#cb51-995" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(nu_estimates) <span class="ot">&lt;-</span> <span class="fu">names</span>(compoisson_model2<span class="sc">$</span>gamma)</span>
<span id="cb51-996"><a href="#cb51-996" aria-hidden="true" tabindex="-1"></a>nu_estimates</span>
<span id="cb51-997"><a href="#cb51-997" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-998"><a href="#cb51-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-999"><a href="#cb51-999" aria-hidden="true" tabindex="-1"></a>Again, both groups' data were knowingly generated from a standard Poisson distribution here, so we expected the conditional estimates to be near 1 as well. Nevertheless, it illustrates the power and flexibility of this framework. </span>
<span id="cb51-1000"><a href="#cb51-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1001"><a href="#cb51-1001" aria-hidden="true" tabindex="-1"></a><span class="fu">## Generating Fitted Values {#comfittedvalues}</span></span>
<span id="cb51-1002"><a href="#cb51-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1003"><a href="#cb51-1003" aria-hidden="true" tabindex="-1"></a>As <span class="co">[</span><span class="ot">previously mentioned</span><span class="co">](#compoissonmeanapprox)</span>, there is no closed form solution for the mean of a COM-Poisson random variable. So when we generate fitted values from the model's linear predictor, it is hard to conceptualize what they represent (it is _NOT_ the mean). Since our model _does_ produce estimates for both $\lambda$ and $\nu$, the [recommendation](https://projecteuclid.org/journals/annals-of-applied-statistics/volume-4/issue-2/A-flexible-regression-model-for-count-data/10.1214/09-AOAS306.full) is to plug these into the inverse cumulative density function (CDF) to obtain quantile-based fitted values. Specifically, we can use the _median_. The figure below displays the median and $25^{th}$/$75^{th}$ percentiles from the parameter grid used in the <span class="co">[</span><span class="ot">simulation above</span><span class="co">](#centralitysimulation)</span>.</span>
<span id="cb51-1004"><a href="#cb51-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1007"><a href="#cb51-1007" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-1008"><a href="#cb51-1008" aria-hidden="true" tabindex="-1"></a>params <span class="sc">%&gt;%</span></span>
<span id="cb51-1009"><a href="#cb51-1009" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-1010"><a href="#cb51-1010" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the quantiles</span></span>
<span id="cb51-1011"><a href="#cb51-1011" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb51-1012"><a href="#cb51-1012" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> </span>
<span id="cb51-1013"><a href="#cb51-1013" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb51-1014"><a href="#cb51-1014" aria-hidden="true" tabindex="-1"></a>        <span class="at">Quantile =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.50</span>, <span class="fl">0.75</span>)</span>
<span id="cb51-1015"><a href="#cb51-1015" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb51-1016"><a href="#cb51-1016" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">character</span>()</span>
<span id="cb51-1017"><a href="#cb51-1017" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-1018"><a href="#cb51-1018" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-1019"><a href="#cb51-1019" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the value</span></span>
<span id="cb51-1020"><a href="#cb51-1020" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb51-1021"><a href="#cb51-1021" aria-hidden="true" tabindex="-1"></a>    <span class="at">Value =</span> <span class="fu">qcmp</span>(Quantile, lambda, nu),</span>
<span id="cb51-1022"><a href="#cb51-1022" aria-hidden="true" tabindex="-1"></a>    <span class="at">Linegroup =</span> <span class="fu">factor</span>(Quantile <span class="sc">==</span> <span class="fl">0.50</span>) <span class="sc">%&gt;%</span> <span class="fu">fct_rev</span>(),</span>
<span id="cb51-1023"><a href="#cb51-1023" aria-hidden="true" tabindex="-1"></a>    <span class="at">nu =</span> </span>
<span id="cb51-1024"><a href="#cb51-1024" aria-hidden="true" tabindex="-1"></a>      nu <span class="sc">%&gt;%</span></span>
<span id="cb51-1025"><a href="#cb51-1025" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-1026"><a href="#cb51-1026" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relabel</span>(</span>
<span id="cb51-1027"><a href="#cb51-1027" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x) <span class="fu">paste0</span>(<span class="st">"nu == "</span>, x)</span>
<span id="cb51-1028"><a href="#cb51-1028" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb51-1029"><a href="#cb51-1029" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-1030"><a href="#cb51-1030" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-1031"><a href="#cb51-1031" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb51-1032"><a href="#cb51-1032" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb51-1033"><a href="#cb51-1033" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-1034"><a href="#cb51-1034" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> lambda,</span>
<span id="cb51-1035"><a href="#cb51-1035" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Value,</span>
<span id="cb51-1036"><a href="#cb51-1036" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> Quantile</span>
<span id="cb51-1037"><a href="#cb51-1037" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-1038"><a href="#cb51-1038" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-1039"><a href="#cb51-1039" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb51-1040"><a href="#cb51-1040" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-1041"><a href="#cb51-1041" aria-hidden="true" tabindex="-1"></a>      <span class="at">linetype =</span> Linegroup,</span>
<span id="cb51-1042"><a href="#cb51-1042" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> Linegroup</span>
<span id="cb51-1043"><a href="#cb51-1043" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-1044"><a href="#cb51-1044" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">1.25</span></span>
<span id="cb51-1045"><a href="#cb51-1045" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-1046"><a href="#cb51-1046" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb51-1047"><a href="#cb51-1047" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">2</span></span>
<span id="cb51-1048"><a href="#cb51-1048" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-1049"><a href="#cb51-1049" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb51-1050"><a href="#cb51-1050" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>nu,</span>
<span id="cb51-1051"><a href="#cb51-1051" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">"free_y"</span>,</span>
<span id="cb51-1052"><a href="#cb51-1052" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"label_parsed"</span></span>
<span id="cb51-1053"><a href="#cb51-1053" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-1054"><a href="#cb51-1054" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Median &amp; 25th/75th Percentiles"</span>) <span class="sc">+</span></span>
<span id="cb51-1055"><a href="#cb51-1055" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb51-1056"><a href="#cb51-1056" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb51-1057"><a href="#cb51-1057" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb51-1058"><a href="#cb51-1058" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-1059"><a href="#cb51-1059" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-1060"><a href="#cb51-1060" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb51-1061"><a href="#cb51-1061" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>)</span>
<span id="cb51-1062"><a href="#cb51-1062" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-1063"><a href="#cb51-1063" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb51-1064"><a href="#cb51-1064" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">unique</span>(params<span class="sc">$</span>lambda)</span>
<span id="cb51-1065"><a href="#cb51-1065" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-1066"><a href="#cb51-1066" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb51-1067"><a href="#cb51-1067" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(lambda)</span>
<span id="cb51-1068"><a href="#cb51-1068" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-1069"><a href="#cb51-1069" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb51-1070"><a href="#cb51-1070" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>)</span>
<span id="cb51-1071"><a href="#cb51-1071" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-1072"><a href="#cb51-1072" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1073"><a href="#cb51-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1074"><a href="#cb51-1074" aria-hidden="true" tabindex="-1"></a>The median values seem to have a relatively similar behavior to the simulated means.</span>
<span id="cb51-1075"><a href="#cb51-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1076"><a href="#cb51-1076" aria-hidden="true" tabindex="-1"></a>So, to obtain _predicted_ values with our model object (we'll use the <span class="co">[</span><span class="ot">first model we made</span><span class="co">](#compoissonregressionmodel)</span>), we have to:</span>
<span id="cb51-1077"><a href="#cb51-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1078"><a href="#cb51-1078" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Produce observation-level estimates of $\lambda$ and $\nu$ with the regression equation</span>
<span id="cb51-1079"><a href="#cb51-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1082"><a href="#cb51-1082" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-1083"><a href="#cb51-1083" aria-hidden="true" tabindex="-1"></a><span class="co"># Multiply the design matrices by the parameter estimates for each linear predictor, then exponentiate</span></span>
<span id="cb51-1084"><a href="#cb51-1084" aria-hidden="true" tabindex="-1"></a>lambda_hat <span class="ot">&lt;-</span> <span class="fu">exp</span>(compoisson_model1<span class="sc">$</span>X <span class="sc">%*%</span> <span class="fu">as.matrix</span>(compoisson_model1<span class="sc">$</span>beta))</span>
<span id="cb51-1085"><a href="#cb51-1085" aria-hidden="true" tabindex="-1"></a>nu_hat <span class="ot">&lt;-</span> <span class="fu">exp</span>(compoisson_model1<span class="sc">$</span>S <span class="sc">%*%</span> <span class="fu">as.matrix</span>(compoisson_model1<span class="sc">$</span>gamma))</span>
<span id="cb51-1086"><a href="#cb51-1086" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(lambda_hat, nu_hat))</span>
<span id="cb51-1087"><a href="#cb51-1087" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1088"><a href="#cb51-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1089"><a href="#cb51-1089" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Plug the estimates into the inverse CDF at the 50th percentile</span>
<span id="cb51-1090"><a href="#cb51-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1093"><a href="#cb51-1093" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-1094"><a href="#cb51-1094" aria-hidden="true" tabindex="-1"></a>y_hat <span class="ot">&lt;-</span> <span class="fu">qcmp</span>(<span class="fu">rep</span>(<span class="fl">0.5</span>, <span class="fu">length</span>(lambda_hat)), <span class="at">lambda =</span> lambda_hat, <span class="at">nu =</span> nu_hat)</span>
<span id="cb51-1095"><a href="#cb51-1095" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(y_hat)</span>
<span id="cb51-1096"><a href="#cb51-1096" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1097"><a href="#cb51-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1098"><a href="#cb51-1098" aria-hidden="true" tabindex="-1"></a>There does exist a <span class="in">`predict.cmp`</span> function that uses the <span class="co">[</span><span class="ot">mean approximation</span><span class="co">](#compoissonmeanapprox)</span> by default, so this could be used for fitted values as well if those conditions are satisfied.</span>
<span id="cb51-1099"><a href="#cb51-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1100"><a href="#cb51-1100" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simulation: Power of Equidispersion Test {#compowersim}</span></span>
<span id="cb51-1101"><a href="#cb51-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1102"><a href="#cb51-1102" aria-hidden="true" tabindex="-1"></a>So how well does the likelihood ratio test <span class="co">[</span><span class="ot">described above</span><span class="co">](#compoissonlrt)</span> detect over or under dispersion in the data-generating process? We can use simulation! To keep it simple, we will base it off of intercept-only regression models (i.e., no covariates), in effect assessing power at varying values of $\lambda$. Presumably, power may depend on the complexity of the model, so coverage might vary as terms are added. Here are the parameter values we will consider:</span>
<span id="cb51-1103"><a href="#cb51-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1104"><a href="#cb51-1104" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb51-1105"><a href="#cb51-1105" aria-hidden="true" tabindex="-1"></a>\begin{equation}</span>
<span id="cb51-1106"><a href="#cb51-1106" aria-hidden="true" tabindex="-1"></a>\begin{split}</span>
<span id="cb51-1107"><a href="#cb51-1107" aria-hidden="true" tabindex="-1"></a>\lambda &amp; = (1, 3, 5, 10, 25) <span class="sc">\\</span></span>
<span id="cb51-1108"><a href="#cb51-1108" aria-hidden="true" tabindex="-1"></a>\nu &amp; = (0.5, 0.75, 1, 1.25, 1.5, 2) <span class="sc">\\</span></span>
<span id="cb51-1109"><a href="#cb51-1109" aria-hidden="true" tabindex="-1"></a>N &amp; = (25, 50, 100, 500) <span class="sc">\\</span></span>
<span id="cb51-1110"><a href="#cb51-1110" aria-hidden="true" tabindex="-1"></a>\end{split}</span>
<span id="cb51-1111"><a href="#cb51-1111" aria-hidden="true" tabindex="-1"></a>\end{equation}</span>
<span id="cb51-1112"><a href="#cb51-1112" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb51-1113"><a href="#cb51-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1114"><a href="#cb51-1114" aria-hidden="true" tabindex="-1"></a>With those, we will take the following steps to carry out the simulation _for each combination of $\lambda$, $\nu$, and $N$_:</span>
<span id="cb51-1115"><a href="#cb51-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1116"><a href="#cb51-1116" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Generate $N$ random COM-Poisson realizations</span>
<span id="cb51-1117"><a href="#cb51-1117" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Fit an intercept-only COM-Poisson regression model</span>
<span id="cb51-1118"><a href="#cb51-1118" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Conduct the likelihood ratio test for equidispersion</span>
<span id="cb51-1119"><a href="#cb51-1119" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Calculate the p-value from (3)</span>
<span id="cb51-1120"><a href="#cb51-1120" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Repeat steps 1-4 for 100 iterations</span>
<span id="cb51-1121"><a href="#cb51-1121" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>Compute the proportion of iterations in (5) where the p-value was less than 0.05</span>
<span id="cb51-1122"><a href="#cb51-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1123"><a href="#cb51-1123" aria-hidden="true" tabindex="-1"></a>The following code chunk carries out these steps:</span>
<span id="cb51-1124"><a href="#cb51-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1125"><a href="#cb51-1125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb51-1126"><a href="#cb51-1126" aria-hidden="true" tabindex="-1"></a><span class="in"># NOTE: THIS CHUNK TAKES A WHILE TO RUN</span></span>
<span id="cb51-1127"><a href="#cb51-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1128"><a href="#cb51-1128" aria-hidden="true" tabindex="-1"></a><span class="in"># Number of iterations</span></span>
<span id="cb51-1129"><a href="#cb51-1129" aria-hidden="true" tabindex="-1"></a><span class="in">sims &lt;- 100</span></span>
<span id="cb51-1130"><a href="#cb51-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1131"><a href="#cb51-1131" aria-hidden="true" tabindex="-1"></a><span class="in">power_results &lt;-</span></span>
<span id="cb51-1132"><a href="#cb51-1132" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb51-1133"><a href="#cb51-1133" aria-hidden="true" tabindex="-1"></a><span class="in">  # Parameter set</span></span>
<span id="cb51-1134"><a href="#cb51-1134" aria-hidden="true" tabindex="-1"></a><span class="in">  list(</span></span>
<span id="cb51-1135"><a href="#cb51-1135" aria-hidden="true" tabindex="-1"></a><span class="in">    lambda = c(1, 3, 5, 10, 25),</span></span>
<span id="cb51-1136"><a href="#cb51-1136" aria-hidden="true" tabindex="-1"></a><span class="in">    nu = c(0.5, 0.75, 1, 1.25, 1.5, 2),</span></span>
<span id="cb51-1137"><a href="#cb51-1137" aria-hidden="true" tabindex="-1"></a><span class="in">    N  = c(25, 50, 100, 500)</span></span>
<span id="cb51-1138"><a href="#cb51-1138" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb51-1139"><a href="#cb51-1139" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb51-1140"><a href="#cb51-1140" aria-hidden="true" tabindex="-1"></a><span class="in">  # Get the cross product</span></span>
<span id="cb51-1141"><a href="#cb51-1141" aria-hidden="true" tabindex="-1"></a><span class="in">  cross_df() %&gt;%</span></span>
<span id="cb51-1142"><a href="#cb51-1142" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb51-1143"><a href="#cb51-1143" aria-hidden="true" tabindex="-1"></a><span class="in">  # Split into a list</span></span>
<span id="cb51-1144"><a href="#cb51-1144" aria-hidden="true" tabindex="-1"></a><span class="in">  split(1:nrow(.)) %&gt;%</span></span>
<span id="cb51-1145"><a href="#cb51-1145" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb51-1146"><a href="#cb51-1146" aria-hidden="true" tabindex="-1"></a><span class="in">  # For each parameter combination</span></span>
<span id="cb51-1147"><a href="#cb51-1147" aria-hidden="true" tabindex="-1"></a><span class="in">  map_df(</span></span>
<span id="cb51-1148"><a href="#cb51-1148" aria-hidden="true" tabindex="-1"></a><span class="in">    function(x) {</span></span>
<span id="cb51-1149"><a href="#cb51-1149" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb51-1150"><a href="#cb51-1150" aria-hidden="true" tabindex="-1"></a><span class="in">      # Generate all CMP realizations</span></span>
<span id="cb51-1151"><a href="#cb51-1151" aria-hidden="true" tabindex="-1"></a><span class="in">      tibble(</span></span>
<span id="cb51-1152"><a href="#cb51-1152" aria-hidden="true" tabindex="-1"></a><span class="in">        S = rep(1:sims, x$N),</span></span>
<span id="cb51-1153"><a href="#cb51-1153" aria-hidden="true" tabindex="-1"></a><span class="in">        Y = rcmp(n = x$N * sims, lambda = x$lambda, nu = x$nu)</span></span>
<span id="cb51-1154"><a href="#cb51-1154" aria-hidden="true" tabindex="-1"></a><span class="in">      ) %&gt;%</span></span>
<span id="cb51-1155"><a href="#cb51-1155" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb51-1156"><a href="#cb51-1156" aria-hidden="true" tabindex="-1"></a><span class="in">        # For each iteration</span></span>
<span id="cb51-1157"><a href="#cb51-1157" aria-hidden="true" tabindex="-1"></a><span class="in">        group_by(S) %&gt;%</span></span>
<span id="cb51-1158"><a href="#cb51-1158" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb51-1159"><a href="#cb51-1159" aria-hidden="true" tabindex="-1"></a><span class="in">        # Compute the p-value</span></span>
<span id="cb51-1160"><a href="#cb51-1160" aria-hidden="true" tabindex="-1"></a><span class="in">        summarise(</span></span>
<span id="cb51-1161"><a href="#cb51-1161" aria-hidden="true" tabindex="-1"></a><span class="in">          PValue = </span></span>
<span id="cb51-1162"><a href="#cb51-1162" aria-hidden="true" tabindex="-1"></a><span class="in">            tryCatch(</span></span>
<span id="cb51-1163"><a href="#cb51-1163" aria-hidden="true" tabindex="-1"></a><span class="in">              equitest(glm.cmp(Y ~ 1))$pvalue,</span></span>
<span id="cb51-1164"><a href="#cb51-1164" aria-hidden="true" tabindex="-1"></a><span class="in">              error = function(e) NA_real_</span></span>
<span id="cb51-1165"><a href="#cb51-1165" aria-hidden="true" tabindex="-1"></a><span class="in">            ),</span></span>
<span id="cb51-1166"><a href="#cb51-1166" aria-hidden="true" tabindex="-1"></a><span class="in">          .groups = "drop"</span></span>
<span id="cb51-1167"><a href="#cb51-1167" aria-hidden="true" tabindex="-1"></a><span class="in">        ) %&gt;%</span></span>
<span id="cb51-1168"><a href="#cb51-1168" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb51-1169"><a href="#cb51-1169" aria-hidden="true" tabindex="-1"></a><span class="in">        # Add the parameter values</span></span>
<span id="cb51-1170"><a href="#cb51-1170" aria-hidden="true" tabindex="-1"></a><span class="in">        mutate(</span></span>
<span id="cb51-1171"><a href="#cb51-1171" aria-hidden="true" tabindex="-1"></a><span class="in">          lambda = x$lambda,</span></span>
<span id="cb51-1172"><a href="#cb51-1172" aria-hidden="true" tabindex="-1"></a><span class="in">          nu = x$nu,</span></span>
<span id="cb51-1173"><a href="#cb51-1173" aria-hidden="true" tabindex="-1"></a><span class="in">          N = x$N</span></span>
<span id="cb51-1174"><a href="#cb51-1174" aria-hidden="true" tabindex="-1"></a><span class="in">        )</span></span>
<span id="cb51-1175"><a href="#cb51-1175" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb51-1176"><a href="#cb51-1176" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb51-1177"><a href="#cb51-1177" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb51-1178"><a href="#cb51-1178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1179"><a href="#cb51-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1180"><a href="#cb51-1180" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo = FALSE}</span></span>
<span id="cb51-1181"><a href="#cb51-1181" aria-hidden="true" tabindex="-1"></a><span class="in"># Load the simulation results</span></span>
<span id="cb51-1182"><a href="#cb51-1182" aria-hidden="true" tabindex="-1"></a><span class="in">load(file = "/Users/alexzajichek/Documents/GitHub/power_results.RData")</span></span>
<span id="cb51-1183"><a href="#cb51-1183" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1184"><a href="#cb51-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1185"><a href="#cb51-1185" aria-hidden="true" tabindex="-1"></a>This code took quite a while to run (~4 hours). I've noticed the fitting procedure takes a bit longer than we'd be used to with a simple <span class="in">`glm`</span> call (which is probably expected given the complexity of the estimation), and varies depending on the combination of parameter values. It's also worth noting that it failed to converge on <span class="in">`r paste0(round(mean(is.na(power_results$PValue)) * 100, 1), "%")`</span> of simulations, which tended to only occur when there was overdispersion ($\nu=0.5$) with large counts ($\lambda &gt; 5$). Nevertheless, the figure below gives us the results of the simulation showing the estimated power for each parameter combination:</span>
<span id="cb51-1186"><a href="#cb51-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1189"><a href="#cb51-1189" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb51-1190"><a href="#cb51-1190" aria-hidden="true" tabindex="-1"></a>power_results <span class="sc">%&gt;%</span></span>
<span id="cb51-1191"><a href="#cb51-1191" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-1192"><a href="#cb51-1192" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each group</span></span>
<span id="cb51-1193"><a href="#cb51-1193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lambda, nu, N) <span class="sc">%&gt;%</span></span>
<span id="cb51-1194"><a href="#cb51-1194" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-1195"><a href="#cb51-1195" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the power, and a measure of simulation error</span></span>
<span id="cb51-1196"><a href="#cb51-1196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb51-1197"><a href="#cb51-1197" aria-hidden="true" tabindex="-1"></a>    <span class="at">Power =</span> <span class="fu">mean</span>(PValue <span class="sc">&lt;=</span> <span class="fl">0.05</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb51-1198"><a href="#cb51-1198" aria-hidden="true" tabindex="-1"></a>    <span class="at">SE =</span> <span class="fu">sd</span>(PValue <span class="sc">&lt;=</span> <span class="fl">0.05</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">n</span>()),</span>
<span id="cb51-1199"><a href="#cb51-1199" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb51-1200"><a href="#cb51-1200" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-1201"><a href="#cb51-1201" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-1202"><a href="#cb51-1202" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a factor</span></span>
<span id="cb51-1203"><a href="#cb51-1203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb51-1204"><a href="#cb51-1204" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">factor</span>(N),</span>
<span id="cb51-1205"><a href="#cb51-1205" aria-hidden="true" tabindex="-1"></a>    <span class="at">nu =</span> </span>
<span id="cb51-1206"><a href="#cb51-1206" aria-hidden="true" tabindex="-1"></a>      nu <span class="sc">%&gt;%</span></span>
<span id="cb51-1207"><a href="#cb51-1207" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-1208"><a href="#cb51-1208" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct_relabel</span>(</span>
<span id="cb51-1209"><a href="#cb51-1209" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x) <span class="fu">paste0</span>(<span class="st">"nu == "</span>, x)</span>
<span id="cb51-1210"><a href="#cb51-1210" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb51-1211"><a href="#cb51-1211" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb51-1212"><a href="#cb51-1212" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-1213"><a href="#cb51-1213" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb51-1214"><a href="#cb51-1214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb51-1215"><a href="#cb51-1215" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-1216"><a href="#cb51-1216" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> lambda,</span>
<span id="cb51-1217"><a href="#cb51-1217" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Power</span>
<span id="cb51-1218"><a href="#cb51-1218" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-1219"><a href="#cb51-1219" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-1220"><a href="#cb51-1220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb51-1221"><a href="#cb51-1221" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-1222"><a href="#cb51-1222" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> N</span>
<span id="cb51-1223"><a href="#cb51-1223" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-1224"><a href="#cb51-1224" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb51-1225"><a href="#cb51-1225" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-1226"><a href="#cb51-1226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb51-1227"><a href="#cb51-1227" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-1228"><a href="#cb51-1228" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> N</span>
<span id="cb51-1229"><a href="#cb51-1229" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-1230"><a href="#cb51-1230" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb51-1231"><a href="#cb51-1231" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-1232"><a href="#cb51-1232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(</span>
<span id="cb51-1233"><a href="#cb51-1233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb51-1234"><a href="#cb51-1234" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymin =</span> Power <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>SE,</span>
<span id="cb51-1235"><a href="#cb51-1235" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymax =</span> Power <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>SE,</span>
<span id="cb51-1236"><a href="#cb51-1236" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> N</span>
<span id="cb51-1237"><a href="#cb51-1237" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-1238"><a href="#cb51-1238" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">35</span></span>
<span id="cb51-1239"><a href="#cb51-1239" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-1240"><a href="#cb51-1240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb51-1241"><a href="#cb51-1241" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>nu,</span>
<span id="cb51-1242"><a href="#cb51-1242" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"label_parsed"</span></span>
<span id="cb51-1243"><a href="#cb51-1243" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-1244"><a href="#cb51-1244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Power"</span>) <span class="sc">+</span></span>
<span id="cb51-1245"><a href="#cb51-1245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb51-1246"><a href="#cb51-1246" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb51-1247"><a href="#cb51-1247" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb51-1248"><a href="#cb51-1248" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-1249"><a href="#cb51-1249" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb51-1250"><a href="#cb51-1250" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb51-1251"><a href="#cb51-1251" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>)</span>
<span id="cb51-1252"><a href="#cb51-1252" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-1253"><a href="#cb51-1253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb51-1254"><a href="#cb51-1254" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">unique</span>(power_results<span class="sc">$</span>lambda)</span>
<span id="cb51-1255"><a href="#cb51-1255" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-1256"><a href="#cb51-1256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb51-1257"><a href="#cb51-1257" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(lambda)</span>
<span id="cb51-1258"><a href="#cb51-1258" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-1259"><a href="#cb51-1259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1260"><a href="#cb51-1260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1261"><a href="#cb51-1261" aria-hidden="true" tabindex="-1"></a>**Findings**:</span>
<span id="cb51-1262"><a href="#cb51-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1263"><a href="#cb51-1263" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The power increases with sample size and deviation from $\nu=1$</span>
<span id="cb51-1264"><a href="#cb51-1264" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The test has a much harder time detecting over/under dispersion when the counts are really small (i.e., $\lambda = 1$) </span>
<span id="cb51-1265"><a href="#cb51-1265" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>When there is overdispersion ($\nu&lt;1$), the power looks higher at lower values of $\lambda$, but the opposite occurs as the data becomes more underdispersed</span>
<span id="cb51-1266"><a href="#cb51-1266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1267"><a href="#cb51-1267" aria-hidden="true" tabindex="-1"></a><span class="fu"># Conclusion {#conclusion}</span></span>
<span id="cb51-1268"><a href="#cb51-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1269"><a href="#cb51-1269" aria-hidden="true" tabindex="-1"></a>The COM-Poisson regression framework is another tool in the toolbox to consider when modeling count data. Given that it is a generalization of the standard Poisson model that handles both over and under dispersed data, a good strategy may be to use it as a starting point to explore the variability in a dataset, and then shape the model from there. The likelihood ratio test allows us to test for violations of equidispersion, at which point we can use estimation to identify the direction that the dispersion exists. Since there are popular methods to handle overdispersed data (e.g., negative binomial models), the real void this method fills is its handling of underdispersed data--the challenge there may simply be finding the use case.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>¬© 2024 Zajichek Stats</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>