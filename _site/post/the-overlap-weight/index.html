<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alex Zajichek">
<meta name="dcterms.date" content="2023-10-02">
<meta name="description" content="A simulation review">

<title>The overlap weight in survival analysis – Zajichek Stats</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../logo.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-9MW3W3RQD9"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-9MW3W3RQD9', { 'anonymize_ip': true});
</script>
<script src="../../site_libs/core-js-2.5.3/shim.min.js"></script>
<script src="../../site_libs/react-18.2.0/react.min.js"></script>
<script src="../../site_libs/react-18.2.0/react-dom.min.js"></script>
<script src="../../site_libs/reactwidget-2.0.0/react-tools.umd.cjs"></script>
<link href="../../site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="../../site_libs/reactable-0.4.4/reactable.css" rel="stylesheet">
<script src="../../site_libs/reactable-binding-0.4.4/reactable.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="The overlap weight in survival analysis – Zajichek Stats">
<meta property="og:description" content="A simulation review">
<meta property="og:image" content="https://www.zajichekstats.com/post/the-overlap-weight/feature.png">
<meta property="og:site_name" content="Zajichek Stats">
<meta property="og:image:height" content="402">
<meta property="og:image:width" content="397">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Zajichek Stats</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/alexzajichek"> <i class="bi bi-linkedin" role="img" aria-label="LinkedIn">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.youtube.com/@centralstatz"> <i class="bi bi-youtube" role="img" aria-label="YouTube">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/zajichek"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">The overlap weight in survival analysis</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">Causal Inference</div>
    <div class="quarto-category">Survival Analysis</div>
    <div class="quarto-category">Propensity Scores</div>
    <div class="quarto-category">Weighting</div>
  </div>
  </div>

<div>
  <div class="description">
    A simulation review
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Alex Zajichek </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 2, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>I was recently introduced to <a href="https://jamanetwork.com/journals/jama/article-abstract/2765748">overlap weighting</a>, which is part of a general family of methods for balancing covariates when estimating treatment effects with observational data. Specifically, it focuses on the <a href="https://www.sciencedirect.com/topics/medicine-and-dentistry/clinical-equipoise#:~:text=Clinical%20equipoise%20is%20defined%20as,Seminars%20in%20Vascular%20Surgery%2C%202022"><em>clinical equipoise</em></a>; that is, the patients in which the treatment decision is most uncertain. I find it more elegant than <a href="https://en.wikipedia.org/wiki/Propensity_score_matching">matching</a> (which I’ve <a href="https://jamanetwork.com/journals/jama/fullarticle/2749478">used in the past</a>), and figured a useful way to better understand the approach is to deconstruct, interpret, and translate a <a href="http://www2.stat.duke.edu/~fl35/OW/OW_survival_Demo.sas">SAS simulation</a> in the context of survival analysis implemented by the <a href="https://pubmed.ncbi.nlm.nih.gov/30189042/">original authors</a>. All code is written in (and translated to) <a href="https://www.r-project.org/"><code>R</code></a>. We’ll start by loading some packages.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reactable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="table-of-contents" class="level1">
<h1>Table of Contents</h1>
<ul>
<li><a href="#potentialoutcomes">Setting up the potential outcomes</a>
<ul>
<li><a href="#simulatepatients">Simulate some patients</a></li>
<li><a href="#treatmentpropensity">Define the treatment propensity</a></li>
<li><a href="#treatmentassignment">Generate the treatment assignment</a></li>
<li><a href="#trueoverlapweight">Compute the (true) overlap weight</a></li>
<li><a href="#treatmenteffect">Set the treatment effect</a></li>
<li><a href="#observedoutcome">Assign the observed outcome</a></li>
</ul></li>
<li><a href="#estimatingweights">Estimating the weights</a>
<ul>
<li><a href="#modelpropensityscores">Model the propensity scores</a></li>
<li><a href="#estimatedoverlapweight">Calculate the (estimated) overlap weight</a></li>
</ul></li>
<li><a href="#estimatingtreatmenteffect">Estimating the treatment effect</a>
<ul>
<li><a href="#truehazardratio">A look at the true hazard ratio</a></li>
<li><a href="#estimatedhazardratio">The final estimate</a></li>
</ul></li>
</ul>
</section>
<section id="potentialoutcomes" class="level1">
<h1>Setting up the potential outcomes</h1>
<p>The theoretical underpinnings of <a href="https://pubmed.ncbi.nlm.nih.gov/30189042/">overlap weighting</a> live in the context of the <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5841618/#:~:text=The%20potential%20outcomes%20framework%20provides%20a%20way%20to%20quantify%20causal,exposure%20or%20intervention%20under%20consideration.">potential outcomes</a> paradigm of <a href="https://www.sciencedirect.com/topics/social-sciences/causal-inference">causal inference</a>. Basically, we wonder what <em>would have</em> happened had we been able to observe each patient under both treatments (known as the <a href="https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/1471-2288-5-28">counterfactual</a>). If we knew the outcomes from the two worlds, the causal treatment effect would simply be the average difference across all patients. The problem of course is that in reality the outcome can only be observed for the treatment in which the patient was assigned (or chose), and so our goal is to work with the “incomplete” information that we do have to try to estimate what the outcome difference would have been had the counterfactual been observed as well.</p>
<section id="simulatepatients" class="level2">
<h2 class="anchored" data-anchor-id="simulatepatients">Simulate some patients</h2>
<p>The first thing we need to do is generate some (fake) patients to facilitate the simulation. Here we’ll focus on age, sex, and income as patient-identifying characteristics.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the sample size</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the seed</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the population</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">10</span>),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">zage =</span> (age <span class="sc">-</span> <span class="dv">50</span>) <span class="sc">/</span> <span class="dv">10</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">male =</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.6</span>),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">income =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">10</span>),</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">zincome =</span> (income <span class="sc">-</span> <span class="dv">50</span>) <span class="sc">/</span> <span class="dv">10</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>population</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,000 × 5
     age    zage  male income zincome
   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt;   &lt;dbl&gt;
 1  44.4 -0.560      0   36.5  -1.35 
 2  47.7 -0.230      1   44.2  -0.579
 3  65.6  1.56       1   41.4  -0.861
 4  50.7  0.0705     1   59.7   0.973
 5  51.3  0.129      0   56.2   0.619
 6  67.2  1.72       1   63.9   1.39 
 7  54.6  0.461      1   35.1  -1.49 
 8  37.3 -1.27       1   56.4   0.639
 9  43.1 -0.687      1   53.7   0.375
10  45.5 -0.446      1   53.7   0.370
# ℹ 9,990 more rows</code></pre>
</div>
</div>
<p>We’ve generated a sample of 10000 patients. We’ll assume <code>age</code> is measured in years, <code>income</code> in thousands of dollars ($), and <code>male</code> is 1 for <em>Male</em> and 0 for <em>Female</em>. The columns <code>zage</code> and <code>zincome</code> are just <a href="https://statisticsbyjim.com/glossary/standardization/#:~:text=In%20statistics%2C%20standardization%20is%20the,standard%20deviation%20for%20a%20variable.">standardized</a> versions of the originals to avoid scaling nuances (we’ll refer to these as <span class="math inline">\(age_z\)</span> and <span class="math inline">\(income_z\)</span>).</p>
</section>
<section id="treatmentpropensity" class="level2">
<h2 class="anchored" data-anchor-id="treatmentpropensity">Define the treatment propensity</h2>
<p>Here’s where the important theory starts to creep in (already). We assume that there is a <em>true</em> propensity score, say <span class="math inline">\(p_i^A\)</span>, that is the <em>true</em> probability that patient <em>i</em> receives treatment <em>A</em> given their specific characteristics (and let’s assume there are possible treatments <em>A</em> &amp; <em>B</em>). Further, we assume (some transformation of) this probability is a linear combination of all the characteristics that confound the crude treatment effect on the outcome. In this simulation, we’ll assume the <a href="https://en.wikipedia.org/wiki/Logistic_regression">logit</a> model:</p>
<p><span class="math display">\[log(\frac{p_i^A}{1 - p_i^A}) = 0.41 \times age_z - 0.22 \times male - 0.69 \times income_z - 0.40\]</span></p>
<p>So let’s add this <em>true</em> propensity score to the <code>population</code> data set:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the true propensity score (unknown quantity)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_odds_pA =</span> <span class="sc">-</span><span class="fl">0.4</span> <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.5</span>)<span class="sc">*</span>zage <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">0.8</span>)<span class="sc">*</span>male <span class="sc">+</span> <span class="fu">log</span>(.<span class="dv">50</span>)<span class="sc">*</span>zincome,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">pA =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>log_odds_pA))</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>population</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,000 × 7
     age    zage  male income zincome log_odds_pA    pA
   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;
 1  44.4 -0.560      0   36.5  -1.35        0.311 0.577
 2  47.7 -0.230      1   44.2  -0.579      -0.315 0.422
 3  65.6  1.56       1   41.4  -0.861       0.606 0.647
 4  50.7  0.0705     1   59.7   0.973      -1.27  0.219
 5  51.3  0.129      0   56.2   0.619      -0.777 0.315
 6  67.2  1.72       1   63.9   1.39       -0.888 0.292
 7  54.6  0.461      1   35.1  -1.49        0.595 0.644
 8  37.3 -1.27       1   56.4   0.639      -1.58  0.171
 9  43.1 -0.687      1   53.7   0.375      -1.16  0.238
10  45.5 -0.446      1   53.7   0.370      -1.06  0.257
# ℹ 9,990 more rows</code></pre>
</div>
</div>
<p>Obviously in practice we don’t know what <span class="math inline">\(p_i^A\)</span> is, so it must be <em>estimated</em> from the treatment assignments we observe in the data. Additionally, we aren’t strictly required to assume the <a href="https://en.wikipedia.org/wiki/Logistic_regression">logit</a> model, but when we use it to estimate the propensity score for <a href="https://pubmed.ncbi.nlm.nih.gov/30189042/">overlap weighting</a>, it has the advantageous property of perfect balance. That is, the weighted-mean differences for all covariates included in the logistic regression model will be zero across the treatment groups.</p>
</section>
<section id="treatmentassignment" class="level2">
<h2 class="anchored" data-anchor-id="treatmentassignment">Generate the treatment assignment</h2>
<p>The treatment assignment is one of the <em>known</em> quantities we would observe in a real life sample, and that is what would be used as the dependent variable for <em>estimating</em> propensity scores. However, since we are running a simulation, we need to generate the treatment assignments from the governing distribution. We assume that the observed treatment for patient <em>i</em> is the result of an (unfair) coin flip that has a probability equal to the <a href="#treatmentpropensity">true propensity score</a>. In statistical notation,</p>
<p><span class="math display">\[A_i \sim Bernoulli(p_i^A)\]</span></p>
<p>where <span class="math inline">\(A_i\)</span> is the indicator of treatment A. Let’s add a <em>realized</em> treatment assignment to the <code>population</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the realized treatment assignment (known quantity)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> pA),</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>population</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,000 × 8
     age    zage  male income zincome log_odds_pA    pA     A
   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
 1  44.4 -0.560      0   36.5  -1.35        0.311 0.577     1
 2  47.7 -0.230      1   44.2  -0.579      -0.315 0.422     0
 3  65.6  1.56       1   41.4  -0.861       0.606 0.647     1
 4  50.7  0.0705     1   59.7   0.973      -1.27  0.219     0
 5  51.3  0.129      0   56.2   0.619      -0.777 0.315     1
 6  67.2  1.72       1   63.9   1.39       -0.888 0.292     1
 7  54.6  0.461      1   35.1  -1.49        0.595 0.644     0
 8  37.3 -1.27       1   56.4   0.639      -1.58  0.171     0
 9  43.1 -0.687      1   53.7   0.375      -1.16  0.238     0
10  45.5 -0.446      1   53.7   0.370      -1.06  0.257     0
# ℹ 9,990 more rows</code></pre>
</div>
</div>
<p>In this case, <code>A=1</code> represents treatment <em>A</em> and <code>A=0</code> represents treatment <em>B</em>. Again, this is the actual treatment we would observe the patient receiving in a sample.</p>
</section>
<section id="trueoverlapweight" class="level2">
<h2 class="anchored" data-anchor-id="trueoverlapweight">Compute the (true) overlap weight</h2>
<p>We need to define what the overlap weight is, and it’s actually quite simple: just assign the patient the probability they <em>did not</em> receive their observed treatment.</p>
<p><span class="math display">\[
\begin{equation}
OW_i=
    \begin{cases}
        1-p_i^A &amp; \text{if } A_i=1\\
        p_i^A &amp; \text{if } A_i=0\\
    \end{cases}
\end{equation}
\]</span></p>
<p>Notice the notation. Since it depends on the <a href="#treatmentpropensity">true propensity score</a>, the overlap weight is another <em>unknown</em> quantity that is estimated from the data. It also depends on the <a href="#treatmentassignment">realized treatment assignment</a>, so the collection of weights across patients differ depending on the observed treatment distribution. We can add these weights to the <code>population</code> data set:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the true overlap weight for the realized treatment (unknown quantity)</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">OW =</span> A <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>pA) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>A) <span class="sc">*</span> pA</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>population</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,000 × 9
     age    zage  male income zincome log_odds_pA    pA     A    OW
   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;
 1  44.4 -0.560      0   36.5  -1.35        0.311 0.577     1 0.423
 2  47.7 -0.230      1   44.2  -0.579      -0.315 0.422     0 0.422
 3  65.6  1.56       1   41.4  -0.861       0.606 0.647     1 0.353
 4  50.7  0.0705     1   59.7   0.973      -1.27  0.219     0 0.219
 5  51.3  0.129      0   56.2   0.619      -0.777 0.315     1 0.685
 6  67.2  1.72       1   63.9   1.39       -0.888 0.292     1 0.708
 7  54.6  0.461      1   35.1  -1.49        0.595 0.644     0 0.644
 8  37.3 -1.27       1   56.4   0.639      -1.58  0.171     0 0.171
 9  43.1 -0.687      1   53.7   0.375      -1.16  0.238     0 0.238
10  45.5 -0.446      1   53.7   0.370      -1.06  0.257     0 0.257
# ℹ 9,990 more rows</code></pre>
</div>
</div>
<p>In a real analysis, these weights are what we are ultimately after in order to estimate the average <em>causal</em> treatment effect on the outcome of interest while balancing differences in patient characteristics across the groups (i.e., removing the confounding factors).</p>
<section id="targetpopulation" class="level3">
<h3 class="anchored" data-anchor-id="targetpopulation">Target population</h3>
<p>Now we do end up normalizing the weights so they sum to one within each treatment group. But the intuition about what’s happening is that the focus of the treatment effect estimation is shifted to patients that are most likely in <em>either</em> treatment group. This is known as the <a href="https://www.sciencedirect.com/topics/medicine-and-dentistry/clinical-equipoise#:~:text=Clinical%20equipoise%20is%20defined%20as,Seminars%20in%20Vascular%20Surgery%2C%202022"><em>clinical equipoise</em></a>, and the resulting treatment effect is interpreted as the <em>average treatment effect in the overlap population</em>.</p>
<p>This makes a lot of sense. When we’re comparing treatments, we should focus most heavily on patients that could be candidates for either, and less so on patients that were bound for one. Thus, we up-weight patients who have the most overlap in characteristics with the opposing treatment group. The beautiful thing here is that we do this without throwing away any information; smoothly and proportionately weighting each subject just the amount that we should.</p>
</section>
</section>
<section id="treatmenteffect" class="level2">
<h2 class="anchored" data-anchor-id="treatmenteffect">Set the treatment effect</h2>
<p>We’ve <a href="#treatmentassignment">generated the treatments</a> and established how they are <a href="#treatmentpropensity">related to patient characteristics</a>, but haven’t talked about the outcome in which we’re ultimately interested in estimating the treatment effect for. Since we’re focusing on <a href="https://www.publichealth.columbia.edu/research/population-health-methods/time-event-data-analysis">time-to-event</a> outcomes, we’ll stay in that context, but the general idea is that we assume there <em>exists</em> a realization of what a patient’s outcome would have been under each treatment scenario. Then if we compare the difference of those outcomes across all patients, the average difference must be caused by the treatment.</p>
<section id="defining-the-event-times" class="level3">
<h3 class="anchored" data-anchor-id="defining-the-event-times">Defining the event times</h3>
<p>In this simulation, we’ll generate event times from a <a href="https://en.wikipedia.org/wiki/Weibull_distribution">Weibull</a> distribution. Starting at treatment initiation, this might be the time until cancer recurrence, hospitalization, or something else; we’re just looking to see how long it takes for some event to occur. The <a href="https://en.wikipedia.org/wiki/Probability_density_function">PDF</a> for this distribution looks <a href="https://stat.ethz.ch/R-manual/R-devel/library/stats/html/Weibull.html">like this</a>:</p>
<p><span class="math display">\[f(t) = \frac{\alpha}{\sigma}\left(\frac{t}{\sigma}\right)^{\alpha-1}e^{-\left(\frac{t}{\sigma}\right)^\alpha}\]</span></p>
<p>where <span class="math inline">\(t\)</span> is the event time, <span class="math inline">\(\alpha\)</span> is the <em>shape</em> parameter, and <span class="math inline">\(\sigma\)</span> is the <em>scale</em> parameter. In our example, we will say that:</p>
<p><span class="math display">\[T_i^A \sim Weibull(\alpha, \sigma_i^A)\]</span> <span class="math display">\[T_i^B \sim Weibull(\alpha, \sigma_i^B)\]</span> where <span class="math inline">\(T_i^A\)</span> and <span class="math inline">\(T_i^B\)</span> are the event times under treatments <em>A</em> and <em>B</em>, respectively. That is, the event times for each patient under each treatment follow a <a href="https://en.wikipedia.org/wiki/Weibull_distribution">Weibull</a> distribution with a common <em>shape</em> parameter (in this case, across both treatments), but a <em>scale</em> parameter that depends on the patient’s specific characteristics (in <em>log-linear</em> form) and differs by treatment, which captures the treatment effect. Specifically,</p>
<p><span class="math display">\[\alpha = 1\]</span> <span class="math display">\[\sigma_i^A = \lambda \times e^{-(\phi_i - 0.36)}\]</span> <span class="math display">\[\sigma_i^B = \lambda \times e^{-\phi_i}\]</span> <span class="math display">\[\phi_i = 1.10 \times age_z - 0.22 \times male - 0.36 \times income_z\]</span> <span class="math display">\[\lambda = 4055.56\]</span></p>
<p>Basically, the <span class="math inline">\(\phi_i\)</span> term does the baseline adjustment on the outcome risk for the patient’s specific characteristics, and the treatment effect is simply a fixed, additive deviation from that for all patients. The <span class="math inline">\(\lambda\)</span> term is the <a href="https://www.linkedin.com/advice/0/how-do-you-interpret-hazard-ratio-baseline-function">baseline hazard function</a>, providing the <em>scale</em> parameter when all covariate values are zero (for treatment <em>B</em>), which in this case is constant over time.</p>
<section id="interpretingtreatmenteffect" class="level4">
<h4 class="anchored" data-anchor-id="interpretingtreatmenteffect">Interpreting the treatment effect</h4>
<p>When setting <span class="math inline">\(\alpha=1\)</span>, the mean of a <a href="https://en.wikipedia.org/wiki/Weibull_distribution">Weibull</a> distribution is equal to its scale parameter. That is,</p>
<p><span class="math display">\[E[T_i^A] = \sigma_i^A\]</span> <span class="math display">\[E[T_i^B] = \sigma_i^B\]</span> This gives us a very nice interpretation of the treatment effect. If we compare them <em>relatively</em>, we get:</p>
<p><span class="math display">\[
\begin{equation}
\begin{split}
\frac{E[T_i^A]}{E[T_i^B]} &amp; = \frac{\sigma_i^A}{\sigma_i^B} \\
&amp; = \frac{\lambda \times e^{-(\phi_i - 0.36)}}{\lambda \times e^{-\phi_i}} \\
&amp; = \frac{e^{-(\phi_i - 0.36)}}{e^{-\phi_i}} \\
&amp; = \frac{e^{0.36}e^{-\phi_i}}{e^{-\phi_i}} \\
&amp; = e^{0.36} \\
&amp; \approx 1.43
\end{split}
\end{equation}
\]</span></p>
<p>So we can say that the <em>time to event for patients on treatment A is 1.43 times, or 43%, longer on average than those on treatment B, given a fixed age, sex, and income</em>. That is, treatment A is “better” than treatment B.</p>
</section>
</section>
<section id="samplingeventtimes" class="level3">
<h3 class="anchored" data-anchor-id="samplingeventtimes">Sampling the event times</h3>
<p>Next, we need to actually sample the times for our <code>population</code> (<em>note that it was confirmed that SAS and R have the same parameterizations</em>):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample outcome event times under each treatment (counterfactual)</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Baseline hazard (constant over time)</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> <span class="dv">1</span><span class="sc">*</span><span class="dv">365</span><span class="sc">/</span><span class="fl">0.09</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define TRUE Weibull linear predictor</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">log</span>(<span class="dv">3</span>) <span class="sc">*</span> zage <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">0.8</span>) <span class="sc">*</span> male <span class="sc">+</span> <span class="fu">log</span>(.<span class="dv">70</span>) <span class="sc">*</span> zincome,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma_A =</span> lambda <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>(phi <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">0.70</span>))),</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma_B =</span> lambda <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi),</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate REALIZED survival times under each treatment scenario (same parameterizations in SAS)</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">t_A =</span> <span class="fu">rweibull</span>(n, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> sigma_A),</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">t_B =</span> <span class="fu">rweibull</span>(n, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> sigma_B), </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span> <span class="fu">select</span>(lambda, phi, sigma_A, sigma_B, t_A, t_B)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,000 × 6
   lambda     phi sigma_A sigma_B    t_A   t_B
    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1  4056. -0.133    6617.   4632.  5689. 7760.
 2  4056. -0.269    7585.   5309.  1831. 9482.
 3  4056.  1.80      961.    673.   488.  300.
 4  4056. -0.493    9482.   6637. 23722.  255.
 5  4056. -0.0788   6269.   4388.  7649. 1800.
 6  4056.  1.17     1804.   1263.  1953. 1493.
 7  4056.  0.814    2568.   1797.  5462. 2652.
 8  4056. -1.84    36514.  25560. 38262. 2385.
 9  4056. -1.11    17604.  12323.  3577. 6894.
10  4056. -0.845   13485.   9439. 38541. 3743.
# ℹ 9,990 more rows</code></pre>
</div>
</div>
<p>Now we can make some density plots comparing the event time distributions across treatments (we’ll use <em>log</em> scaling for visual appeal):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send down the rows</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"t_"</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"EventTime"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_prefix =</span> <span class="st">"t_"</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">log</span>(EventTime),</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> Treatment</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">75</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> <span class="cf">function</span>(x) <span class="fu">round</span>(<span class="fu">exp</span>(x))) <span class="sc">+</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Event Time"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Notice the shift to the right in the distribution for treatment <em>A</em>. This is the treatment effect. In the hypothetical world where all patients received treatment <em>A</em>, the event times happened <em>later</em> than in the world where all patients received treatment <em>B</em> (and all event times were observed), indicating, on average, a “benefit” to treatment <em>A</em>, which was expected from our <a href="#interpretingtreatmenteffect">prior calculation</a>.</p>
</section>
</section>
<section id="observedoutcome" class="level2">
<h2 class="anchored" data-anchor-id="observedoutcome">Assign the observed outcome</h2>
<p>The final step for simulation setup is to assign the event time as we might observe in a real data set. The event times generated in the <a href="#samplingeventtimes">previous section</a> capture both treatment scenarios for all patients, but in reality we would only (potentially) observe the event time for the <a href="#treatmentassignment">treatment the patient received</a>. Additionally, we likely (or definitely) won’t be following all patients long enough to observe all events occur, meaning some patients will be <a href="https://en.wikipedia.org/wiki/Survival_analysis#:~:text=Censoring%20%2F%20Censored%20observation%3A%20Censoring%20occurs,after%20the%20time%20of%20censoring.">censored</a>. Let’s add the observed outcomes to the <code>population</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the observed outcome</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The ACTUAL event time outcome depends on the treatment ACTUALLY observed for the patient</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual_event_time =</span> t_B <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> A) <span class="sc">+</span> t_A <span class="sc">*</span> A,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate a REALIZED censoring time (completely random)</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">censor_time =</span> <span class="dv">500</span> <span class="sc">+</span> <span class="dv">500</span> <span class="sc">*</span> <span class="fu">runif</span>(n),</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the OBSERVED time in the data set (known quantity)</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">pmin</span>(actual_event_time, censor_time), <span class="co"># They either had the event, or were censored first</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the event status (TRUE if event observed, FALSE if censored)</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> <span class="fu">as.numeric</span>(actual_event_time <span class="sc">&lt;</span> censor_time)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span> <span class="fu">select</span>(actual_event_time, censor_time, time, status)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,000 × 4
   actual_event_time censor_time  time status
               &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
 1             5689.        843.  843.      0
 2             9482.        814.  814.      0
 3              488.        882.  488.      1
 4              255.        936.  255.      1
 5             7649.        653.  653.      0
 6             1953.        890.  890.      0
 7             2652.        737.  737.      0
 8             2385.        703.  703.      0
 9             6894.        952.  952.      0
10             3743.        526.  526.      0
# ℹ 9,990 more rows</code></pre>
</div>
</div>
<p>Our final simulated data set has the following <em>observed</em> outcome summaries:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute summary metrics</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Patients =</span> <span class="fu">n</span>(),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time =</span> <span class="fu">mean</span>(time),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(A, status)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add shares within treatment</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Percent =</span> Patients <span class="sc">/</span> <span class="fu">sum</span>(Patients),</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> A</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean/rearrange</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">Status =</span> </span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        status <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Event"</span>,</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Censored"</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    Patients,</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    Percent,</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    Time</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Treatment, <span class="fu">desc</span>(Status)) <span class="sc">|&gt;</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a table</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reactable</span>(</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">groupBy =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> </span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">Patients =</span> <span class="fu">colDef</span>(<span class="at">aggregate =</span> <span class="st">"sum"</span>, <span class="at">align =</span> <span class="st">"center"</span>),</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">Percent =</span> <span class="fu">colDef</span>(<span class="at">name =</span> <span class="st">"Percent of patients in treatment group (%)"</span>, <span class="at">aggregate =</span> <span class="st">"sum"</span>, <span class="at">align =</span> <span class="st">"center"</span>, <span class="at">format =</span> <span class="fu">colFormat</span>(<span class="at">digits =</span> <span class="dv">1</span>, <span class="at">percent =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">Time =</span> <span class="fu">colDef</span>(<span class="at">name =</span> <span class="st">"Avg. time to outcome"</span>, <span class="at">aggregate =</span> zildge<span class="sc">::</span><span class="fu">rectbl_agg_wtd</span>(<span class="st">"Patients"</span>), <span class="at">align =</span> <span class="st">"center"</span>, <span class="at">format =</span> <span class="fu">colFormat</span>(<span class="at">digits =</span> <span class="dv">1</span>))</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">striped =</span> <span class="cn">TRUE</span>,</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">highlight =</span> <span class="cn">TRUE</span>,</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">bordered =</span> <span class="cn">TRUE</span>,</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">resizable =</span> <span class="cn">TRUE</span>,</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme =</span> reactablefmtr<span class="sc">::</span><span class="fu">sandstone</span>()</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>  reactablefmtr<span class="sc">::</span><span class="fu">add_source</span>(<span class="st">"Use arrows to expand table"</span>, <span class="at">font_size =</span> <span class="dv">12</span>, <span class="at">font_style =</span> <span class="st">"italic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="reactable html-widget html-fill-item" id="htmlwidget-a2195d80fa4b22595ce8" style="width:auto;height:auto;"></div>
<p style="color:#000;background:#FFFFFF;text-align:left;font-size:12px;font-style:italic;font-weight:normal;text-decoration:;letter-spacing:px;word-spacing:px;text-transform:;text-shadow:;margin-top:0px;margin-right:0px;margin-bottom:0px;margin-left:0px">Use arrows to expand table</p>
<script type="application/json" data-for="htmlwidget-a2195d80fa4b22595ce8">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"Treatment":["A","A","B","B"],"Status":["Event","Censored","Event","Censored"],"Patients":[836,3046,1137,4981],"Percent":[0.215352910870685,0.784647089129315,0.185845047401111,0.814154952598888],"Time":[345.503703338068,745.228837321148,343.475165801799,746.272923924017]},"columns":[{"id":"Treatment","name":"Treatment","type":"character"},{"id":"Status","name":"Status","type":"character"},{"id":"Patients","name":"Patients","type":"numeric","aggregate":"sum","align":"center"},{"id":"Percent","name":"Percent of patients in treatment group (%)","type":"numeric","aggregate":"sum","format":{"cell":{"digits":1,"percent":true},"aggregated":{"digits":1,"percent":true}},"align":"center"},{"id":"Time","name":"Avg. time to outcome","type":"numeric","aggregate":"function(values, rows) {\n            var numerator = 0\n            var denominator = 0\n\n            rows.forEach(function(row, index) {\n                numerator += row['Patients'] * values[index]\n                denominator += row['Patients']\n            })\n\n            if('mean' == 'mean') {\n                return numerator / denominator\n            } else {\n                return numerator\n            }\n        }","format":{"cell":{"digits":1},"aggregated":{"digits":1}},"align":"center"}],"groupBy":["Treatment"],"resizable":true,"highlight":true,"bordered":true,"striped":true,"theme":{"color":"#3e3f3a","backgroundColor":"#ffffff","borderColor":"#f8f5f0","borderWidth":"1px","stripedColor":"#ededed","highlightColor":"#f8f5f0","cellPadding":6,"tableStyle":{"fontSize":15},"headerStyle":{"borderWidth":"2px","backgroundColor":"#f8f5f0","color":"#7c7a78","transitionDuration":"0.5s","&:hover[aria-sort]":{"color":"#000000"},"&[aria-sort='ascending'], &[aria-sort='descending']":{"color":"#000000"},"fontSize":16},"groupHeaderStyle":{"&:not(:empty)":{"color":"#3e3f3a","fontSize":16},"&:hover":{"fontWeight":"bold","transitionDuration":"1s","transitionTimingFunction":"ease-out","color":"#000000"}},"rowSelectedStyle":{"backgroundColor":"#dfd7ca","color":"#8e8c84"},"inputStyle":{"backgroundColor":"#ffffff","borderColor":"#bcbfc1","color":"#3e3f3a"},"searchInputStyle":{"backgroundColor":"#ffffff","color":"#3e3f3a","borderColor":"#bcbfc1","&:focus":{"color":"#3e3f3a"}},"selectStyle":{"backgroundColor":"#dfd7ca","color":"#8e8c84","borderColor":"#ffffff","outlineColor":"#ffffff"},"pageButtonStyle":{"backgroundColor":"#f8f5f0","color":"#8e8c84","&:hover":{"backgroundColor":"#f3969a","color":"#8e8c84"}},"pageButtonHoverStyle":{"backgroundColor":"#dfd7ca","color":"#8e8c84"},"pageButtonActiveStyle":{"backgroundColor":"#dfd7ca","color":"#8e8c84"},"pageButtonCurrentStyle":{"backgroundColor":"#dfd7ca","color":"#8e8c84"}},"dataKey":"803f0e909881888862e5822d6c0d5d1e"},"children":[]},"class":"reactR_markup"},"evals":["tag.attribs.columns.4.aggregate"],"jsHooks":[]}</script>
</div>
</div>
<p><br></p>
<p>We can also look at the survival curves.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Nest by treatment</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(A) <span class="sc">|&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">|&gt;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Esimtate survival curves for each treatment</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Surv =</span> </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">|&gt;</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">map</span>(</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(.trt) {</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Fit the model</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>          mod <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> .trt)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Extract the elements</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>          <span class="fu">tibble</span>(</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">Time =</span> mod<span class="sc">$</span>time,</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">Survival =</span> mod<span class="sc">$</span>surv,</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">Lower =</span> mod<span class="sc">$</span>lower,</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>            <span class="at">Upper =</span> mod<span class="sc">$</span>upper</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unnest the curves</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>data) <span class="sc">|&gt;</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> Surv) <span class="sc">|&gt;</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean labels</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Time,</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Survival</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> Treatment)) <span class="sc">+</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymin =</span> Lower,</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymax =</span> Upper,</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> Treatment</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">25</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>),</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since treatment"</span>) <span class="sc">+</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Survival Probability"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If we weren’t doing a simulation, we wouldn’t know how much of these differences are explained by the treatment. And actually, these crude survival curves suggest longer survival from treatment <em>B</em>, even though we know the <a href="#treatmenteffect">opposite is true</a>. The goal is to use this <em>known</em> information (along with <a href="#simulatepatients">patient characteristics</a>) to estimate the causal treatment effect that is baked into all of the <em>unknown</em> quantities we have here that would be unavailable to us in a real-life analysis.</p>
</section>
</section>
<section id="estimatingweights" class="level1">
<h1>Estimating the weights</h1>
<p>Now that our <a href="#potentialoutcomes">simulation is set</a>, we can start using the observed data (i.e., known quantities) to estimate the case-weights needed for treatment effect estimation. This is the process we’d go through in a real-life analysis, but here we have the benefit of knowing the truth, so we can see how close our estimations are to reality.</p>
<p>The intention of these weights is to <em>adjust</em> the observed sample to create a <em>pseudo-population</em> such that the patient characteristics that we believe are confounding the treatment effect are corrected for, or <em>balanced</em>, across the treatment groups. The term “pseudo” here is a little misleading. It’s simply referring to the fact that each patient will not contribute the same weight in estimating the treatment effect. In fact, the patients with the most <em>overlap</em> in characteristics across the treatment groups will contribute the most, with patients being proportionately down-weighted the less overlap they have (I’d argue this is the same thing that is done in <a href="https://en.wikipedia.org/wiki/Propensity_score_matching">matching</a>, it’s just that the weights for patients are either exactly <em>1</em> or <em>0</em>). This is done to tease out the portion of the outcome differences that is explained by the treatment, namely, the causal treatment effect.</p>
<section id="modelpropensityscores" class="level2">
<h2 class="anchored" data-anchor-id="modelpropensityscores">Model the propensity scores</h2>
<p>We’ve <a href="#trueoverlapweight">established</a> that the overlap weights are quantities that need to be estimated from the data. In order to calculate those weights, we first need to estimate the propensity scores. We know what the <a href="#treatmentpropensity">true model</a> is, but let’s assume we are only working with observable data:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span> <span class="fu">select</span>(zage, male, zincome, A, time, status)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,000 × 6
      zage  male zincome     A  time status
     &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;
 1 -0.560      0  -1.35      1  843.      0
 2 -0.230      1  -0.579     0  814.      0
 3  1.56       1  -0.861     1  488.      1
 4  0.0705     1   0.973     0  255.      1
 5  0.129      0   0.619     1  653.      0
 6  1.72       1   1.39      1  890.      0
 7  0.461      1  -1.49      0  737.      0
 8 -1.27       1   0.639     0  703.      0
 9 -0.687      1   0.375     0  952.      0
10 -0.446      1   0.370     0  526.      0
# ℹ 9,990 more rows</code></pre>
</div>
</div>
<p>Our goal is to obtain patient-specific probabilities of receiving treatment <em>A</em>. We’ll estimate this with a <a href="https://en.wikipedia.org/wiki/Logistic_regression">logistic regression</a> model, but we’ll allow for some flexibility in the shape of the relationships between the continuous variables (age and income) and the outcome with the use of <a href="https://www.nature.com/articles/s41409-019-0679-x">restricted cubic splines</a> (see my <a href="https://www.zajichekstats.com/post/the-evasive-spline/">other post</a> for another explanation):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the propensity score model</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>ps_mod <span class="ot">&lt;-</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> A <span class="sc">~</span> rms<span class="sc">::</span><span class="fu">rcs</span>(zage, <span class="dv">3</span>) <span class="sc">+</span> rms<span class="sc">::</span><span class="fu">rcs</span>(zincome, <span class="dv">3</span>) <span class="sc">+</span> <span class="fu">factor</span>(male),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> population,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"binomial"</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ps_mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = A ~ rms::rcs(zage, 3) + rms::rcs(zincome, 3) + 
    factor(male), family = "binomial", data = population)

Coefficients:
                             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                  -0.30027    0.06527  -4.600 4.22e-06 ***
rms::rcs(zage, 3)zage         0.40206    0.05099   7.885 3.16e-15 ***
rms::rcs(zage, 3)zage'       -0.07337    0.05813  -1.262    0.207    
rms::rcs(zincome, 3)zincome  -0.63792    0.04950 -12.888  &lt; 2e-16 ***
rms::rcs(zincome, 3)zincome' -0.04020    0.06434  -0.625    0.532    
factor(male)1                -0.25432    0.04415  -5.760 8.41e-09 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 13359  on 9999  degrees of freedom
Residual deviance: 12193  on 9994  degrees of freedom
AIC: 12205

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>The model seems to indicate that the non-linear terms for age and income don’t particularly matter (which <a href="#treatmentpropensity">is expected</a>), but we’ll leave it as-is. Next, let’s attach the <em>estimated</em> propensity scores to the <code>population</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the estimated propensity score</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">pA_hat =</span> <span class="fu">predict</span>(ps_mod, <span class="at">type =</span> <span class="st">"response"</span>) <span class="co"># P(A = 1 | X)</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can take a look at the estimated propensity score distribution across the treatment groups (we’ll also overlay the <em>true</em> distributions for comparison):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send PS scores down the rows</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(pA, pA_hat),</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Type"</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Score"</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean labels</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Type =</span> </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        Type <span class="sc">==</span> <span class="st">"pA"</span> <span class="sc">~</span> <span class="st">"True"</span>,</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Estimated"</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Score,</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> Treatment,</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">linetype =</span> Type</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">40</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"P(A=1|X)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The model does a great job at estimating the true propensity scores. In a real analysis we probably wouldn’t be this close since we likely wouldn’t have only and all true confounders accounted for.</p>
<section id="visualizing-propensity-score-effects" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-propensity-score-effects">Visualizing propensity score effects</h3>
<p>In the same vein, we can explore the modeled relationships between each patient characteristic and the propensity scores.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send PS scores down the rows</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(pA, pA_hat),</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Type"</span>,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Score"</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean labels</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">Type =</span> </span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        Type <span class="sc">==</span> <span class="st">"pA"</span> <span class="sc">~</span> <span class="st">"True"</span>,</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Estimated"</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send covariates down the rows</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(zage, zincome, male),</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_prefix =</span> <span class="st">"^z"</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make groups</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">Group =</span> </span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">==</span> <span class="st">"male"</span> <span class="sc">~</span> <span class="st">"categorical"</span>,</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"continuous"</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a nested frame</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Group) <span class="sc">|&gt;</span></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">|&gt;</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make plot depending on type</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot =</span> </span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">|&gt;</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">map</span>(</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(.group) {</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Check condition</span></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">n_distinct</span>(.group<span class="sc">$</span>value) <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>            .group <span class="sc">|&gt;</span></span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarize</span>(</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>                <span class="at">Rate =</span> <span class="fu">mean</span>(Score),</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>                <span class="at">.by =</span> <span class="fu">c</span>(Treatment, Type, name, value)</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">|&gt;</span></span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>                <span class="at">Sex =</span> </span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">case_when</span>(</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>                    value <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Male"</span>,</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>                    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Female"</span></span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>                <span class="at">name =</span> <span class="st">"Sex"</span></span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">|&gt;</span></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>              <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>              <span class="fu">geom_point</span>(</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>                  <span class="at">x =</span> Sex,</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> Rate,</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> Treatment,</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>                  <span class="at">shape =</span> Type,</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>                  <span class="at">group =</span> Type</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">+</span></span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>              <span class="fu">geom_line</span>(</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>                  <span class="at">x =</span> Sex,</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> Rate,</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> Treatment,</span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> Type,</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>                  <span class="at">group =</span> <span class="fu">interaction</span>(Type, Treatment)</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">+</span></span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>              <span class="fu">facet_wrap</span>(<span class="sc">~</span>name) <span class="sc">+</span></span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>              <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>              <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>              <span class="fu">theme</span>(</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>                <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>                <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>),</span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>                <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>                <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">+</span></span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>              <span class="fu">ylab</span>(<span class="st">"P(A=1|X)"</span>)</span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a>            .group <span class="sc">|&gt;</span> </span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>              <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a>              <span class="fu">geom_smooth</span>(</span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(</span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>                  <span class="at">x =</span> value,</span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> Score,</span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> Treatment,</span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fill =</span> Treatment,</span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> Type</span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a>                <span class="at">alpha =</span> .<span class="dv">25</span></span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">+</span></span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a>              <span class="fu">facet_wrap</span>(<span class="sc">~</span>name) <span class="sc">+</span></span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a>              <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a>              <span class="fu">theme</span>(</span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a>                <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a>                <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>),</span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a>                <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">+</span></span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a>              <span class="fu">xlab</span>(<span class="st">"Z-Score"</span>) <span class="sc">+</span></span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a>              <span class="fu">ylab</span>(<span class="st">"P(A=1|X)"</span>)</span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(plots<span class="sc">$</span>plot[[<span class="dv">1</span>]], plots<span class="sc">$</span>plot[[<span class="dv">2</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As known from the <a href="#treatmentpropensity">true model</a>, patients who received treatment <em>A</em> tend to be older, female patients with lower income. We can also see slight miscalibration in the estimates for patients who are older in that the model tends to <em>underestimate</em> the true propensity score in these patients. We see similar miscalibration for sex.</p>
</section>
</section>
<section id="estimatedoverlapweight" class="level2">
<h2 class="anchored" data-anchor-id="estimatedoverlapweight">Calculate the (estimated) overlap weight</h2>
<p>We’ve already <a href="#trueoverlapweight">defined</a> how to calculate the overlap weights. The only difference here is that we’ll do it from the <a href="#modelpropensityscores"><em>estimated</em></a> propensity scores instead of the <a href="#treatmentpropensity">true</a> ones. First, we’ll apply the formula to add the estimated weights to the <code>population</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the estimated overlap weight for the realized treatment (known quantity)</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">OW_hat =</span> A <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>pA_hat) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>A) <span class="sc">*</span> pA_hat</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As we’ve <a href="#targetpopulation">mentioned earlier</a>, we will then <em>normalize</em> the weights <em>within</em> each treatment group so they have the same cumulative contribution for estimating the treatment effect in the outcome model.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the normalized weights (adding true and estimated)</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">OW_norm =</span> OW <span class="sc">/</span> <span class="fu">sum</span>(OW),</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">OW_hat_norm =</span> OW_hat <span class="sc">/</span> <span class="fu">sum</span>(OW_hat),</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> A</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span> <span class="fu">select</span>(A, pA, pA_hat, OW, OW_norm, OW_hat, OW_hat_norm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,000 × 7
       A    pA pA_hat    OW   OW_norm OW_hat OW_hat_norm
   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;       &lt;dbl&gt;
 1     1 0.577  0.583 0.423 0.000202   0.417   0.000198 
 2     0 0.422  0.427 0.422 0.000201   0.427   0.000202 
 3     1 0.647  0.610 0.353 0.000168   0.390   0.000185 
 4     0 0.219  0.226 0.219 0.000105   0.226   0.000107 
 5     1 0.315  0.329 0.685 0.000327   0.671   0.000318 
 6     1 0.292  0.265 0.708 0.000338   0.735   0.000348 
 7     0 0.644  0.628 0.644 0.000307   0.628   0.000297 
 8     0 0.171  0.181 0.171 0.0000814  0.181   0.0000856
 9     0 0.238  0.250 0.238 0.000114   0.250   0.000118 
10     0 0.257  0.268 0.257 0.000123   0.268   0.000127 
# ℹ 9,990 more rows</code></pre>
</div>
</div>
<p>To get a sense of the impact of these weights, let’s first look at their distributions (again, adding the <a href="#trueoverlapweight">true</a> weights for comparison):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send overlap weight down the rows</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(OW_norm, OW_hat_norm),</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Type"</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Weight"</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean labels</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Type =</span> </span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>        Type <span class="sc">==</span> <span class="st">"OW_norm"</span> <span class="sc">~</span> <span class="st">"True"</span>,</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Estimated"</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Weight,</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> Treatment,</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">linetype =</span> Type</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">40</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Normalized Overlap Weight"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In aggregate, the groups will have equal weight. The distribution shift has to do with the sampled treatment distribution. Only 38.8% of patients have treatment <em>A</em> so at an individual level each patient will contribute more on average.</p>
<section id="cumulative-patient-contribution" class="level3">
<h3 class="anchored" data-anchor-id="cumulative-patient-contribution">Cumulative patient contribution</h3>
<p>We can also look at the accumulation of <em>patients</em> (i.e., when each patient contributes equally) as a function of the cumulative <em>overlap weight</em> in each group. This allows us to understand how much (or little) the treatment effect estimation will be dominated by smaller concentrations of patients.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send overlap weight down the rows</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(OW_norm, OW_hat_norm),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Type"</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Weight"</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean labels</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Type =</span> </span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        Type <span class="sc">==</span> <span class="st">"OW_norm"</span> <span class="sc">~</span> <span class="st">"True"</span>,</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Estimated"</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">NullWeight =</span> <span class="dv">1</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rearrange</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Treatment, Type, Weight) <span class="sc">|&gt;</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the cumulative weight</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">Weight =</span> <span class="fu">cumsum</span>(Weight) <span class="sc">/</span> <span class="fu">sum</span>(Weight),</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">NullWeight =</span> <span class="fu">cumsum</span>(NullWeight) <span class="sc">/</span> <span class="fu">sum</span>(NullWeight),</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(Treatment, Type)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Weight,</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> NullWeight,</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> Treatment,</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">linetype =</span> Type</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>),</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>),</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Cumulative percent of overlap weight (%)"</span>) <span class="sc">+</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cumulative percent of patients (%)"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see that for treatment <em>B</em>, about 40% of the outcome model weight will be accounted for by only 25% of patients. The weights for treatment <em>A</em> are slightly more evenly spread across the patients.</p>
</section>
<section id="weighted-mean-differences" class="level3">
<h3 class="anchored" data-anchor-id="weighted-mean-differences">Weighted-mean differences</h3>
<p>It was <a href="#treatmentpropensity">previously mentioned</a> that the overlap weight methodology leads to perfect balance among the covariates used in the propensity score model. We can verify by looking at the group means for <a href="#modelpropensityscores">each model factor</a> before and after weighting.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add uniform weights</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_column</span>(<span class="at">NullWeight =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send weights down the rows</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(NullWeight, OW_hat_norm),</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Type"</span>,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Weight"</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send factors down the rows</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(age, income, male),</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Factor"</span>,</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Value"</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each </span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">Patients =</span> <span class="fu">n</span>(),</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean =</span> <span class="fu">sum</span>(Weight <span class="sc">*</span> Value) <span class="sc">/</span> <span class="fu">sum</span>(Weight),</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(Factor, Type, A)</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean up</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">Factor =</span> </span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>        Factor <span class="sc">==</span> <span class="st">"age"</span> <span class="sc">~</span> <span class="st">"Age (years)"</span>,</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>        Factor <span class="sc">==</span> <span class="st">"income"</span> <span class="sc">~</span> <span class="st">"Income ($)"</span>,</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>        Factor <span class="sc">==</span> <span class="st">"male"</span> <span class="sc">~</span> <span class="st">"Male (%)"</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>    Type,</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>    Patients,</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean =</span> </span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>        Factor <span class="sc">==</span> <span class="st">"Male (%)"</span> <span class="sc">~</span> <span class="dv">100</span> <span class="sc">*</span> Mean,</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> Mean</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send over the columns</span></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> Type,</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> <span class="fu">c</span>(Patients, Mean)</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rearrange</span></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Factor, Treatment) <span class="sc">|&gt;</span></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Factor, Treatment, <span class="fu">ends_with</span>(<span class="st">"NullWeight"</span>), Mean_OW_hat_norm) <span class="sc">|&gt;</span> </span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a table</span></span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reactable</span>(</span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">groupBy =</span> <span class="st">"Factor"</span>,</span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> </span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">Patients_NullWeight =</span> <span class="fu">colDef</span>(<span class="at">name =</span> <span class="st">"Patients"</span>, <span class="at">aggregate =</span> <span class="st">"sum"</span>, <span class="at">align =</span> <span class="st">"center"</span>),</span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">Mean_NullWeight =</span> <span class="fu">colDef</span>(<span class="at">name =</span> <span class="st">"Before Weighting"</span>, <span class="at">aggregate =</span> zildge<span class="sc">::</span><span class="fu">rectbl_agg_wtd</span>(<span class="st">"Patients_NullWeight"</span>), <span class="at">align =</span> <span class="st">"center"</span>, <span class="at">format =</span> <span class="fu">colFormat</span>(<span class="at">digits =</span> <span class="dv">1</span>)),</span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">Mean_OW_hat_norm =</span> <span class="fu">colDef</span>(<span class="at">name =</span> <span class="st">"After Weighting"</span>, <span class="at">aggregate =</span> zildge<span class="sc">::</span><span class="fu">rectbl_agg_wtd</span>(<span class="st">"Patients_NullWeight"</span>), <span class="at">align =</span> <span class="st">"center"</span>, <span class="at">format =</span> <span class="fu">colFormat</span>(<span class="at">digits =</span> <span class="dv">1</span>))</span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">columnGroups =</span> </span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colGroup</span>(</span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>          <span class="at">name =</span> <span class="st">"Mean Value"</span>,</span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>          <span class="at">columns =</span> <span class="fu">c</span>(<span class="st">"Mean_NullWeight"</span>, <span class="st">"Mean_OW_hat_norm"</span>)</span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">striped =</span> <span class="cn">TRUE</span>,</span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">highlight =</span> <span class="cn">TRUE</span>,</span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">bordered =</span> <span class="cn">TRUE</span>,</span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">resizable =</span> <span class="cn">TRUE</span>,</span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme =</span> reactablefmtr<span class="sc">::</span><span class="fu">sandstone</span>()</span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a>  reactablefmtr<span class="sc">::</span><span class="fu">add_source</span>(<span class="st">"Use arrows to expand table"</span>, <span class="at">font_size =</span> <span class="dv">12</span>, <span class="at">font_style =</span> <span class="st">"italic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="reactable html-widget html-fill-item" id="htmlwidget-858fd2eb03b0c0ded5eb" style="width:auto;height:auto;"></div>
<p style="color:#000;background:#FFFFFF;text-align:left;font-size:12px;font-style:italic;font-weight:normal;text-decoration:;letter-spacing:px;word-spacing:px;text-transform:;text-shadow:;margin-top:0px;margin-right:0px;margin-bottom:0px;margin-left:0px">Use arrows to expand table</p>
<script type="application/json" data-for="htmlwidget-858fd2eb03b0c0ded5eb">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"Factor":["Age (years)","Age (years)","Income ($)","Income ($)","Male (%)","Male (%)"],"Treatment":["A","B","A","B","A","B"],"Patients_NullWeight":[3882,6118,3882,6118,3882,6118],"Mean_NullWeight":[51.8724351584411,48.7731344443606,46.152542137955,52.1470439747779,55.7444616177228,61.7522066034652],"Mean_OW_hat_norm":[50.6909470423481,50.6909470423472,48.480546358988,48.4805463589892,58.1435359891369,58.1435359891387]},"columns":[{"id":"Factor","name":"Factor","type":"character"},{"id":"Treatment","name":"Treatment","type":"character"},{"id":"Patients_NullWeight","name":"Patients","type":"numeric","aggregate":"sum","align":"center"},{"id":"Mean_NullWeight","name":"Before Weighting","type":"numeric","aggregate":"function(values, rows) {\n            var numerator = 0\n            var denominator = 0\n\n            rows.forEach(function(row, index) {\n                numerator += row['Patients_NullWeight'] * values[index]\n                denominator += row['Patients_NullWeight']\n            })\n\n            if('mean' == 'mean') {\n                return numerator / denominator\n            } else {\n                return numerator\n            }\n        }","format":{"cell":{"digits":1},"aggregated":{"digits":1}},"align":"center"},{"id":"Mean_OW_hat_norm","name":"After Weighting","type":"numeric","aggregate":"function(values, rows) {\n            var numerator = 0\n            var denominator = 0\n\n            rows.forEach(function(row, index) {\n                numerator += row['Patients_NullWeight'] * values[index]\n                denominator += row['Patients_NullWeight']\n            })\n\n            if('mean' == 'mean') {\n                return numerator / denominator\n            } else {\n                return numerator\n            }\n        }","format":{"cell":{"digits":1},"aggregated":{"digits":1}},"align":"center"}],"columnGroups":[{"name":"Mean Value","columns":["Mean_NullWeight","Mean_OW_hat_norm"]}],"groupBy":["Factor"],"resizable":true,"highlight":true,"bordered":true,"striped":true,"theme":{"color":"#3e3f3a","backgroundColor":"#ffffff","borderColor":"#f8f5f0","borderWidth":"1px","stripedColor":"#ededed","highlightColor":"#f8f5f0","cellPadding":6,"tableStyle":{"fontSize":15},"headerStyle":{"borderWidth":"2px","backgroundColor":"#f8f5f0","color":"#7c7a78","transitionDuration":"0.5s","&:hover[aria-sort]":{"color":"#000000"},"&[aria-sort='ascending'], &[aria-sort='descending']":{"color":"#000000"},"fontSize":16},"groupHeaderStyle":{"&:not(:empty)":{"color":"#3e3f3a","fontSize":16},"&:hover":{"fontWeight":"bold","transitionDuration":"1s","transitionTimingFunction":"ease-out","color":"#000000"}},"rowSelectedStyle":{"backgroundColor":"#dfd7ca","color":"#8e8c84"},"inputStyle":{"backgroundColor":"#ffffff","borderColor":"#bcbfc1","color":"#3e3f3a"},"searchInputStyle":{"backgroundColor":"#ffffff","color":"#3e3f3a","borderColor":"#bcbfc1","&:focus":{"color":"#3e3f3a"}},"selectStyle":{"backgroundColor":"#dfd7ca","color":"#8e8c84","borderColor":"#ffffff","outlineColor":"#ffffff"},"pageButtonStyle":{"backgroundColor":"#f8f5f0","color":"#8e8c84","&:hover":{"backgroundColor":"#f3969a","color":"#8e8c84"}},"pageButtonHoverStyle":{"backgroundColor":"#dfd7ca","color":"#8e8c84"},"pageButtonActiveStyle":{"backgroundColor":"#dfd7ca","color":"#8e8c84"},"pageButtonCurrentStyle":{"backgroundColor":"#dfd7ca","color":"#8e8c84"}},"dataKey":"0e103bb7f71d932df5c23f1aa11d9ef7"},"children":[]},"class":"reactR_markup"},"evals":["tag.attribs.columns.3.aggregate","tag.attribs.columns.4.aggregate"],"jsHooks":[]}</script>
</div>
</div>
<p>We can see that, overall, the weighted sample is <em>slightly</em> older and female with lower income.</p>
</section>
<section id="confounder-weight-shifts" class="level3">
<h3 class="anchored" data-anchor-id="confounder-weight-shifts">Confounder weight shifts</h3>
<p>Similar to looking at weight attributions <a href="#estimatedoverlapweight">as a whole</a>, we can explore weight shifts within subgroups of patient characteristics. This helps build intuition about which patients the subsequent treatment effect estimates will focus on most (and least).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add uniform weights</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_column</span>(<span class="at">NullWeight =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to quntiles</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(age, income),</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>      \(x) Hmisc<span class="sc">::</span><span class="fu">cut2</span>(x, <span class="at">g =</span> <span class="dv">10</span>)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Age =</span> age,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Income =</span> income,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">Sex =</span> </span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        male <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Male"</span>,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Female"</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send weights down the rows</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(NullWeight, OW_hat_norm),</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Type"</span>,</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Weight"</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send factors down the rows</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(Age, Income, Sex),</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Factor"</span>,</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Level"</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute total weights</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">Weight =</span> <span class="fu">sum</span>(Weight),</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(Factor, Level, Type, Treatment)</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find percent of weight</span></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">Weight =</span> Weight <span class="sc">/</span> <span class="fu">sum</span>(Weight),</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(Factor, Type, Treatment)</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send over columns</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> Type,</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> Weight</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean up</span></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">Level =</span> <span class="fu">factor</span>(Level) <span class="sc">|&gt;</span> <span class="fu">fct_rev</span>(),</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">Factor =</span> </span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>        Factor <span class="sc">==</span> <span class="st">"Age"</span> <span class="sc">~</span> <span class="st">"Age (years)"</span>,</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>        Factor <span class="sc">==</span> <span class="st">"Income"</span> <span class="sc">~</span> <span class="st">"Income ($)"</span>,</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> Factor</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(</span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Level,</span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> NullWeight,</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> Treatment</span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> .<span class="dv">75</span>,</span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">40</span>,</span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"dodge"</span></span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Level,</span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> OW_hat_norm,</span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> Treatment,</span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">shape =</span> Treatment</span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="dv">1</span>),</span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Level,</span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> OW_hat_norm,</span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> Treatment,</span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> Treatment</span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="dv">1</span>),</span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> .<span class="dv">5</span></span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Factor, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>),</span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Level"</span>) <span class="sc">+</span></span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Share of weight within group (%)"</span>) <span class="sc">+</span></span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Before Weighting"</span>,</span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="st">"After Weighting"</span>,</span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"After Weighting"</span></span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see the balancing take place. After overlap weighting, the contribution to treatment effect estimation is reduced in older patients with lower income for treatment <em>A</em>, and vice-versa for treatment <em>B</em>, with some levels in the middle having increased weight for <em>both</em> treatments. This is where the most overlap is between the groups.</p>
<p>It is also useful to look at these plots for factors that were <em>not</em> included in the propensity score model. We may find drastic weight shifts which might indicate significant co-variation among factors already accounted for.</p>
</section>
</section>
</section>
<section id="estimatingtreatmenteffect" class="level1">
<h1>Estimating the treatment effect</h1>
<p>We’re now ready to estimate the causal treatment effect. Although we <a href="#treatmenteffect">generated our data</a> from a <a href="https://en.wikipedia.org/wiki/Weibull_distribution">Weibull</a> distribution, we will use a <a href="https://en.wikipedia.org/wiki/Proportional_hazards_model">Cox proportional-hazards model</a> for estimation, which is a <em>semi-parametric</em> method, and tends to be the default choice for modeling survival data, especially in healthcare.</p>
<section id="truehazardratio" class="level2">
<h2 class="anchored" data-anchor-id="truehazardratio">A look at the true hazard ratio</h2>
<p>The treatment effect will be quantified by a <a href="https://en.wikipedia.org/wiki/Hazard_ratio"><em>hazard ratio</em></a>, which is an estimate of the ratio of instantaneous event rates between the treatment groups (this is what is done in <a href="https://www2.stat.duke.edu/~fl35/OW/OW_survival_Demo.sas">the original simulation</a>). This measure is different than the effect we <a href="#interpretingtreatmenteffect">interpreted</a> from the true data-generating process, so, although we won’t expect them to provide the same numerical result, we should still get a similar conclusion, in that treatment <em>A</em> is superior to treatment <em>B</em>.</p>
<p>To start, we can compute the actual hazard ratio had we been able to observe each potential outcome (i.e., the counterfactual). To do this, we need to transform our data such that we have two rows of data per patient–one for each treatment. Then, we fit the Cox model, using the <em>true</em> overlap weights as case weights.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>true_hr_mod <span class="ot">&lt;-</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coxph</span>(</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="fu">factor</span>(A),</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>      population <span class="sc">|&gt;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Keep columns needed</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        OW_norm, <span class="co"># True (normalized) overlap weight (could use un-normalized version here)</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        t_A, <span class="co"># True event time under treatment A</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        t_B, <span class="co"># True event time under treatment B</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        censor_time <span class="co"># When the patient was censored</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Send true event times down the rows</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(t_A, t_B),</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"A"</span>,</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"time"</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Check if censored first</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">A =</span> <span class="fu">case_when</span>(A <span class="sc">==</span> <span class="st">"t_A"</span> <span class="sc">~</span> <span class="dv">1</span>, <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span>), <span class="co"># Replace with our notation</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">time =</span> <span class="fu">pmin</span>(time, censor_time),</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">status =</span> <span class="fu">as.numeric</span>(time <span class="sc">&lt;</span> censor_time)</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> OW_norm</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the result</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>true_hr <span class="ot">&lt;-</span> <span class="fu">exp</span>(true_hr_mod<span class="sc">$</span>coefficients)[[<span class="dv">1</span>]]</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>true_hr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7284168</code></pre>
</div>
</div>
<p>If we could compare the worlds in which we observe all patients under each treatment, the hazard ratio is 0.73, suggesting that the instantaneous event rate is 27% lower with treatment <em>A</em> than with treatment <em>B</em>. This aligns with what we’ve established as the <a href="#interpretingtreatmenteffect">true effect</a>. Our hope is that the estimate from the observable data (in the <a href="#estimatedhazardratio">next section</a>) will contain this value within some margin of sampling error.</p>
</section>
<section id="estimatedhazardratio" class="level2">
<h2 class="anchored" data-anchor-id="estimatedhazardratio">Our estimate of the treatment effect</h2>
<p>Finally, we can obtain our estimate of the treatment effect using only the observable quantities we have in our data set, which is what we would have in a real-life analysis. Similar to the <a href="##truehazardratio">previous section</a>, we are just fitting a Cox model with the treatment as a covariate. Except this time we only observe one outcome per patient as a result of the treatment they <a href="#treatmentassignment">actually received</a>, and use the <a href="#estimatedoverlapweight"><em>estimated</em> overlap weight</a> to balance the confounding factors (age, sex, and income). We will also use <a href="https://rdrr.io/cran/survival/man/coxph.html">robust</a> standard error estimates.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>estimated_hr_mod <span class="ot">&lt;-</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coxph</span>(</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="fu">factor</span>(A),</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> population,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> OW_hat_norm,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the result</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>estimated_hr <span class="ot">&lt;-</span> <span class="fu">exp</span>(estimated_hr_mod<span class="sc">$</span>coefficients)[[<span class="dv">1</span>]]</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>estimated_hr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7423806</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the confidence interval</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>estimated_hr_ci <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">confint</span>(estimated_hr_mod))</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>estimated_hr_ci</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>               2.5 %    97.5 %
factor(A)1 0.6756889 0.8156548</code></pre>
</div>
</div>
<p>Our estimate for the hazard ratio is 0.74, with a 95% confidence interval ranging from 0.68 to 0.82, suggesting that the instantaneous event rate for treatment <em>A</em> is between 18% and 32% lower compared to treatment <em>B</em> (note that this captures the <a href="#truehazardratio">true hazard ratio</a>). Under the assumption that we’ve correctly specified all confounding factors (which <a href="#treatmentpropensity">we did</a>), we can interpret this as the <em>causal</em> treatment effect, and, assuming the magnitude of improvement is of practical importance (when considering things like cost, resources, clinical outcomes, etc.), we can reliably conclude that there is a benefit to treatment <em>A</em> over treatment <em>B</em>, on average.</p>
</section>
</section>
<section id="resources" class="level1">
<h1>Resources</h1>
<p>Some additional resources I’ve come across while learning the methodology:</p>
<ul>
<li>Original paper for overlap weighting (<a href="https://pubmed.ncbi.nlm.nih.gov/30189042/">link</a>)</li>
<li>Paper extending overlap weighting to survival analysis (<a href="https://arxiv.org/abs/2108.04394">link</a>)</li>
<li>Example simulation of overlap weighting in the survival setting in SAS (<a href="http://www2.stat.duke.edu/~fl35/OW/OW_survival_Demo.sas">link</a>)</li>
<li>R package for implementing overlap weight methods (<a href="https://github.com/thuizhou/PSweight">link</a>)</li>
<li>R functions for overlap weighting in the survival setting (<a href="https://github.com/chaochengstat/OW_Survival">link</a>)</li>
<li>Author’s web page dedicated to overlap weighting (<a href="https://www2.stat.duke.edu/~fl35/OW.html">link</a>)</li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.zajichekstats\.com\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb37" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "The overlap weight in survival analysis"</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "A simulation review"</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Alex Zajichek"</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "10/2/2023"</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> "feature.png"</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - Causal Inference</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - Survival Analysis</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - Propensity Scores</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - Weighting</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE} </span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(warning = FALSE, message = FALSE) </span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>I was recently introduced to <span class="co">[</span><span class="ot">overlap weighting</span><span class="co">](https://jamanetwork.com/journals/jama/article-abstract/2765748)</span>, which is part of a general family of methods for balancing covariates when estimating treatment effects with observational data. Specifically, it focuses on the <span class="co">[</span><span class="ot">_clinical equipoise_</span><span class="co">](https://www.sciencedirect.com/topics/medicine-and-dentistry/clinical-equipoise#:~:text=Clinical%20equipoise%20is%20defined%20as,Seminars%20in%20Vascular%20Surgery%2C%202022)</span>; that is, the patients in which the treatment decision is most uncertain. I find it more elegant than <span class="co">[</span><span class="ot">matching</span><span class="co">](https://en.wikipedia.org/wiki/Propensity_score_matching)</span> (which I've <span class="co">[</span><span class="ot">used in the past</span><span class="co">](https://jamanetwork.com/journals/jama/fullarticle/2749478)</span>), and figured a useful way to better understand the approach is to deconstruct, interpret, and translate a <span class="co">[</span><span class="ot">SAS simulation</span><span class="co">](http://www2.stat.duke.edu/~fl35/OW/OW_survival_Demo.sas)</span> in the context of survival analysis implemented by the <span class="co">[</span><span class="ot">original authors</span><span class="co">](https://pubmed.ncbi.nlm.nih.gov/30189042/)</span>. All code is written in (and translated to) <span class="co">[</span><span class="ot">`R`</span><span class="co">](https://www.r-project.org/)</span>. We'll start by loading some packages.</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reactable)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a><span class="fu"># Table of Contents</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Setting up the potential outcomes</span><span class="co">](#potentialoutcomes)</span></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">Simulate some patients</span><span class="co">](#simulatepatients)</span></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">Define the treatment propensity</span><span class="co">](#treatmentpropensity)</span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">Generate the treatment assignment</span><span class="co">](#treatmentassignment)</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">Compute the (true) overlap weight</span><span class="co">](#trueoverlapweight)</span></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">Set the treatment effect</span><span class="co">](#treatmenteffect)</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">Assign the observed outcome</span><span class="co">](#observedoutcome)</span></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Estimating the weights</span><span class="co">](#estimatingweights)</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">Model the propensity scores</span><span class="co">](#modelpropensityscores)</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">Calculate the (estimated) overlap weight</span><span class="co">](#estimatedoverlapweight)</span></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Estimating the treatment effect</span><span class="co">](#estimatingtreatmenteffect)</span></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">A look at the true hazard ratio</span><span class="co">](#truehazardratio)</span></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span><span class="co">[</span><span class="ot">The final estimate</span><span class="co">](#estimatedhazardratio)</span></span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a><span class="fu"># Setting up the potential outcomes {#potentialoutcomes}</span></span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>The theoretical underpinnings of <span class="co">[</span><span class="ot">overlap weighting</span><span class="co">](https://pubmed.ncbi.nlm.nih.gov/30189042/)</span> live in the context of the <span class="co">[</span><span class="ot">potential outcomes</span><span class="co">](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5841618/#:~:text=The%20potential%20outcomes%20framework%20provides%20a%20way%20to%20quantify%20causal,exposure%20or%20intervention%20under%20consideration.)</span> paradigm of <span class="co">[</span><span class="ot">causal inference</span><span class="co">](https://www.sciencedirect.com/topics/social-sciences/causal-inference)</span>. Basically, we wonder what _would have_ happened had we been able to observe each patient under both treatments (known as the <span class="co">[</span><span class="ot">counterfactual</span><span class="co">](https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/1471-2288-5-28)</span>). If we knew the outcomes from the two worlds, the causal treatment effect would simply be the average difference across all patients. The problem of course is that in reality the outcome can only be observed for the treatment in which the patient was assigned (or chose), and so our goal is to work with the "incomplete" information that we do have to try to estimate what the outcome difference would have been had the counterfactual been observed as well.</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simulate some patients {#simulatepatients}</span></span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>The first thing we need to do is generate some (fake) patients to facilitate the simulation. Here we'll focus on age, sex, and income as patient-identifying characteristics.</span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the sample size</span></span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the seed</span></span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the population</span></span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">10</span>),</span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">zage =</span> (age <span class="sc">-</span> <span class="dv">50</span>) <span class="sc">/</span> <span class="dv">10</span>,</span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">male =</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.6</span>),</span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">income =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">10</span>),</span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">zincome =</span> (income <span class="sc">-</span> <span class="dv">50</span>) <span class="sc">/</span> <span class="dv">10</span></span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-75"><a href="#cb37-75" aria-hidden="true" tabindex="-1"></a>population</span>
<span id="cb37-76"><a href="#cb37-76" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-77"><a href="#cb37-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-78"><a href="#cb37-78" aria-hidden="true" tabindex="-1"></a>We've generated a sample of <span class="in">`r paste(n)`</span> patients. We'll assume <span class="in">`age`</span> is measured in years, <span class="in">`income`</span> in thousands of dollars (\$), and <span class="in">`male`</span> is 1 for _Male_ and 0 for _Female_. The columns <span class="in">`zage`</span> and <span class="in">`zincome`</span> are just <span class="co">[</span><span class="ot">standardized</span><span class="co">](https://statisticsbyjim.com/glossary/standardization/#:~:text=In%20statistics%2C%20standardization%20is%20the,standard%20deviation%20for%20a%20variable.)</span> versions of the originals to avoid scaling nuances (we'll refer to these as $age_z$ and $income_z$).</span>
<span id="cb37-79"><a href="#cb37-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-80"><a href="#cb37-80" aria-hidden="true" tabindex="-1"></a><span class="fu">## Define the treatment propensity {#treatmentpropensity}</span></span>
<span id="cb37-81"><a href="#cb37-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-82"><a href="#cb37-82" aria-hidden="true" tabindex="-1"></a>Here's where the important theory starts to creep in (already). We assume that there is a _true_ propensity score, say $p_i^A$, that is the _true_ probability that patient _i_ receives treatment _A_ given their specific characteristics (and let's assume there are possible treatments _A_ &amp; _B_). Further, we assume (some transformation of) this probability is a linear combination of all the characteristics that confound the crude treatment effect on the outcome. In this simulation, we'll assume the <span class="co">[</span><span class="ot">logit</span><span class="co">](https://en.wikipedia.org/wiki/Logistic_regression)</span> model:</span>
<span id="cb37-83"><a href="#cb37-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-84"><a href="#cb37-84" aria-hidden="true" tabindex="-1"></a>$$log(\frac{p_i^A}{1 - p_i^A}) = 0.41 \times age_z - 0.22 \times male - 0.69 \times income_z - 0.40$$</span>
<span id="cb37-85"><a href="#cb37-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-86"><a href="#cb37-86" aria-hidden="true" tabindex="-1"></a>So let's add this _true_ propensity score to the <span class="in">`population`</span> data set:</span>
<span id="cb37-87"><a href="#cb37-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-90"><a href="#cb37-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-91"><a href="#cb37-91" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb37-92"><a href="#cb37-92" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb37-93"><a href="#cb37-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-94"><a href="#cb37-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the true propensity score (unknown quantity)</span></span>
<span id="cb37-95"><a href="#cb37-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-96"><a href="#cb37-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_odds_pA =</span> <span class="sc">-</span><span class="fl">0.4</span> <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.5</span>)<span class="sc">*</span>zage <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">0.8</span>)<span class="sc">*</span>male <span class="sc">+</span> <span class="fu">log</span>(.<span class="dv">50</span>)<span class="sc">*</span>zincome,</span>
<span id="cb37-97"><a href="#cb37-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">pA =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>log_odds_pA))</span>
<span id="cb37-98"><a href="#cb37-98" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-99"><a href="#cb37-99" aria-hidden="true" tabindex="-1"></a>population</span>
<span id="cb37-100"><a href="#cb37-100" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-101"><a href="#cb37-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-102"><a href="#cb37-102" aria-hidden="true" tabindex="-1"></a>Obviously in practice we don't know what $p_i^A$ is, so it must be _estimated_ from the treatment assignments we observe in the data. Additionally, we aren't strictly required to assume the <span class="co">[</span><span class="ot">logit</span><span class="co">](https://en.wikipedia.org/wiki/Logistic_regression)</span> model, but when we use it to estimate the propensity score for <span class="co">[</span><span class="ot">overlap weighting</span><span class="co">](https://pubmed.ncbi.nlm.nih.gov/30189042/)</span>, it has the advantageous property of perfect balance. That is, the weighted-mean differences for all covariates included in the logistic regression model will be zero across the treatment groups.</span>
<span id="cb37-103"><a href="#cb37-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-104"><a href="#cb37-104" aria-hidden="true" tabindex="-1"></a><span class="fu">## Generate the treatment assignment {#treatmentassignment}</span></span>
<span id="cb37-105"><a href="#cb37-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-106"><a href="#cb37-106" aria-hidden="true" tabindex="-1"></a>The treatment assignment is one of the _known_ quantities we would observe in a real life sample, and that is what would be used as the dependent variable for _estimating_ propensity scores. However, since we are running a simulation, we need to generate the treatment assignments from the governing distribution. We assume that the observed treatment for patient _i_ is the result of an (unfair) coin flip that has a probability equal to the <span class="co">[</span><span class="ot">true propensity score</span><span class="co">](#treatmentpropensity)</span>. In statistical notation,</span>
<span id="cb37-107"><a href="#cb37-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-108"><a href="#cb37-108" aria-hidden="true" tabindex="-1"></a>$$A_i \sim Bernoulli(p_i^A)$$</span>
<span id="cb37-109"><a href="#cb37-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-110"><a href="#cb37-110" aria-hidden="true" tabindex="-1"></a>where $A_i$ is the indicator of treatment A. Let's add a _realized_ treatment assignment to the <span class="in">`population`</span>:</span>
<span id="cb37-111"><a href="#cb37-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-114"><a href="#cb37-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-115"><a href="#cb37-115" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb37-116"><a href="#cb37-116" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb37-117"><a href="#cb37-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-118"><a href="#cb37-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the realized treatment assignment (known quantity)</span></span>
<span id="cb37-119"><a href="#cb37-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-120"><a href="#cb37-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> pA),</span>
<span id="cb37-121"><a href="#cb37-121" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-122"><a href="#cb37-122" aria-hidden="true" tabindex="-1"></a>population</span>
<span id="cb37-123"><a href="#cb37-123" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-124"><a href="#cb37-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-125"><a href="#cb37-125" aria-hidden="true" tabindex="-1"></a>In this case, <span class="in">`A=1`</span> represents treatment _A_ and `A=0` represents treatment _B_. Again, this is the actual treatment we would observe the patient receiving in a sample.</span>
<span id="cb37-126"><a href="#cb37-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-127"><a href="#cb37-127" aria-hidden="true" tabindex="-1"></a><span class="fu">## Compute the (true) overlap weight {#trueoverlapweight}</span></span>
<span id="cb37-128"><a href="#cb37-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-129"><a href="#cb37-129" aria-hidden="true" tabindex="-1"></a>We need to define what the overlap weight is, and it's actually quite simple: just assign the patient the probability they _did not_ receive their observed treatment. </span>
<span id="cb37-130"><a href="#cb37-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-131"><a href="#cb37-131" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-132"><a href="#cb37-132" aria-hidden="true" tabindex="-1"></a>\begin{equation}</span>
<span id="cb37-133"><a href="#cb37-133" aria-hidden="true" tabindex="-1"></a>OW_i=</span>
<span id="cb37-134"><a href="#cb37-134" aria-hidden="true" tabindex="-1"></a>    \begin{cases}</span>
<span id="cb37-135"><a href="#cb37-135" aria-hidden="true" tabindex="-1"></a>        1-p_i^A &amp; \text{if } A_i=1<span class="sc">\\</span></span>
<span id="cb37-136"><a href="#cb37-136" aria-hidden="true" tabindex="-1"></a>        p_i^A &amp; \text{if } A_i=0<span class="sc">\\</span></span>
<span id="cb37-137"><a href="#cb37-137" aria-hidden="true" tabindex="-1"></a>    \end{cases}</span>
<span id="cb37-138"><a href="#cb37-138" aria-hidden="true" tabindex="-1"></a>\end{equation}</span>
<span id="cb37-139"><a href="#cb37-139" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-140"><a href="#cb37-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-141"><a href="#cb37-141" aria-hidden="true" tabindex="-1"></a>Notice the notation. Since it depends on the <span class="co">[</span><span class="ot">true propensity score</span><span class="co">](#treatmentpropensity)</span>, the overlap weight is another _unknown_ quantity that is estimated from the data. It also depends on the <span class="co">[</span><span class="ot">realized treatment assignment</span><span class="co">](#treatmentassignment)</span>, so the collection of weights across patients differ depending on the observed treatment distribution. We can add these weights to the <span class="in">`population`</span> data set:</span>
<span id="cb37-142"><a href="#cb37-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-145"><a href="#cb37-145" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-146"><a href="#cb37-146" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb37-147"><a href="#cb37-147" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb37-148"><a href="#cb37-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-149"><a href="#cb37-149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the true overlap weight for the realized treatment (unknown quantity)</span></span>
<span id="cb37-150"><a href="#cb37-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-151"><a href="#cb37-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">OW =</span> A <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>pA) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>A) <span class="sc">*</span> pA</span>
<span id="cb37-152"><a href="#cb37-152" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-153"><a href="#cb37-153" aria-hidden="true" tabindex="-1"></a>population</span>
<span id="cb37-154"><a href="#cb37-154" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-155"><a href="#cb37-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-156"><a href="#cb37-156" aria-hidden="true" tabindex="-1"></a>In a real analysis, these weights are what we are ultimately after in order to estimate the average _causal_ treatment effect on the outcome of interest while balancing differences in patient characteristics across the groups (i.e., removing the confounding factors).</span>
<span id="cb37-157"><a href="#cb37-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-158"><a href="#cb37-158" aria-hidden="true" tabindex="-1"></a><span class="fu">### Target population {#targetpopulation}</span></span>
<span id="cb37-159"><a href="#cb37-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-160"><a href="#cb37-160" aria-hidden="true" tabindex="-1"></a>Now we do end up normalizing the weights so they sum to one within each treatment group. But the intuition about what's happening is that the focus of the treatment effect estimation is shifted to patients that are most likely in _either_ treatment group. This is known as the [_clinical equipoise_](https://www.sciencedirect.com/topics/medicine-and-dentistry/clinical-equipoise#:~:text=Clinical%20equipoise%20is%20defined%20as,Seminars%20in%20Vascular%20Surgery%2C%202022), and the resulting treatment effect is interpreted as the _average treatment effect in the overlap population_.</span>
<span id="cb37-161"><a href="#cb37-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-162"><a href="#cb37-162" aria-hidden="true" tabindex="-1"></a>This makes a lot of sense. When we're comparing treatments, we should focus most heavily on patients that could be candidates for either, and less so on patients that were bound for one. Thus, we up-weight patients who have the most overlap in characteristics with the opposing treatment group. The beautiful thing here is that we do this without throwing away any information; smoothly and proportionately weighting each subject just the amount that we should.</span>
<span id="cb37-163"><a href="#cb37-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-164"><a href="#cb37-164" aria-hidden="true" tabindex="-1"></a><span class="fu">## Set the treatment effect {#treatmenteffect}</span></span>
<span id="cb37-165"><a href="#cb37-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-166"><a href="#cb37-166" aria-hidden="true" tabindex="-1"></a>We've <span class="co">[</span><span class="ot">generated the treatments</span><span class="co">](#treatmentassignment)</span> and established how they are <span class="co">[</span><span class="ot">related to patient characteristics</span><span class="co">](#treatmentpropensity)</span>, but haven't talked about the outcome in which we're ultimately interested in estimating the treatment effect for. Since we're focusing on <span class="co">[</span><span class="ot">time-to-event</span><span class="co">](https://www.publichealth.columbia.edu/research/population-health-methods/time-event-data-analysis)</span> outcomes, we'll stay in that context, but the general idea is that we assume there _exists_ a realization of what a patient's outcome would have been under each treatment scenario. Then if we compare the difference of those outcomes across all patients, the average difference must be caused by the treatment.</span>
<span id="cb37-167"><a href="#cb37-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-168"><a href="#cb37-168" aria-hidden="true" tabindex="-1"></a><span class="fu">### Defining the event times</span></span>
<span id="cb37-169"><a href="#cb37-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-170"><a href="#cb37-170" aria-hidden="true" tabindex="-1"></a>In this simulation, we'll generate event times from a <span class="co">[</span><span class="ot">Weibull</span><span class="co">](https://en.wikipedia.org/wiki/Weibull_distribution)</span> distribution. Starting at treatment initiation, this might be the time until cancer recurrence, hospitalization, or something else; we're just looking to see how long it takes for some event to occur. The <span class="co">[</span><span class="ot">PDF</span><span class="co">](https://en.wikipedia.org/wiki/Probability_density_function)</span> for this distribution looks <span class="co">[</span><span class="ot">like this</span><span class="co">](https://stat.ethz.ch/R-manual/R-devel/library/stats/html/Weibull.html)</span>:</span>
<span id="cb37-171"><a href="#cb37-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-172"><a href="#cb37-172" aria-hidden="true" tabindex="-1"></a>$$f(t) = \frac{\alpha}{\sigma}\left(\frac{t}{\sigma}\right)^{\alpha-1}e^{-\left(\frac{t}{\sigma}\right)^\alpha}$$</span>
<span id="cb37-173"><a href="#cb37-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-174"><a href="#cb37-174" aria-hidden="true" tabindex="-1"></a>where $t$ is the event time, $\alpha$ is the _shape_ parameter, and $\sigma$ is the _scale_ parameter. In our example, we will say that:</span>
<span id="cb37-175"><a href="#cb37-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-176"><a href="#cb37-176" aria-hidden="true" tabindex="-1"></a>$$T_i^A \sim Weibull(\alpha, \sigma_i^A)$$</span>
<span id="cb37-177"><a href="#cb37-177" aria-hidden="true" tabindex="-1"></a>$$T_i^B \sim Weibull(\alpha, \sigma_i^B)$$</span>
<span id="cb37-178"><a href="#cb37-178" aria-hidden="true" tabindex="-1"></a>where $T_i^A$ and $T_i^B$ are the event times under treatments _A_ and _B_, respectively. That is, the event times for each patient under each treatment follow a [Weibull](https://en.wikipedia.org/wiki/Weibull_distribution) distribution with a common _shape_ parameter (in this case, across both treatments), but a _scale_ parameter that depends on the patient's specific characteristics (in _log-linear_ form) and differs by treatment, which captures the treatment effect. Specifically,</span>
<span id="cb37-179"><a href="#cb37-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-180"><a href="#cb37-180" aria-hidden="true" tabindex="-1"></a>$$\alpha = 1$$</span>
<span id="cb37-181"><a href="#cb37-181" aria-hidden="true" tabindex="-1"></a>$$\sigma_i^A = \lambda \times e^{-(\phi_i - 0.36)}$$</span>
<span id="cb37-182"><a href="#cb37-182" aria-hidden="true" tabindex="-1"></a>$$\sigma_i^B = \lambda \times e^{-\phi_i}$$</span>
<span id="cb37-183"><a href="#cb37-183" aria-hidden="true" tabindex="-1"></a>$$\phi_i = 1.10 \times age_z - 0.22 \times male - 0.36 \times income_z$$</span>
<span id="cb37-184"><a href="#cb37-184" aria-hidden="true" tabindex="-1"></a>$$\lambda = 4055.56$$</span>
<span id="cb37-185"><a href="#cb37-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-186"><a href="#cb37-186" aria-hidden="true" tabindex="-1"></a>Basically, the $\phi_i$ term does the baseline adjustment on the outcome risk for the patient's specific characteristics, and the treatment effect is simply a fixed, additive deviation from that for all patients. The $\lambda$ term is the <span class="co">[</span><span class="ot">baseline hazard function</span><span class="co">](https://www.linkedin.com/advice/0/how-do-you-interpret-hazard-ratio-baseline-function)</span>, providing the _scale_ parameter when all covariate values are zero (for treatment _B_), which in this case is constant over time. </span>
<span id="cb37-187"><a href="#cb37-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-188"><a href="#cb37-188" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Interpreting the treatment effect {#interpretingtreatmenteffect}</span></span>
<span id="cb37-189"><a href="#cb37-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-190"><a href="#cb37-190" aria-hidden="true" tabindex="-1"></a>When setting $\alpha=1$, the mean of a <span class="co">[</span><span class="ot">Weibull</span><span class="co">](https://en.wikipedia.org/wiki/Weibull_distribution)</span> distribution is equal to its scale parameter. That is,</span>
<span id="cb37-191"><a href="#cb37-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-192"><a href="#cb37-192" aria-hidden="true" tabindex="-1"></a>$$E<span class="co">[</span><span class="ot">T_i^A</span><span class="co">]</span> = \sigma_i^A$$</span>
<span id="cb37-193"><a href="#cb37-193" aria-hidden="true" tabindex="-1"></a>$$E<span class="co">[</span><span class="ot">T_i^B</span><span class="co">]</span> = \sigma_i^B$$</span>
<span id="cb37-194"><a href="#cb37-194" aria-hidden="true" tabindex="-1"></a>This gives us a very nice interpretation of the treatment effect. If we compare them _relatively_, we get:</span>
<span id="cb37-195"><a href="#cb37-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-196"><a href="#cb37-196" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-197"><a href="#cb37-197" aria-hidden="true" tabindex="-1"></a>\begin{equation} </span>
<span id="cb37-198"><a href="#cb37-198" aria-hidden="true" tabindex="-1"></a>\begin{split}</span>
<span id="cb37-199"><a href="#cb37-199" aria-hidden="true" tabindex="-1"></a>\frac{E<span class="co">[</span><span class="ot">T_i^A</span><span class="co">]</span>}{E<span class="co">[</span><span class="ot">T_i^B</span><span class="co">]</span>} &amp; = \frac{\sigma_i^A}{\sigma_i^B} <span class="sc">\\</span></span>
<span id="cb37-200"><a href="#cb37-200" aria-hidden="true" tabindex="-1"></a>&amp; = \frac{\lambda \times e^{-(\phi_i - 0.36)}}{\lambda \times e^{-\phi_i}} <span class="sc">\\</span></span>
<span id="cb37-201"><a href="#cb37-201" aria-hidden="true" tabindex="-1"></a>&amp; = \frac{e^{-(\phi_i - 0.36)}}{e^{-\phi_i}} <span class="sc">\\</span></span>
<span id="cb37-202"><a href="#cb37-202" aria-hidden="true" tabindex="-1"></a>&amp; = \frac{e^{0.36}e^{-\phi_i}}{e^{-\phi_i}} <span class="sc">\\</span></span>
<span id="cb37-203"><a href="#cb37-203" aria-hidden="true" tabindex="-1"></a>&amp; = e^{0.36} <span class="sc">\\</span></span>
<span id="cb37-204"><a href="#cb37-204" aria-hidden="true" tabindex="-1"></a>&amp; \approx 1.43</span>
<span id="cb37-205"><a href="#cb37-205" aria-hidden="true" tabindex="-1"></a>\end{split}</span>
<span id="cb37-206"><a href="#cb37-206" aria-hidden="true" tabindex="-1"></a>\end{equation}</span>
<span id="cb37-207"><a href="#cb37-207" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-208"><a href="#cb37-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-209"><a href="#cb37-209" aria-hidden="true" tabindex="-1"></a>So we can say that the _time to event for patients on treatment A is 1.43 times, or 43%, longer on average than those on treatment B, given a fixed age, sex, and income_. That is, treatment A is "better" than treatment B.</span>
<span id="cb37-210"><a href="#cb37-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-211"><a href="#cb37-211" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sampling the event times {#samplingeventtimes}</span></span>
<span id="cb37-212"><a href="#cb37-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-213"><a href="#cb37-213" aria-hidden="true" tabindex="-1"></a>Next, we need to actually sample the times for our <span class="in">`population`</span> (_note that it was confirmed that SAS and R have the same parameterizations_):</span>
<span id="cb37-214"><a href="#cb37-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-217"><a href="#cb37-217" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-218"><a href="#cb37-218" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb37-219"><a href="#cb37-219" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb37-220"><a href="#cb37-220" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-221"><a href="#cb37-221" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample outcome event times under each treatment (counterfactual)</span></span>
<span id="cb37-222"><a href="#cb37-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-223"><a href="#cb37-223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-224"><a href="#cb37-224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Baseline hazard (constant over time)</span></span>
<span id="cb37-225"><a href="#cb37-225" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> <span class="dv">1</span><span class="sc">*</span><span class="dv">365</span><span class="sc">/</span><span class="fl">0.09</span>,</span>
<span id="cb37-226"><a href="#cb37-226" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-227"><a href="#cb37-227" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define TRUE Weibull linear predictor</span></span>
<span id="cb37-228"><a href="#cb37-228" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">log</span>(<span class="dv">3</span>) <span class="sc">*</span> zage <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">0.8</span>) <span class="sc">*</span> male <span class="sc">+</span> <span class="fu">log</span>(.<span class="dv">70</span>) <span class="sc">*</span> zincome,</span>
<span id="cb37-229"><a href="#cb37-229" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma_A =</span> lambda <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>(phi <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">0.70</span>))),</span>
<span id="cb37-230"><a href="#cb37-230" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma_B =</span> lambda <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi),</span>
<span id="cb37-231"><a href="#cb37-231" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-232"><a href="#cb37-232" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate REALIZED survival times under each treatment scenario (same parameterizations in SAS)</span></span>
<span id="cb37-233"><a href="#cb37-233" aria-hidden="true" tabindex="-1"></a>    <span class="at">t_A =</span> <span class="fu">rweibull</span>(n, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> sigma_A),</span>
<span id="cb37-234"><a href="#cb37-234" aria-hidden="true" tabindex="-1"></a>    <span class="at">t_B =</span> <span class="fu">rweibull</span>(n, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> sigma_B), </span>
<span id="cb37-235"><a href="#cb37-235" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-236"><a href="#cb37-236" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span> <span class="fu">select</span>(lambda, phi, sigma_A, sigma_B, t_A, t_B)</span>
<span id="cb37-237"><a href="#cb37-237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-238"><a href="#cb37-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-239"><a href="#cb37-239" aria-hidden="true" tabindex="-1"></a>Now we can make some density plots comparing the event time distributions across treatments (we'll use _log_ scaling for visual appeal):</span>
<span id="cb37-240"><a href="#cb37-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-243"><a href="#cb37-243" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-244"><a href="#cb37-244" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span></span>
<span id="cb37-245"><a href="#cb37-245" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-246"><a href="#cb37-246" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send down the rows</span></span>
<span id="cb37-247"><a href="#cb37-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb37-248"><a href="#cb37-248" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"t_"</span>),</span>
<span id="cb37-249"><a href="#cb37-249" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb37-250"><a href="#cb37-250" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"EventTime"</span>,</span>
<span id="cb37-251"><a href="#cb37-251" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_prefix =</span> <span class="st">"t_"</span></span>
<span id="cb37-252"><a href="#cb37-252" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb37-253"><a href="#cb37-253" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-254"><a href="#cb37-254" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb37-255"><a href="#cb37-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb37-256"><a href="#cb37-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(</span>
<span id="cb37-257"><a href="#cb37-257" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb37-258"><a href="#cb37-258" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">log</span>(EventTime),</span>
<span id="cb37-259"><a href="#cb37-259" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> Treatment</span>
<span id="cb37-260"><a href="#cb37-260" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-261"><a href="#cb37-261" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">75</span></span>
<span id="cb37-262"><a href="#cb37-262" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb37-263"><a href="#cb37-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> <span class="cf">function</span>(x) <span class="fu">round</span>(<span class="fu">exp</span>(x))) <span class="sc">+</span></span>
<span id="cb37-264"><a href="#cb37-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb37-265"><a href="#cb37-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-266"><a href="#cb37-266" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-267"><a href="#cb37-267" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-268"><a href="#cb37-268" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-269"><a href="#cb37-269" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb37-270"><a href="#cb37-270" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-271"><a href="#cb37-271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Event Time"</span>)</span>
<span id="cb37-272"><a href="#cb37-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-273"><a href="#cb37-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-274"><a href="#cb37-274" aria-hidden="true" tabindex="-1"></a>Notice the shift to the right in the distribution for treatment _A_. This is the treatment effect. In the hypothetical world where all patients received treatment _A_, the event times happened _later_ than in the world where all patients received treatment _B_ (and all event times were observed), indicating, on average, a "benefit" to treatment _A_, which was expected from our <span class="co">[</span><span class="ot">prior calculation</span><span class="co">](#interpretingtreatmenteffect)</span>.</span>
<span id="cb37-275"><a href="#cb37-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-276"><a href="#cb37-276" aria-hidden="true" tabindex="-1"></a><span class="fu">## Assign the observed outcome {#observedoutcome}</span></span>
<span id="cb37-277"><a href="#cb37-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-278"><a href="#cb37-278" aria-hidden="true" tabindex="-1"></a>The final step for simulation setup is to assign the event time as we might observe in a real data set. The event times generated in the <span class="co">[</span><span class="ot">previous section</span><span class="co">](#samplingeventtimes)</span> capture both treatment scenarios for all patients, but in reality we would only (potentially) observe the event time for the <span class="co">[</span><span class="ot">treatment the patient received</span><span class="co">](#treatmentassignment)</span>. Additionally, we likely (or definitely) won't be following all patients long enough to observe all events occur, meaning some patients will be <span class="co">[</span><span class="ot">censored</span><span class="co">](https://en.wikipedia.org/wiki/Survival_analysis#:~:text=Censoring%20%2F%20Censored%20observation%3A%20Censoring%20occurs,after%20the%20time%20of%20censoring.)</span>. Let's add the observed outcomes to the <span class="in">`population`</span>:</span>
<span id="cb37-279"><a href="#cb37-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-282"><a href="#cb37-282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-283"><a href="#cb37-283" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb37-284"><a href="#cb37-284" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span> </span>
<span id="cb37-285"><a href="#cb37-285" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-286"><a href="#cb37-286" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the observed outcome</span></span>
<span id="cb37-287"><a href="#cb37-287" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-288"><a href="#cb37-288" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-289"><a href="#cb37-289" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The ACTUAL event time outcome depends on the treatment ACTUALLY observed for the patient</span></span>
<span id="cb37-290"><a href="#cb37-290" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual_event_time =</span> t_B <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> A) <span class="sc">+</span> t_A <span class="sc">*</span> A,</span>
<span id="cb37-291"><a href="#cb37-291" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-292"><a href="#cb37-292" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate a REALIZED censoring time (completely random)</span></span>
<span id="cb37-293"><a href="#cb37-293" aria-hidden="true" tabindex="-1"></a>    <span class="at">censor_time =</span> <span class="dv">500</span> <span class="sc">+</span> <span class="dv">500</span> <span class="sc">*</span> <span class="fu">runif</span>(n),</span>
<span id="cb37-294"><a href="#cb37-294" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-295"><a href="#cb37-295" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the OBSERVED time in the data set (known quantity)</span></span>
<span id="cb37-296"><a href="#cb37-296" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">pmin</span>(actual_event_time, censor_time), <span class="co"># They either had the event, or were censored first</span></span>
<span id="cb37-297"><a href="#cb37-297" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-298"><a href="#cb37-298" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the event status (TRUE if event observed, FALSE if censored)</span></span>
<span id="cb37-299"><a href="#cb37-299" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> <span class="fu">as.numeric</span>(actual_event_time <span class="sc">&lt;</span> censor_time)</span>
<span id="cb37-300"><a href="#cb37-300" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-301"><a href="#cb37-301" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span> <span class="fu">select</span>(actual_event_time, censor_time, time, status)</span>
<span id="cb37-302"><a href="#cb37-302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-303"><a href="#cb37-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-304"><a href="#cb37-304" aria-hidden="true" tabindex="-1"></a>Our final simulated data set has the following _observed_ outcome summaries:</span>
<span id="cb37-305"><a href="#cb37-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-308"><a href="#cb37-308" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-309"><a href="#cb37-309" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span></span>
<span id="cb37-310"><a href="#cb37-310" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-311"><a href="#cb37-311" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute summary metrics</span></span>
<span id="cb37-312"><a href="#cb37-312" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb37-313"><a href="#cb37-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">Patients =</span> <span class="fu">n</span>(),</span>
<span id="cb37-314"><a href="#cb37-314" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time =</span> <span class="fu">mean</span>(time),</span>
<span id="cb37-315"><a href="#cb37-315" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(A, status)</span>
<span id="cb37-316"><a href="#cb37-316" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb37-317"><a href="#cb37-317" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-318"><a href="#cb37-318" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add shares within treatment</span></span>
<span id="cb37-319"><a href="#cb37-319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-320"><a href="#cb37-320" aria-hidden="true" tabindex="-1"></a>    <span class="at">Percent =</span> Patients <span class="sc">/</span> <span class="fu">sum</span>(Patients),</span>
<span id="cb37-321"><a href="#cb37-321" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> A</span>
<span id="cb37-322"><a href="#cb37-322" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-323"><a href="#cb37-323" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-324"><a href="#cb37-324" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean/rearrange</span></span>
<span id="cb37-325"><a href="#cb37-325" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb37-326"><a href="#cb37-326" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb37-327"><a href="#cb37-327" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-328"><a href="#cb37-328" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb37-329"><a href="#cb37-329" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb37-330"><a href="#cb37-330" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb37-331"><a href="#cb37-331" aria-hidden="true" tabindex="-1"></a>    <span class="at">Status =</span> </span>
<span id="cb37-332"><a href="#cb37-332" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-333"><a href="#cb37-333" aria-hidden="true" tabindex="-1"></a>        status <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Event"</span>,</span>
<span id="cb37-334"><a href="#cb37-334" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Censored"</span></span>
<span id="cb37-335"><a href="#cb37-335" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb37-336"><a href="#cb37-336" aria-hidden="true" tabindex="-1"></a>    Patients,</span>
<span id="cb37-337"><a href="#cb37-337" aria-hidden="true" tabindex="-1"></a>    Percent,</span>
<span id="cb37-338"><a href="#cb37-338" aria-hidden="true" tabindex="-1"></a>    Time</span>
<span id="cb37-339"><a href="#cb37-339" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-340"><a href="#cb37-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Treatment, <span class="fu">desc</span>(Status)) <span class="sc">|&gt;</span></span>
<span id="cb37-341"><a href="#cb37-341" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-342"><a href="#cb37-342" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a table</span></span>
<span id="cb37-343"><a href="#cb37-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reactable</span>(</span>
<span id="cb37-344"><a href="#cb37-344" aria-hidden="true" tabindex="-1"></a>    <span class="at">groupBy =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb37-345"><a href="#cb37-345" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> </span>
<span id="cb37-346"><a href="#cb37-346" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb37-347"><a href="#cb37-347" aria-hidden="true" tabindex="-1"></a>        <span class="at">Patients =</span> <span class="fu">colDef</span>(<span class="at">aggregate =</span> <span class="st">"sum"</span>, <span class="at">align =</span> <span class="st">"center"</span>),</span>
<span id="cb37-348"><a href="#cb37-348" aria-hidden="true" tabindex="-1"></a>        <span class="at">Percent =</span> <span class="fu">colDef</span>(<span class="at">name =</span> <span class="st">"Percent of patients in treatment group (%)"</span>, <span class="at">aggregate =</span> <span class="st">"sum"</span>, <span class="at">align =</span> <span class="st">"center"</span>, <span class="at">format =</span> <span class="fu">colFormat</span>(<span class="at">digits =</span> <span class="dv">1</span>, <span class="at">percent =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb37-349"><a href="#cb37-349" aria-hidden="true" tabindex="-1"></a>        <span class="at">Time =</span> <span class="fu">colDef</span>(<span class="at">name =</span> <span class="st">"Avg. time to outcome"</span>, <span class="at">aggregate =</span> zildge<span class="sc">::</span><span class="fu">rectbl_agg_wtd</span>(<span class="st">"Patients"</span>), <span class="at">align =</span> <span class="st">"center"</span>, <span class="at">format =</span> <span class="fu">colFormat</span>(<span class="at">digits =</span> <span class="dv">1</span>))</span>
<span id="cb37-350"><a href="#cb37-350" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb37-351"><a href="#cb37-351" aria-hidden="true" tabindex="-1"></a>    <span class="at">striped =</span> <span class="cn">TRUE</span>,</span>
<span id="cb37-352"><a href="#cb37-352" aria-hidden="true" tabindex="-1"></a>    <span class="at">highlight =</span> <span class="cn">TRUE</span>,</span>
<span id="cb37-353"><a href="#cb37-353" aria-hidden="true" tabindex="-1"></a>    <span class="at">bordered =</span> <span class="cn">TRUE</span>,</span>
<span id="cb37-354"><a href="#cb37-354" aria-hidden="true" tabindex="-1"></a>    <span class="at">resizable =</span> <span class="cn">TRUE</span>,</span>
<span id="cb37-355"><a href="#cb37-355" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme =</span> reactablefmtr<span class="sc">::</span><span class="fu">sandstone</span>()</span>
<span id="cb37-356"><a href="#cb37-356" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-357"><a href="#cb37-357" aria-hidden="true" tabindex="-1"></a>  reactablefmtr<span class="sc">::</span><span class="fu">add_source</span>(<span class="st">"Use arrows to expand table"</span>, <span class="at">font_size =</span> <span class="dv">12</span>, <span class="at">font_style =</span> <span class="st">"italic"</span>)</span>
<span id="cb37-358"><a href="#cb37-358" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-359"><a href="#cb37-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-360"><a href="#cb37-360" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb37-361"><a href="#cb37-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-362"><a href="#cb37-362" aria-hidden="true" tabindex="-1"></a>We can also look at the survival curves.</span>
<span id="cb37-363"><a href="#cb37-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-366"><a href="#cb37-366" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-367"><a href="#cb37-367" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span></span>
<span id="cb37-368"><a href="#cb37-368" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-369"><a href="#cb37-369" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Nest by treatment</span></span>
<span id="cb37-370"><a href="#cb37-370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(A) <span class="sc">|&gt;</span></span>
<span id="cb37-371"><a href="#cb37-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">|&gt;</span></span>
<span id="cb37-372"><a href="#cb37-372" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-373"><a href="#cb37-373" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Esimtate survival curves for each treatment</span></span>
<span id="cb37-374"><a href="#cb37-374" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-375"><a href="#cb37-375" aria-hidden="true" tabindex="-1"></a>    <span class="at">Surv =</span> </span>
<span id="cb37-376"><a href="#cb37-376" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">|&gt;</span></span>
<span id="cb37-377"><a href="#cb37-377" aria-hidden="true" tabindex="-1"></a>      <span class="fu">map</span>(</span>
<span id="cb37-378"><a href="#cb37-378" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(.trt) {</span>
<span id="cb37-379"><a href="#cb37-379" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb37-380"><a href="#cb37-380" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Fit the model</span></span>
<span id="cb37-381"><a href="#cb37-381" aria-hidden="true" tabindex="-1"></a>          mod <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> .trt)</span>
<span id="cb37-382"><a href="#cb37-382" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb37-383"><a href="#cb37-383" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Extract the elements</span></span>
<span id="cb37-384"><a href="#cb37-384" aria-hidden="true" tabindex="-1"></a>          <span class="fu">tibble</span>(</span>
<span id="cb37-385"><a href="#cb37-385" aria-hidden="true" tabindex="-1"></a>            <span class="at">Time =</span> mod<span class="sc">$</span>time,</span>
<span id="cb37-386"><a href="#cb37-386" aria-hidden="true" tabindex="-1"></a>            <span class="at">Survival =</span> mod<span class="sc">$</span>surv,</span>
<span id="cb37-387"><a href="#cb37-387" aria-hidden="true" tabindex="-1"></a>            <span class="at">Lower =</span> mod<span class="sc">$</span>lower,</span>
<span id="cb37-388"><a href="#cb37-388" aria-hidden="true" tabindex="-1"></a>            <span class="at">Upper =</span> mod<span class="sc">$</span>upper</span>
<span id="cb37-389"><a href="#cb37-389" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb37-390"><a href="#cb37-390" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb37-391"><a href="#cb37-391" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb37-392"><a href="#cb37-392" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb37-393"><a href="#cb37-393" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb37-394"><a href="#cb37-394" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-395"><a href="#cb37-395" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unnest the curves</span></span>
<span id="cb37-396"><a href="#cb37-396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>data) <span class="sc">|&gt;</span></span>
<span id="cb37-397"><a href="#cb37-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> Surv) <span class="sc">|&gt;</span></span>
<span id="cb37-398"><a href="#cb37-398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb37-399"><a href="#cb37-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-400"><a href="#cb37-400" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean labels</span></span>
<span id="cb37-401"><a href="#cb37-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-402"><a href="#cb37-402" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb37-403"><a href="#cb37-403" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-404"><a href="#cb37-404" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb37-405"><a href="#cb37-405" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb37-406"><a href="#cb37-406" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb37-407"><a href="#cb37-407" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-408"><a href="#cb37-408" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-409"><a href="#cb37-409" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb37-410"><a href="#cb37-410" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb37-411"><a href="#cb37-411" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb37-412"><a href="#cb37-412" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Time,</span>
<span id="cb37-413"><a href="#cb37-413" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Survival</span>
<span id="cb37-414"><a href="#cb37-414" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-415"><a href="#cb37-415" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb37-416"><a href="#cb37-416" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> Treatment)) <span class="sc">+</span></span>
<span id="cb37-417"><a href="#cb37-417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(</span>
<span id="cb37-418"><a href="#cb37-418" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb37-419"><a href="#cb37-419" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymin =</span> Lower,</span>
<span id="cb37-420"><a href="#cb37-420" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymax =</span> Upper,</span>
<span id="cb37-421"><a href="#cb37-421" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> Treatment</span>
<span id="cb37-422"><a href="#cb37-422" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-423"><a href="#cb37-423" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">25</span></span>
<span id="cb37-424"><a href="#cb37-424" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-425"><a href="#cb37-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb37-426"><a href="#cb37-426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb37-427"><a href="#cb37-427" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-428"><a href="#cb37-428" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>),</span>
<span id="cb37-429"><a href="#cb37-429" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb37-430"><a href="#cb37-430" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-431"><a href="#cb37-431" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since treatment"</span>) <span class="sc">+</span></span>
<span id="cb37-432"><a href="#cb37-432" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Survival Probability"</span>)</span>
<span id="cb37-433"><a href="#cb37-433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-434"><a href="#cb37-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-435"><a href="#cb37-435" aria-hidden="true" tabindex="-1"></a>If we weren't doing a simulation, we wouldn't know how much of these differences are explained by the treatment. And actually, these crude survival curves suggest longer survival from treatment _B_, even though we know the [opposite is true](#treatmenteffect). The goal is to use this _known_ information (along with [patient characteristics](#simulatepatients)) to estimate the causal treatment effect that is baked into all of the _unknown_ quantities we have here that would be unavailable to us in a real-life analysis.</span>
<span id="cb37-436"><a href="#cb37-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-437"><a href="#cb37-437" aria-hidden="true" tabindex="-1"></a><span class="fu"># Estimating the weights {#estimatingweights}</span></span>
<span id="cb37-438"><a href="#cb37-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-439"><a href="#cb37-439" aria-hidden="true" tabindex="-1"></a>Now that our <span class="co">[</span><span class="ot">simulation is set</span><span class="co">](#potentialoutcomes)</span>, we can start using the observed data (i.e., known quantities) to estimate the case-weights needed for treatment effect estimation. This is the process we'd go through in a real-life analysis, but here we have the benefit of knowing the truth, so we can see how close our estimations are to reality. </span>
<span id="cb37-440"><a href="#cb37-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-441"><a href="#cb37-441" aria-hidden="true" tabindex="-1"></a>The intention of these weights is to _adjust_ the observed sample to create a _pseudo-population_ such that the patient characteristics that we believe are confounding the treatment effect are corrected for, or _balanced_, across the treatment groups. The term "pseudo" here is a little misleading. It's simply referring to the fact that each patient will not contribute the same weight in estimating the treatment effect. In fact, the patients with the most _overlap_ in characteristics across the treatment groups will contribute the most, with patients being proportionately down-weighted the less overlap they have (I'd argue this is the same thing that is done in [matching](https://en.wikipedia.org/wiki/Propensity_score_matching), it's just that the weights for patients are either exactly _1_ or _0_). This is done to tease out the portion of the outcome differences that is explained by the treatment, namely, the causal treatment effect. </span>
<span id="cb37-442"><a href="#cb37-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-443"><a href="#cb37-443" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model the propensity scores {#modelpropensityscores}</span></span>
<span id="cb37-444"><a href="#cb37-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-445"><a href="#cb37-445" aria-hidden="true" tabindex="-1"></a>We've <span class="co">[</span><span class="ot">established</span><span class="co">](#trueoverlapweight)</span> that the overlap weights are quantities that need to be estimated from the data. In order to calculate those weights, we first need to estimate the propensity scores. We know what the <span class="co">[</span><span class="ot">true model</span><span class="co">](#treatmentpropensity)</span> is, but let's assume we are only working with observable data:</span>
<span id="cb37-446"><a href="#cb37-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-449"><a href="#cb37-449" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-450"><a href="#cb37-450" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span> <span class="fu">select</span>(zage, male, zincome, A, time, status)</span>
<span id="cb37-451"><a href="#cb37-451" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-452"><a href="#cb37-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-453"><a href="#cb37-453" aria-hidden="true" tabindex="-1"></a>Our goal is to obtain patient-specific probabilities of receiving treatment _A_. We'll estimate this with a <span class="co">[</span><span class="ot">logistic regression</span><span class="co">](https://en.wikipedia.org/wiki/Logistic_regression)</span> model, but we'll allow for some flexibility in the shape of the relationships between the continuous variables (age and income) and the outcome with the use of <span class="co">[</span><span class="ot">restricted cubic splines</span><span class="co">](https://www.nature.com/articles/s41409-019-0679-x)</span> (see my <span class="co">[</span><span class="ot">other post</span><span class="co">](https://www.zajichekstats.com/post/the-evasive-spline/)</span> for another explanation):</span>
<span id="cb37-454"><a href="#cb37-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-457"><a href="#cb37-457" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-458"><a href="#cb37-458" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the propensity score model</span></span>
<span id="cb37-459"><a href="#cb37-459" aria-hidden="true" tabindex="-1"></a>ps_mod <span class="ot">&lt;-</span></span>
<span id="cb37-460"><a href="#cb37-460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(</span>
<span id="cb37-461"><a href="#cb37-461" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> A <span class="sc">~</span> rms<span class="sc">::</span><span class="fu">rcs</span>(zage, <span class="dv">3</span>) <span class="sc">+</span> rms<span class="sc">::</span><span class="fu">rcs</span>(zincome, <span class="dv">3</span>) <span class="sc">+</span> <span class="fu">factor</span>(male),</span>
<span id="cb37-462"><a href="#cb37-462" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> population,</span>
<span id="cb37-463"><a href="#cb37-463" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"binomial"</span></span>
<span id="cb37-464"><a href="#cb37-464" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-465"><a href="#cb37-465" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ps_mod)</span>
<span id="cb37-466"><a href="#cb37-466" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-467"><a href="#cb37-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-468"><a href="#cb37-468" aria-hidden="true" tabindex="-1"></a>The model seems to indicate that the non-linear terms for age and income don't particularly matter (which <span class="co">[</span><span class="ot">is expected</span><span class="co">](#treatmentpropensity)</span>), but we'll leave it as-is. Next, let's attach the _estimated_ propensity scores to the <span class="in">`population`</span>:</span>
<span id="cb37-469"><a href="#cb37-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-472"><a href="#cb37-472" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-473"><a href="#cb37-473" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb37-474"><a href="#cb37-474" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb37-475"><a href="#cb37-475" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-476"><a href="#cb37-476" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the estimated propensity score</span></span>
<span id="cb37-477"><a href="#cb37-477" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-478"><a href="#cb37-478" aria-hidden="true" tabindex="-1"></a>    <span class="at">pA_hat =</span> <span class="fu">predict</span>(ps_mod, <span class="at">type =</span> <span class="st">"response"</span>) <span class="co"># P(A = 1 | X)</span></span>
<span id="cb37-479"><a href="#cb37-479" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-480"><a href="#cb37-480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-481"><a href="#cb37-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-482"><a href="#cb37-482" aria-hidden="true" tabindex="-1"></a>We can take a look at the estimated propensity score distribution across the treatment groups (we'll also overlay the _true_ distributions for comparison):</span>
<span id="cb37-483"><a href="#cb37-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-486"><a href="#cb37-486" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-487"><a href="#cb37-487" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span></span>
<span id="cb37-488"><a href="#cb37-488" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-489"><a href="#cb37-489" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send PS scores down the rows</span></span>
<span id="cb37-490"><a href="#cb37-490" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb37-491"><a href="#cb37-491" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(pA, pA_hat),</span>
<span id="cb37-492"><a href="#cb37-492" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Type"</span>,</span>
<span id="cb37-493"><a href="#cb37-493" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Score"</span></span>
<span id="cb37-494"><a href="#cb37-494" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-495"><a href="#cb37-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-496"><a href="#cb37-496" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean labels</span></span>
<span id="cb37-497"><a href="#cb37-497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-498"><a href="#cb37-498" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb37-499"><a href="#cb37-499" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-500"><a href="#cb37-500" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb37-501"><a href="#cb37-501" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb37-502"><a href="#cb37-502" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb37-503"><a href="#cb37-503" aria-hidden="true" tabindex="-1"></a>    <span class="at">Type =</span> </span>
<span id="cb37-504"><a href="#cb37-504" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-505"><a href="#cb37-505" aria-hidden="true" tabindex="-1"></a>        Type <span class="sc">==</span> <span class="st">"pA"</span> <span class="sc">~</span> <span class="st">"True"</span>,</span>
<span id="cb37-506"><a href="#cb37-506" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Estimated"</span></span>
<span id="cb37-507"><a href="#cb37-507" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb37-508"><a href="#cb37-508" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-509"><a href="#cb37-509" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-510"><a href="#cb37-510" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb37-511"><a href="#cb37-511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb37-512"><a href="#cb37-512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(</span>
<span id="cb37-513"><a href="#cb37-513" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb37-514"><a href="#cb37-514" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Score,</span>
<span id="cb37-515"><a href="#cb37-515" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> Treatment,</span>
<span id="cb37-516"><a href="#cb37-516" aria-hidden="true" tabindex="-1"></a>      <span class="at">linetype =</span> Type</span>
<span id="cb37-517"><a href="#cb37-517" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-518"><a href="#cb37-518" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">40</span></span>
<span id="cb37-519"><a href="#cb37-519" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-520"><a href="#cb37-520" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb37-521"><a href="#cb37-521" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb37-522"><a href="#cb37-522" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-523"><a href="#cb37-523" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-524"><a href="#cb37-524" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-525"><a href="#cb37-525" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-526"><a href="#cb37-526" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb37-527"><a href="#cb37-527" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-528"><a href="#cb37-528" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"P(A=1|X)"</span>)</span>
<span id="cb37-529"><a href="#cb37-529" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-530"><a href="#cb37-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-531"><a href="#cb37-531" aria-hidden="true" tabindex="-1"></a>The model does a great job at estimating the true propensity scores. In a real analysis we probably wouldn't be this close since we likely wouldn't have only and all true confounders accounted for.</span>
<span id="cb37-532"><a href="#cb37-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-533"><a href="#cb37-533" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualizing propensity score effects</span></span>
<span id="cb37-534"><a href="#cb37-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-535"><a href="#cb37-535" aria-hidden="true" tabindex="-1"></a>In the same vein, we can explore the modeled relationships between each patient characteristic and the propensity scores. </span>
<span id="cb37-536"><a href="#cb37-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-539"><a href="#cb37-539" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-540"><a href="#cb37-540" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span></span>
<span id="cb37-541"><a href="#cb37-541" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb37-542"><a href="#cb37-542" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-543"><a href="#cb37-543" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send PS scores down the rows</span></span>
<span id="cb37-544"><a href="#cb37-544" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb37-545"><a href="#cb37-545" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(pA, pA_hat),</span>
<span id="cb37-546"><a href="#cb37-546" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Type"</span>,</span>
<span id="cb37-547"><a href="#cb37-547" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Score"</span></span>
<span id="cb37-548"><a href="#cb37-548" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-549"><a href="#cb37-549" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-550"><a href="#cb37-550" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean labels</span></span>
<span id="cb37-551"><a href="#cb37-551" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-552"><a href="#cb37-552" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb37-553"><a href="#cb37-553" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-554"><a href="#cb37-554" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb37-555"><a href="#cb37-555" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb37-556"><a href="#cb37-556" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb37-557"><a href="#cb37-557" aria-hidden="true" tabindex="-1"></a>    <span class="at">Type =</span> </span>
<span id="cb37-558"><a href="#cb37-558" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-559"><a href="#cb37-559" aria-hidden="true" tabindex="-1"></a>        Type <span class="sc">==</span> <span class="st">"pA"</span> <span class="sc">~</span> <span class="st">"True"</span>,</span>
<span id="cb37-560"><a href="#cb37-560" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Estimated"</span></span>
<span id="cb37-561"><a href="#cb37-561" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb37-562"><a href="#cb37-562" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-563"><a href="#cb37-563" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-564"><a href="#cb37-564" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send covariates down the rows</span></span>
<span id="cb37-565"><a href="#cb37-565" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb37-566"><a href="#cb37-566" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(zage, zincome, male),</span>
<span id="cb37-567"><a href="#cb37-567" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_prefix =</span> <span class="st">"^z"</span></span>
<span id="cb37-568"><a href="#cb37-568" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-569"><a href="#cb37-569" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-570"><a href="#cb37-570" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make groups</span></span>
<span id="cb37-571"><a href="#cb37-571" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-572"><a href="#cb37-572" aria-hidden="true" tabindex="-1"></a>    <span class="at">Group =</span> </span>
<span id="cb37-573"><a href="#cb37-573" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-574"><a href="#cb37-574" aria-hidden="true" tabindex="-1"></a>        name <span class="sc">==</span> <span class="st">"male"</span> <span class="sc">~</span> <span class="st">"categorical"</span>,</span>
<span id="cb37-575"><a href="#cb37-575" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"continuous"</span></span>
<span id="cb37-576"><a href="#cb37-576" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb37-577"><a href="#cb37-577" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-578"><a href="#cb37-578" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-579"><a href="#cb37-579" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a nested frame</span></span>
<span id="cb37-580"><a href="#cb37-580" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Group) <span class="sc">|&gt;</span></span>
<span id="cb37-581"><a href="#cb37-581" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">|&gt;</span></span>
<span id="cb37-582"><a href="#cb37-582" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-583"><a href="#cb37-583" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make plot depending on type</span></span>
<span id="cb37-584"><a href="#cb37-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-585"><a href="#cb37-585" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot =</span> </span>
<span id="cb37-586"><a href="#cb37-586" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">|&gt;</span></span>
<span id="cb37-587"><a href="#cb37-587" aria-hidden="true" tabindex="-1"></a>      <span class="fu">map</span>(</span>
<span id="cb37-588"><a href="#cb37-588" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(.group) {</span>
<span id="cb37-589"><a href="#cb37-589" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb37-590"><a href="#cb37-590" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Check condition</span></span>
<span id="cb37-591"><a href="#cb37-591" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">n_distinct</span>(.group<span class="sc">$</span>value) <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb37-592"><a href="#cb37-592" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb37-593"><a href="#cb37-593" aria-hidden="true" tabindex="-1"></a>            .group <span class="sc">|&gt;</span></span>
<span id="cb37-594"><a href="#cb37-594" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarize</span>(</span>
<span id="cb37-595"><a href="#cb37-595" aria-hidden="true" tabindex="-1"></a>                <span class="at">Rate =</span> <span class="fu">mean</span>(Score),</span>
<span id="cb37-596"><a href="#cb37-596" aria-hidden="true" tabindex="-1"></a>                <span class="at">.by =</span> <span class="fu">c</span>(Treatment, Type, name, value)</span>
<span id="cb37-597"><a href="#cb37-597" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">|&gt;</span></span>
<span id="cb37-598"><a href="#cb37-598" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(</span>
<span id="cb37-599"><a href="#cb37-599" aria-hidden="true" tabindex="-1"></a>                <span class="at">Sex =</span> </span>
<span id="cb37-600"><a href="#cb37-600" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">case_when</span>(</span>
<span id="cb37-601"><a href="#cb37-601" aria-hidden="true" tabindex="-1"></a>                    value <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Male"</span>,</span>
<span id="cb37-602"><a href="#cb37-602" aria-hidden="true" tabindex="-1"></a>                    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Female"</span></span>
<span id="cb37-603"><a href="#cb37-603" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="cb37-604"><a href="#cb37-604" aria-hidden="true" tabindex="-1"></a>                <span class="at">name =</span> <span class="st">"Sex"</span></span>
<span id="cb37-605"><a href="#cb37-605" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">|&gt;</span></span>
<span id="cb37-606"><a href="#cb37-606" aria-hidden="true" tabindex="-1"></a>              <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb37-607"><a href="#cb37-607" aria-hidden="true" tabindex="-1"></a>              <span class="fu">geom_point</span>(</span>
<span id="cb37-608"><a href="#cb37-608" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(</span>
<span id="cb37-609"><a href="#cb37-609" aria-hidden="true" tabindex="-1"></a>                  <span class="at">x =</span> Sex,</span>
<span id="cb37-610"><a href="#cb37-610" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> Rate,</span>
<span id="cb37-611"><a href="#cb37-611" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> Treatment,</span>
<span id="cb37-612"><a href="#cb37-612" aria-hidden="true" tabindex="-1"></a>                  <span class="at">shape =</span> Type,</span>
<span id="cb37-613"><a href="#cb37-613" aria-hidden="true" tabindex="-1"></a>                  <span class="at">group =</span> Type</span>
<span id="cb37-614"><a href="#cb37-614" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb37-615"><a href="#cb37-615" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">+</span></span>
<span id="cb37-616"><a href="#cb37-616" aria-hidden="true" tabindex="-1"></a>              <span class="fu">geom_line</span>(</span>
<span id="cb37-617"><a href="#cb37-617" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(</span>
<span id="cb37-618"><a href="#cb37-618" aria-hidden="true" tabindex="-1"></a>                  <span class="at">x =</span> Sex,</span>
<span id="cb37-619"><a href="#cb37-619" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> Rate,</span>
<span id="cb37-620"><a href="#cb37-620" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> Treatment,</span>
<span id="cb37-621"><a href="#cb37-621" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> Type,</span>
<span id="cb37-622"><a href="#cb37-622" aria-hidden="true" tabindex="-1"></a>                  <span class="at">group =</span> <span class="fu">interaction</span>(Type, Treatment)</span>
<span id="cb37-623"><a href="#cb37-623" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb37-624"><a href="#cb37-624" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">+</span></span>
<span id="cb37-625"><a href="#cb37-625" aria-hidden="true" tabindex="-1"></a>              <span class="fu">facet_wrap</span>(<span class="sc">~</span>name) <span class="sc">+</span></span>
<span id="cb37-626"><a href="#cb37-626" aria-hidden="true" tabindex="-1"></a>              <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb37-627"><a href="#cb37-627" aria-hidden="true" tabindex="-1"></a>              <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb37-628"><a href="#cb37-628" aria-hidden="true" tabindex="-1"></a>              <span class="fu">theme</span>(</span>
<span id="cb37-629"><a href="#cb37-629" aria-hidden="true" tabindex="-1"></a>                <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-630"><a href="#cb37-630" aria-hidden="true" tabindex="-1"></a>                <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>),</span>
<span id="cb37-631"><a href="#cb37-631" aria-hidden="true" tabindex="-1"></a>                <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb37-632"><a href="#cb37-632" aria-hidden="true" tabindex="-1"></a>                <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb37-633"><a href="#cb37-633" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">+</span></span>
<span id="cb37-634"><a href="#cb37-634" aria-hidden="true" tabindex="-1"></a>              <span class="fu">ylab</span>(<span class="st">"P(A=1|X)"</span>)</span>
<span id="cb37-635"><a href="#cb37-635" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb37-636"><a href="#cb37-636" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb37-637"><a href="#cb37-637" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb37-638"><a href="#cb37-638" aria-hidden="true" tabindex="-1"></a>            .group <span class="sc">|&gt;</span> </span>
<span id="cb37-639"><a href="#cb37-639" aria-hidden="true" tabindex="-1"></a>              <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb37-640"><a href="#cb37-640" aria-hidden="true" tabindex="-1"></a>              <span class="fu">geom_smooth</span>(</span>
<span id="cb37-641"><a href="#cb37-641" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(</span>
<span id="cb37-642"><a href="#cb37-642" aria-hidden="true" tabindex="-1"></a>                  <span class="at">x =</span> value,</span>
<span id="cb37-643"><a href="#cb37-643" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> Score,</span>
<span id="cb37-644"><a href="#cb37-644" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> Treatment,</span>
<span id="cb37-645"><a href="#cb37-645" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fill =</span> Treatment,</span>
<span id="cb37-646"><a href="#cb37-646" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> Type</span>
<span id="cb37-647"><a href="#cb37-647" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb37-648"><a href="#cb37-648" aria-hidden="true" tabindex="-1"></a>                <span class="at">alpha =</span> .<span class="dv">25</span></span>
<span id="cb37-649"><a href="#cb37-649" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">+</span></span>
<span id="cb37-650"><a href="#cb37-650" aria-hidden="true" tabindex="-1"></a>              <span class="fu">facet_wrap</span>(<span class="sc">~</span>name) <span class="sc">+</span></span>
<span id="cb37-651"><a href="#cb37-651" aria-hidden="true" tabindex="-1"></a>              <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb37-652"><a href="#cb37-652" aria-hidden="true" tabindex="-1"></a>              <span class="fu">theme</span>(</span>
<span id="cb37-653"><a href="#cb37-653" aria-hidden="true" tabindex="-1"></a>                <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-654"><a href="#cb37-654" aria-hidden="true" tabindex="-1"></a>                <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>),</span>
<span id="cb37-655"><a href="#cb37-655" aria-hidden="true" tabindex="-1"></a>                <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb37-656"><a href="#cb37-656" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">+</span></span>
<span id="cb37-657"><a href="#cb37-657" aria-hidden="true" tabindex="-1"></a>              <span class="fu">xlab</span>(<span class="st">"Z-Score"</span>) <span class="sc">+</span></span>
<span id="cb37-658"><a href="#cb37-658" aria-hidden="true" tabindex="-1"></a>              <span class="fu">ylab</span>(<span class="st">"P(A=1|X)"</span>)</span>
<span id="cb37-659"><a href="#cb37-659" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb37-660"><a href="#cb37-660" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb37-661"><a href="#cb37-661" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb37-662"><a href="#cb37-662" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb37-663"><a href="#cb37-663" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb37-664"><a href="#cb37-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-665"><a href="#cb37-665" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(plots<span class="sc">$</span>plot[[<span class="dv">1</span>]], plots<span class="sc">$</span>plot[[<span class="dv">2</span>]])</span>
<span id="cb37-666"><a href="#cb37-666" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-667"><a href="#cb37-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-668"><a href="#cb37-668" aria-hidden="true" tabindex="-1"></a>As known from the <span class="co">[</span><span class="ot">true model</span><span class="co">](#treatmentpropensity)</span>, patients who received treatment _A_ tend to be older, female patients with lower income. We can also see slight miscalibration in the estimates for patients who are older in that the model tends to _underestimate_ the true propensity score in these patients. We see similar miscalibration for sex.</span>
<span id="cb37-669"><a href="#cb37-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-670"><a href="#cb37-670" aria-hidden="true" tabindex="-1"></a><span class="fu">## Calculate the (estimated) overlap weight {#estimatedoverlapweight}</span></span>
<span id="cb37-671"><a href="#cb37-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-672"><a href="#cb37-672" aria-hidden="true" tabindex="-1"></a>We've already <span class="co">[</span><span class="ot">defined</span><span class="co">](#trueoverlapweight)</span> how to calculate the overlap weights. The only difference here is that we'll do it from the <span class="co">[</span><span class="ot">_estimated_</span><span class="co">](#modelpropensityscores)</span> propensity scores instead of the <span class="co">[</span><span class="ot">true</span><span class="co">](#treatmentpropensity)</span> ones. First, we'll apply the formula to add the estimated weights to the <span class="in">`population`</span>:</span>
<span id="cb37-673"><a href="#cb37-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-676"><a href="#cb37-676" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-677"><a href="#cb37-677" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb37-678"><a href="#cb37-678" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb37-679"><a href="#cb37-679" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-680"><a href="#cb37-680" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the estimated overlap weight for the realized treatment (known quantity)</span></span>
<span id="cb37-681"><a href="#cb37-681" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-682"><a href="#cb37-682" aria-hidden="true" tabindex="-1"></a>    <span class="at">OW_hat =</span> A <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>pA_hat) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>A) <span class="sc">*</span> pA_hat</span>
<span id="cb37-683"><a href="#cb37-683" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-684"><a href="#cb37-684" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-685"><a href="#cb37-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-686"><a href="#cb37-686" aria-hidden="true" tabindex="-1"></a>As we've <span class="co">[</span><span class="ot">mentioned earlier</span><span class="co">](#targetpopulation)</span>, we will then _normalize_ the weights _within_ each treatment group so they have the same cumulative contribution for estimating the treatment effect in the outcome model.</span>
<span id="cb37-687"><a href="#cb37-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-690"><a href="#cb37-690" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-691"><a href="#cb37-691" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span> </span>
<span id="cb37-692"><a href="#cb37-692" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span></span>
<span id="cb37-693"><a href="#cb37-693" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-694"><a href="#cb37-694" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the normalized weights (adding true and estimated)</span></span>
<span id="cb37-695"><a href="#cb37-695" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-696"><a href="#cb37-696" aria-hidden="true" tabindex="-1"></a>    <span class="at">OW_norm =</span> OW <span class="sc">/</span> <span class="fu">sum</span>(OW),</span>
<span id="cb37-697"><a href="#cb37-697" aria-hidden="true" tabindex="-1"></a>    <span class="at">OW_hat_norm =</span> OW_hat <span class="sc">/</span> <span class="fu">sum</span>(OW_hat),</span>
<span id="cb37-698"><a href="#cb37-698" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> A</span>
<span id="cb37-699"><a href="#cb37-699" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-700"><a href="#cb37-700" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span> <span class="fu">select</span>(A, pA, pA_hat, OW, OW_norm, OW_hat, OW_hat_norm)</span>
<span id="cb37-701"><a href="#cb37-701" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-702"><a href="#cb37-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-703"><a href="#cb37-703" aria-hidden="true" tabindex="-1"></a>To get a sense of the impact of these weights, let's first look at their distributions (again, adding the <span class="co">[</span><span class="ot">true</span><span class="co">](#trueoverlapweight)</span> weights for comparison):</span>
<span id="cb37-704"><a href="#cb37-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-707"><a href="#cb37-707" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-708"><a href="#cb37-708" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span></span>
<span id="cb37-709"><a href="#cb37-709" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-710"><a href="#cb37-710" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send overlap weight down the rows</span></span>
<span id="cb37-711"><a href="#cb37-711" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb37-712"><a href="#cb37-712" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(OW_norm, OW_hat_norm),</span>
<span id="cb37-713"><a href="#cb37-713" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Type"</span>,</span>
<span id="cb37-714"><a href="#cb37-714" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Weight"</span></span>
<span id="cb37-715"><a href="#cb37-715" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-716"><a href="#cb37-716" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-717"><a href="#cb37-717" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean labels</span></span>
<span id="cb37-718"><a href="#cb37-718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-719"><a href="#cb37-719" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb37-720"><a href="#cb37-720" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-721"><a href="#cb37-721" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb37-722"><a href="#cb37-722" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb37-723"><a href="#cb37-723" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb37-724"><a href="#cb37-724" aria-hidden="true" tabindex="-1"></a>    <span class="at">Type =</span> </span>
<span id="cb37-725"><a href="#cb37-725" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-726"><a href="#cb37-726" aria-hidden="true" tabindex="-1"></a>        Type <span class="sc">==</span> <span class="st">"OW_norm"</span> <span class="sc">~</span> <span class="st">"True"</span>,</span>
<span id="cb37-727"><a href="#cb37-727" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Estimated"</span></span>
<span id="cb37-728"><a href="#cb37-728" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb37-729"><a href="#cb37-729" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-730"><a href="#cb37-730" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-731"><a href="#cb37-731" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb37-732"><a href="#cb37-732" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb37-733"><a href="#cb37-733" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(</span>
<span id="cb37-734"><a href="#cb37-734" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb37-735"><a href="#cb37-735" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Weight,</span>
<span id="cb37-736"><a href="#cb37-736" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> Treatment,</span>
<span id="cb37-737"><a href="#cb37-737" aria-hidden="true" tabindex="-1"></a>      <span class="at">linetype =</span> Type</span>
<span id="cb37-738"><a href="#cb37-738" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-739"><a href="#cb37-739" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">40</span></span>
<span id="cb37-740"><a href="#cb37-740" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-741"><a href="#cb37-741" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb37-742"><a href="#cb37-742" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-743"><a href="#cb37-743" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-744"><a href="#cb37-744" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-745"><a href="#cb37-745" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-746"><a href="#cb37-746" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb37-747"><a href="#cb37-747" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-748"><a href="#cb37-748" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Normalized Overlap Weight"</span>)</span>
<span id="cb37-749"><a href="#cb37-749" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-750"><a href="#cb37-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-751"><a href="#cb37-751" aria-hidden="true" tabindex="-1"></a>In aggregate, the groups will have equal weight. The distribution shift has to do with the sampled treatment distribution. Only <span class="in">`r paste0(round(mean(population$A)*100, 1), "%")`</span> of patients have treatment _A_ so at an individual level each patient will contribute more on average.</span>
<span id="cb37-752"><a href="#cb37-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-753"><a href="#cb37-753" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cumulative patient contribution</span></span>
<span id="cb37-754"><a href="#cb37-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-755"><a href="#cb37-755" aria-hidden="true" tabindex="-1"></a>We can also look at the accumulation of _patients_ (i.e., when each patient contributes equally) as a function of the cumulative _overlap weight_ in each group. This allows us to understand how much (or little) the treatment effect estimation will be dominated by smaller concentrations of patients.</span>
<span id="cb37-756"><a href="#cb37-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-759"><a href="#cb37-759" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-760"><a href="#cb37-760" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span></span>
<span id="cb37-761"><a href="#cb37-761" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-762"><a href="#cb37-762" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send overlap weight down the rows</span></span>
<span id="cb37-763"><a href="#cb37-763" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb37-764"><a href="#cb37-764" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(OW_norm, OW_hat_norm),</span>
<span id="cb37-765"><a href="#cb37-765" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Type"</span>,</span>
<span id="cb37-766"><a href="#cb37-766" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Weight"</span></span>
<span id="cb37-767"><a href="#cb37-767" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-768"><a href="#cb37-768" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-769"><a href="#cb37-769" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean labels</span></span>
<span id="cb37-770"><a href="#cb37-770" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-771"><a href="#cb37-771" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb37-772"><a href="#cb37-772" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-773"><a href="#cb37-773" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb37-774"><a href="#cb37-774" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb37-775"><a href="#cb37-775" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb37-776"><a href="#cb37-776" aria-hidden="true" tabindex="-1"></a>    <span class="at">Type =</span> </span>
<span id="cb37-777"><a href="#cb37-777" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-778"><a href="#cb37-778" aria-hidden="true" tabindex="-1"></a>        Type <span class="sc">==</span> <span class="st">"OW_norm"</span> <span class="sc">~</span> <span class="st">"True"</span>,</span>
<span id="cb37-779"><a href="#cb37-779" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Estimated"</span></span>
<span id="cb37-780"><a href="#cb37-780" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb37-781"><a href="#cb37-781" aria-hidden="true" tabindex="-1"></a>    <span class="at">NullWeight =</span> <span class="dv">1</span></span>
<span id="cb37-782"><a href="#cb37-782" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb37-783"><a href="#cb37-783" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-784"><a href="#cb37-784" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rearrange</span></span>
<span id="cb37-785"><a href="#cb37-785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Treatment, Type, Weight) <span class="sc">|&gt;</span></span>
<span id="cb37-786"><a href="#cb37-786" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-787"><a href="#cb37-787" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the cumulative weight</span></span>
<span id="cb37-788"><a href="#cb37-788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-789"><a href="#cb37-789" aria-hidden="true" tabindex="-1"></a>    <span class="at">Weight =</span> <span class="fu">cumsum</span>(Weight) <span class="sc">/</span> <span class="fu">sum</span>(Weight),</span>
<span id="cb37-790"><a href="#cb37-790" aria-hidden="true" tabindex="-1"></a>    <span class="at">NullWeight =</span> <span class="fu">cumsum</span>(NullWeight) <span class="sc">/</span> <span class="fu">sum</span>(NullWeight),</span>
<span id="cb37-791"><a href="#cb37-791" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(Treatment, Type)</span>
<span id="cb37-792"><a href="#cb37-792" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb37-793"><a href="#cb37-793" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-794"><a href="#cb37-794" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb37-795"><a href="#cb37-795" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb37-796"><a href="#cb37-796" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb37-797"><a href="#cb37-797" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb37-798"><a href="#cb37-798" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Weight,</span>
<span id="cb37-799"><a href="#cb37-799" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> NullWeight,</span>
<span id="cb37-800"><a href="#cb37-800" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> Treatment,</span>
<span id="cb37-801"><a href="#cb37-801" aria-hidden="true" tabindex="-1"></a>      <span class="at">linetype =</span> Type</span>
<span id="cb37-802"><a href="#cb37-802" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-803"><a href="#cb37-803" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb37-804"><a href="#cb37-804" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-805"><a href="#cb37-805" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb37-806"><a href="#cb37-806" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb37-807"><a href="#cb37-807" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb37-808"><a href="#cb37-808" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-809"><a href="#cb37-809" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>),</span>
<span id="cb37-810"><a href="#cb37-810" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>),</span>
<span id="cb37-811"><a href="#cb37-811" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb37-812"><a href="#cb37-812" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-813"><a href="#cb37-813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Cumulative percent of overlap weight (%)"</span>) <span class="sc">+</span></span>
<span id="cb37-814"><a href="#cb37-814" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cumulative percent of patients (%)"</span>) </span>
<span id="cb37-815"><a href="#cb37-815" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-816"><a href="#cb37-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-817"><a href="#cb37-817" aria-hidden="true" tabindex="-1"></a>We can see that for treatment _B_, about 40% of the outcome model weight will be accounted for by only 25% of patients. The weights for treatment _A_ are slightly more evenly spread across the patients.</span>
<span id="cb37-818"><a href="#cb37-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-819"><a href="#cb37-819" aria-hidden="true" tabindex="-1"></a><span class="fu">### Weighted-mean differences</span></span>
<span id="cb37-820"><a href="#cb37-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-821"><a href="#cb37-821" aria-hidden="true" tabindex="-1"></a>It was <span class="co">[</span><span class="ot">previously mentioned</span><span class="co">](#treatmentpropensity)</span> that the overlap weight methodology leads to perfect balance among the covariates used in the propensity score model. We can verify by looking at the group means for <span class="co">[</span><span class="ot">each model factor</span><span class="co">](#modelpropensityscores)</span> before and after weighting.</span>
<span id="cb37-822"><a href="#cb37-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-825"><a href="#cb37-825" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-826"><a href="#cb37-826" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span> </span>
<span id="cb37-827"><a href="#cb37-827" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-828"><a href="#cb37-828" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add uniform weights</span></span>
<span id="cb37-829"><a href="#cb37-829" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_column</span>(<span class="at">NullWeight =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb37-830"><a href="#cb37-830" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-831"><a href="#cb37-831" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send weights down the rows</span></span>
<span id="cb37-832"><a href="#cb37-832" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb37-833"><a href="#cb37-833" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(NullWeight, OW_hat_norm),</span>
<span id="cb37-834"><a href="#cb37-834" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Type"</span>,</span>
<span id="cb37-835"><a href="#cb37-835" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Weight"</span></span>
<span id="cb37-836"><a href="#cb37-836" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb37-837"><a href="#cb37-837" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-838"><a href="#cb37-838" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send factors down the rows</span></span>
<span id="cb37-839"><a href="#cb37-839" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb37-840"><a href="#cb37-840" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(age, income, male),</span>
<span id="cb37-841"><a href="#cb37-841" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Factor"</span>,</span>
<span id="cb37-842"><a href="#cb37-842" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Value"</span></span>
<span id="cb37-843"><a href="#cb37-843" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb37-844"><a href="#cb37-844" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-845"><a href="#cb37-845" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each </span></span>
<span id="cb37-846"><a href="#cb37-846" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb37-847"><a href="#cb37-847" aria-hidden="true" tabindex="-1"></a>    <span class="at">Patients =</span> <span class="fu">n</span>(),</span>
<span id="cb37-848"><a href="#cb37-848" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean =</span> <span class="fu">sum</span>(Weight <span class="sc">*</span> Value) <span class="sc">/</span> <span class="fu">sum</span>(Weight),</span>
<span id="cb37-849"><a href="#cb37-849" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(Factor, Type, A)</span>
<span id="cb37-850"><a href="#cb37-850" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-851"><a href="#cb37-851" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-852"><a href="#cb37-852" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean up</span></span>
<span id="cb37-853"><a href="#cb37-853" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb37-854"><a href="#cb37-854" aria-hidden="true" tabindex="-1"></a>    <span class="at">Factor =</span> </span>
<span id="cb37-855"><a href="#cb37-855" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-856"><a href="#cb37-856" aria-hidden="true" tabindex="-1"></a>        Factor <span class="sc">==</span> <span class="st">"age"</span> <span class="sc">~</span> <span class="st">"Age (years)"</span>,</span>
<span id="cb37-857"><a href="#cb37-857" aria-hidden="true" tabindex="-1"></a>        Factor <span class="sc">==</span> <span class="st">"income"</span> <span class="sc">~</span> <span class="st">"Income ($)"</span>,</span>
<span id="cb37-858"><a href="#cb37-858" aria-hidden="true" tabindex="-1"></a>        Factor <span class="sc">==</span> <span class="st">"male"</span> <span class="sc">~</span> <span class="st">"Male (%)"</span></span>
<span id="cb37-859"><a href="#cb37-859" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb37-860"><a href="#cb37-860" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb37-861"><a href="#cb37-861" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-862"><a href="#cb37-862" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb37-863"><a href="#cb37-863" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb37-864"><a href="#cb37-864" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb37-865"><a href="#cb37-865" aria-hidden="true" tabindex="-1"></a>    Type,</span>
<span id="cb37-866"><a href="#cb37-866" aria-hidden="true" tabindex="-1"></a>    Patients,</span>
<span id="cb37-867"><a href="#cb37-867" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean =</span> </span>
<span id="cb37-868"><a href="#cb37-868" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-869"><a href="#cb37-869" aria-hidden="true" tabindex="-1"></a>        Factor <span class="sc">==</span> <span class="st">"Male (%)"</span> <span class="sc">~</span> <span class="dv">100</span> <span class="sc">*</span> Mean,</span>
<span id="cb37-870"><a href="#cb37-870" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> Mean</span>
<span id="cb37-871"><a href="#cb37-871" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb37-872"><a href="#cb37-872" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-873"><a href="#cb37-873" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-874"><a href="#cb37-874" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send over the columns</span></span>
<span id="cb37-875"><a href="#cb37-875" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb37-876"><a href="#cb37-876" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> Type,</span>
<span id="cb37-877"><a href="#cb37-877" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> <span class="fu">c</span>(Patients, Mean)</span>
<span id="cb37-878"><a href="#cb37-878" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb37-879"><a href="#cb37-879" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-880"><a href="#cb37-880" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rearrange</span></span>
<span id="cb37-881"><a href="#cb37-881" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Factor, Treatment) <span class="sc">|&gt;</span></span>
<span id="cb37-882"><a href="#cb37-882" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Factor, Treatment, <span class="fu">ends_with</span>(<span class="st">"NullWeight"</span>), Mean_OW_hat_norm) <span class="sc">|&gt;</span> </span>
<span id="cb37-883"><a href="#cb37-883" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-884"><a href="#cb37-884" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a table</span></span>
<span id="cb37-885"><a href="#cb37-885" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reactable</span>(</span>
<span id="cb37-886"><a href="#cb37-886" aria-hidden="true" tabindex="-1"></a>    <span class="at">groupBy =</span> <span class="st">"Factor"</span>,</span>
<span id="cb37-887"><a href="#cb37-887" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> </span>
<span id="cb37-888"><a href="#cb37-888" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb37-889"><a href="#cb37-889" aria-hidden="true" tabindex="-1"></a>        <span class="at">Patients_NullWeight =</span> <span class="fu">colDef</span>(<span class="at">name =</span> <span class="st">"Patients"</span>, <span class="at">aggregate =</span> <span class="st">"sum"</span>, <span class="at">align =</span> <span class="st">"center"</span>),</span>
<span id="cb37-890"><a href="#cb37-890" aria-hidden="true" tabindex="-1"></a>        <span class="at">Mean_NullWeight =</span> <span class="fu">colDef</span>(<span class="at">name =</span> <span class="st">"Before Weighting"</span>, <span class="at">aggregate =</span> zildge<span class="sc">::</span><span class="fu">rectbl_agg_wtd</span>(<span class="st">"Patients_NullWeight"</span>), <span class="at">align =</span> <span class="st">"center"</span>, <span class="at">format =</span> <span class="fu">colFormat</span>(<span class="at">digits =</span> <span class="dv">1</span>)),</span>
<span id="cb37-891"><a href="#cb37-891" aria-hidden="true" tabindex="-1"></a>        <span class="at">Mean_OW_hat_norm =</span> <span class="fu">colDef</span>(<span class="at">name =</span> <span class="st">"After Weighting"</span>, <span class="at">aggregate =</span> zildge<span class="sc">::</span><span class="fu">rectbl_agg_wtd</span>(<span class="st">"Patients_NullWeight"</span>), <span class="at">align =</span> <span class="st">"center"</span>, <span class="at">format =</span> <span class="fu">colFormat</span>(<span class="at">digits =</span> <span class="dv">1</span>))</span>
<span id="cb37-892"><a href="#cb37-892" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb37-893"><a href="#cb37-893" aria-hidden="true" tabindex="-1"></a>    <span class="at">columnGroups =</span> </span>
<span id="cb37-894"><a href="#cb37-894" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb37-895"><a href="#cb37-895" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colGroup</span>(</span>
<span id="cb37-896"><a href="#cb37-896" aria-hidden="true" tabindex="-1"></a>          <span class="at">name =</span> <span class="st">"Mean Value"</span>,</span>
<span id="cb37-897"><a href="#cb37-897" aria-hidden="true" tabindex="-1"></a>          <span class="at">columns =</span> <span class="fu">c</span>(<span class="st">"Mean_NullWeight"</span>, <span class="st">"Mean_OW_hat_norm"</span>)</span>
<span id="cb37-898"><a href="#cb37-898" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-899"><a href="#cb37-899" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb37-900"><a href="#cb37-900" aria-hidden="true" tabindex="-1"></a>    <span class="at">striped =</span> <span class="cn">TRUE</span>,</span>
<span id="cb37-901"><a href="#cb37-901" aria-hidden="true" tabindex="-1"></a>    <span class="at">highlight =</span> <span class="cn">TRUE</span>,</span>
<span id="cb37-902"><a href="#cb37-902" aria-hidden="true" tabindex="-1"></a>    <span class="at">bordered =</span> <span class="cn">TRUE</span>,</span>
<span id="cb37-903"><a href="#cb37-903" aria-hidden="true" tabindex="-1"></a>    <span class="at">resizable =</span> <span class="cn">TRUE</span>,</span>
<span id="cb37-904"><a href="#cb37-904" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme =</span> reactablefmtr<span class="sc">::</span><span class="fu">sandstone</span>()</span>
<span id="cb37-905"><a href="#cb37-905" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-906"><a href="#cb37-906" aria-hidden="true" tabindex="-1"></a>  reactablefmtr<span class="sc">::</span><span class="fu">add_source</span>(<span class="st">"Use arrows to expand table"</span>, <span class="at">font_size =</span> <span class="dv">12</span>, <span class="at">font_style =</span> <span class="st">"italic"</span>)</span>
<span id="cb37-907"><a href="#cb37-907" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-908"><a href="#cb37-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-909"><a href="#cb37-909" aria-hidden="true" tabindex="-1"></a>We can see that, overall, the weighted sample is _slightly_ older and female with lower income.</span>
<span id="cb37-910"><a href="#cb37-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-911"><a href="#cb37-911" aria-hidden="true" tabindex="-1"></a><span class="fu">### Confounder weight shifts</span></span>
<span id="cb37-912"><a href="#cb37-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-913"><a href="#cb37-913" aria-hidden="true" tabindex="-1"></a>Similar to looking at weight attributions <span class="co">[</span><span class="ot">as a whole</span><span class="co">](#estimatedoverlapweight)</span>, we can explore weight shifts within subgroups of patient characteristics. This helps build intuition about which patients the subsequent treatment effect estimates will focus on most (and least). </span>
<span id="cb37-914"><a href="#cb37-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-917"><a href="#cb37-917" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-918"><a href="#cb37-918" aria-hidden="true" tabindex="-1"></a>population <span class="sc">|&gt;</span> </span>
<span id="cb37-919"><a href="#cb37-919" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-920"><a href="#cb37-920" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add uniform weights</span></span>
<span id="cb37-921"><a href="#cb37-921" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_column</span>(<span class="at">NullWeight =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb37-922"><a href="#cb37-922" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-923"><a href="#cb37-923" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to quntiles</span></span>
<span id="cb37-924"><a href="#cb37-924" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-925"><a href="#cb37-925" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb37-926"><a href="#cb37-926" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(age, income),</span>
<span id="cb37-927"><a href="#cb37-927" aria-hidden="true" tabindex="-1"></a>      \(x) Hmisc<span class="sc">::</span><span class="fu">cut2</span>(x, <span class="at">g =</span> <span class="dv">10</span>)</span>
<span id="cb37-928"><a href="#cb37-928" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-929"><a href="#cb37-929" aria-hidden="true" tabindex="-1"></a>    <span class="at">Age =</span> age,</span>
<span id="cb37-930"><a href="#cb37-930" aria-hidden="true" tabindex="-1"></a>    <span class="at">Income =</span> income,</span>
<span id="cb37-931"><a href="#cb37-931" aria-hidden="true" tabindex="-1"></a>    <span class="at">Sex =</span> </span>
<span id="cb37-932"><a href="#cb37-932" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-933"><a href="#cb37-933" aria-hidden="true" tabindex="-1"></a>        male <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Male"</span>,</span>
<span id="cb37-934"><a href="#cb37-934" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Female"</span></span>
<span id="cb37-935"><a href="#cb37-935" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb37-936"><a href="#cb37-936" aria-hidden="true" tabindex="-1"></a>    <span class="at">Treatment =</span> </span>
<span id="cb37-937"><a href="#cb37-937" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-938"><a href="#cb37-938" aria-hidden="true" tabindex="-1"></a>        A <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb37-939"><a href="#cb37-939" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"B"</span></span>
<span id="cb37-940"><a href="#cb37-940" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb37-941"><a href="#cb37-941" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb37-942"><a href="#cb37-942" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-943"><a href="#cb37-943" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send weights down the rows</span></span>
<span id="cb37-944"><a href="#cb37-944" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb37-945"><a href="#cb37-945" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(NullWeight, OW_hat_norm),</span>
<span id="cb37-946"><a href="#cb37-946" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Type"</span>,</span>
<span id="cb37-947"><a href="#cb37-947" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Weight"</span></span>
<span id="cb37-948"><a href="#cb37-948" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-949"><a href="#cb37-949" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-950"><a href="#cb37-950" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send factors down the rows</span></span>
<span id="cb37-951"><a href="#cb37-951" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb37-952"><a href="#cb37-952" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(Age, Income, Sex),</span>
<span id="cb37-953"><a href="#cb37-953" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Factor"</span>,</span>
<span id="cb37-954"><a href="#cb37-954" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Level"</span></span>
<span id="cb37-955"><a href="#cb37-955" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb37-956"><a href="#cb37-956" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-957"><a href="#cb37-957" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute total weights</span></span>
<span id="cb37-958"><a href="#cb37-958" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb37-959"><a href="#cb37-959" aria-hidden="true" tabindex="-1"></a>    <span class="at">Weight =</span> <span class="fu">sum</span>(Weight),</span>
<span id="cb37-960"><a href="#cb37-960" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(Factor, Level, Type, Treatment)</span>
<span id="cb37-961"><a href="#cb37-961" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-962"><a href="#cb37-962" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-963"><a href="#cb37-963" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find percent of weight</span></span>
<span id="cb37-964"><a href="#cb37-964" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-965"><a href="#cb37-965" aria-hidden="true" tabindex="-1"></a>    <span class="at">Weight =</span> Weight <span class="sc">/</span> <span class="fu">sum</span>(Weight),</span>
<span id="cb37-966"><a href="#cb37-966" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(Factor, Type, Treatment)</span>
<span id="cb37-967"><a href="#cb37-967" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-968"><a href="#cb37-968" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-969"><a href="#cb37-969" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send over columns</span></span>
<span id="cb37-970"><a href="#cb37-970" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb37-971"><a href="#cb37-971" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> Type,</span>
<span id="cb37-972"><a href="#cb37-972" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> Weight</span>
<span id="cb37-973"><a href="#cb37-973" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-974"><a href="#cb37-974" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-975"><a href="#cb37-975" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean up</span></span>
<span id="cb37-976"><a href="#cb37-976" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-977"><a href="#cb37-977" aria-hidden="true" tabindex="-1"></a>    <span class="at">Level =</span> <span class="fu">factor</span>(Level) <span class="sc">|&gt;</span> <span class="fu">fct_rev</span>(),</span>
<span id="cb37-978"><a href="#cb37-978" aria-hidden="true" tabindex="-1"></a>    <span class="at">Factor =</span> </span>
<span id="cb37-979"><a href="#cb37-979" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb37-980"><a href="#cb37-980" aria-hidden="true" tabindex="-1"></a>        Factor <span class="sc">==</span> <span class="st">"Age"</span> <span class="sc">~</span> <span class="st">"Age (years)"</span>,</span>
<span id="cb37-981"><a href="#cb37-981" aria-hidden="true" tabindex="-1"></a>        Factor <span class="sc">==</span> <span class="st">"Income"</span> <span class="sc">~</span> <span class="st">"Income ($)"</span>,</span>
<span id="cb37-982"><a href="#cb37-982" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> Factor</span>
<span id="cb37-983"><a href="#cb37-983" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb37-984"><a href="#cb37-984" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-985"><a href="#cb37-985" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-986"><a href="#cb37-986" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a plot</span></span>
<span id="cb37-987"><a href="#cb37-987" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb37-988"><a href="#cb37-988" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(</span>
<span id="cb37-989"><a href="#cb37-989" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb37-990"><a href="#cb37-990" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Level,</span>
<span id="cb37-991"><a href="#cb37-991" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> NullWeight,</span>
<span id="cb37-992"><a href="#cb37-992" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> Treatment</span>
<span id="cb37-993"><a href="#cb37-993" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-994"><a href="#cb37-994" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb37-995"><a href="#cb37-995" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> .<span class="dv">75</span>,</span>
<span id="cb37-996"><a href="#cb37-996" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">40</span>,</span>
<span id="cb37-997"><a href="#cb37-997" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"dodge"</span></span>
<span id="cb37-998"><a href="#cb37-998" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb37-999"><a href="#cb37-999" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb37-1000"><a href="#cb37-1000" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb37-1001"><a href="#cb37-1001" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Level,</span>
<span id="cb37-1002"><a href="#cb37-1002" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> OW_hat_norm,</span>
<span id="cb37-1003"><a href="#cb37-1003" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> Treatment,</span>
<span id="cb37-1004"><a href="#cb37-1004" aria-hidden="true" tabindex="-1"></a>      <span class="at">shape =</span> Treatment</span>
<span id="cb37-1005"><a href="#cb37-1005" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-1006"><a href="#cb37-1006" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="dv">1</span>),</span>
<span id="cb37-1007"><a href="#cb37-1007" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb37-1008"><a href="#cb37-1008" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-1009"><a href="#cb37-1009" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb37-1010"><a href="#cb37-1010" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb37-1011"><a href="#cb37-1011" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> Level,</span>
<span id="cb37-1012"><a href="#cb37-1012" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> OW_hat_norm,</span>
<span id="cb37-1013"><a href="#cb37-1013" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> Treatment,</span>
<span id="cb37-1014"><a href="#cb37-1014" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> Treatment</span>
<span id="cb37-1015"><a href="#cb37-1015" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-1016"><a href="#cb37-1016" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="dv">1</span>),</span>
<span id="cb37-1017"><a href="#cb37-1017" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> .<span class="dv">5</span></span>
<span id="cb37-1018"><a href="#cb37-1018" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-1019"><a href="#cb37-1019" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Factor, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb37-1020"><a href="#cb37-1020" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb37-1021"><a href="#cb37-1021" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb37-1022"><a href="#cb37-1022" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb37-1023"><a href="#cb37-1023" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-1024"><a href="#cb37-1024" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray"</span>),</span>
<span id="cb37-1025"><a href="#cb37-1025" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb37-1026"><a href="#cb37-1026" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-1027"><a href="#cb37-1027" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Level"</span>) <span class="sc">+</span></span>
<span id="cb37-1028"><a href="#cb37-1028" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Share of weight within group (%)"</span>) <span class="sc">+</span></span>
<span id="cb37-1029"><a href="#cb37-1029" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb37-1030"><a href="#cb37-1030" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Before Weighting"</span>,</span>
<span id="cb37-1031"><a href="#cb37-1031" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="st">"After Weighting"</span>,</span>
<span id="cb37-1032"><a href="#cb37-1032" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"After Weighting"</span></span>
<span id="cb37-1033"><a href="#cb37-1033" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-1034"><a href="#cb37-1034" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1035"><a href="#cb37-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1036"><a href="#cb37-1036" aria-hidden="true" tabindex="-1"></a>We can see the balancing take place. After overlap weighting, the contribution to treatment effect estimation is reduced in older patients with lower income for treatment _A_, and vice-versa for treatment _B_, with some levels in the middle having increased weight for _both_ treatments. This is where the most overlap is between the groups.</span>
<span id="cb37-1037"><a href="#cb37-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1038"><a href="#cb37-1038" aria-hidden="true" tabindex="-1"></a>It is also useful to look at these plots for factors that were _not_ included in the propensity score model. We may find drastic weight shifts which might indicate significant co-variation among factors already accounted for.</span>
<span id="cb37-1039"><a href="#cb37-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1040"><a href="#cb37-1040" aria-hidden="true" tabindex="-1"></a><span class="fu"># Estimating the treatment effect {#estimatingtreatmenteffect}</span></span>
<span id="cb37-1041"><a href="#cb37-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1042"><a href="#cb37-1042" aria-hidden="true" tabindex="-1"></a>We're now ready to estimate the causal treatment effect. Although we <span class="co">[</span><span class="ot">generated our data</span><span class="co">](#treatmenteffect)</span> from a <span class="co">[</span><span class="ot">Weibull</span><span class="co">](https://en.wikipedia.org/wiki/Weibull_distribution)</span> distribution, we will use a <span class="co">[</span><span class="ot">Cox proportional-hazards model</span><span class="co">](https://en.wikipedia.org/wiki/Proportional_hazards_model)</span> for estimation, which is a _semi-parametric_ method, and tends to be the default choice for modeling survival data, especially in healthcare. </span>
<span id="cb37-1043"><a href="#cb37-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1044"><a href="#cb37-1044" aria-hidden="true" tabindex="-1"></a><span class="fu">## A look at the true hazard ratio {#truehazardratio}</span></span>
<span id="cb37-1045"><a href="#cb37-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1046"><a href="#cb37-1046" aria-hidden="true" tabindex="-1"></a>The treatment effect will be quantified by a <span class="co">[</span><span class="ot">_hazard ratio_</span><span class="co">](https://en.wikipedia.org/wiki/Hazard_ratio)</span>, which is an estimate of the ratio of instantaneous event rates between the treatment groups (this is what is done in <span class="co">[</span><span class="ot">the original simulation</span><span class="co">](https://www2.stat.duke.edu/~fl35/OW/OW_survival_Demo.sas)</span>). This measure is different than the effect we <span class="co">[</span><span class="ot">interpreted</span><span class="co">](#interpretingtreatmenteffect)</span> from the true data-generating process, so, although we won't expect them to provide the same numerical result, we should still get a similar conclusion, in that treatment _A_ is superior to treatment _B_.</span>
<span id="cb37-1047"><a href="#cb37-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1048"><a href="#cb37-1048" aria-hidden="true" tabindex="-1"></a>To start, we can compute the actual hazard ratio had we been able to observe each potential outcome (i.e., the counterfactual). To do this, we need to transform our data such that we have two rows of data per patient--one for each treatment. Then, we fit the Cox model, using the _true_ overlap weights as case weights.</span>
<span id="cb37-1049"><a href="#cb37-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1052"><a href="#cb37-1052" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-1053"><a href="#cb37-1053" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb37-1054"><a href="#cb37-1054" aria-hidden="true" tabindex="-1"></a>true_hr_mod <span class="ot">&lt;-</span></span>
<span id="cb37-1055"><a href="#cb37-1055" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coxph</span>(</span>
<span id="cb37-1056"><a href="#cb37-1056" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="fu">factor</span>(A),</span>
<span id="cb37-1057"><a href="#cb37-1057" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb37-1058"><a href="#cb37-1058" aria-hidden="true" tabindex="-1"></a>      population <span class="sc">|&gt;</span></span>
<span id="cb37-1059"><a href="#cb37-1059" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb37-1060"><a href="#cb37-1060" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Keep columns needed</span></span>
<span id="cb37-1061"><a href="#cb37-1061" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb37-1062"><a href="#cb37-1062" aria-hidden="true" tabindex="-1"></a>        OW_norm, <span class="co"># True (normalized) overlap weight (could use un-normalized version here)</span></span>
<span id="cb37-1063"><a href="#cb37-1063" aria-hidden="true" tabindex="-1"></a>        t_A, <span class="co"># True event time under treatment A</span></span>
<span id="cb37-1064"><a href="#cb37-1064" aria-hidden="true" tabindex="-1"></a>        t_B, <span class="co"># True event time under treatment B</span></span>
<span id="cb37-1065"><a href="#cb37-1065" aria-hidden="true" tabindex="-1"></a>        censor_time <span class="co"># When the patient was censored</span></span>
<span id="cb37-1066"><a href="#cb37-1066" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb37-1067"><a href="#cb37-1067" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb37-1068"><a href="#cb37-1068" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Send true event times down the rows</span></span>
<span id="cb37-1069"><a href="#cb37-1069" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(</span>
<span id="cb37-1070"><a href="#cb37-1070" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(t_A, t_B),</span>
<span id="cb37-1071"><a href="#cb37-1071" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"A"</span>,</span>
<span id="cb37-1072"><a href="#cb37-1072" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"time"</span></span>
<span id="cb37-1073"><a href="#cb37-1073" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb37-1074"><a href="#cb37-1074" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb37-1075"><a href="#cb37-1075" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Check if censored first</span></span>
<span id="cb37-1076"><a href="#cb37-1076" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb37-1077"><a href="#cb37-1077" aria-hidden="true" tabindex="-1"></a>        <span class="at">A =</span> <span class="fu">case_when</span>(A <span class="sc">==</span> <span class="st">"t_A"</span> <span class="sc">~</span> <span class="dv">1</span>, <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span>), <span class="co"># Replace with our notation</span></span>
<span id="cb37-1078"><a href="#cb37-1078" aria-hidden="true" tabindex="-1"></a>        <span class="at">time =</span> <span class="fu">pmin</span>(time, censor_time),</span>
<span id="cb37-1079"><a href="#cb37-1079" aria-hidden="true" tabindex="-1"></a>        <span class="at">status =</span> <span class="fu">as.numeric</span>(time <span class="sc">&lt;</span> censor_time)</span>
<span id="cb37-1080"><a href="#cb37-1080" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb37-1081"><a href="#cb37-1081" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> OW_norm</span>
<span id="cb37-1082"><a href="#cb37-1082" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-1083"><a href="#cb37-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1084"><a href="#cb37-1084" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the result</span></span>
<span id="cb37-1085"><a href="#cb37-1085" aria-hidden="true" tabindex="-1"></a>true_hr <span class="ot">&lt;-</span> <span class="fu">exp</span>(true_hr_mod<span class="sc">$</span>coefficients)[[<span class="dv">1</span>]]</span>
<span id="cb37-1086"><a href="#cb37-1086" aria-hidden="true" tabindex="-1"></a>true_hr</span>
<span id="cb37-1087"><a href="#cb37-1087" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1088"><a href="#cb37-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1089"><a href="#cb37-1089" aria-hidden="true" tabindex="-1"></a>If we could compare the worlds in which we observe all patients under each treatment, the hazard ratio is <span class="in">`r round(true_hr, 2)`</span>, suggesting that the instantaneous event rate is <span class="in">`r round(100*(1-true_hr))`</span>% lower with treatment _A_ than with treatment _B_. This aligns with what we've established as the <span class="co">[</span><span class="ot">true effect</span><span class="co">](#interpretingtreatmenteffect)</span>. Our hope is that the estimate from the observable data (in the <span class="co">[</span><span class="ot">next section</span><span class="co">](#estimatedhazardratio)</span>) will contain this value within some margin of sampling error.</span>
<span id="cb37-1090"><a href="#cb37-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1091"><a href="#cb37-1091" aria-hidden="true" tabindex="-1"></a><span class="fu">## Our estimate of the treatment effect {#estimatedhazardratio}</span></span>
<span id="cb37-1092"><a href="#cb37-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1093"><a href="#cb37-1093" aria-hidden="true" tabindex="-1"></a>Finally, we can obtain our estimate of the treatment effect using only the observable quantities we have in our data set, which is what we would have in a real-life analysis. Similar to the <span class="co">[</span><span class="ot">previous section</span><span class="co">](##truehazardratio)</span>, we are just fitting a Cox model with the treatment as a covariate. Except this time we only observe one outcome per patient as a result of the treatment they <span class="co">[</span><span class="ot">actually received</span><span class="co">](#treatmentassignment)</span>, and use the <span class="co">[</span><span class="ot">_estimated_ overlap weight</span><span class="co">](#estimatedoverlapweight)</span> to balance the confounding factors (age, sex, and income). We will also use <span class="co">[</span><span class="ot">robust</span><span class="co">](https://rdrr.io/cran/survival/man/coxph.html)</span> standard error estimates.</span>
<span id="cb37-1094"><a href="#cb37-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1097"><a href="#cb37-1097" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-1098"><a href="#cb37-1098" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb37-1099"><a href="#cb37-1099" aria-hidden="true" tabindex="-1"></a>estimated_hr_mod <span class="ot">&lt;-</span></span>
<span id="cb37-1100"><a href="#cb37-1100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coxph</span>(</span>
<span id="cb37-1101"><a href="#cb37-1101" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="fu">factor</span>(A),</span>
<span id="cb37-1102"><a href="#cb37-1102" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> population,</span>
<span id="cb37-1103"><a href="#cb37-1103" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> OW_hat_norm,</span>
<span id="cb37-1104"><a href="#cb37-1104" aria-hidden="true" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span></span>
<span id="cb37-1105"><a href="#cb37-1105" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-1106"><a href="#cb37-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1107"><a href="#cb37-1107" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the result</span></span>
<span id="cb37-1108"><a href="#cb37-1108" aria-hidden="true" tabindex="-1"></a>estimated_hr <span class="ot">&lt;-</span> <span class="fu">exp</span>(estimated_hr_mod<span class="sc">$</span>coefficients)[[<span class="dv">1</span>]]</span>
<span id="cb37-1109"><a href="#cb37-1109" aria-hidden="true" tabindex="-1"></a>estimated_hr</span>
<span id="cb37-1110"><a href="#cb37-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1111"><a href="#cb37-1111" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the confidence interval</span></span>
<span id="cb37-1112"><a href="#cb37-1112" aria-hidden="true" tabindex="-1"></a>estimated_hr_ci <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">confint</span>(estimated_hr_mod))</span>
<span id="cb37-1113"><a href="#cb37-1113" aria-hidden="true" tabindex="-1"></a>estimated_hr_ci</span>
<span id="cb37-1114"><a href="#cb37-1114" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1115"><a href="#cb37-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1116"><a href="#cb37-1116" aria-hidden="true" tabindex="-1"></a>Our estimate for the hazard ratio is <span class="in">`r round(estimated_hr, 2)`</span>, with a 95% confidence interval ranging from <span class="in">`r round(estimated_hr_ci[[1]], 2)`</span> to <span class="in">`r round(estimated_hr_ci[[2]], 2)`</span>, suggesting that the instantaneous event rate for treatment _A_ is between `r round(100*(1-estimated_hr_ci[[2]]))`% and `r round(100*(1-estimated_hr_ci[[1]]))`% lower compared to treatment _B_ (note that this captures the [true hazard ratio](#truehazardratio)). Under the assumption that we've correctly specified all confounding factors (which [we did](#treatmentpropensity)), we can interpret this as the _causal_ treatment effect, and, assuming the magnitude of improvement is of practical importance (when considering things like cost, resources, clinical outcomes, etc.), we can reliably conclude that there is a benefit to treatment _A_ over treatment _B_, on average.</span>
<span id="cb37-1117"><a href="#cb37-1117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1118"><a href="#cb37-1118" aria-hidden="true" tabindex="-1"></a><span class="fu"># Resources {#resources}</span></span>
<span id="cb37-1119"><a href="#cb37-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1120"><a href="#cb37-1120" aria-hidden="true" tabindex="-1"></a>Some additional resources I've come across while learning the methodology:</span>
<span id="cb37-1121"><a href="#cb37-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1122"><a href="#cb37-1122" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Original paper for overlap weighting (<span class="co">[</span><span class="ot">link</span><span class="co">](https://pubmed.ncbi.nlm.nih.gov/30189042/)</span>)</span>
<span id="cb37-1123"><a href="#cb37-1123" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Paper extending overlap weighting to survival analysis (<span class="co">[</span><span class="ot">link</span><span class="co">](https://arxiv.org/abs/2108.04394)</span>)</span>
<span id="cb37-1124"><a href="#cb37-1124" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Example simulation of overlap weighting in the survival setting in SAS (<span class="co">[</span><span class="ot">link</span><span class="co">](http://www2.stat.duke.edu/~fl35/OW/OW_survival_Demo.sas)</span>)</span>
<span id="cb37-1125"><a href="#cb37-1125" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>R package for implementing overlap weight methods (<span class="co">[</span><span class="ot">link</span><span class="co">](https://github.com/thuizhou/PSweight)</span>)</span>
<span id="cb37-1126"><a href="#cb37-1126" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>R functions for overlap weighting in the survival setting (<span class="co">[</span><span class="ot">link</span><span class="co">](https://github.com/chaochengstat/OW_Survival)</span>)</span>
<span id="cb37-1127"><a href="#cb37-1127" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Author's web page dedicated to overlap weighting (<span class="co">[</span><span class="ot">link</span><span class="co">](https://www2.stat.duke.edu/~fl35/OW.html)</span>)</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>© 2024 Zajichek Stats</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>