{
  "hash": "9733a427eb542add28fb6e2dec5164a7",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"How do you assess the proportional-odds assumption? Directly.\"\ndescription: \"A simple visual check.\"\nauthor: \"Alex Zajichek\"\ndate: \"7/19/2024\"\nimage: \"feature.png\"\ndraft: false\ncategories:\n  - Regression\nformat:\n  html:\n    code-fold: true\n    code-tools: true\n---\n\n{{< video https://www.youtube.com/embed/9q_0tWT89W4 >}}\n\n\n\n\nThis dataset comes from the [2011 Annual Resident Survey](https://data.world/durhamnc/2011-resident-survey) in Durham, NC.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load packages\nlibrary(tidyverse)\n\n# Import the dataset\ndat <- read_delim(\n  file = \"https://query.data.world/s/zr3uaxpaagbzddttoreosktj2zy7lm?dws=00000\", \n  delim = \";\",\n  na = c(\"\", \" \", \"NA\", \"N/A\")\n) |>\n  \n  # Keep a few columns\n  transmute(\n    QOL = \n      q3f_quality_of_life_in_city |>\n      factor() |>\n      fct_relevel(\n        \"Very Dissatisfied\",\n        \"Dissatisfied\",\n        \"Neutral\",\n        \"Satisfied\",\n        \"Very Satisfied\"\n      ),\n    Age = str_remove(`18_34_years`, \"(?i)\\\\syears$\") |> factor(),\n    Income = \n      q38_annual_household_income |>\n      factor() |>\n      fct_relevel(\n        \"Under $30,000\",\n        \"$30,000 to $59,999\",\n        \"$60,000 to $99,999\",\n        \"$100,000 or more\"\n      ),\n    Sex = q34_respondents_gender\n  ) |>\n  \n  # Remove missing cases\n  na.omit()\n```\n:::\n\n\n\nSuppose we are interested in understanding the relationship between resident age and their perceived quality of life in the city, after adjusting for gender and annual household income. We have the following observed distribution (note that we've removed missing data for simplicity):\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat |> \n  \n  # Compute group summaries\n  summarize(\n    N = n(),\n    .by = \n      c(\n        QOL,\n        Age\n      )\n  ) |>  \n  \n  # Flip the order\n  mutate(\n    QOL = fct_rev(QOL)\n  ) |>\n  \n  # Make a plot\n  ggplot() + \n  geom_col(\n    aes(\n      x = Age,\n      y = N,\n      fill = QOL\n    ),\n    color = \"black\",\n    alpha = .75\n  ) +\n  theme(\n    panel.background = element_blank(),\n    panel.grid.major.y = element_line(color = \"gray\"),\n    legend.position = \"top\",\n    legend.title = element_blank(),\n    legend.text = element_text(size = 10),\n    axis.title = element_text(size = 14),\n    axis.text = element_text(size = 12),\n    plot.title = element_text(hjust = .5)\n  ) +\n  xlab(\"Respondent Age (years)\") +\n  ylab(\"Count\") +\n  labs(title = \"Quality of life in the city\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\nOverall, it looks like older respondents tend to report more pessimistic views of quality of life. \n\n# Forming a model\n\nA typical approach for modeling [likert-like](https://en.wikipedia.org/wiki/Likert_scale) data is to use a [proportional-odds logistic regression model](https://en.wikipedia.org/wiki/Ordered_logit). It is an extension of the widely-used binary [logistic regression](https://en.wikipedia.org/wiki/Logistic_regression) model, with one key assumption: _the ratio of odds between two groups (e.g., ages 35-44 versus 18-34) of being at or above a response level (e.g., satisfied or very satisfied versus neutral, dissatisfied, or very dissatisfied) are **proportional** (i.e., the same) regardless of where we make that comparison in the outcome_. So this odds ratio would also be the same if we instead compared, for example, very satisfied versus everything else.\n\n## What does that mean?\n\nLet's clarify this by using our model output directly. We'll fit the model, adjusted for annual household income and gender, using the `MASS::polr` function. The age group 18-34 will serve as the reference category in which all other age groups will be compared against. _Note: By default the package computes odds ratios in the opposite direction to what we what we want, so we invert them._\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit the model\nmod <-\n  MASS::polr(\n    formula = QOL ~ Age + Income + Sex,\n    data = dat,\n    Hess = TRUE\n  )\n\n# Make a table of odds-ratios\nmod$coefficients |>\n  \n  # Convert to data frame\n  enframe(\n    name = \"Term\",\n    value = \"Estimate\"\n  ) |>\n  \n  # Join to get the CI\n  inner_join(\n    y = \n      # Get the 95% confidence intervals\n      confint(mod) |> \n      \n      # Convert to tibble, add the coefficient names\n      as_tibble() |> \n      add_column(Term = names(mod$coefficients)),\n    by = \"Term\"\n  ) |> \n  \n  # Filter to age factor only\n  filter(str_detect(Term, \"^Age\")) |>\n  \n  # Clean up\n  mutate(\n    Term = str_remove(Term, \"^Age\"),\n    across(\n      where(is.numeric),\n      \\(x) sprintf(\"%.2f\", 1 / exp(x))\n    )\n  ) |> \n  \n  # Rename\n  rename(\n    `Age (years)` = Term,\n    `Odds-ratio` = Estimate,\n    Lower = `97.5 %`,\n    Upper = `2.5 %`\n  ) |>\n  \n  # Change location\n  relocate(Lower, .before = Upper) |>\n  \n  # Add the reference row\n  add_row(\n    `Age (years)` = \"18-34\",\n    `Odds-ratio` = \"-\",\n    Lower = \"-\",\n    Upper = \"-\",\n    .before = 1\n  ) |>\n  \n  # Make a table\n  knitr::kable(format = \"html\") |>\n  kableExtra::kable_styling() |>\n  kableExtra::add_header_above(c(\"\", \"\", \"95% CI\" = 2))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n<tr>\n<th style=\"empty-cells: hide;border-bottom:hidden;\" colspan=\"1\"></th>\n<th style=\"empty-cells: hide;border-bottom:hidden;\" colspan=\"1\"></th>\n<th style=\"border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; \" colspan=\"2\"><div style=\"border-bottom: 1px solid #ddd; padding-bottom: 5px; \">95% CI</div></th>\n</tr>\n  <tr>\n   <th style=\"text-align:left;\"> Age (years) </th>\n   <th style=\"text-align:left;\"> Odds-ratio </th>\n   <th style=\"text-align:left;\"> Lower </th>\n   <th style=\"text-align:left;\"> Upper </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 18-34 </td>\n   <td style=\"text-align:left;\"> - </td>\n   <td style=\"text-align:left;\"> - </td>\n   <td style=\"text-align:left;\"> - </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 35-44 </td>\n   <td style=\"text-align:left;\"> 1.24 </td>\n   <td style=\"text-align:left;\"> 0.67 </td>\n   <td style=\"text-align:left;\"> 2.30 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 45-54 </td>\n   <td style=\"text-align:left;\"> 1.13 </td>\n   <td style=\"text-align:left;\"> 0.64 </td>\n   <td style=\"text-align:left;\"> 1.98 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 55-64 </td>\n   <td style=\"text-align:left;\"> 1.74 </td>\n   <td style=\"text-align:left;\"> 0.97 </td>\n   <td style=\"text-align:left;\"> 3.12 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 65-74 </td>\n   <td style=\"text-align:left;\"> 3.02 </td>\n   <td style=\"text-align:left;\"> 1.40 </td>\n   <td style=\"text-align:left;\"> 6.54 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 75+ </td>\n   <td style=\"text-align:left;\"> 0.93 </td>\n   <td style=\"text-align:left;\"> 0.30 </td>\n   <td style=\"text-align:left;\"> 2.88 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\nGenerally, the estimates pan out roughly how we suspected. In particular, the estimated odds of _worse_ perceived quality of life in the city for 65-74 year olds are 3 times that of 18-34 year olds, after adjusting for annual household income and gender (with a 95% [confidence interval](https://en.wikipedia.org/wiki/Confidence_interval) of 1.4 to 6.5). \n\nAgain, this interpretation is assumed to hold true if \"worse\" is defined as _very dissatisfied_ versus everything else, or _very dissatisfied_ through _satisfied_ versus _very satisfied_, and everything in between.\n\n# Does the assumption hold?\n\nThe question becomes whether that big assumption of proportional-odds actually holds. We may have reason to think, from the data or gut instinct, that it might not. Well, one simple way to check is by _directly_ assessing what it implies.\n\n## Continue...\n\nWe said earlier that the model assumes the same odds ratios for any mutually exclusive comparison of the ordered response categories. Thus, we can free up this constraint by thinking of constructing a collection of _binary_ logistic regression models: one for each of those ordinal comparisons. Specifically,\n\n* _Very Dissatisfied_ versus everything else\n* _Very Dissatisfied_ or _Dissatisfied_ versus everything else\n* _Very Dissatisfied_, _Dissatisfied_, or _Neutral_ versus _Satisfied_ or _Very Satisfied_\n* _Very Dissatisfied_ through _Satisfied_ versus _Very Satisfied_\n\nThen, we simply just look to see if the resulting odds ratios are reasonably similar across all of those models. If so, then we can be somewhat confident that it _can_ be reduced to a single model, and stick with our original proportional-odds estimates.\n\nMy preference is to do this in a plot.\n\n## Making the plot\n\nWe'll cycle through the response categories, iteratively define the binary outcomes as described above, and then fit a logistic regression model for each definition. Once we do this, we get the following plot:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Set the number of comparisons\nn_comp <- n_distinct(dat$QOL) - 1\n\n# Make each data set\n1:n_comp |>\n  \n  # For each set\n  map_df(\n    function(.index) {\n      \n      # Extract the current response set\n      temp_resp <- levels(dat$QOL)[1:.index]\n      \n      # Create binary outcome in the data\n      temp_dat <- \n        dat |>\n        \n        # Create target\n        mutate(\n          Response = \n            case_when(\n              QOL %in% temp_resp ~ 1,\n              TRUE ~ 0\n            )\n        )\n      \n      # Fit the binary logistic regression model\n      temp_mod <-\n        glm(\n          formula = Response ~ Age + Income + Sex,\n          data = temp_dat,\n          family = \"binomial\"\n        )\n      \n      # Make a table of odds-ratios\n      temp_mod$coefficients |>\n        \n        # Convert to data frame\n        enframe(\n          name = \"Term\",\n          value = \"Estimate\"\n        ) |>\n        \n        # Join to get the CI\n        inner_join(\n          y = \n            # Get the 95% confidence intervals\n            confint.default(temp_mod) |> \n            \n            # Convert to tibble, add the coefficient names\n            as_tibble() |> \n            add_column(Term = names(temp_mod$coefficients)),\n          by = \"Term\"\n        ) |> \n        \n        # Filter to age factor only\n        filter(str_detect(Term, \"^Age\")) |>\n        \n        # Clean up\n        mutate(\n          Term = str_remove(Term, \"^Age\"),\n          across(\n            where(is.numeric),\n            \\(x) exp(x)\n          )\n        ) |>\n        \n        # Rename\n        rename(\n          Age = Term,\n          OR = Estimate,\n          Lower = `2.5 %`,\n          Upper = `97.5 %`\n        ) |>\n        \n        # Add the reference row\n        add_row(\n          Age = \"18-34\",\n          OR = 1,\n          Lower = 1,\n          Upper = 1,\n          .before = 1\n        ) |>\n        \n        # Attach outcome level\n        add_column(QOL = levels(dat$QOL)[.index])\n      \n    },\n    .id = \"Order\"\n  ) |>\n  \n  # Make the factor\n  mutate(\n    Order = as.numeric(Order),\n    QOL = factor(QOL) |> fct_reorder(Order)\n  ) |>\n  \n  # Make a plot\n  ggplot(\n    aes(\n      x = QOL,\n      y = OR,\n      group = 1\n    )\n  ) +\n  geom_line(\n    aes(\n      color = Age\n    ),\n    linewidth = 1.5\n  ) +\n  geom_point(\n    aes(\n      color = Age\n    ),\n    size = 3\n  ) +\n  geom_ribbon(\n    aes(\n      ymin = Lower,\n      ymax = Upper,\n      fill = Age\n    ),\n    alpha = .25\n  ) +\n  geom_hline(yintercept = 1, color = \"gray\") +\n  facet_wrap(~paste0(Age, \" years\")) +\n  coord_cartesian(ylim = c(0, 4)) +\n  theme(\n    panel.background = element_blank(),\n    panel.grid.major.y = element_line(color = \"gray\"),\n    legend.position = \"none\",\n    axis.title = element_text(size = 12),\n    axis.text = element_text(size = 12),\n    axis.text.x = element_text(angle = 45, size = 10),\n    plot.title = element_text(hjust = .5),\n    strip.text = element_text(size = 14)\n  ) +\n  xlab(\"Response\") +\n  ylab(\"Odds-ratio (95% CI) for being at or below response level\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\nUnfortunately we're quite plagued by variability here, especially in the lower-end (i.e., _very dissatisfied_ versus everything else), due to scanty event volumes, but you get the picture. Actually, for 65-74 year olds, the proportional-odds assumption seems to be a reasonable one: it was estimated earlier at 3.02, and we see the point estimates across these binary models vary between 2.5-3.5. \n\nFor other age categories, it may not be so good of an assumption. It looks like 35-44 and 55-64 year olds tend to have a much higher odds of responding _very dissatisfied_ relative to 18-34 year olds, but there is much less of a difference (in all age categories) for the odds of responding _very satisfied_, suggesting something like older residents may make a point to select the least favorable response but don't see much difference between being _satisfied_ or _very satisfied_.\n\n## So what do we do in practice?\n\nFirst, the same proportional-odds assumptions hold for all covariates in the model, so we would also want to assess this for annual household income and gender. Second, if the assumption is not met, then we need to accommodate that by introducing more flexibility into the model. That may be by being clever with interaction terms, defining sensible groups to create, or by using separate binary models for each possible comparison, as we've done here. It's really a judgement call.\n\n\n\n{{< bluesky-comments uri=\"at://did:plc:sh3av73hihgu72vx7k44kgv7/app.bsky.feed.post/3lc73sgvuqk2t\" >}}\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}